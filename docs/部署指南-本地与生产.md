后端部署指南（本地与生产）

一、本地完整体验部署（Windows 10/11）
1) 安装依赖
- Node.js ≥ 18 LTS（建议 18.18+ 或 20 LTS）
- PowerShell 7（可选）
- 在项目根目录执行：npm install 或 npm ci
2) 环境变量
- .env 中确保：
  PORT=14000
  NODE_ENV=development
  ALLOWED_ORIGINS=*
3) 启动与自检
- 运行：node src/app.js
- 或运行脚本：.\scripts\start-local.ps1
- 打开浏览器访问：
  - http://localhost:14000/ （首页 local-game）
  - http://localhost:14000/health
  - http://localhost:14000/api/info
  - http://localhost:14000/api/agents/status
- 简易注册/登录（本地占位）：
  - POST /api/auth/register（body: { username, password }）
  - POST /api/auth/login（返回 token）
  - POST /api/auth/logout（body: { token }）

二、生产部署（推荐：Linux + Docker + Nginx）
1) 服务器环境要求
- 操作系统：Ubuntu 20.04/22.04 或 Debian 11+
- Docker ≥ 24 与 docker-compose v2
- Nginx ≥ 1.20（反向代理与HTTPS）
2) 准备配置
- 复制 .env.example.production 为 .env（按需修改）
- 检查 docker-compose.yml（默认暴露 14000）
- 检查 deploy/nginx.conf（填入你的域名与证书路径）
3) 启动服务
- docker compose up -d
- 配置 Nginx 站点并启用 HTTPS（Let’s Encrypt）
- 验证：
  - https://your-domain/health
  - https://your-domain/api/info
4) 数据库（生产建议）
- 使用外部托管数据库（Postgres/MySQL），在 .env 中配置 DATABASE_URL
- 初期可沿用 SQLite（持久化挂载 data/），但不建议长期在线上使用
5) 安全与性能
- CORS 限定到你的前端域名
- 收紧 CSP（减少 'unsafe-inline'）
- 开启 gzip（Nginx），必要时启用 compression 中间件
- 使用 pm2 cluster 或容器横向扩展
- 日志集中与监控（/health 探针；日志输出到文件或外部系统）

三、CI/CD（可选）
- 使用 .github/workflows/docker-deploy.yml：
  - 推送到 main 分支触发：构建 Docker 镜像并推送到仓库
  - 在服务器上拉取最新镜像并 docker compose up -d
- 在仓库 Secrets 中配置：
  - REGISTRY/TOKEN、DATABASE_URL、NODE_ENV、ALLOWED_ORIGINS 等

四、常见问题
- 端口占用：确保 .env 的 PORT=14000；Nginx 反代 443→app:14000
- 跨域：前端用同源相对路径（fetch('/api/...')），生产下设置 ALLOWED_ORIGINS
- SQLite 权限：容器或服务器需对 data/ 目录有可写权限（挂载与权限正确）
- 证书：使用 Let’s Encrypt 自动签发，更新周期自动化（certbot）

五、上线最小流程（示例）
- 准备一台 Linux 服务器（2C/4G）
- 安装 Docker 与 docker-compose
- 配置 .env（生产）
- docker compose up -d
- 配置 Nginx 域名与 HTTPS
- 验证健康与主要接口，前端指向你的域名即可使用