# 🌟 宠物进化系统完整文档

## 📋 概述

宠物进化系统是《灵境斗宠录》的核心玩法之一,提供了深度的养成体验和多样化的进化路径。

---

## 🎯 系统特性

### ✨ 核心亮点
1. **多分支进化** - 每个宠物有3条主要进化路线(力量/速度/智慧)
2. **动态触发** - 8种触发方式,自动/手动结合
3. **AI辅助** - 自动生成史诗级进化故事
4. **行为驱动** - 玩家行为影响进化方向
5. **稀有度提升** - N→R→SR→SSR→SSS完整进化链

### 📊 数据统计
- **支持种族**: 5个初始种族(龙、狐、凤凰等)
- **进化路径**: 15+条路径
- **传说进化**: 3个SSS级终极形态
- **特性系统**: 50+种独特特性

---

## 🗺️ 进化路径示例

### 幼龙进化树

```
幼龙 (N)
├─ [力量路线] → 烈焰龙 (R) → 炎龙 (SR) → 焚天龙皇 (SSR)
├─ [速度路线] → 风龙 (R) → 疾风龙王 (SR) → 天空霸主 (SSR)
└─ [智慧路线] → 灵龙 (R) → 贤者龙 (SR) → 智慧龙尊 (SSR)

烈焰龙还可分支:
└─ [暗炎融合] → 暗炎龙 (SR) - 需要"暗之结晶"
```

### 灵狐进化树

```
灵狐 (R)
├─ [幻术路线] → 幻狐 (SR) → 千幻仙狐 (SSR)
└─ [九尾路线] → 九尾仙狐 (SSS) - 传说进化!
   要求: 等级40 + 羁绊50 + 月圆之夜 + 纯净度80
```

---

## 🔧 进化要求类型

### 1. 基础要求
- **等级**: 20/40/60级(不同阶段)
- **羁绊**: 20/30/40/50/60(与玩家的亲密度)

### 2. 行为倾向
| 倾向类型 | 说明 | 培养方式 |
|---------|------|---------|
| 攻击型 | 激进战斗风格 | 多次主动攻击 |
| 防御型 | 稳健防守 | 多使用防御/格挡 |
| 敏捷型 | 快速灵活 | 频繁闪避/逃脱 |
| 策略型 | 善用技能道具 | 多用技能和道具 |
| 欺诈型 | 幻术诡计 | 使用幻术/偷袭 |
| 辅助型 | 治疗增益 | 治疗/增益技能 |

### 3. 特殊条件
- **战斗次数**: 最少10次战斗
- **Boss击败**: 击败3/5/10个Boss
- **特殊道具**: 进化石、龙之心、凤凰之羽等
- **时间条件**: 月圆之夜(每月15日)、满月夜(22:00-04:00)
- **传说任务**: 火焰试炼、冰霜考验等
- **纯净度**: 不作恶行为积累的善良值

---

## 🎮 使用指南

### API 接口

#### 1. 查看可用进化路径
```http
GET /api/evolution/paths/:petId
Authorization: Bearer {accessToken}
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "petId": "123",
    "petName": "小火",
    "currentSpecies": "幼龙",
    "currentRarity": "N",
    "level": 25,
    "bondLevel": 30,
    "canEvolve": true,
    "readyPaths": [
      {
        "key": "power",
        "name": "力量觉醒",
        "description": "走上追求极致力量的道路",
        "available": true,
        "evolution": {
          "species": "烈焰龙",
          "rarity": "R",
          "statBonus": {
            "health": 50,
            "attack": 40,
            "defense": 15
          },
          "newTraits": ["烈焰吐息", "龙威", "坚韧鳞甲"]
        }
      }
    ]
  }
}
```

#### 2. 执行进化
```http
POST /api/evolution/execute
Authorization: Bearer {accessToken}
Content-Type: application/json

{
  "petId": "123",
  "pathKey": "power",
  "generateStory": true
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "进化成功!",
  "data": {
    "pet": {
      "id": "123",
      "species": "烈焰龙",
      "rarity": "R",
      "health": 150,
      "attack": 55,
      "newTraits": ["烈焰吐息", "龙威", "坚韧鳞甲"]
    },
    "story": "天空突然乌云密布,雷电交加...",
    "isLegendary": false
  }
}
```

#### 3. 检查进化资格
```http
GET /api/evolution/check/:petId
Authorization: Bearer {accessToken}
```

#### 4. 查看进化历史
```http
GET /api/evolution/history/:petId?limit=10
Authorization: Bearer {accessToken}
```

#### 5. 获取种族进化树
```http
GET /api/evolution/tree/幼龙
```

#### 6. 全服进化统计
```http
GET /api/evolution/statistics
```

---

## 💻 前端集成示例

### 查询进化路径

```javascript
async function checkEvolutionPaths(petId) {
  const response = await fetch(`/api/evolution/paths/${petId}`, {
    headers: {
      'Authorization': `Bearer ${accessToken}`
    }
  });

  const result = await response.json();

  if (result.success && result.data.canEvolve) {
    // 显示进化选项
    showEvolutionOptions(result.data.readyPaths);
  } else if (result.data.nearEvolution) {
    // 显示接近提示
    showNearEvolutionHint(result.data.nearReadyPaths);
  }
}
```

### 执行进化

```javascript
async function evolve(petId, pathKey) {
  // 显示加载动画
  showEvolutionAnimation();

  const response = await fetch('/api/evolution/execute', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${accessToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      petId,
      pathKey,
      generateStory: true
    })
  });

  const result = await response.json();

  if (result.success) {
    // 播放进化动画
    playEvolutionCutscene(result.data);

    // 显示进化故事
    displayEvolutionStory(result.data.story);

    // 展示新属性
    showNewStats(result.data.pet);
  }
}
```

---

## 🎨 进化演出设计

### 阶段一:预兆(2秒)
- 屏幕震动效果
- 宠物周围光芒闪烁
- 文字提示:"感受到强大的力量..."

### 阶段二:进化过程(5秒)
- 全屏白光
- 宠物轮廓变化动画
- 粒子特效爆发
- 背景音乐高潮

### 阶段三:完成展示(3秒)
- 新形态登场
- 属性变化对比
- 新特性解锁提示
- 稀有度颜色变换

### 阶段四:故事叙述(自适应)
- AI生成的进化故事
- 逐字显示效果
- 可跳过选项

---

## 🔄 行为记录系统

### 记录玩家行为

```javascript
// 在战斗/互动时记录
async function recordBehavior(petId, action) {
  // action类型:
  // 'attack', 'defend', 'dodge', 'skill', 'item',
  // 'flee', 'heal', 'buff', 'trick', 'charge'

  const behaviorHistory = JSON.parse(pet.behavior_history || '[]');
  behaviorHistory.push({
    action,
    timestamp: Date.now()
  });

  // 只保留最近100条
  if (behaviorHistory.length > 100) {
    behaviorHistory.shift();
  }

  await database.run(
    'UPDATE pets SET behavior_history = ? WHERE id = ?',
    [JSON.stringify(behaviorHistory), petId]
  );
}
```

---

## 📈 进化概率与平衡

### 稀有度分布目标

| 稀有度 | 目标占比 | 获取方式 |
|-------|---------|---------|
| N | 40% | 初始召唤 |
| R | 35% | 1次进化 |
| SR | 20% | 2次进化 |
| SSR | 4.5% | 3次进化或特殊路线 |
| SSS | 0.5% | 传说进化 |

### 进化难度曲线

```
N → R:   等级20,  羁绊20  (容易)
R → SR:  等级40,  羁绊40  (中等)
SR → SSR: 等级60, 羁绊60 + Boss10个 (困难)
SSR → SSS: 等级80, 羁绊80 + 传说任务 (极难)
```

---

## 🐛 常见问题

### Q: 进化失败怎么办?
A: 检查API响应的`missing`字段,查看缺少什么条件。

### Q: 如何培养特定行为倾向?
A: 多次使用对应类型的行动。例如想要攻击型,就多主动攻击。

### Q: 特殊道具在哪获得?
A: 通过Boss战斗、任务奖励、商店购买等方式。

### Q: 月圆之夜错过了怎么办?
A: 每月15日都是月圆,下个月再来。

### Q: 进化后能反悔吗?
A: 不能回退,但可以继续向其他分支进化。

---

## 🔐 数据库Schema

### evolution_records 表

```sql
CREATE TABLE evolution_records (
  id SERIAL PRIMARY KEY,
  pet_id INTEGER REFERENCES pets(id),
  from_species VARCHAR(100),
  to_species VARCHAR(100),
  from_rarity VARCHAR(10),
  to_rarity VARCHAR(10),
  evolution_path VARCHAR(50),
  trigger_reason TEXT,
  ai_story TEXT,
  stats_before JSONB,
  stats_after JSONB,
  player_choices JSONB,
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 🚀 后续扩展计划

### 第二周 Day 4-7 计划
- [ ] 进化动画特效系统
- [ ] 进化剧情库扩充(100+段)
- [ ] 更多种族进化路径
- [ ] 融合进化系统
- [ ] 退化机制(被诅咒)

### 未来功能
- [ ] 进化预测AI(预测玩家会选哪条路径)
- [ ] 进化模拟器(让玩家提前看效果)
- [ ] 进化排行榜
- [ ] 进化成就系统
- [ ] 进化皮肤系统

---

## 📚 相关文件

| 文件 | 说明 |
|------|------|
| `src/game/EvolutionPathSystem.js` | 进化路径定义和逻辑 |
| `src/game/EvolutionTriggerSystem.js` | 进化触发和执行 |
| `src/routes/petEvolutionRoutes.js` | API路由 |
| `scripts/supabase-schema.sql` | 数据库Schema |

---

## 🎉 总结

宠物进化系统已完整实现核心功能:
- ✅ 3条主要进化路线
- ✅ 8种触发方式
- ✅ AI故事生成
- ✅ 行为倾向分析
- ✅ 完整API接口
- ✅ 数据库支持

**下一步**: 实现前端进化演出动画!

---

**第二周 Day 1-3 完成! 🎊**
