# 开发进度交底（迭代01）

时间：2025-09-29
目标：文字为主的沉浸式演出；事件触发不跳转；场景氛围可切换；右上面板承载信息。

## 已完成
- 事件委托：在故事容器(#storyContent)拦截文本链接点击，依据 data-action 分发到 startAdventure / triggerDaily / triggerBattle，避免浏览器 GET 中文路径导致 404。
- 场景氛围层：加入 .scene-aura 覆盖层，使用 CSS 变量 --aura-1/--aura-2 控制条纹渐变，提供 setSceneVisuals(key) 映射 volcano/sky/forest/desert。
- 信息布局调整：中心仅文字演出；宠物与数值信息收拢到右上角面板（“宠物信息”区块）。
- 根路径“/”直达本地文字演绎版（不再显示登录页）。

## 变更文件
- public/local-game.html
  - 注入 .scene-aura 样式和 DOM
  - 新增 setSceneVisuals(key)
  - 尾部脚本增加事件委托，拦截 <a data-action="..."> 的默认跳转
- src/app.js
  - 静态中间件 index:false，确保“/”按路由响应本地文字页面

## 测试清单
- 打开 http://localhost:3000/，点击故事中的“开始冒险/日常互动/灵境对决”提示词（如存在），应触发演出且不跳页。
- 控制台执行 setSceneVisuals('volcano'|'sky'|'forest'|'desert')，氛围条纹应变化。
- 面板展开后，宠物信息显示名称/稀有/种类/属性/简述/五维属性；剧情结束后不再在中心展示宠物形象。

## 下一步计划（迭代02）
1. 将 setSceneVisuals 自动嵌入开场：
   - startAdventure → 根据地区设置如 'forest' / 'volcano'
   - triggerDaily → 'camp/forest'
   - triggerBattle → 根据敌方场域选择 'desert/sky/volcano'
2. 提示词模板落地与即梦4.0接入：
   - 场景文本生成接口（返回结构化文本，不强依赖图片）
   - 宠物文字形象与数值框架生成；需要图片时调用 /api/media/pet-image?provider=vim&prompt=...
3. 路由输出结构对齐（占位 → 真实）：
   - { text/event, deltas: {exp,bond,items}, meta: {scene,actors,task,plot} }
4. 自动滚动到最新文字段落，提高“对话流”体验。
5. 进化路线与剧情路线提示词植入，固定算法约束：概率权重、数值边界、事件合法性。

## 风险与缓解
- 前端与后端字段不一致：先以占位字段 meta/deltas 对齐；日志记录并降级为本地模板。
- 提示词过长：拆分为“场景/宠物/互动”三段，分步生成，提升稳定性。