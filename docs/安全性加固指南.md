# ğŸ” ã€Šçµå¢ƒæ–—å® å½•ã€‹å®‰å…¨æ€§åŠ å›ºæŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—ä»‹ç»é¡¹ç›®çš„å®‰å…¨åŠ å›ºæ–¹æ¡ˆ,åŒ…æ‹¬APIé™æµã€è¾“å…¥éªŒè¯ã€JWTè®¤è¯ã€å†…å®¹è¿‡æ»¤ç­‰ã€‚

---

## ğŸ›¡ï¸ å·²å®ç°çš„å®‰å…¨åŠŸèƒ½

### 1. APIé™æµ (`src/middleware/rateLimiter.js`)

**åŠŸèƒ½**:é˜²æ­¢APIæ»¥ç”¨ã€DDoSæ”»å‡»å’ŒAIæ¥å£è¢«åˆ·çˆ†

**é…ç½®**:
```javascript
// å…¨å±€é™æµ: 15åˆ†é’Ÿ100æ¬¡è¯·æ±‚
// AIæ¥å£é™æµ: 1å°æ—¶50æ¬¡è¯·æ±‚
// ç™»å½•é™æµ: 15åˆ†é’Ÿ5æ¬¡è¯·æ±‚
// å® ç‰©åˆ›å»ºé™æµ: 1åˆ†é’Ÿ3æ¬¡è¯·æ±‚
```

**ä½¿ç”¨æ–¹æ³•**:
```javascript
const { globalLimit, aiLimit, authLimit } = require('./middleware/rateLimiter');

// åº”ç”¨åˆ°æ‰€æœ‰è·¯ç”±
app.use(globalLimit);

// ç‰¹å®šè·¯ç”±ä½¿ç”¨ç‰¹æ®Šé™æµ
app.post('/api/ai/generate', aiLimit, handler);
app.post('/api/auth/login', authLimit, handler);
```

**è‡ªå®šä¹‰é™æµ**:
```javascript
const { createCustomLimit } = require('./middleware/rateLimiter');

// 10ç§’å†…æœ€å¤š3æ¬¡
const customLimit = createCustomLimit(10000, 3);
app.post('/api/sensitive', customLimit, handler);
```

---

### 2. è¾“å…¥éªŒè¯ (`src/middleware/validator.js`)

**åŠŸèƒ½**:é˜²æ­¢SQLæ³¨å…¥ã€XSSæ”»å‡»ã€æ¶æ„è¾“å…¥

**å†…ç½®éªŒè¯è§„åˆ™**:
- ç”¨æˆ·å: 3-20å­—ç¬¦,å­—æ¯/æ•°å­—/ä¸‹åˆ’çº¿/ä¸­æ–‡
- é‚®ç®±: æ ‡å‡†é‚®ç®±æ ¼å¼
- å¯†ç : 6-50å­—ç¬¦,å¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—
- å® ç‰©åç§°: 1-20å­—ç¬¦,æ— ç‰¹æ®Šå­—ç¬¦
- ID: çº¯æ•°å­—
- ç­‰çº§: 1-100ä¹‹é—´

**ä½¿ç”¨æ–¹æ³•**:
```javascript
const { validateUserRegister, validatePetCreate } = require('./middleware/validator');

// é¢„å®šä¹‰schema
app.post('/api/users/register', validateUserRegister, handler);
app.post('/api/pets/create', validatePetCreate, handler);

// è‡ªå®šä¹‰schema
const { Validator, ValidationRules } = require('./middleware/validator');

const customSchema = {
  customField: {
    type: 'string',
    minLength: 5,
    maxLength: 100,
    required: true
  }
};

app.post('/api/custom', Validator.middleware(customSchema), handler);
```

**éªŒè¯åçš„æ•°æ®**:
```javascript
// åœ¨è·¯ç”±å¤„ç†å™¨ä¸­è®¿é—®
app.post('/api/example', validatePetCreate, (req, res) => {
  const cleanData = req.validated; // å·²éªŒè¯å’Œæ¸…ç†çš„æ•°æ®
  // ...
});
```

---

### 3. JWTè®¤è¯ (`src/middleware/auth.js`)

**åŠŸèƒ½**:ç”¨æˆ·è®¤è¯ã€Tokenåˆ·æ–°ã€ä¼šè¯ç®¡ç†

**Tokenç±»å‹**:
- **AccessToken**: 7å¤©æœ‰æ•ˆæœŸ,ç”¨äºAPIè¯·æ±‚
- **RefreshToken**: 30å¤©æœ‰æ•ˆæœŸ,ç”¨äºåˆ·æ–°AccessToken

**ä½¿ç”¨æ–¹æ³•**:
```javascript
const { authenticate, generateTokenPair } = require('./middleware/auth');

// ç™»å½•æ—¶ç”ŸæˆTokenå¯¹
app.post('/api/auth/login', async (req, res) => {
  // éªŒè¯ç”¨æˆ·...
  const tokens = generateTokenPair(userId, username);
  res.json({
    success: true,
    data: tokens
  });
});

// ä¿æŠ¤éœ€è¦è®¤è¯çš„è·¯ç”±
app.get('/api/user/profile', authenticate(), (req, res) => {
  const userId = req.user.userId; // å·²è§£æçš„ç”¨æˆ·ä¿¡æ¯
  // ...
});

// å¯é€‰è®¤è¯(Tokenæœ‰æ•ˆæ—¶é™„åŠ ç”¨æˆ·ä¿¡æ¯)
app.get('/api/public', optionalAuth(), (req, res) => {
  if (req.user) {
    // å·²ç™»å½•ç”¨æˆ·
  } else {
    // æœªç™»å½•ç”¨æˆ·
  }
});
```

**Tokenåˆ·æ–°**:
```javascript
const { authHandlers } = require('./middleware/auth');

// åˆ·æ–°Tokenè·¯ç”±
app.post('/api/auth/refresh', authHandlers.refreshToken);

// ç™»å‡ºè·¯ç”±
app.post('/api/auth/logout', authenticate(), authHandlers.logout);
```

**æƒé™æ£€æŸ¥**:
```javascript
const { requireRole } = require('./middleware/auth');

// åªæœ‰ç®¡ç†å‘˜å¯è®¿é—®
app.delete('/api/admin/users/:id',
  authenticate(),
  requireRole(['admin']),
  handler
);
```

---

### 4. å†…å®¹è¿‡æ»¤ (`src/middleware/contentFilter.js`)

**åŠŸèƒ½**:æ•æ„Ÿè¯æ£€æµ‹ã€ä¸è‰¯å†…å®¹è¿‡æ»¤ã€AIå†…å®¹å®¡æ ¸

**æ•æ„Ÿè¯åˆ†ç±»**:
- æ”¿æ²»æ•æ„Ÿ
- è‰²æƒ…ä½ä¿—
- æš´åŠ›è¡€è…¥
- è¿æ³•çŠ¯ç½ª
- è¾±éª‚æ”»å‡»
- å¹¿å‘Šè¥é”€

**ä½¿ç”¨æ–¹æ³•**:
```javascript
const { filterRequest, auditAIResponse } = require('./middleware/contentFilter');

// è¯·æ±‚å†…å®¹è¿‡æ»¤(éä¸¥æ ¼æ¨¡å¼:è‡ªåŠ¨æ›¿æ¢æ•æ„Ÿè¯)
app.post('/api/pets/create',
  filterRequest({ fields: ['name', 'description'] }),
  handler
);

// è¯·æ±‚å†…å®¹è¿‡æ»¤(ä¸¥æ ¼æ¨¡å¼:å‘ç°æ•æ„Ÿè¯ç›´æ¥æ‹¦æˆª)
app.post('/api/chat',
  filterRequest({ fields: ['message'], strict: true }),
  handler
);

// AIå“åº”å†…å®¹å®¡æ ¸
app.post('/api/ai/generate',
  auditAIResponse(),
  handler
);
```

**æ‰‹åŠ¨æ£€æµ‹**:
```javascript
const { detectSensitiveWords, maskSensitiveWords } = require('./middleware/contentFilter');

const text = 'ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬';
const result = detectSensitiveWords(text);

if (result.hasSensitive) {
  console.log('å‘ç°æ•æ„Ÿè¯:', result.matches);
  const masked = maskSensitiveWords(text);
  console.log('æ›¿æ¢å:', masked);
}
```

---

### 5. é”™è¯¯å¤„ç† (`src/middleware/errorHandler.js`)

**åŠŸèƒ½**:ç»Ÿä¸€é”™è¯¯å“åº”ã€é”™è¯¯æ—¥å¿—ã€å…¨å±€å¼‚å¸¸æ•è·

**é¢„å®šä¹‰é”™è¯¯ç±»**:
```javascript
const {
  ValidationError,      // 400 - éªŒè¯é”™è¯¯
  AuthenticationError,  // 401 - è®¤è¯å¤±è´¥
  AuthorizationError,   // 403 - æƒé™ä¸è¶³
  NotFoundError,        // 404 - èµ„æºä¸å­˜åœ¨
  ConflictError,        // 409 - èµ„æºå†²çª
  RateLimitError,       // 429 - é™æµ
  DatabaseError,        // 500 - æ•°æ®åº“é”™è¯¯
  AIServiceError        // 503 - AIæœåŠ¡å¼‚å¸¸
} = require('./middleware/errorHandler');
```

**ä½¿ç”¨æ–¹æ³•**:
```javascript
const { catchAsync, throwError, errorHandler, notFoundHandler } = require('./middleware/errorHandler');

// åŒ…è£…å¼‚æ­¥è·¯ç”±(è‡ªåŠ¨æ•è·å¼‚å¸¸)
app.get('/api/pets/:id', catchAsync(async (req, res) => {
  const pet = await getPetById(req.params.id);

  if (!pet) {
    throw new NotFoundError('å® ç‰©');
  }

  res.json({ success: true, data: pet });
}));

// å¿«é€ŸæŠ›å‡ºé”™è¯¯
app.post('/api/example', (req, res) => {
  if (!req.body.required) {
    throwError('ç¼ºå°‘å¿…å¡«å­—æ®µ', 400, 'MISSING_FIELD');
  }
});

// åœ¨app.jsæœ€åæ·»åŠ 
app.use(notFoundHandler);  // 404å¤„ç†
app.use(errorHandler);     // ç»Ÿä¸€é”™è¯¯å¤„ç†
```

**å…¨å±€å¼‚å¸¸å¤„ç†**:
```javascript
const { setupGlobalHandlers } = require('./middleware/errorHandler');

// åœ¨app.jså¼€å¤´è°ƒç”¨
setupGlobalHandlers();
```

---

### 6. æ—¥å¿—ç³»ç»Ÿ (`src/utils/logger.js`)

**åŠŸèƒ½**:åˆ†çº§æ—¥å¿—ã€æ—¥å¿—è½®è½¬ã€ç»“æ„åŒ–æ—¥å¿—

**æ—¥å¿—çº§åˆ«**:
- `error`: é”™è¯¯æ—¥å¿—(å•ç‹¬æ–‡ä»¶)
- `warn`: è­¦å‘Šæ—¥å¿—(å•ç‹¬æ–‡ä»¶)
- `info`: ä¿¡æ¯æ—¥å¿—
- `debug`: è°ƒè¯•æ—¥å¿—

**ä½¿ç”¨æ–¹æ³•**:
```javascript
const logger = require('./utils/logger');

// åŸºç¡€æ—¥å¿—
logger.info('ç”¨æˆ·ç™»å½•', { userId: 123, ip: '127.0.0.1' });
logger.warn('APIè¯·æ±‚é¢‘ç¹', { endpoint: '/api/pets', count: 50 });
logger.error('æ•°æ®åº“è¿æ¥å¤±è´¥', { error: err.message });

// æ‰©å±•æ–¹æ³•
logger.security('ç™»å½•å¤±è´¥', { username, ip, reason });
logger.performance('APIå“åº”', 250, { endpoint: '/api/pets' });
logger.audit('åˆ é™¤å® ç‰©', userId, { petId, petName });
```

**æ—¥å¿—æ–‡ä»¶**:
- `logs/error.log` - é”™è¯¯æ—¥å¿—(ä¿ç•™7å¤©)
- `logs/warn.log` - è­¦å‘Šæ—¥å¿—(ä¿ç•™5å¤©)
- `logs/combined.log` - ç»¼åˆæ—¥å¿—(ä¿ç•™7å¤©)
- `logs/security.log` - å®‰å…¨æ—¥å¿—(ä¿ç•™30å¤©)

---

## ğŸš€ å®Œæ•´é›†æˆç¤ºä¾‹

### app.js é›†æˆ

```javascript
require('dotenv').config();
const express = require('express');
const helmet = require('helmet');
const cors = require('cors');

const logger = require('./utils/logger');
const { setupGlobalHandlers, errorHandler, notFoundHandler } = require('./middleware/errorHandler');
const { globalLimit } = require('./middleware/rateLimiter');
const { filterRequest } = require('./middleware/contentFilter');

// è®¾ç½®å…¨å±€å¼‚å¸¸å¤„ç†
setupGlobalHandlers();

const app = express();

// åŸºç¡€ä¸­é—´ä»¶
app.use(helmet());
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// å®‰å…¨ä¸­é—´ä»¶
app.use(globalLimit); // å…¨å±€é™æµ
app.use(filterRequest({ fields: ['content', 'message', 'text', 'name'] })); // å†…å®¹è¿‡æ»¤

// å¥åº·æ£€æŸ¥(ä¸é™æµ)
app.get('/health', (req, res) => {
  res.json({ status: 'ok' });
});

// ä¸šåŠ¡è·¯ç”±
app.use('/api/auth', require('./routes/authRoutes'));
app.use('/api/pets', require('./routes/petRoutes'));
app.use('/api/ai', require('./routes/aiRoutes'));

// é”™è¯¯å¤„ç†(å¿…é¡»åœ¨æœ€å)
app.use(notFoundHandler);
app.use(errorHandler);

// å¯åŠ¨æœåŠ¡å™¨
const PORT = process.env.PORT || 14000;
app.listen(PORT, () => {
  logger.info(`Server started on port ${PORT}`);
});
```

### è·¯ç”±é›†æˆç¤ºä¾‹

```javascript
// routes/petRoutes.js
const express = require('express');
const router = express.Router();

const { authenticate } = require('../middleware/auth');
const { validatePetCreate } = require('../middleware/validator');
const { petCreateLimit } = require('../middleware/rateLimiter');
const { catchAsync } = require('../middleware/errorHandler');

// åˆ›å»ºå® ç‰©(éœ€è¦è®¤è¯+éªŒè¯+é™æµ)
router.post('/create',
  authenticate(),
  validatePetCreate,
  petCreateLimit,
  catchAsync(async (req, res) => {
    const userId = req.user.userId;
    const petData = req.validated;

    const pet = await petService.create(userId, petData);

    res.json({
      success: true,
      data: pet
    });
  })
);

module.exports = router;
```

---

## âš™ï¸ ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ :

```bash
# å®‰å…¨é…ç½®
JWT_SECRET=your-super-secret-key-change-this-in-production
JWT_EXPIRES_IN=7d

# é™æµé…ç½®
RATE_LIMIT_MAX_REQUESTS=100
AI_MAX_REQUESTS_PER_HOUR=50

# å†…å®¹è¿‡æ»¤
ENABLE_CONTENT_FILTER=true

# æ—¥å¿—é…ç½®
LOG_LEVEL=info
LOG_MAX_SIZE=10485760
LOG_MAX_FILES=7
DISABLE_CONSOLE_LOG=false

# é”™è¯¯å¤„ç†
EXIT_ON_UNHANDLED_REJECTION=false
```

---

## ğŸ“Š ç›‘æ§å’Œç»Ÿè®¡

### APIé™æµç»Ÿè®¡

```javascript
const { statsHandler } = require('./middleware/rateLimiter');

app.get('/api/admin/rate-limit-stats', authenticate(), requireRole(['admin']), statsHandler);
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "clients": 125,
    "endpoints": 480,
    "memoryUsage": 45678912
  }
}
```

### å†…å®¹è¿‡æ»¤ç»Ÿè®¡

```javascript
const { filterHandlers } = require('./middleware/contentFilter');

app.get('/api/admin/filter-stats', authenticate(), requireRole(['admin']), filterHandlers.stats);
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "totalChecks": 5420,
    "blocked": 38,
    "byCategory": {
      "vulgar": 12,
      "abuse": 18,
      "spam": 8
    },
    "enabled": true
  }
}
```

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. é™æµæµ‹è¯•

```bash
# å¿«é€Ÿå‘é€100ä¸ªè¯·æ±‚æµ‹è¯•é™æµ
for i in {1..100}; do
  curl -X GET http://localhost:14000/api/test &
done
```

### 2. è¾“å…¥éªŒè¯æµ‹è¯•

```bash
# æµ‹è¯•SQLæ³¨å…¥é˜²æŠ¤
curl -X POST http://localhost:14000/api/pets/create \
  -H "Content-Type: application/json" \
  -d '{"name":"test'; DROP TABLE pets;--"}'

# åº”è¿”å›400éªŒè¯é”™è¯¯
```

### 3. XSSé˜²æŠ¤æµ‹è¯•

```bash
# æµ‹è¯•XSSé˜²æŠ¤
curl -X POST http://localhost:14000/api/pets/create \
  -H "Content-Type: application/json" \
  -d '{"name":"<script>alert(1)</script>"}'

# nameåº”è¢«æ¸…ç†æˆ–æ‹¦æˆª
```

### 4. æ•æ„Ÿè¯æµ‹è¯•

```bash
# æµ‹è¯•æ•æ„Ÿè¯è¿‡æ»¤
curl -X POST http://localhost:14000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"message":"è¿™æ˜¯æ•æ„Ÿè¯æµ‹è¯•"}'

# æ•æ„Ÿè¯åº”è¢«æ›¿æ¢ä¸º***
```

---

## âš ï¸ å®‰å…¨æœ€ä½³å®è·µ

### 1. å¯†é’¥ç®¡ç†
- âœ… ä½¿ç”¨å¼ºJWTå¯†é’¥(è‡³å°‘32å­—ç¬¦éšæœºå­—ç¬¦ä¸²)
- âœ… å®šæœŸè½®æ¢å¯†é’¥
- âŒ ç»ä¸å°†å¯†é’¥æäº¤åˆ°Git

### 2. HTTPS
- âœ… ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨HTTPS
- âœ… ä½¿ç”¨HSTS(HTTP Strict Transport Security)
- âœ… é…ç½®SSLè¯ä¹¦

### 3. æ•°æ®åº“å®‰å…¨
- âœ… ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢(å·²ç”±ORM/æ•°æ®åº“å±‚å¤„ç†)
- âœ… æœ€å°æƒé™åŸåˆ™
- âœ… å®šæœŸå¤‡ä»½

### 4. APIå®‰å…¨
- âœ… æ‰€æœ‰æ•æ„Ÿæ“ä½œéœ€è¦è®¤è¯
- âœ… é‡è¦æ“ä½œéœ€è¦äºŒæ¬¡ç¡®è®¤
- âœ… è®°å½•å®¡è®¡æ—¥å¿—

### 5. ä¾èµ–å®‰å…¨
```bash
# å®šæœŸæ£€æŸ¥ä¾èµ–æ¼æ´
npm audit

# è‡ªåŠ¨ä¿®å¤
npm audit fix
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Supabaseè¿ç§»æŒ‡å—](./Supabaseè¿ç§»æŒ‡å—.md)
- [APIæ–‡æ¡£](../README.md)
- [éƒ¨ç½²æŒ‡å—](./éƒ¨ç½²æŒ‡å—.md)

---

## ğŸ†˜ æ•…éšœæ’é™¤

### é™æµè¯¯æ‹¦æˆª
**é—®é¢˜**: æ­£å¸¸ç”¨æˆ·è¢«é™æµ
**è§£å†³**: è°ƒæ•´ `.env` ä¸­çš„é™æµé…ç½®,å¢åŠ  `RATE_LIMIT_MAX_REQUESTS`

### Tokenè¿‡æœŸå¤„ç†
**é—®é¢˜**: ç”¨æˆ·é¢‘ç¹éœ€è¦é‡æ–°ç™»å½•
**è§£å†³**:
1. å®ç°Tokenåˆ·æ–°é€»è¾‘
2. å®¢æˆ·ç«¯æ£€æµ‹401é”™è¯¯è‡ªåŠ¨åˆ·æ–°Token

### æ—¥å¿—æ–‡ä»¶è¿‡å¤§
**é—®é¢˜**: æ—¥å¿—æ–‡ä»¶å ç”¨å¤§é‡ç£ç›˜ç©ºé—´
**è§£å†³**:
1. è°ƒæ•´ `LOG_MAX_SIZE` å’Œ `LOG_MAX_FILES`
2. è®¾ç½®å®šæ—¶ä»»åŠ¡æ¸…ç†æ—§æ—¥å¿—

---

**å®‰å…¨æ€§åŠ å›ºå®Œæˆ! ğŸ”**

æ‰€æœ‰ä¸­é—´ä»¶å·²å°±ç»ª,å»ºè®®åœ¨å¼€å‘å®Œæˆåè¿›è¡Œå®Œæ•´çš„å®‰å…¨æµ‹è¯•å’Œæ¸—é€æµ‹è¯•ã€‚
