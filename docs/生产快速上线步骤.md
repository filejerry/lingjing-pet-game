生产快速上线步骤（Ubuntu + Docker + Nginx + HTTPS）

前提：你已准备好一个域名，以及一台 Ubuntu 20.04/22.04 的云服务器（公网访问）

一、服务器初始化
1) 登录服务器，切到 root 或使用 sudo
2) 上传项目或在服务器拉取仓库
3) 执行初始化脚本：
   sudo bash deploy/setup-server.sh your-domain.com
   - 安装 Docker/Compose、Nginx、Certbot（可选）
   - 创建应用目录 /opt/spirit-pet（可按需调整）

二、环境变量与编排
1) 在项目根目录复制并修改 .env（参考 .env.example.production）：
   - PORT=14000
   - NODE_ENV=production
   - ALLOWED_ORIGINS=https://your-frontend.com（如前后端同域可省略）
   - 数据库：DATABASE_URL=postgres://user:pass@host:5432/dbname（生产推荐外部托管DB）
2) 检查 docker-compose.yml（默认将 14000 映射到宿主机）
   - volumes 已映射：./data、./logs、./public
   - healthcheck 测试 /health

三、启动服务
1) 在项目根目录执行：
   docker compose up -d
2) 检查容器状态：
   docker compose ps
3) 验证后端：
   curl http://YOUR_SERVER_IP:14000/health
   curl http://YOUR_SERVER_IP:14000/api/info

四、配置 Nginx 域名与 HTTPS
1) 编辑 deploy/nginx.site.conf，将 your-domain.com 替换为你的域名
   - 默认将 80 转发到后端（也可改为强制跳转至 HTTPS）
2) 链接并重载：
   sudo cp deploy/nginx.site.conf /etc/nginx/sites-available/spirit-pet.conf
   sudo ln -sf /etc/nginx/sites-available/spirit-pet.conf /etc/nginx/sites-enabled/spirit-pet.conf
   sudo nginx -t && sudo systemctl reload nginx
3) 申请证书（推荐）：
   sudo certbot --nginx -d your-domain.com -d www.your-domain.com
4) 验证：
   https://your-domain.com/health
   https://your-domain.com/api/info

五、前端策略
- 若前后端同域：前端使用相对路径 fetch('/api/...') 即可
- 若分域：设置 ALLOWED_ORIGINS，并在前端配置后端 API 基地址

六、常用运维命令
- 查看日志：docker compose logs -f app
- 重启应用：docker compose restart app
- 更新镜像：docker compose pull && docker compose up -d
- 数据目录：项目根目录的 data/ 与 logs/（映射到容器）

七、注意事项
- 生产尽量使用托管数据库（Supabase/Neon/PlanetScale/RDS）
- 收紧 CORS 与 CSP（减少 'unsafe-inline'）
- HTTPS 强制：可将 80 的 server 块改为跳转到 443
- 监控与备份：定期备份 data/ 与 logs/；添加 /health 到云监控

八、可选：CI/CD（GitHub Actions）
- 已提供 .github/workflows/docker-deploy.yml
- 在仓库 Secrets 中配置：
  - REGISTRY/TOKEN（用于登录镜像仓库）
  - DATABASE_URL、ALLOWED_ORIGINS、NODE_ENV 等
- 工作流执行后，可在服务器用 Watchtower 或 SSH 自动拉取并重启容器