# 开发进度交底（迭代02）

时间：2025-09-29
目标：以大模型API驱动“剧情推动”和“养成进化”两大核心模块；前端演出稳固为纯文字对话流；世界观持续扩展。

## 已完成（相对迭代01的新增）
- setStoryMeta → 自动联动氛围与新闻播报：任何场景标识设置后，背景条纹与底部播报同步更新。
- 开场氛围与播报：startAdventure / triggerDaily / triggerBattle 在开头切换 setSceneVisuals 并推送播报。
- 演出自动滚动：showStoryLinesWithClasses 每段插入后自动滚动到底部。
- 互动选项收拢：右上角面板折叠后点击展开；中心保持纯文字演出。

## 正在推进
1) 剧情推动（StoryEngine 前后端接口）
- 前端：统一调用 /api/story/next；失败回退本地模板。
- 后端：输出 { text, deltas, meta }；分 daily/special/side/battle 类型；统一错误码与降级。
- 模型接入：提示词模板拆分为 场景/互动/续写 三段；provider 支持 vim（即梦4.0）。

2) 养成进化（EvolutionSystem + ThreeLayerEngine）
- L1 记录：pet_behaviors/battle_records/adventure_events（时间衰减）
- L2 倾向：攻/防/治愈/元素/神性/堕落 等 10 类，概率与冲突解决
- L3 决策：合法性校验→结果固化（稀有度/属性边界/词条更新）
- 接口：/api/progress/apply 返回 { eligible, candidates[], text }；/api/story-agent/preview 返回文字演出片段

## 待办清单（近期）
- 前端：meta.scene → setSceneVisuals 映射完善；自动滚动增强，支持长段落分页；新闻播报推送关键事件（进化/胜负/稀有升级）。
- 后端：/api/media/pet-image 增加 provider=vim 和 prompt 字段；文本优先，图片按需。
- 世界观：区域/族群/事件/角色模板落地到 docs/世界观蓝图.md；提示词模板细化到 docs/提示词模板.md。

## 测试清单
- 冒险/日常/对决三入口：氛围切换、文字演出滚动、播报同步。
- 进化候选与决策：候选出现→选择→文字演出→数值更新。
- 降级策略：接口不可用时，落到本地模板且有清晰提示。

## 风险与缓解
- 模型不稳定：分段提示词+固定算法兜底；失败自动降级文本模板。
- 世界观一致性：模板与术语词典统一；设立“世界观审校”角色把关。