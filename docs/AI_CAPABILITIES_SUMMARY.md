# AI接入能力梳理总结

## 概述

本文档总结了《灵境斗宠录》项目中完整的AI接入能力，明确区分了文字模型、图像模型和多模态应用的使用场景。

## AI模型分类与职责

### 🔤 文字模型 - Kimi (kimi-k2-250905)

**API配置:**
- **API Key**: `2ffe7955-a0a1-4238-93cd-d354c2c6d7ec`
- **端点**: `https://ark.cn-beijing.volces.com/api/v3/chat/completions`
- **模型**: `kimi-k2-250905`

**核心职责:**
1. **宠物人格档案生成** - 六维人格框架构建
2. **对话系统** - 宠物与玩家的智能对话
3. **故事生成** - 冒险、进化、相遇等情节创作
4. **数值计算** - 属性变化、战斗结果等逻辑处理
5. **行为分析** - 基于互动历史的性格演化

### 🎨 图像模型 - 即梦4.0 (doubao-seedream-4-0-250828)

**API配置:**
- **API Key**: `1973ac03-1d99-42c1-ba94-7cec42b465a5`
- **端点**: `https://ark.cn-beijing.volces.com/api/v3/images/generations`
- **模型**: `doubao-seedream-4-0-250828`

**专用场景:**
1. **宠物外形生成** - 仅用于美术资源创作
2. **进化形象展示** - 宠物进化后的视觉呈现
3. **抽卡变体生成** - 多样化的外观选择
4. **特殊形态渲染** - 神话觉醒等特殊状态

**重要限制:**
- ❌ 不用于逻辑处理
- ❌ 不用于文字生成
- ✅ 仅用于视觉美术资源

### 🔄 多模态协作策略

**协作原则:**
1. **文字优先** - 所有逻辑、对话、计算使用Kimi
2. **图像辅助** - 仅在视觉需求时使用即梦4.0
3. **成本控制** - 图像生成设置使用限制
4. **用户体验** - 平衡功能丰富度与响应速度

## 核心系统架构

### 1. 人格档案系统 (PetPersonaSystem.js)

**六维人格框架:**
```
宠物核心标识 → 行为特征 → 关系动力
     ↓           ↓         ↓
背景脉络 → 灵性空间 → 使用指南
```

**核心功能:**
- 基于互动历史生成个性化人格档案
- 动态更新宠物性格特征
- 提供个性化互动建议

### 2. 图像进化系统 (ImageEvolutionSystem.js)

**核心特性:**
- **幼年期保护**: 5级以下显示黑暗效果
- **进化触发**: 达到条件后生成形象
- **抽卡机制**: 付费重新生成变体
- **免费额度**: 80次免费更换机会

### 3. 数据库集成 (EnhancedDatabase.js)

**新增表结构:**
- `pet_personas` - 人格档案存储
- `pet_image_regenerations` - 图像重新生成记录
- `pet_images` - 图像资源管理

## API接口体系

### 人格系统接口
```
POST /api/pet-persona/generate          # 生成人格档案
GET  /api/pet-persona/:petId           # 获取人格档案
PUT  /api/pet-persona/:petId           # 更新人格档案
```

### 图像系统接口
```
POST /api/pet-persona/evolution-image   # 生成进化图像
POST /api/pet-persona/card-draw        # 抽卡重新生成
GET  /api/pet-persona/regeneration-stats/:petId # 获取统计
```

### 原有AI接口
```
POST /api/pet-images/generate          # 单张图像生成
POST /api/pet-images/batch-generate    # 批量图像生成
POST /api/pet-images/evolution-comparison # 进化对比图像
```

## 使用限制与成本控制

### 免费用户限制
- ✅ 每个宠物80次免费图像重新生成
- ✅ 无限制的文字交互和人格更新
- ❌ 超出免费额度后需付费

### 付费机制
- 💰 付费抽卡: 10积分/次
- 💰 批量生成: 支持多变体选择
- 💰 VIP用户: 更高免费额度

### 技术优化
- 🚀 缓存机制减少重复调用
- 🚀 批处理优化大量请求
- 🚀 错误重试与降级处理

## 环境配置

### 必需环境变量
```bash
# 文字模型
ARK_API_KEY="2ffe7955-a0a1-4238-93cd-d354c2c6d7ec"
KIMI_MODEL="kimi-k2-250905"

# 图像模型
SEEDREAM_API_KEY="1973ac03-1d99-42c1-ba94-7cec42b465a5"
SEEDREAM_MODEL="doubao-seedream-4-0-250828"

# 功能开关
PERSONA_SYSTEM_ENABLED=true
IMAGE_GENERATION_ENABLED=true
IMAGE_CARD_DRAW_ENABLED=true
```

## 集成测试清单

### ✅ 已完成
- [x] 人格系统核心逻辑
- [x] 图像生成API集成
- [x] 数据库结构扩展
- [x] 路由系统集成
- [x] 环境配置模板

### 🔄 待测试
- [ ] 人格生成完整流程
- [ ] 图像生成与缓存
- [ ] 幼年期限制逻辑
- [ ] 抽卡付费机制
- [ ] 性能与成本监控

### 🚀 未来扩展
- [ ] 个性化推荐系统
- [ ] 宠物社交功能
- [ ] 多模态深度交互
- [ ] 高级分析与预测

## 使用指南

### 开发者快速开始
1. 复制 `.env.example` 到 `.env`
2. 配置API密钥
3. 启动服务: `npm start`
4. 测试接口: `POST /api/pet-persona/generate`

### 功能测试流程
1. **创建宠物** → 调用宠物创建API
2. **生成人格** → 调用人格生成API
3. **等级提升** → 宠物达到5级以上
4. **生成图像** → 调用进化图像API
5. **抽卡变体** → 调用抽卡重新生成API

## 监控与维护

### 关键指标
- 📊 API调用成功率
- 📊 图像生成耗时
- 📊 用户满意度
- 📊 成本控制效果

### 日常维护
- 🔧 定期清理缓存
- 🔧 监控API配额使用
- 🔧 备份人格档案数据
- 🔧 优化提示词模板

---

**总结**: 通过明确的模型分工、完善的系统架构和严格的成本控制，实现了高效、可扩展的AI集成方案。文字模型负责智能逻辑，图像模型专注视觉呈现，两者协作提供完整的宠物养成体验。

*文档版本: v1.0*  
*最后更新: 2025/9/30*