# å…¨æ ˆéƒ¨ç½²æŒ‡å— - çµå¢ƒæ–—å® å½• V3.0

å®Œæ•´çš„å…¨æ ˆåº”ç”¨éƒ¨ç½²æ•™ç¨‹,åŒ…å«å‰ç«¯ã€åç«¯ã€MCPæœåŠ¡å™¨å’ŒWebSocketã€‚

---

## ğŸ“‹ æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·æµè§ˆå™¨                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Vue3å‰ç«¯ (localhost:5173)               â”‚
â”‚  - Composition API                                  â”‚
â”‚  - PiniaçŠ¶æ€ç®¡ç†                                     â”‚
â”‚  - TailwindCSS                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                              â”‚
            â”‚ HTTP API                     â”‚ WebSocket
            â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸»åº”ç”¨æœåŠ¡å™¨         â”‚    â”‚   WebSocketæœåŠ¡          â”‚
â”‚  (localhost:3000)    â”‚    â”‚   (Socket.IO)            â”‚
â”‚  - REST API          â”‚    â”‚   - å®æ—¶å¯¹æˆ˜              â”‚
â”‚  - é™æ€æ–‡ä»¶æœåŠ¡       â”‚    â”‚   - åŒ¹é…ç³»ç»Ÿ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ HTTP
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MCPæœåŠ¡å™¨ (localhost:3001)              â”‚
â”‚  - AIå‰§æƒ…ç”Ÿæˆ                                        â”‚
â”‚  - è¿›åŒ–è·¯å¾„è®¡ç®—                                      â”‚
â”‚  - å›¾ç‰‡ç”Ÿæˆ                                          â”‚
â”‚  - è¡Œä¸ºåˆ†æ                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ HTTP
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¤–éƒ¨AIæœåŠ¡                               â”‚
â”‚  - å³æ¢¦4.0 / DALL-E / Stable Diffusion              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ å¿«é€Ÿéƒ¨ç½² (å¼€å‘ç¯å¢ƒ)

### å‰ç½®è¦æ±‚

- Node.js >= 18.0.0
- pnpm >= 8.0.0 (æˆ–npm)
- Git

### ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
# 1. å…‹éš†é¡¹ç›®
cd I:\chognwu

# 2. å®‰è£…æ‰€æœ‰ä¾èµ–
pnpm install                  # ä¸»åº”ç”¨
cd client && pnpm install && cd ..          # Vue3å‰ç«¯
cd server/mcp && npm install && cd ../..    # MCPæœåŠ¡å™¨

# 3. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
cp client/.env.development client/.env.local
cp server/mcp/.env.example server/mcp/.env

# 4. ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡
npm run dev:all
```

è¿™ä¸ªå‘½ä»¤ä¼šå¹¶è¡Œå¯åŠ¨:
- ä¸»åº”ç”¨ (http://localhost:3000)
- MCPæœåŠ¡å™¨ (http://localhost:3001)
- Vue3å‰ç«¯ (http://localhost:5173)

### åˆ†æ­¥å¯åŠ¨

#### 1. å¯åŠ¨ä¸»åº”ç”¨ (åç«¯API + WebSocket)

```bash
cd I:\chognwu
npm install
npm run dev
```

è®¿é—®: http://localhost:3000

#### 2. å¯åŠ¨MCPæœåŠ¡å™¨

```bash
cd I:\chognwu\server\mcp
npm install
npm run dev
```

è®¿é—®: http://localhost:3001/health

#### 3. å¯åŠ¨Vue3å‰ç«¯

```bash
cd I:\chognwu\client
pnpm install
pnpm dev
```

è®¿é—®: http://localhost:5173

---

## ğŸ”§ ç¯å¢ƒå˜é‡é…ç½®

### ä¸»åº”ç”¨ (.env)

```env
# æœåŠ¡å™¨é…ç½®
PORT=3000
NODE_ENV=development

# å®¢æˆ·ç«¯URL
CLIENT_URL=http://localhost:5173

# MCPæœåŠ¡å™¨
MCP_PORT=3001

# æ•°æ®åº“
DATABASE_URL=./data/game.db

# JWT
JWT_SECRET=your-secret-key-here

# æ—¥å¿—
LOG_LEVEL=info
```

### MCPæœåŠ¡å™¨ (server/mcp/.env)

```env
# MCPæœåŠ¡å™¨ç«¯å£
MCP_PORT=3001

# AIæœåŠ¡é…ç½®
AI_API_URL=http://localhost:8000/v1/chat/completions
AI_API_KEY=your_ai_api_key

# å³æ¢¦4.0
VIM_API_URL=https://api.vim.com/v1
VIM_API_KEY=your_vim_key

# OpenAI (å¯é€‰)
OPENAI_API_KEY=sk-...

# Stable Diffusion (å¯é€‰)
SD_API_URL=http://localhost:7860
```

### Vue3å‰ç«¯ (client/.env.local)

```env
VITE_API_BASE_URL=http://localhost:3000/api
VITE_MCP_SERVER_URL=http://localhost:3001/mcp
VITE_WS_URL=ws://localhost:3000
```

---

## ğŸ“¡ APIç«¯ç‚¹æµ‹è¯•

### ä¸»åº”ç”¨API

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3000/health

# è·å–å® ç‰©åˆ—è¡¨
curl http://localhost:3000/api/pets

# è·å–å® ç‰©è¯¦æƒ…
curl http://localhost:3000/api/pets/pet_1

# å¼€å§‹å†’é™©
curl -X POST http://localhost:3000/api/adventure/start \
  -H "Content-Type: application/json" \
  -d '{"petId":"pet_1","location":"forest"}'
```

### MCPæœåŠ¡å™¨API

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3001/health

# åˆ—å‡ºæ‰€æœ‰å·¥å…·
curl http://localhost:3001/mcp/tools

# ç”Ÿæˆå‰§æƒ…
curl -X POST http://localhost:3001/mcp/tools/generate_story \
  -H "Content-Type: application/json" \
  -d '{
    "arguments": {
      "type": "adventure",
      "context": {"scene": "forest"}
    }
  }'

# è®¡ç®—è¿›åŒ–
curl -X POST http://localhost:3001/mcp/tools/calculate_evolution \
  -H "Content-Type: application/json" \
  -d '{
    "arguments": {
      "petId": "pet_1",
      "behaviors": []
    }
  }'
```

### WebSocketæµ‹è¯•

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æµ‹è¯•
import io from 'socket.io-client'

const socket = io('http://localhost:3000')

socket.on('connect', () => {
  console.log('âœ… WebSocketå·²è¿æ¥')

  // åŠ å…¥åŒ¹é…é˜Ÿåˆ—
  socket.emit('battle:join_queue', {
    userId: 'user_1',
    petId: 'pet_1'
  })
})

socket.on('battle:queue_joined', (data) => {
  console.log('å·²åŠ å…¥åŒ¹é…é˜Ÿåˆ—:', data)
})

socket.on('battle:match_found', (data) => {
  console.log('åŒ¹é…æˆåŠŸ:', data)
})
```

---

## ğŸ¯ å®Œæ•´å·¥ä½œæµæµ‹è¯•

### 1. æ‰“å¼€Vue3å‰ç«¯

è®¿é—® http://localhost:5173

åº”è¯¥çœ‹åˆ°:
- ğŸ¾ çµå¢ƒæ–—å® å½• ä¸»ç•Œé¢
- å››ä¸ªåŠŸèƒ½å…¥å£
- MCPè¿æ¥çŠ¶æ€ (ç»¿è‰²è¡¨ç¤ºå·²è¿æ¥)

### 2. åˆ›å»º/é€‰æ‹©å® ç‰©

ç‚¹å‡»"æˆ‘çš„å® ç‰©" â†’ "åˆ›å»ºç¬¬ä¸€åªå® ç‰©"

### 3. å¼€å§‹å†’é™©

ç‚¹å‡»"å¼€å§‹å†’é™©" â†’ "å¼€å§‹æ–°å†’é™©"

- å‰ç«¯è°ƒç”¨ `/api/adventure/start`
- ä¸»åº”ç”¨è¿”å›å‰§æƒ…æ–‡æœ¬
- å¯é€‰: è°ƒç”¨MCPç”ŸæˆAIå‰§æƒ…

### 4. è¿›åŒ–å® ç‰©

ç‚¹å‡»"è¿›åŒ–ç³»ç»Ÿ" â†’ "åˆ†æè¿›åŒ–è·¯å¾„"

- å‰ç«¯è°ƒç”¨ `/api/pets/:id/evolution-candidates`
- ä¸»åº”ç”¨è°ƒç”¨MCPè®¡ç®—è¿›åŒ–å€¾å‘
- è¿”å›è¿›åŒ–å€™é€‰åˆ—è¡¨

### 5. å¤šäººå¯¹æˆ˜

ç‚¹å‡»"å¯¹æˆ˜ç³»ç»Ÿ" â†’ "åŠ å…¥åŒ¹é…"

- å‰ç«¯é€šè¿‡WebSocketè¿æ¥
- å‘é€ `battle:join_queue` äº‹ä»¶
- ç­‰å¾…åŒ¹é…
- è¿›å…¥å®æ—¶å¯¹æˆ˜

---

## ğŸ“¦ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### 1. æ„å»ºå‰ç«¯

```bash
cd client
pnpm build
```

äº§ç‰©è¾“å‡ºåˆ° `public/v3/`

### 2. å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨

```bash
# ä¸»åº”ç”¨
NODE_ENV=production npm start

# MCPæœåŠ¡å™¨
cd server/mcp
NODE_ENV=production npm start
```

### 3. ä½¿ç”¨PM2ç®¡ç†è¿›ç¨‹

```bash
# å®‰è£…PM2
npm install -g pm2

# å¯åŠ¨ä¸»åº”ç”¨
pm2 start src/app-v3.js --name "spirit-pet-app"

# å¯åŠ¨MCPæœåŠ¡å™¨
pm2 start server/mcp/server.js --name "mcp-server"

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs

# å¼€æœºè‡ªå¯
pm2 startup
pm2 save
```

### 4. Nginxåå‘ä»£ç†

```nginx
server {
    listen 80;
    server_name yourdomain.com;

    # Vue3å‰ç«¯
    location / {
        root /path/to/public/v3;
        try_files $uri $uri/ /index.html;
    }

    # APIä»£ç†
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # WebSocketä»£ç†
    location /socket.io {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # MCPä»£ç†
    location /mcp {
        proxy_pass http://localhost:3001;
    }
}
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### å‰ç«¯æ— æ³•è¿æ¥åç«¯

**ç—‡çŠ¶**: MCPçŠ¶æ€æ˜¾ç¤º"æœªè¿æ¥"

**è§£å†³**:
1. æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨: `curl http://localhost:3000/health`
2. æ£€æŸ¥MCPæœåŠ¡å™¨: `curl http://localhost:3001/health`
3. æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯
4. æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®

### WebSocketè¿æ¥å¤±è´¥

**ç—‡çŠ¶**: å¯¹æˆ˜åŒ¹é…æ— å“åº”

**è§£å†³**:
1. ç¡®è®¤Socket.IOå·²å¯åŠ¨
2. æ£€æŸ¥CORSé…ç½®
3. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
4. æµ‹è¯•è¿æ¥: `wscat -c ws://localhost:3000/socket.io`

### MCPå·¥å…·è°ƒç”¨å¤±è´¥

**ç—‡çŠ¶**: AIå‰§æƒ…ç”Ÿæˆè¿”å›é™çº§æ¨¡æ¿

**è§£å†³**:
1. æ£€æŸ¥MCPæœåŠ¡å™¨æ—¥å¿—
2. éªŒè¯AI APIå¯†é’¥é…ç½®
3. æµ‹è¯•ç½‘ç»œè¿æ¥
4. æŸ¥çœ‹é™çº§æ—¥å¿—

### ç«¯å£å†²çª

**ç—‡çŠ¶**: å¯åŠ¨å¤±è´¥ "EADDRINUSE"

**è§£å†³**:
```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
netstat -ano | findstr :3000

# ç»“æŸè¿›ç¨‹
taskkill /PID <è¿›ç¨‹ID> /F

# æˆ–ä¿®æ”¹ç«¯å£
# .env ä¸­ä¿®æ”¹ PORT=3001
```

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—ä½ç½®

- ä¸»åº”ç”¨: `logs/app-combined.log`, `logs/app-error.log`
- MCPæœåŠ¡å™¨: `logs/mcp-combined.log`, `logs/mcp-error.log`

### å®æ—¶æ—¥å¿—æŸ¥çœ‹

```bash
# ä¸»åº”ç”¨æ—¥å¿—
tail -f logs/app-combined.log

# MCPæœåŠ¡å™¨æ—¥å¿—
tail -f server/mcp/logs/mcp-combined.log

# PM2æ—¥å¿—
pm2 logs spirit-pet-app
```

### æ€§èƒ½ç›‘æ§

```bash
# ä½¿ç”¨PM2ç›‘æ§
pm2 monit

# æˆ–ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·
# - New Relic
# - Datadog
# - Sentry (é”™è¯¯è¿½è¸ª)
```

---

## ğŸ”’ å®‰å…¨æ£€æŸ¥æ¸…å•

- [ ] ç¯å¢ƒå˜é‡ä¸æäº¤åˆ°Git
- [ ] APIå¯†é’¥å¦¥å–„ä¿ç®¡
- [ ] æ•°æ®åº“å¤‡ä»½å®šæœŸæ‰§è¡Œ
- [ ] CORSé…ç½®é™åˆ¶æ¥æº
- [ ] Helmetå®‰å…¨å¤´å·²å¯ç”¨
- [ ] è¾“å…¥éªŒè¯å’Œè¿‡æ»¤
- [ ] é™æµé˜²æ­¢æ»¥ç”¨
- [ ] HTTPSè¯ä¹¦é…ç½® (ç”Ÿäº§)

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Vue3å‰ç«¯æ¶æ„](./è¿­ä»£03-å‰ç«¯ç°ä»£åŒ–æ¶æ„æ–¹æ¡ˆ.md)
- [MCPæœåŠ¡å™¨æ–‡æ¡£](../server/mcp/README.md)
- [APIæ¥å£æ–‡æ¡£](./APIæ¥å£æ–‡æ¡£.md)
- [WebSocketåè®®](./WebSocketåè®®.md)

---

**éƒ¨ç½²å®Œæˆ!** ğŸ‰

è®¿é—® http://localhost:5173 å¼€å§‹æ¸¸æˆ!
