<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¾ çµå¢ƒæ–—å® å½• - å•æœºæ¼”ç¤ºç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* åœºæ™¯æ°›å›´å±‚ */
        .scene-aura {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.6;
            pointer-events: none;
            z-index: 0;
            background: repeating-linear-gradient(
                -45deg,
                rgba(60, 200, 120, 0.10),
                rgba(60, 200, 120, 0.10) 20px,
                rgba(40, 120, 80, 0.12) 20px,
                rgba(40, 120, 80, 0.12) 40px
            );
            transition: all 1s ease;
        }

        .container {
            position: relative;
            z-index: 10;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* æ ‡é¢˜ */
        .title {
            text-align: center;
            margin: 40px 0;
            animation: fadeIn 1s ease;
        }

        .title h1 {
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #ffffff, #888888);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .title p {
            font-size: 1.2rem;
            color: #888;
        }

        /* å¡ç‰‡ */
        .card {
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid #444;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: #ffffff;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
        }

        .card h2 {
            font-size: 1.8rem;
            margin-bottom: 16px;
            border-bottom: 2px solid #444;
            padding-bottom: 12px;
        }

        /* æŒ‰é’® */
        .btn {
            display: inline-block;
            padding: 12px 24px;
            margin: 8px;
            background: #ffffff;
            color: #000000;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #e0e0e0;
            transform: scale(1.05);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: #333;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #444;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* å® ç‰©ä¿¡æ¯ */
        .pet-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 16px 0;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .stat-bar {
            width: 100%;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 4px;
        }

        .stat-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.5s ease;
        }

        /* å‰§æƒ…æ˜¾ç¤º */
        .story-display {
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            padding: 16px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            margin: 16px 0;
        }

        .story-line {
            margin: 12px 0;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid #4CAF50;
            border-radius: 4px;
            animation: slideUp 0.3s ease;
        }

        .story-line.choice {
            border-left-color: #FFD700;
            font-weight: bold;
        }

        /* é€‰æ‹©æŒ‰é’® */
        .choices {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
        }

        .choice-btn {
            padding: 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #666;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .choice-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #fff;
            transform: translateX(4px);
        }

        /* ç¨€æœ‰åº¦é¢œè‰² */
        .rarity-N { color: #9CA3AF; }
        .rarity-R { color: #3B82F6; }
        .rarity-SR { color: #8B5CF6; }
        .rarity-SSR { color: #EF4444; }
        .rarity-SSS {
            background: linear-gradient(90deg, #FF0080, #FF8C00, #FFD700, #00FF00, #00CED1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* åŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        /* æ ‡ç­¾ */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: bold;
            margin: 0 4px;
        }

        /* ç½‘æ ¼å¸ƒå±€ */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* çŠ¶æ€æ  */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.95);
            padding: 12px;
            text-align: center;
            border-top: 1px solid #444;
            font-size: 0.9rem;
            color: #888;
            z-index: 100;
        }

        .version {
            color: #666;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <!-- åœºæ™¯æ°›å›´å±‚ -->
    <div class="scene-aura" id="sceneAura"></div>

    <div class="container">
        <!-- æ ‡é¢˜ -->
        <div class="title">
            <h1>ğŸ¾ çµå¢ƒæ–—å® å½•</h1>
            <p>AIé©±åŠ¨çš„æ–‡å­—å® ç‰©å…»æˆæ¸¸æˆ - å•æœºæ¼”ç¤ºç‰ˆ</p>
        </div>

        <!-- å½“å‰å® ç‰©ä¿¡æ¯ -->
        <div class="card" id="petCard">
            <h2>æˆ‘çš„å® ç‰©</h2>
            <div id="petInfo">
                <p style="text-align: center; color: #666;">è¯·å…ˆåˆ›å»ºä¸€åªå® ç‰©</p>
            </div>
            <div style="margin-top: 16px;">
                <button class="btn" onclick="createPet()">åˆ›å»ºå® ç‰©</button>
                <button class="btn btn-secondary" onclick="showPetList()">å® ç‰©å›¾é‰´</button>
            </div>
        </div>

        <!-- å†’é™©ç³»ç»Ÿ -->
        <div class="card">
            <h2>âš”ï¸ å†’é™©æ¢ç´¢</h2>
            <div class="story-display" id="storyDisplay">
                <div class="story-line">
                    æ¬¢è¿æ¥åˆ°çµå¢ƒå¤§é™†!è¿™é‡Œæ˜¯ç”±ä¸–ç•Œæ ‘ç§å­è¡ç”Ÿçš„ç¥ç§˜ä¸–ç•Œ...
                </div>
                <div class="story-line">
                    åœ¨è¿™ç‰‡åœŸåœ°ä¸Š,æ –æ¯ç€å„ç±»å±±æµ·ç»ç¥å…½å’Œçµå® ã€‚ä½œä¸ºçµå¸ˆ,ä½ å°†ä¸å®ƒä»¬å»ºç«‹å¥‘çº¦,å…±åŒå†’é™©ã€‚
                </div>
            </div>
            <div id="choicesContainer"></div>
            <div style="margin-top: 16px;">
                <button class="btn" onclick="startAdventure()" id="adventureBtn">å¼€å§‹å†’é™©</button>
                <button class="btn btn-secondary" onclick="clearStory()">æ¸…ç©ºå‰§æƒ…</button>
            </div>
        </div>

        <!-- è¿›åŒ–ç³»ç»Ÿ -->
        <div class="card">
            <h2>âœ¨ è¿›åŒ–ç³»ç»Ÿ</h2>
            <div id="evolutionInfo">
                <p style="color: #666;">å® ç‰©è¾¾åˆ°ç­‰çº§10ä¸”ç»éªŒâ‰¥100æ—¶å¯è¿›åŒ–</p>
            </div>
            <div id="evolutionCandidates" style="margin-top: 16px;"></div>
            <button class="btn" onclick="checkEvolution()" id="evolutionBtn">æŸ¥çœ‹è¿›åŒ–è·¯å¾„</button>
        </div>

        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            <span id="statusText">å•æœºç‰ˆ - æ— éœ€è”ç½‘ - æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨</span>
            <span class="version" style="margin-left: 20px;">v3.0.0 Standalone</span>
        </div>
    </div>

    <script>
        // ==================== æ•°æ®æ¨¡å‹ ====================

        let currentPet = null;
        let storyLines = [];
        let gameState = {
            behaviors: [],
            scene: 'forest'
        };

        // ä»localStorageåŠ è½½æ•°æ®
        function loadGame() {
            const saved = localStorage.getItem('spirit_pet_game');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    currentPet = data.pet;
                    gameState = data.state || gameState;
                    if (currentPet) {
                        displayPet();
                    }
                } catch (e) {
                    console.error('åŠ è½½å¤±è´¥:', e);
                }
            }
        }

        // ä¿å­˜æ¸¸æˆ
        function saveGame() {
            const data = {
                pet: currentPet,
                state: gameState
            };
            localStorage.setItem('spirit_pet_game', JSON.stringify(data));
        }

        // ==================== å® ç‰©ç³»ç»Ÿ ====================

        const petTemplates = [
            {
                name: 'æ—¶çµ',
                species: 'æ¢¦å¢ƒå®ˆæŠ¤è€…',
                rarity: 'SR',
                description: 'æ –æ¯äºæ¢¦å¢ƒè¾¹ç•Œçš„ç¥ç§˜ç”Ÿçµ,èƒ½å¤Ÿæ„ŸçŸ¥æ—¶é—´çš„æµåŠ¨',
                baseStats: { hp: 850, attack: 120, defense: 90, speed: 105, magic: 140 }
            },
            {
                name: 'èµ¤ç„°å…½',
                species: 'ç«ç„°ç¥å…½',
                rarity: 'SSR',
                description: 'ä¼ è¯´ä¸­çš„ç«ç„°ç²¾çµ,æŒæ§ç†Šç†Šçƒˆç«',
                baseStats: { hp: 900, attack: 180, defense: 80, speed: 120, magic: 130 }
            },
            {
                name: 'é’æœ¨çµ',
                species: 'æ£®æ—å®ˆæŠ¤',
                rarity: 'R',
                description: 'æ£®æ—çš„å®ˆæŠ¤è€…,ä¸è‡ªç„¶å’Œè°å…±ç”Ÿ',
                baseStats: { hp: 750, attack: 100, defense: 110, speed: 90, magic: 120 }
            }
        ];

        function createPet() {
            const template = petTemplates[Math.floor(Math.random() * petTemplates.length)];

            currentPet = {
                id: 'pet_' + Date.now(),
                name: template.name,
                species: template.species,
                rarity: template.rarity,
                level: 1,
                exp: 0,
                bond: 0,
                stats: { ...template.baseStats },
                description: template.description,
                createdAt: new Date().toISOString()
            };

            displayPet();
            saveGame();
            addStoryLine(`âœ¨ æ­å–œ!ä½ è·å¾—äº†å® ç‰©: ${currentPet.name} (${currentPet.rarity}çº§)`, 'choice');
            setScene('forest');
        }

        function displayPet() {
            if (!currentPet) return;

            const html = `
                <div class="pet-info">
                    <div>
                        <h3 class="rarity-${currentPet.rarity}">${currentPet.name}</h3>
                        <p style="color: #888; font-size: 0.9rem;">${currentPet.species}</p>
                        <p style="margin-top: 8px; font-size: 0.95rem;">${currentPet.description}</p>
                    </div>
                    <div>
                        <div class="stat-item">
                            <span>ç­‰çº§</span>
                            <span class="badge" style="background: #4CAF50;">Lv.${currentPet.level}</span>
                        </div>
                        <div class="stat-item">
                            <span>ç»éªŒ</span>
                            <span>${currentPet.exp}/100</span>
                        </div>
                        <div class="stat-item">
                            <span>ç¾ç»Š</span>
                            <span>${currentPet.bond}</span>
                        </div>
                        <div class="stat-item">
                            <span>ç¨€æœ‰åº¦</span>
                            <span class="badge rarity-${currentPet.rarity}">${currentPet.rarity}</span>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 16px;">
                    <div style="margin-bottom: 8px;">
                        <span style="color: #888;">HP</span>
                        <div class="stat-bar">
                            <div class="stat-bar-fill" style="width: ${(currentPet.stats.hp / 1000) * 100}%; background: #F44336;"></div>
                        </div>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <span style="color: #888;">ATK</span>
                        <div class="stat-bar">
                            <div class="stat-bar-fill" style="width: ${(currentPet.stats.attack / 200) * 100}%; background: #FF9800;"></div>
                        </div>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <span style="color: #888;">DEF</span>
                        <div class="stat-bar">
                            <div class="stat-bar-fill" style="width: ${(currentPet.stats.defense / 200) * 100}%; background: #2196F3;"></div>
                        </div>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <span style="color: #888;">SPD</span>
                        <div class="stat-bar">
                            <div class="stat-bar-fill" style="width: ${(currentPet.stats.speed / 200) * 100}%; background: #9C27B0;"></div>
                        </div>
                    </div>
                    <div>
                        <span style="color: #888;">MAG</span>
                        <div class="stat-bar">
                            <div class="stat-bar-fill" style="width: ${(currentPet.stats.magic / 200) * 100}%; background: #3F51B5;"></div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('petInfo').innerHTML = html;
        }

        // ==================== å‰§æƒ…ç³»ç»Ÿ ====================

        const storyTemplates = {
            forest: [
                'ä½ å¸¦ç€{pet}è¸å…¥äº†é’æœ¨çµå¢ƒã€‚å¤æ ‘å‚å¤©,è—¤è”“äº¤ç»‡,ç©ºæ°”ä¸­å¼¥æ¼«ç€å¥‡å¼‚çš„çµåŠ›æ³¢åŠ¨ã€‚',
                'è¿œå¤„ä¼ æ¥æœªçŸ¥ç”Ÿç‰©çš„ä½é¸£,{pet}è­¦è§‰åœ°ç¯é¡¾å››å‘¨,é¼»å°–å¾®å¾®æŠ½åŠ¨,æ•æ‰ç€ç©ºæ°”ä¸­çš„æ°”æ¯ã€‚',
                'å‰æ–¹çš„é“è·¯åˆ†æˆä¸‰æ¡:å·¦è¾¹é€šå¾€å¹½æš—çš„å¯†æ—æ·±å¤„,ä¸­é—´æ˜¯ä¸€æ¡è¢«è‹”è—“è¦†ç›–çš„çŸ³é˜¶,å³è¾¹åˆ™æ˜¯æºªæ°´æ½ºæ½ºçš„å°å¾„ã€‚'
            ],
            volcano: [
                'è¿›å…¥ç«å±±è¾¹ç¼˜,çƒ­æµªæ‰‘é¢è€Œæ¥ã€‚{pet}çš„èº«èº¯å¾®å¾®å‘å…‰,ä¼¼ä¹åœ¨é€‚åº”è¿™é‡Œçš„é«˜æ¸©ç¯å¢ƒã€‚',
                'å²©æµ†åœ¨è£‚ç¼ä¸­ç¼“ç¼“æµåŠ¨,æ•£å‘ç€çº¢è‰²çš„å…‰èŠ’ã€‚ç©ºæ°”ä¸­å¼¥æ¼«ç€ç¡«ç£ºçš„æ°”å‘³ã€‚',
                'çªç„¶,ä¸€åªç«ç„°ç²¾çµä»å²©æµ†ä¸­è·ƒèµ·!{pet}ç«‹åˆ»è¿›å…¥æˆ˜æ–—å§¿æ€!'
            ],
            camp: [
                'å›åˆ°è¥åœ°,{pet}èˆ’æœåœ°èººåœ¨æŸ”è½¯çš„è‰åœ°ä¸Šã€‚',
                'ä½ è½»è½»æŠšæ‘¸ç€å®ƒçš„å¤´é¢…,{pet}å‘å‡ºæ»¡è¶³çš„ä½é¸£,çœ¼ç›å¾®å¾®çœ¯èµ·ã€‚',
                'è¿™ä»½å®é™è®©ä½ ä»¬çš„ç¾ç»Šåˆæ·±äº†ä¸€åˆ†...'
            ]
        };

        const choices = {
            forest: [
                { text: 'æ·±å…¥å¯†æ—æ¢ç´¢', action: 'explore_deep', scene: 'forest' },
                { text: 'æ²¿ç€çŸ³é˜¶å‰è¿›', action: 'follow_path', scene: 'volcano' },
                { text: 'é¡ºç€æºªæµå‰è¡Œ', action: 'follow_stream', scene: 'camp' }
            ],
            volcano: [
                { text: 'è¿æˆ˜ç«ç„°ç²¾çµ', action: 'battle', reward: { exp: 30, bond: 10 } },
                { text: 'å°è¯•äº¤æµ', action: 'communicate', reward: { exp: 15, bond: 20 } },
                { text: 'æ’¤é€€åˆ°å®‰å…¨åŒº', action: 'retreat', scene: 'camp' }
            ],
            camp: [
                { text: 'ä¸å® ç‰©ç©è€', action: 'play', reward: { bond: 15 } },
                { text: 'è®­ç»ƒæŠ€èƒ½', action: 'train', reward: { exp: 20 } },
                { text: 'ç»§ç»­å†’é™©', action: 'new_adventure', scene: 'forest' }
            ]
        };

        function startAdventure() {
            if (!currentPet) {
                alert('è¯·å…ˆåˆ›å»ºä¸€åªå® ç‰©!');
                return;
            }

            const scene = gameState.scene || 'forest';
            const stories = storyTemplates[scene];

            stories.forEach(story => {
                const text = story.replace('{pet}', currentPet.name);
                addStoryLine(text);
            });

            showChoices(scene);

            // è®°å½•è¡Œä¸º
            recordBehavior('explore', 10);
        }

        function addStoryLine(text, className = '') {
            const line = document.createElement('div');
            line.className = 'story-line ' + className;
            line.textContent = text;

            const display = document.getElementById('storyDisplay');
            display.appendChild(line);
            display.scrollTop = display.scrollHeight;

            storyLines.push(text);
        }

        function showChoices(scene) {
            const choiceList = choices[scene];
            if (!choiceList) return;

            let html = '<div class="choices">';
            choiceList.forEach((choice, index) => {
                html += `
                    <div class="choice-btn" onclick="makeChoice('${scene}', ${index})">
                        <div style="font-weight: bold; margin-bottom: 4px;">${choice.text}</div>
                        <div style="font-size: 0.85rem; color: #888;">
                            ${choice.reward ? `å¥–åŠ±: ${choice.reward.exp ? 'EXP+' + choice.reward.exp : ''} ${choice.reward.bond ? 'BOND+' + choice.reward.bond : ''}` : ''}
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            document.getElementById('choicesContainer').innerHTML = html;
        }

        function makeChoice(scene, index) {
            const choice = choices[scene][index];

            addStoryLine(`ä½ é€‰æ‹©äº†: ${choice.text}`, 'choice');

            // åº”ç”¨å¥–åŠ±
            if (choice.reward) {
                if (choice.reward.exp) {
                    currentPet.exp += choice.reward.exp;
                    addStoryLine(`è·å¾— ${choice.reward.exp} ç‚¹ç»éªŒ!`);

                    // æ£€æŸ¥å‡çº§
                    while (currentPet.exp >= 100) {
                        currentPet.level += 1;
                        currentPet.exp -= 100;
                        addStoryLine(`ğŸ‰ ${currentPet.name} å‡çº§äº†! å½“å‰ç­‰çº§: ${currentPet.level}`);

                        // æå‡å±æ€§
                        currentPet.stats.hp += 50;
                        currentPet.stats.attack += 10;
                        currentPet.stats.defense += 8;
                        currentPet.stats.speed += 8;
                        currentPet.stats.magic += 12;
                    }
                }

                if (choice.reward.bond) {
                    currentPet.bond += choice.reward.bond;
                    addStoryLine(`ç¾ç»Š +${choice.reward.bond}!`);
                }

                displayPet();
                saveGame();
            }

            // åˆ‡æ¢åœºæ™¯
            if (choice.scene) {
                setTimeout(() => {
                    setScene(choice.scene);
                    gameState.scene = choice.scene;
                    startAdventure();
                }, 1000);
            } else {
                // æ¸…ç©ºé€‰æ‹©
                document.getElementById('choicesContainer').innerHTML = '';

                // æ·»åŠ ç»§ç»­æŒ‰é’®
                setTimeout(() => {
                    const continueBtn = document.createElement('button');
                    continueBtn.className = 'btn';
                    continueBtn.textContent = 'ç»§ç»­å†’é™©';
                    continueBtn.onclick = startAdventure;
                    document.getElementById('choicesContainer').appendChild(continueBtn);
                }, 500);
            }

            // è®°å½•è¡Œä¸º
            recordBehavior(choice.action, choice.reward?.exp || 5);
        }

        function clearStory() {
            document.getElementById('storyDisplay').innerHTML = '';
            document.getElementById('choicesContainer').innerHTML = '';
            storyLines = [];
        }

        // ==================== åœºæ™¯ç³»ç»Ÿ ====================

        const sceneColors = {
            forest: ['rgba(60,200,120,0.10)', 'rgba(40,120,80,0.12)'],
            volcano: ['rgba(255,60,60,0.14)', 'rgba(255,140,0,0.12)'],
            camp: ['rgba(100,100,100,0.10)', 'rgba(60,60,60,0.12)'],
            sky: ['rgba(70,140,255,0.12)', 'rgba(160,120,255,0.10)']
        };

        function setScene(scene) {
            const colors = sceneColors[scene];
            if (colors) {
                const aura = document.getElementById('sceneAura');
                aura.style.background = `repeating-linear-gradient(
                    -45deg,
                    ${colors[0]},
                    ${colors[0]} 20px,
                    ${colors[1]} 20px,
                    ${colors[1]} 40px
                )`;
            }
        }

        // ==================== è¿›åŒ–ç³»ç»Ÿ ====================

        function recordBehavior(type, value) {
            gameState.behaviors.push({
                type,
                value,
                timestamp: new Date().toISOString()
            });

            // åªä¿ç•™æœ€è¿‘50æ¡
            if (gameState.behaviors.length > 50) {
                gameState.behaviors = gameState.behaviors.slice(-50);
            }

            saveGame();
        }

        function checkEvolution() {
            if (!currentPet) {
                alert('è¯·å…ˆåˆ›å»ºå® ç‰©!');
                return;
            }

            if (currentPet.level < 10 || currentPet.exp < 100) {
                document.getElementById('evolutionInfo').innerHTML = `
                    <p style="color: #FF9800;">è¿›åŒ–æ¡ä»¶æœªæ»¡è¶³:</p>
                    <p>â€¢ ç­‰çº§: ${currentPet.level}/10</p>
                    <p>â€¢ ç»éªŒ: ${currentPet.exp}/100</p>
                `;
                return;
            }

            // ç®€åŒ–çš„è¿›åŒ–å€¾å‘è®¡ç®—
            const tendency = calculateTendency();
            const candidates = getEvolutionCandidates(tendency);

            let html = '<h3 style="margin-bottom: 16px;">è¿›åŒ–å€™é€‰:</h3>';
            candidates.forEach(candidate => {
                html += `
                    <div class="choice-btn" onclick="evolve('${candidate.path}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: bold; font-size: 1.1rem;">${candidate.name}</div>
                                <div style="color: #888; font-size: 0.9rem; margin-top: 4px;">${candidate.description}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.2rem; font-weight: bold; color: #4CAF50;">
                                    ${Math.round(candidate.probability * 100)}%
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            document.getElementById('evolutionCandidates').innerHTML = html;
        }

        function calculateTendency() {
            const tendency = {
                attack: 0,
                defense: 0,
                speed: 0,
                magic: 0
            };

            gameState.behaviors.forEach(b => {
                switch (b.type) {
                    case 'battle':
                        tendency.attack += b.value;
                        break;
                    case 'retreat':
                        tendency.defense += b.value;
                        break;
                    case 'explore_deep':
                    case 'follow_stream':
                        tendency.speed += b.value;
                        break;
                    case 'communicate':
                    case 'train':
                        tendency.magic += b.value;
                        break;
                }
            });

            const total = Object.values(tendency).reduce((a, b) => a + b, 0);
            if (total > 0) {
                Object.keys(tendency).forEach(k => {
                    tendency[k] = tendency[k] / total;
                });
            }

            return tendency;
        }

        function getEvolutionCandidates(tendency) {
            const paths = [
                {
                    path: 'warrior',
                    name: 'æˆ˜å£«å½¢æ€',
                    description: 'æ”»å‡»åŠ›å¤§å¹…æå‡,æˆä¸ºæˆ˜åœºä¸»å®°',
                    requiredTendency: 'attack',
                    statsBonus: { attack: 80, defense: 20, speed: 30, magic: 10 }
                },
                {
                    path: 'guardian',
                    name: 'å®ˆæŠ¤è€…å½¢æ€',
                    description: 'é˜²å¾¡åŠ›æå¤§å¢å¼º,ä¿æŠ¤é˜Ÿå‹',
                    requiredTendency: 'defense',
                    statsBonus: { attack: 20, defense: 80, speed: 10, magic: 30 }
                },
                {
                    path: 'assassin',
                    name: 'åˆºå®¢å½¢æ€',
                    description: 'é€Ÿåº¦ä¸æš´å‡»çš„å®Œç¾ç»“åˆ',
                    requiredTendency: 'speed',
                    statsBonus: { attack: 50, defense: 10, speed: 80, magic: 20 }
                },
                {
                    path: 'mage',
                    name: 'æ³•å¸ˆå½¢æ€',
                    description: 'å…ƒç´ é­”æ³•é€ è¯£å¤§å¢',
                    requiredTendency: 'magic',
                    statsBonus: { attack: 30, defense: 20, speed: 20, magic: 100 }
                }
            ];

            return paths.map(path => {
                const probability = tendency[path.requiredTendency] || 0.25;
                return {
                    ...path,
                    probability
                };
            }).sort((a, b) => b.probability - a.probability).slice(0, 3);
        }

        function evolve(path) {
            if (!confirm(`ç¡®å®šè¦è¿›åŒ–ä¸º ${path} å—?`)) return;

            const pathData = getEvolutionCandidates(calculateTendency()).find(p => p.path === path);
            if (!pathData) return;

            // æå‡ç¨€æœ‰åº¦
            const rarityUp = { 'N': 'R', 'R': 'SR', 'SR': 'SSR', 'SSR': 'SSS' };
            currentPet.rarity = rarityUp[currentPet.rarity] || currentPet.rarity;

            // åº”ç”¨å±æ€§åŠ æˆ
            Object.keys(pathData.statsBonus).forEach(stat => {
                currentPet.stats[stat] += pathData.statsBonus[stat];
            });

            // é‡ç½®ç»éªŒå’Œç­‰çº§
            currentPet.level = 10;
            currentPet.exp = 0;

            // æ›´æ–°åç§°
            currentPet.species = pathData.name;

            displayPet();
            saveGame();

            clearStory();
            addStoryLine('âœ¨ ä¸€è‚¡ç¥ç§˜çš„èƒ½é‡åŒ…å›´ç€ä½ çš„å® ç‰©!', 'choice');
            addStoryLine('å®ƒçš„èº«ä½“å¼€å§‹å‘å…‰,æ•£å‘å‡ºè€€çœ¼çš„å…‰èŠ’ã€‚èƒ½é‡å¦‚æ½®æ°´èˆ¬æ¶Œå…¥,èº«èº¯é€æ¸å‘ç”Ÿå˜åŒ–ã€‚');
            addStoryLine('å…‰èŠ’æ¸æ¸æ¶ˆæ•£,ä¸€ä¸ªå…¨æ–°çš„å½¢æ€å‡ºç°åœ¨ä½ é¢å‰!');
            addStoryLine(`ğŸ‰ ${currentPet.name} è¿›åŒ–æˆåŠŸ! æ–°å½¢æ€: ${pathData.name}`, 'choice');
            addStoryLine(`ç¨€æœ‰åº¦æå‡ä¸º: ${currentPet.rarity}`);

            document.getElementById('evolutionCandidates').innerHTML = '';
        }

        // ==================== å…¶ä»–åŠŸèƒ½ ====================

        function showPetList() {
            const html = `
                <h3 style="margin-bottom: 16px;">å±±æµ·ç»å® ç‰©å›¾é‰´</h3>
                ${petTemplates.map(t => `
                    <div class="stat-item" style="display: block; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span class="rarity-${t.rarity}" style="font-weight: bold;">${t.name}</span>
                            <span class="badge rarity-${t.rarity}">${t.rarity}</span>
                        </div>
                        <div style="color: #888; font-size: 0.9rem; margin-top: 4px;">
                            ${t.species} - ${t.description}
                        </div>
                    </div>
                `).join('')}
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(20, 20, 20, 0.98);
                padding: 32px;
                border-radius: 16px;
                border: 2px solid #444;
                max-width: 600px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                z-index: 1000;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            `;
            modal.innerHTML = html + '<button class="btn" onclick="this.parentElement.remove()">å…³é—­</button>';
            document.body.appendChild(modal);

            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                z-index: 999;
            `;
            overlay.onclick = () => {
                modal.remove();
                overlay.remove();
            };
            document.body.appendChild(overlay);
        }

        // ==================== åˆå§‹åŒ– ====================

        window.onload = function() {
            loadGame();
            setScene('forest');

            // æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
            setTimeout(() => {
                addStoryLine('ğŸ® æ¬¢è¿æ¥åˆ°çµå¢ƒæ–—å® å½•!');
                addStoryLine('è¿™æ˜¯ä¸€ä¸ªAIé©±åŠ¨çš„æ–‡å­—å® ç‰©å…»æˆæ¸¸æˆã€‚');
                addStoryLine('ç‚¹å‡»"åˆ›å»ºå® ç‰©"å¼€å§‹ä½ çš„å†’é™©ä¹‹æ—…!');
            }, 500);
        };

        // å®šæœŸè‡ªåŠ¨ä¿å­˜
        setInterval(saveGame, 30000);
    </script>
</body>
</html>
