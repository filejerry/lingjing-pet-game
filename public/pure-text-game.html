<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±±æµ·ç»çµå¢ƒæ–—å® å½•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'SimSun', serif;
            background: #0a0a0a;
            color: #e8e8e8;
            line-height: 1.8;
            font-size: 16px;
            overflow-x: hidden;
        }

        /* ä¸»è¦æ–‡å­—åŒºåŸŸ */
        .text-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            min-height: 100vh;
        }

        .story-text {
            margin-bottom: 30px;
            text-align: justify;
            letter-spacing: 0.5px;
        }

        .story-line {
            margin-bottom: 20px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 1.2s ease;
        }

        .story-line.show {
            opacity: 1;
            transform: translateY(0);
        }

        .story-line.title {
            font-size: 1.4em;
            color: #d4af37;
            text-align: center;
            margin: 30px 0;
            font-weight: bold;
        }

        .story-line.emphasis {
            color: #87ceeb;
            font-style: italic;
        }

        .story-line.dialogue {
            color: #98fb98;
            padding-left: 20px;
            border-left: 2px solid #98fb98;
        }

        /* é€‰æ‹©æŒ‰é’® */
        .choices {
            margin-top: 40px;
            opacity: 0;
            transition: opacity 1s ease;
        }

        .choices.show {
            opacity: 1;
        }

        .choice-item {
            display: block;
            width: 100%;
            background: transparent;
            border: 1px solid #444;
            color: #e8e8e8;
            padding: 15px 20px;
            margin: 10px 0;
            cursor: pointer;
            font-size: 16px;
            text-align: left;
            transition: all 0.3s ease;
            border-radius: 0;
            font-family: inherit;
        }

        .choice-item:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: #d4af37;
            color: #d4af37;
        }

        .choice-item:focus {
            outline: none;
            background: rgba(212, 175, 55, 0.1);
            border-color: #d4af37;
        }

        /* å³ä¸Šè§’æ§åˆ¶é¢æ¿ */
        .control-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .panel-toggle {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #444;
            color: #e8e8e8;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 4px;
        }

        .panel-toggle:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: #d4af37;
        }

        .panel-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid #444;
            border-radius: 4px;
            min-width: 200px;
            display: none;
            margin-top: 5px;
        }

        .panel-menu.show {
            display: block;
        }

        .menu-section {
            border-bottom: 1px solid #333;
            padding: 10px;
        }

        .menu-section:last-child {
            border-bottom: none;
        }

        .menu-title {
            color: #d4af37;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .menu-item {
            display: block;
            background: transparent;
            border: none;
            color: #e8e8e8;
            padding: 5px 0;
            cursor: pointer;
            font-size: 13px;
            text-align: left;
            width: 100%;
            font-family: inherit;
        }

        .menu-item:hover {
            color: #d4af37;
        }

        .status-display {
            font-size: 11px;
            color: #888;
            margin: 2px 0;
        }

        /* è¾“å…¥æ¡†æ ·å¼ */
        .text-input {
            width: 100%;
            background: transparent;
            border: 1px solid #444;
            color: #e8e8e8;
            padding: 10px;
            font-size: 16px;
            font-family: inherit;
            margin: 20px 0;
            border-radius: 0;
        }

        .text-input:focus {
            outline: none;
            border-color: #d4af37;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            color: #d4af37;
            text-align: center;
            font-style: italic;
        }

        .loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        /* ç‰¹æ®Šæ–‡å­—æ•ˆæœ */
        .highlight {
            color: #d4af37;
            font-weight: bold;
        }

        .mystical {
            color: #87ceeb;
            text-shadow: 0 0 5px rgba(135, 206, 235, 0.3);
        }

        .ancient {
            color: #daa520;
            font-style: italic;
        }

        .creature {
            color: #98fb98;
            font-weight: bold;
        }

        /* ç‰¹æ®Šå†…å®¹æ ·å¼ */
        .clue-item {
            color: #ffd700;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .challenge-item {
            color: #ff6b6b;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }

        .bond-item {
            color: #4ecdc4;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(78, 205, 196, 0.5);
        }

        .reward-item {
            color: #45b7d1;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(69, 183, 209, 0.5);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .text-container {
                padding: 20px 15px;
            }
            
            body {
                font-size: 15px;
            }
            
            .control-panel {
                top: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <button class="panel-toggle" id="panelToggle">â˜° èœå•</button>
        <div class="panel-menu" id="panelMenu">
            <div class="menu-section">
                <div class="menu-title">æ¸¸æˆæ§åˆ¶</div>
                <button class="menu-item" id="startStory">å¼€å§‹æ–°æ•…äº‹</button>
                <button class="menu-item" id="restartGame">é‡æ–°å¼€å§‹</button>
                <button class="menu-item" id="saveGame">ä¿å­˜è¿›åº¦</button>
                <button class="menu-item" id="loadGame">åŠ è½½è¿›åº¦</button>
            </div>
            
            <div class="menu-section">
                <div class="menu-title">å® ç‰©çŠ¶æ€</div>
                <div class="status-display">åç§°: <span id="petName">æœªè·å¾—</span></div>
                <div class="status-display">ç­‰çº§: <span id="petLevel">-</span></div>
                <div class="status-display">ç»éªŒ: <span id="petExp">-</span></div>
                <div class="status-display">ç¾ç»Š: <span id="petBond">-</span></div>
                <button class="menu-item" id="viewPetStatus">æŸ¥çœ‹è¯¦ç»†çŠ¶æ€</button>
                <button class="menu-item" id="addExperience">è·å¾—ç»éªŒ</button>
                <button class="menu-item" id="checkEvolution">æ£€æŸ¥è¿›åŒ–</button>
            </div>
            
            <div class="menu-section">
                <div class="menu-title">å‰§æƒ…ç³»ç»Ÿ</div>
                <button class="menu-item" id="startExploration">å±±æµ·ç»æ¢ç´¢</button>
                <button class="menu-item" id="startGrowth">å® ç‰©æˆé•¿</button>
                <button class="menu-item" id="startBattle">æˆ˜æ–—è¯•ç‚¼</button>
                <button class="menu-item" id="getCurrentStory">å½“å‰å‰§æƒ…</button>
            </div>
            
            <div class="menu-section">
                <div class="menu-title">ç³»ç»Ÿä¿¡æ¯</div>
                <div class="status-display">æœåŠ¡å™¨: <span id="serverStatus">æ£€æŸ¥ä¸­</span></div>
                <button class="menu-item" id="testAPI">æµ‹è¯•API</button>
                <button class="menu-item" id="clearLog">æ¸…ç©ºæ—¥å¿—</button>
            </div>
        </div>
    </div>

    <div class="text-container">
        <div id="storyContent">
            <div class="story-line loading show">æ­£åœ¨åˆå§‹åŒ–å±±æµ·ç»ä¸–ç•Œ</div>
        </div>
        
        <div class="choices" id="choicesContainer">
            <!-- é€‰æ‹©æŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        const gameState = {
            currentPet: {
                name: 'æœªè·å¾—',
                species: '',
                level: 0,
                totalExp: 0,
                bond: 0,
                attribute: '',
                stats: {}
            },
            currentPlayerId: 'player_' + Date.now(),
            storyHistory: [],
            isLoading: false
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeGame();
            setupEventListeners();
            checkServerStatus();
        });

        // åˆå§‹åŒ–æ¸¸æˆ
        function initializeGame() {
            setTimeout(() => {
                showWelcomeStory();
            }, 1500);
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬
        function setupEventListeners() {
            // é¢æ¿æ§åˆ¶
            document.getElementById('panelToggle').addEventListener('click', togglePanel);
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.control-panel')) {
                    hidePanel();
                }
            });

            // æ¸¸æˆæ§åˆ¶
            document.getElementById('startStory').addEventListener('click', showWelcomeStory);
            document.getElementById('restartGame').addEventListener('click', restartGame);
            document.getElementById('saveGame').addEventListener('click', saveGame);
            document.getElementById('loadGame').addEventListener('click', loadGame);

            // å® ç‰©ç›¸å…³
            document.getElementById('viewPetStatus').addEventListener('click', viewPetStatus);
            document.getElementById('addExperience').addEventListener('click', addExperience);
            document.getElementById('checkEvolution').addEventListener('click', checkEvolution);

            // å‰§æƒ…ç³»ç»Ÿ
            document.getElementById('startExploration').addEventListener('click', () => startStoryMode('shanhai_exploration'));
            document.getElementById('startGrowth').addEventListener('click', () => startStoryMode('pet_growth'));
            document.getElementById('startBattle').addEventListener('click', () => startStoryMode('battle_scenarios'));
            document.getElementById('getCurrentStory').addEventListener('click', getCurrentStory);

            // ç³»ç»ŸåŠŸèƒ½
            document.getElementById('testAPI').addEventListener('click', testAPI);
            document.getElementById('clearLog').addEventListener('click', clearLog);
        }

        // é¢æ¿æ§åˆ¶
        function togglePanel() {
            const menu = document.getElementById('panelMenu');
            menu.classList.toggle('show');
        }

        function hidePanel() {
            document.getElementById('panelMenu').classList.remove('show');
        }

        // æ˜¾ç¤ºæ¬¢è¿æ•…äº‹
        function showWelcomeStory() {
            const storyLines = [
                { text: "å±±æµ·ç»çµå¢ƒæ–—å® å½•", type: "title" },
                { text: "åœ¨è¿™ä¸ªç”±ä¸–ç•Œæ ‘æ”¯æ’‘çš„ç¥è¯ä¸–ç•Œä¸­ï¼Œå¤è€çš„ä¼ è¯´æ­£åœ¨è‹é†’ã€‚", type: "normal" },
                { text: "ä½ ç«™åœ¨ä¸–ç•Œæ ‘çš„æ ¹éƒ¨ï¼Œæ„Ÿå—ç€æ¥è‡ªä¸åŒæ–¹å‘çš„ç¥ç§˜å¬å”¤ã€‚", type: "normal" },
                { text: "å¾®é£è½»æŠšè¿‡ä½ çš„è„¸åºï¼Œå¸¦æ¥äº†è¿œå¤æ—¶ä»£çš„è®°å¿†ç¢ç‰‡ã€‚", type: "emphasis" },
                { text: "\"å¹´è½»çš„æ—…è€…ï¼Œä½ å‡†å¤‡å¥½å¼€å§‹è¿™æ®µå¥‡å¦™çš„æ—…ç¨‹äº†å—ï¼Ÿ\"", type: "dialogue" },
                { text: "è¯·é€‰æ‹©ä½ æ„Ÿåº”åˆ°çš„åŠ›é‡ï¼š", type: "normal" }
            ];

            displayStoryLines(storyLines, () => {
                showInitialChoices();
            });
        }

        // æ˜¾ç¤ºæ•…äº‹è¡Œ
        function displayStoryLines(lines, callback) {
            const container = document.getElementById('storyContent');
            container.innerHTML = '';
            
            lines.forEach((line, index) => {
                setTimeout(() => {
                    const lineElement = document.createElement('div');
                    lineElement.className = `story-line ${line.type}`;
                    lineElement.textContent = line.text;
                    container.appendChild(lineElement);
                    
                    setTimeout(() => {
                        lineElement.classList.add('show');
                    }, 100);
                    
                    if (index === lines.length - 1 && callback) {
                        setTimeout(callback, 1000);
                    }
                }, index * 800);
            });
        }

        // æ˜¾ç¤ºåˆå§‹é€‰æ‹©
        function showInitialChoices() {
            const choices = [
                { text: "æˆ‘å¬åˆ°äº†å¤è€çš„é¾™åŸå£°ï¼Œä»¿ä½›æ¥è‡ªæ—¶é—´çš„æ·±å¤„...", action: () => startPetGeneration('dragon') },
                { text: "æˆ‘æ„Ÿå—åˆ°äº†è‡ªç„¶çš„å‘¼å”¤ï¼ŒèŠ±è‰æ ‘æœ¨éƒ½åœ¨è¯‰è¯´ç”Ÿå‘½çš„å¥¥ç§˜...", action: () => startPetGeneration('nature') },
                { text: "æˆ‘çœ‹è§äº†æ˜Ÿç©ºä¸­çš„å¹»è±¡ï¼Œæ— æ•°çš„å¯èƒ½æ€§åœ¨è™šç©ºä¸­é—ªçƒ...", action: () => startPetGeneration('mystic') },
                { text: "æˆ‘æ„Ÿåˆ°ä¸€è‚¡ç¥ç§˜çš„åŠ›é‡åœ¨å¬å”¤ï¼Œé‚£æ˜¯åˆ›ä¸–çš„å›å“...", action: () => startPetGeneration('genesis') }
            ];

            showChoices(choices);
        }

        // æ˜¾ç¤ºé€‰æ‹©
        function showChoices(choices) {
            const container = document.getElementById('choicesContainer');
            container.innerHTML = '';
            
            choices.forEach((choice, index) => {
                const button = document.createElement('button');
                button.className = 'choice-item';
                button.textContent = choice.text;
                button.addEventListener('click', choice.action);
                container.appendChild(button);
            });
            
            setTimeout(() => {
                container.classList.add('show');
            }, 500);
        }

        // éšè—é€‰æ‹©
        function hideChoices() {
            const container = document.getElementById('choicesContainer');
            container.classList.remove('show');
            setTimeout(() => {
                container.innerHTML = '';
            }, 500);
        }

        // å¼€å§‹å® ç‰©ç”Ÿæˆ
        function startPetGeneration(type) {
            hideChoices();
            
            const generationLines = [
                { text: "ä½ çš„é€‰æ‹©å¼•èµ·äº†ä¸–ç•Œæ ‘çš„å…±é¸£...", type: "normal" },
                { text: "ç¥ç§˜çš„å…‰èŠ’å¼€å§‹åœ¨ä½ å‘¨å›´èšé›†ã€‚", type: "emphasis" },
                { text: "\"æ­£åœ¨ä¸ºä½ å¯»æ‰¾æœ€åˆé€‚çš„ä¼™ä¼´...\"", type: "dialogue" },
                { text: "è¯·ç¨ç­‰ï¼Œå¥‡è¿¹å³å°†é™ä¸´ã€‚", type: "loading" }
            ];

            displayStoryLines(generationLines, () => {
                setTimeout(() => {
                    generatePet(type);
                }, 2000);
            });
        }

        // ç”Ÿæˆå® ç‰©
        async function generatePet(type) {
            try {
                // æ¨¡æ‹Ÿå® ç‰©ç”Ÿæˆ
                const pet = await mockPetGeneration(type);
                gameState.currentPet = pet;
                updatePetDisplay();
                
                showPetIntroduction(pet);
                
            } catch (error) {
                showError('ç”Ÿæˆå® ç‰©æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•ã€‚');
            }
        }

        // æ¨¡æ‹Ÿå® ç‰©ç”Ÿæˆ
        async function mockPetGeneration(type) {
            const petData = {
                dragon: {
                    species: ['ç«é¾™', 'å†°é¾™', 'é›·é¾™', 'æš—é¾™', 'å…‰é¾™'],
                    attributes: ['çƒˆç„°', 'å¯’å†°', 'é›·é¸£', 'æš—å½±', 'åœ£å…‰']
                },
                nature: {
                    species: ['æœ¨ç²¾', 'èŠ±ä»™', 'æ ‘çµ', 'è‰å¦–', 'è—¤æ€ª'],
                    attributes: ['ç”Ÿæœº', 'æ²»æ„ˆ', 'æˆé•¿', 'ç¹èŒ‚', 'æ–°ç”Ÿ']
                },
                mystic: {
                    species: ['å¹»çµ', 'æ˜Ÿå…½', 'è™šå½±', 'æ¢¦é­‡', 'æ—¶çµ'],
                    attributes: ['å¹»è±¡', 'æ˜Ÿå…‰', 'è™šæ— ', 'æ¢¦å¢ƒ', 'æ—¶é—´']
                },
                genesis: {
                    species: ['åˆ›ä¸–', 'åŸåˆ', 'æ··æ²Œ', 'å¤ªåˆ', 'å¼€å¤©'],
                    attributes: ['åˆ›é€ ', 'æ¯ç­', 'é‡ç”Ÿ', 'æ¼”åŒ–', 'èµ·æº']
                }
            };

            const data = petData[type] || petData.nature;
            const species = data.species[Math.floor(Math.random() * data.species.length)];
            const attribute = data.attributes[Math.floor(Math.random() * data.attributes.length)];
            
            return {
                name: `${species}Â·${attribute}`,
                species: species,
                attribute: attribute,
                level: 1,
                totalExp: 0,
                bond: 10,
                stats: {
                    hp: 45 + Math.floor(Math.random() * 20),
                    attack: 15 + Math.floor(Math.random() * 10),
                    defense: 10 + Math.floor(Math.random() * 8),
                    speed: 8 + Math.floor(Math.random() * 6),
                    magic: 12 + Math.floor(Math.random() * 8)
                }
            };
        }

        // æ˜¾ç¤ºå® ç‰©ä»‹ç»
        function showPetIntroduction(pet) {
            const introLines = [
                { text: `ä¸–ç•Œæ ‘çš„å…‰èŠ’é—ªçƒï¼Œ${pet.name} å‡ºç°åœ¨ä½ é¢å‰ï¼`, type: "title" },
                { text: `è¿™åª${pet.species}èº«æŠ«${pet.attribute}ä¹‹åŠ›çš„å…‰è¾‰ï¼Œçœ¼ä¸­é—ªçƒç€æ™ºæ…§çš„å…‰èŠ’ã€‚`, type: "normal" },
                { text: `å®ƒè½»è½»è¹­äº†è¹­ä½ çš„æ‰‹ï¼Œä¼¼ä¹å·²ç»è®¤å¯äº†ä½ è¿™ä¸ªä¼™ä¼´ã€‚`, type: "emphasis" },
                { text: `\"æ­å–œä½ ï¼Œå¹´è½»çš„è®­ç»ƒå¸ˆã€‚è¿™å°†æ˜¯ä¸€æ®µç¾å¦™æ—…ç¨‹çš„å¼€å§‹ã€‚\"`, type: "dialogue" },
                { text: "ç°åœ¨ï¼Œä½ ä»¬å¯ä»¥å¼€å§‹å†’é™©äº†ã€‚", type: "normal" }
            ];

            displayStoryLines(introLines, () => {
                showMainChoices();
            });
        }

        // æ˜¾ç¤ºä¸»è¦é€‰æ‹©
        function showMainChoices() {
            const choices = [
                { text: "å¼€å§‹æ¢ç´¢å±±æµ·ç»çš„ç¥ç§˜ä¸–ç•Œ", action: () => startStoryMode('shanhai_exploration') },
                { text: "ä¸å® ç‰©è¿›è¡Œæ·±åº¦äº¤æµå’Œè®­ç»ƒ", action: () => startStoryMode('pet_growth') },
                { text: "å¯»æ‰¾å…¶ä»–è®­ç»ƒå¸ˆè¿›è¡Œæˆ˜æ–—", action: () => startStoryMode('battle_scenarios') },
                { text: "åœ¨æ­¤åœ°ä¼‘æ¯ï¼Œè§‚å¯Ÿå‘¨å›´çš„ç¯å¢ƒ", action: () => showRestScene() }
            ];

            showChoices(choices);
        }

        // å¼€å§‹æ•…äº‹æ¨¡å¼
        async function startStoryMode(storyType) {
            if (gameState.isLoading) return;
            
            gameState.isLoading = true;
            hideChoices();
            
            try {
                showLoading('æ­£åœ¨å‡†å¤‡å‰§æƒ…...');
                
                const response = await fetch('/api/story-growth/stories/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        playerId: gameState.currentPlayerId,
                        storyType: storyType,
                        context: {
                            petName: gameState.currentPet.name,
                            level: gameState.currentPet.level,
                            bond: gameState.currentPet.bond,
                            courage: 3,
                            wisdom: 2
                        }
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    displayStoryNode(data.result.currentNode);
                } else {
                    showError('å‰§æƒ…å¼€å§‹å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                    showMainChoices();
                }
            } catch (error) {
                showError('è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚');
                showMainChoices();
            } finally {
                gameState.isLoading = false;
            }
        }

        // æ˜¾ç¤ºæ•…äº‹èŠ‚ç‚¹
        function displayStoryNode(node) {
            const storyLines = [
                { text: node.title, type: "title" },
                { text: node.description, type: "normal" }
            ];

            displayStoryLines(storyLines, () => {
                if (node.choices && node.choices.length > 0) {
                    const choices = node.choices.map(choice => ({
                        text: choice.text,
                        action: () => makeStoryChoice(choice.id)
                    }));
                    showChoices(choices);
                } else {
                    setTimeout(() => {
                        showMainChoices();
                    }, 2000);
                }
            });
        }

        // åšå‡ºæ•…äº‹é€‰æ‹©
        async function makeStoryChoice(choiceId) {
            if (gameState.isLoading) return;
            
            gameState.isLoading = true;
            hideChoices();
            
            try {
                showLoading('æ­£åœ¨å¤„ç†ä½ çš„é€‰æ‹©...');
                
                const response = await fetch('/api/story-growth/stories/choice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        playerId: gameState.currentPlayerId,
                        choiceId: choiceId
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    if (data.result.effects) {
                        applyEffects(data.result.effects);
                    }
                    
                    if (data.result.nextNode) {
                        displayStoryNode(data.result.nextNode);
                    } else {
                        const endLines = [
                            { text: "è¿™æ®µå†’é™©å‘Šä¸€æ®µè½ã€‚", type: "normal" },
                            { text: "ä½†ä½ ä»¬çš„æ—…ç¨‹æ‰åˆšåˆšå¼€å§‹...", type: "emphasis" }
                        ];
                        displayStoryLines(endLines, () => {
                            showMainChoices();
                        });
                    }
                } else {
                    showError('é€‰æ‹©å¤„ç†å¤±è´¥: ' + (data.reason || data.message || 'æœªçŸ¥é”™è¯¯'));
                    showMainChoices();
                }
            } catch (error) {
                showError('è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚');
                showMainChoices();
            } finally {
                gameState.isLoading = false;
            }
        }

        // åº”ç”¨æ•ˆæœ
        function applyEffects(effects) {
            if (effects.exp) {
                gameState.currentPet.totalExp += effects.exp;
                showMessage(`è·å¾—äº†${effects.exp}ç‚¹ç»éªŒå€¼ï¼`);
            }
            if (effects.bond) {
                gameState.currentPet.bond += effects.bond;
                showMessage(`ç¾ç»Šå€¼å¢åŠ äº†${effects.bond}ç‚¹ï¼`);
            }
            updatePetDisplay();
        }

        // æ˜¾ç¤ºä¼‘æ¯åœºæ™¯
        function showRestScene() {
            const restLines = [
                { text: "ä½ å’Œä½ çš„ä¼™ä¼´åœ¨ä¸–ç•Œæ ‘ä¸‹æ‰¾äº†ä¸ªèˆ’é€‚çš„åœ°æ–¹ä¼‘æ¯ã€‚", type: "normal" },
                { text: "å¾®é£è½»æŠšï¼Œå¸¦æ¥äº†è¿œæ–¹çš„èŠ±é¦™ã€‚", type: "emphasis" },
                { text: `${gameState.currentPet.name}èœ·ç¼©åœ¨ä½ èº«è¾¹ï¼Œå‘å‡ºæ»¡è¶³çš„è½»é¸£ã€‚`, type: "normal" },
                { text: "è¿™æ ·çš„å®é™æ—¶å…‰è®©ä½ ä»¬çš„ç¾ç»Šæ›´åŠ æ·±åšã€‚", type: "emphasis" }
            ];

            displayStoryLines(restLines, () => {
                gameState.currentPet.bond += 1;
                updatePetDisplay();
                setTimeout(() => {
                    showMainChoices();
                }, 2000);
            });
        }

        // æ·»åŠ ç»éªŒå€¼
        async function addExperience() {
            if (gameState.currentPet.level === 0) {
                showMessage('è¯·å…ˆè·å¾—å® ç‰©ï¼');
                return;
            }

            try {
                const expGained = 25 + Math.floor(Math.random() * 25);
                
                const response = await fetch('/api/story-growth/growth/add-exp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pet: gameState.currentPet,
                        expGained: expGained
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    gameState.currentPet.totalExp = data.result.levelInfo.totalExp;
                    gameState.currentPet.level = data.result.levelInfo.level;
                    updatePetDisplay();
                    
                    if (data.result.leveledUp) {
                        showMessage(`ğŸ‰ å‡çº§äº†ï¼ä»${data.result.oldLevel}çº§å‡åˆ°${data.result.newLevel}çº§ï¼`);
                        if (data.guidance) {
                            setTimeout(() => {
                                alert(data.guidance.congratulations + '\n\n' + 
                                     data.guidance.improvements.join('\n') + '\n\n' +
                                     data.guidance.nextGoals.join('\n'));
                            }, 1000);
                        }
                    } else {
                        showMessage(`è·å¾—äº†${expGained}ç‚¹ç»éªŒå€¼ï¼`);
                    }
                } else {
                    showMessage('ç»éªŒå€¼æ·»åŠ å¤±è´¥');
                }
            } catch (error) {
                showMessage('è¿æ¥æœåŠ¡å™¨å¤±è´¥');
            }
        }

        // æ£€æŸ¥è¿›åŒ–
        async function checkEvolution() {
            if (gameState.currentPet.level === 0) {
                showMessage('è¯·å…ˆè·å¾—å® ç‰©ï¼');
                return;
            }

            try {
                const response = await fetch('/api/story-growth/growth/check-evolution', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pet: gameState.currentPet })
                });

                const data = await response.json();
                
                if (data.success) {
                    if (data.canEvolve) {
                        if (confirm('ğŸ”¥ ä½ çš„å® ç‰©å¯ä»¥è¿›åŒ–äº†ï¼æ˜¯å¦ç«‹å³è¿›åŒ–ï¼Ÿ')) {
                            evolvePet();
                        }
                    } else {
                        showMessage('æš‚æ—¶è¿˜ä¸èƒ½è¿›åŒ–ï¼Œç»§ç»­åŠªåŠ›å§ï¼');
                    }
                } else {
                    showMessage('è¿›åŒ–æ£€æŸ¥å¤±è´¥');
                }
            } catch (error) {
                showMessage('è¿æ¥æœåŠ¡å™¨å¤±è´¥');
            }
        }

        // æ‰§è¡Œè¿›åŒ–
        async function evolvePet() {
            try {
                showLoading('æ­£åœ¨è¿›åŒ–...');
                
                const response = await fetch('/api/story-growth/growth/evolve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pet: gameState.currentPet })
                });

                const data = await response.json();
                
                if (data.success) {
                    gameState.currentPet.species = data.result.afterEvolution.name;
                    gameState.currentPet.name = data.result.afterEvolution.name;
                    gameState.currentPet.stats = data.result.afterEvolution.stats;
                    updatePetDisplay();
                    
                    const evolutionLines = [
                        { text: "è¿›åŒ–ä¹‹å…‰åŒ…å›´äº†ä½ çš„ä¼™ä¼´ï¼", type: "title" },
                        { text: data.result.description, type: "emphasis" },
                        { text: `${data.result.beforeEvolution.name} æˆåŠŸè¿›åŒ–ä¸º ${data.result.afterEvolution.name}ï¼`, type: "normal" }
                    ];
                    
                    displayStoryLines(evolutionLines, () => {
                        showMainChoices();
                    });
                } else {
                    showMessage('è¿›åŒ–å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                showMessage('è¿æ¥æœåŠ¡å™¨å¤±è´¥');
            }
        }

        // æŸ¥çœ‹å® ç‰©çŠ¶æ€
        async function viewPetStatus() {
            if (gameState.currentPet.level === 0) {
                showMessage('è¯·å…ˆè·å¾—å® ç‰©ï¼');
                return;
            }

            try {
                const response = await fetch('/api/story-growth/growth/status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pet: gameState.currentPet })
                });

                const data = await response.json();
                
                if (data.success) {
                    const status = data.status;
                    let statusText = `=== ${status.basic.name} è¯¦ç»†çŠ¶æ€ ===\n\n`;
                    statusText += `åŸºæœ¬ä¿¡æ¯:\n`;
                    statusText += `- åç§°: ${status.basic.name}\n`;
                    statusText += `- ç§æ—: ${status.basic.species}\n`;
                    statusText += `- ç­‰çº§: ${status.basic.level}\n`;
                    statusText += `- å±æ€§: ${status.basic.type}\n\n`;
                    
                    statusText += `ç»éªŒå€¼:\n`;
                    statusText += `- æ€»ç»éªŒ: ${status.experience.totalExp}\n`;
                    statusText += `- è·ç¦»ä¸‹çº§: ${status.experience.expToNextLevel}\n\n`;
                    
                    statusText += `è¿›åŒ–ä¿¡æ¯:\n`;
                    statusText += `- å½“å‰é˜¶æ®µ: ${status.evolution.currentStage + 1}\n`;
                    statusText += `- ä¸‹ä¸€é˜¶æ®µ: ${status.evolution.nextStage || 'å·²è¾¾æœ€é«˜é˜¶æ®µ'}\n`;
                    statusText += `- å¯ä»¥è¿›åŒ–: ${status.evolution.canEvolve ? 'æ˜¯' : 'å¦'}\n`;
                    
                    alert(statusText);
                } else {
                    showMessage('çŠ¶æ€è·å–å¤±è´¥');
                }
            } catch (error) {
                showMessage('è¿æ¥æœåŠ¡å™¨å¤±è´¥');
            }
        }

        // è·å–å½“å‰å‰§æƒ…
        async function getCurrentStory() {
            try {
                const response = await fetch(`/api/story-growth/stories/current/${gameState.currentPlayerId}`);
                const data = await response.json();
                
                if (data.success) {
                    if (data.hasActiveStory) {
                        showMessage('æœ‰æ­£åœ¨è¿›è¡Œçš„å‰§æƒ…');
                    } else {
                        showMessage('å½“å‰æ²¡æœ‰è¿›è¡Œä¸­çš„å‰§æƒ…');
                    }
                } else {
                    showMessage('è·å–å‰§æƒ…çŠ¶æ€å¤±è´¥');
                }
            } catch (error) {
                showMessage('è¿æ¥æœåŠ¡å™¨å¤±è´¥');
            }
        }

        // æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥
        async function checkServerStatus() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                document.getElementById('serverStatus').textContent = 'æ­£å¸¸';
                document.getElementById('serverStatus').style.color = '#98fb98';
            } catch (error) {
                document.getElementById('serverStatus').textContent = 'ç¦»çº¿';
                document.getElementById('serverStatus').style.color = '#ff6b6b';
            }
        }

        // æµ‹è¯•API
        async function testAPI() {
            try {
                const response = await fetch('/api/info');
                const data = await response.json();
                alert('APIæµ‹è¯•æˆåŠŸï¼\n' + JSON.stringify(data, null, 2));
            } catch (error) {
                alert('APIæµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // æ›´æ–°å® ç‰©æ˜¾ç¤º
        function updatePetDisplay() {
            document.getElementById('petName').textContent = gameState.currentPet.name;
            document.getElementById('petLevel').textContent = gameState.currentPet.level;
            document.getElementById('petExp').textContent = gameState.currentPet.totalExp;
            document.getElementById('petBond').textContent = gameState.currentPet.bond;
        }

        // å·¥å…·å‡½æ•°
        function showLoading(message) {
            const container = document.getElementById('storyContent');
            container.innerHTML = `<div class="story-line loading show">${message}</div>`;
        }

        function showMessage(message) {
            const lines = [{ text: message, type: "emphasis" }];
            displayStoryLines(lines);
        }

        function showError(message) {
            const lines = [{ text: "é”™è¯¯: " + message, type: "normal" }];
            displayStoryLines(lines);
        }

        function saveGame() {
            localStorage.setItem('gameState', JSON.stringify(gameState));
            showMessage('æ¸¸æˆå·²ä¿å­˜');
        }

        function loadGame() {
            const saved = localStorage.getItem('gameState');
            if (saved) {
                Object.assign(gameState, JSON.parse(saved));
                updatePetDisplay();
                showMessage('æ¸¸æˆå·²åŠ è½½');
            } else {
                showMessage('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„æ¸¸æˆ');
            }
        }

        function restartGame() {
            if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿå½“å‰è¿›åº¦å°†ä¸¢å¤±ã€‚')) {
                gameState.currentPet = {
                    name: 'æœªè·å¾—',
                    species: '',
                    level: 0,
                    totalExp: 0,
                    bond: 0,
                    attribute: '',
                    stats: {}
                };
                gameState.storyHistory = [];
                updatePetDisplay();
                showWelcomeStory();
            }
        }

        function clearLog() {
            document.getElementById('storyContent').innerHTML = '';
            hideChoices();
        }

        // å®šæœŸæ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        setInterval(checkServerStatus, 30000);
    </script>
</body>
</html>