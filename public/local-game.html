<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµå¢ƒæ–—å® å½• - æœ¬åœ°æ¸¸ç©ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            position: relative;
        }

        /* èƒŒæ™¯ç²’å­æ•ˆæœ */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: float 6s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 0.8; }
        }

        .game-container {
            position: relative;
            z-index: 2;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* å³ä¸Šè§’æ§åˆ¶é¢æ¿ */
        .control-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-btn {
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            border-radius: 20px;
            color: #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            backdrop-filter: blur(10px);
            text-align: center;
            min-width: 80px;
        }

        .control-btn:hover {
            border-color: #ffd700;
            background: rgba(0, 0, 0, 0.9);
            transform: scale(1.05);
        }

        /* æ²‰æµ¸å¼ä¸»å†…å®¹åŒº */
        .immersive-container {
            position: relative;
            z-index: 2;
            max-width: 800px;
            margin: 0 auto;
            padding: 60px 40px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .story-stage {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 20px;
            padding: 60px;
            backdrop-filter: blur(15px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 500px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .story-content {
            font-size: 1.0em;
            line-height: 1.6;
            color: #e8e8e8;
            text-align: center;
            letter-spacing: 0.2px;
            font-weight: 300;
        }

        .story-line {
            margin-bottom: 18px;
            opacity: 0;
            transform: translateY(20px) scale(0.98);
            transition: all 1.0s cubic-bezier(0.23, 1, 0.32, 1);
            text-shadow: 0 1px 8px rgba(0, 0, 0, 0.6);
        }

        .story-line.show {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .story-line.title {
            font-size: 2.2em;
            background: linear-gradient(135deg, #ffd700, #ffed4e, #ffd700, #fff, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 25px rgba(255, 215, 0, 0.3);
            margin-bottom: 35px;
            font-weight: 600;
            letter-spacing: 2px;
            animation: titleGlow 5s ease-in-out infinite alternate;
        }

        .story-line.subtitle {
            font-size: 0.95em;
            color: #bbb;
            margin-bottom: 40px;
            font-style: italic;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .story-line.author {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 50px;
            opacity: 0.7;
            font-weight: 300;
        }

        @keyframes titleGlow {
            0% { text-shadow: 0 0 30px rgba(255, 215, 0, 0.4); }
            100% { text-shadow: 0 0 50px rgba(255, 215, 0, 0.8); }
        }

        .choices-container {
            margin-top: 40px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 1s ease;
        }

        .choices-container.show {
            opacity: 1;
            transform: translateY(0);
        }

        .choice-button {
            display: block;
            width: 100%;
            padding: 20px 30px;
            margin-bottom: 12px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 15px;
            color: #f5f5f5;
            font-size: 1.05em;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            text-align: center;
            line-height: 1.3;
            backdrop-filter: blur(20px);
            font-weight: 400;
            letter-spacing: 0.8px;
            min-height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        .choice-button:hover {
            border-color: rgba(255, 215, 0, 0.7);
            background: rgba(255, 215, 0, 0.12);
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(255, 215, 0, 0.2);
            color: #fff;
        }

        .pet-reveal {
            text-align: center;
            margin-top: 40px;
            opacity: 0;
            transform: scale(0.8);
            transition: all 1.5s ease;
        }

        .pet-reveal.show {
            opacity: 1;
            transform: scale(1);
        }

        .pet-avatar {
            width: 150px;
            height: 150px;
            background: linear-gradient(45deg, #333, #555);
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4em;
            border: 3px solid #666;
            transition: all 0.5s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .pet-name-container {
            margin-bottom: 15px;
        }

        .pet-custom-name {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px 15px;
            color: #e0e0e0;
            font-size: 1.1em;
            margin-bottom: 10px;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            font-weight: 300;
            letter-spacing: 0.5px;
            max-width: 300px;
            margin: 0 auto 10px;
        }

        .pet-custom-name:focus {
            outline: none;
            border-color: rgba(255, 215, 0, 0.5);
            background: rgba(255, 215, 0, 0.05);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        }

        .pet-custom-name::placeholder {
            color: #888;
            font-style: italic;
        }

        .pet-name {
            font-size: 1.4em;
            margin-bottom: 8px;
            font-weight: 500;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            letter-spacing: 0.5px;
        }

        .pet-attributes {
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 15px;
            font-weight: 300;
        }

        .pet-rarity {
            font-size: 1.0em;
            margin-bottom: 20px;
            padding: 6px 16px;
            border-radius: 20px;
            display: inline-block;
            font-weight: 400;
        }

        .name-confirm-btn {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 6px;
            padding: 4px 10px;
            color: #ffd700;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
            margin-top: 5px;
        }

        .name-confirm-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: rgba(255, 215, 0, 0.5);
        }

        .rarity-sss {
            background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
            color: white;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
            animation: rainbow 2s linear infinite;
        }

        .rarity-ssr {
            background: linear-gradient(45deg, #ff4444, #cc0000);
            color: white;
            text-shadow: 0 0 15px rgba(255, 68, 68, 0.8);
        }

        .rarity-sr {
            background: linear-gradient(45deg, #8a2be2, #4b0082);
            color: white;
            text-shadow: 0 0 15px rgba(138, 43, 226, 0.8);
        }

        .rarity-r {
            background: linear-gradient(45deg, #4169e1, #0000ff);
            color: white;
            text-shadow: 0 0 15px rgba(65, 105, 225, 0.8);
        }

        .rarity-n {
            background: linear-gradient(45deg, #808080, #555555);
            color: white;
        }

        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        /* å® ç‰©åç§°ç‰¹æ®Šæ˜¾ç¤º */
        .pet-name-base {
            color: #e0e0e0;
            font-weight: bold;
        }

        .pet-name-trait {
            color: #4a9eff;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(74, 158, 255, 0.6);
        }

        .pet-name-rarity {
            color: #ff6b6b;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(255, 107, 107, 0.6);
        }

        /* ç‰¹æ®Šæ ‡è®°æ ·å¼ */
        .rarity-legendary {
            color: #ffd700;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .rarity-epic {
            color: #8a2be2;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(138, 43, 226, 0.5);
        }

        .rarity-rare {
            color: #4169e1;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(65, 105, 225, 0.5);
        }

        .element-metal {
            color: #c0c0c0;
            font-weight: bold;
        }

        .element-wood {
            color: #228b22;
            font-weight: bold;
        }

        .element-water {
            color: #1e90ff;
            font-weight: bold;
        }

        .element-fire {
            color: #ff4500;
            font-weight: bold;
        }

        .element-earth {
            color: #8b4513;
            font-weight: bold;
        }

        .item-artifact {
            color: #ffd700;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
        }

        .item-treasure {
            color: #ff69b4;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(255, 105, 180, 0.6);
        }

        .item-medicine {
            color: #98fb98;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(152, 251, 152, 0.6);
        }

        .item-talisman {
            color: #dda0dd;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(221, 160, 221, 0.6);
        }

        .region-kunlun {
            color: #87ceeb;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(135, 206, 235, 0.6);
        }

        .region-penglai {
            color: #20b2aa;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(32, 178, 170, 0.6);
        }

        .region-yaochi {
            color: #4682b4;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(70, 130, 180, 0.6);
        }

        .region-worldtree {
            color: #32cd32;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(50, 205, 50, 0.6);
        }

        /* ç”Ÿç‰©æ ‡è®°æ ·å¼ */
        .creature-beast {
            color: #ff8c00;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(255, 140, 0, 0.6);
        }

        .creature-divine {
            color: #9370db;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(147, 112, 219, 0.6);
        }

        /* å–åç•Œé¢æ ·å¼ */
        .naming-container {
            text-align: center;
            padding: 20px;
        }

        .pet-name-input {
            width: 100%;
            max-width: 300px;
            padding: 15px 20px;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            color: #f5f5f5;
            font-size: 1.1em;
            text-align: center;
            backdrop-filter: blur(15px);
            font-weight: 400;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .pet-name-input:focus {
            outline: none;
            border-color: rgba(255, 215, 0, 0.7);
            background: rgba(255, 215, 0, 0.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .pet-name-input::placeholder {
            color: #888;
            font-style: italic;
        }

        .naming-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .naming-buttons .choice-button {
            flex: 1;
            max-width: 140px;
            padding: 12px 20px;
            font-size: 0.95em;
        }

        .naming-hint {
            color: #aaa;
            font-size: 0.85em;
            font-style: italic;
            margin-top: 10px;
        }

        /* å¯¹è¯æ¡†æ ·å¼ */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .dialog-overlay.show {
            opacity: 1;
        }

        .dialog-box {
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }

        .dialog-overlay.show .dialog-box {
            transform: scale(1);
        }

        .dialog-title {
            color: #ffd700;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .dialog-content {
            color: #e0e0e0;
            font-size: 1.0em;
            line-height: 1.6;
            margin-bottom: 25px;
            text-align: center;
        }

        .dialog-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .dialog-button {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 10px 20px;
            color: #ffd700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95em;
            font-weight: 400;
        }

        .dialog-button:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: rgba(255, 215, 0, 0.6);
            transform: translateY(-2px);
        }

        /* ç‚¹å‡»ç»§ç»­æç¤º */
        .click-to-continue {
            text-align: center;
            color: #ffd700;
            font-size: 0.9em;
            margin-top: 20px;
            animation: pulse 2s infinite;
            cursor: pointer;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .pet-description {
            font-size: 1.1em;
            color: #ccc;
            line-height: 1.8;
            margin-top: 20px;
            text-align: justify;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        /* çŠ¶æ€æ˜¾ç¤º */
        .status-display {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            border-radius: 15px;
            padding: 15px 20px;
            backdrop-filter: blur(10px);
            font-size: 0.9em;
            color: #aaa;
            z-index: 1000;
        }

        .status-item {
            margin-bottom: 5px;
        }

        .status-value {
            color: #ffd700;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            color: #ffd700;
            font-size: 1.1em;
        }

        .loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .game-title {
                font-size: 2em;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
        }
        /* å‰§æƒ…æ ‡è¯†æ ä¸å¾½æ ‡ */
        .meta-badge {
            display: inline-block;
            padding: 6px 10px;
            font-size: 0.82em;
            color: #e6e6e6;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 999px;
            background: rgba(0,0,0,0.35);
            backdrop-filter: blur(10px);
            letter-spacing: 0.2px;
        }
        .meta-badge[data-key="scene"] { border-color: rgba(135,206,250,0.45); color: #a8d8ff; }
        .meta-badge[data-key="actors"] { border-color: rgba(255,182,193,0.45); color: #ffc7d8; }
        .meta-badge[data-key="task"] { border-color: rgba(255,215,0,0.45); color: #ffe27a; }
        .meta-badge[data-key="plot"] { border-color: rgba(186,85,211,0.45); color: #e7b3ff; }
        .meta-badge[data-key="item"] { border-color: rgba(144,238,144,0.45); color: #bff2bf; }
        /* ä¸­å¿ƒåŒºåŸŸä»…æ–‡å­—æ¼”å‡ºï¼šéšè—å® ç‰©å±•ç¤º */
        .pet-reveal { display: none !important; }
    /* åœºæ™¯æ°›å›´å±‚ï¼šç”¨ CSS å˜é‡é©±åŠ¨æ¡çº¹æ¸å˜ï¼Œéšå‰§æƒ…åˆ‡æ¢ */
.scene-aura {
  position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background: linear-gradient(135deg, var(--aura-1, rgba(255,0,0,0.08)), var(--aura-2, rgba(255,140,0,0.08)));
  mask-image: repeating-linear-gradient(90deg, rgba(0,0,0,0.15) 0 4px, transparent 4px 10px);
}
/* ä¸­å¿ƒåŒºåŸŸä»…æ–‡å­—æ¼”å‡ºï¼šéšè—å® ç‰©å±•ç¤ºï¼ˆè‹¥å­˜åœ¨ï¼‰ */
.pet-reveal { display: none !important; }

/* çº¯æ–‡å­—åœºæ™¯æ¼”å‡ºå±‚ */
.text-scene-layer {
  position: fixed; inset: 0; pointer-events: none; z-index: 1;
  font-family: 'Courier New', monospace;
  color: rgba(255,255,255,0.1);
  overflow: hidden;
}

.scene-text-effect {
  position: absolute;
  font-size: 0.8em;
  line-height: 1;
  animation: sceneFloat 8s infinite ease-in-out;
  text-shadow: 0 0 3px currentColor;
}

@keyframes sceneFloat {
  0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
  50% { transform: translateY(-15px) rotate(5deg); opacity: 0.8; }
}

.scene-rain { animation: rainFall 3s linear infinite; }
@keyframes rainFall {
  0% { transform: translateY(-20px); opacity: 0; }
  10% { opacity: 0.6; }
  90% { opacity: 0.6; }
  100% { transform: translateY(100vh); opacity: 0; }
}

.scene-fire { 
  color: rgba(255,100,0,0.4);
  animation: fireFlicker 1.5s ease-in-out infinite alternate;
}
@keyframes fireFlicker {
  0% { transform: scale(1) rotate(-2deg); opacity: 0.3; }
  100% { transform: scale(1.1) rotate(2deg); opacity: 0.7; }
}

.scene-snow {
  color: rgba(200,230,255,0.3);
  animation: snowDrift 6s linear infinite;
}
@keyframes snowDrift {
  0% { transform: translateY(-20px) translateX(0px); opacity: 0; }
  10% { opacity: 0.8; }
  90% { opacity: 0.8; }
  100% { transform: translateY(100vh) translateX(30px); opacity: 0; }
}

.scene-wind {
  animation: windSway 4s ease-in-out infinite;
}
@keyframes windSway {
  0%, 100% { transform: translateX(0px) rotate(0deg); }
  50% { transform: translateX(10px) rotate(3deg); }
}

/* æ–‡å­—åœºæ™¯è½®å»“ */
.text-landscape {
  position: absolute;
  font-family: 'Courier New', monospace;
  font-size: 0.7em;
  line-height: 0.8;
  color: rgba(255,255,255,0.08);
  white-space: pre;
  pointer-events: none;
}

.landscape-mountain {
  bottom: 20%;
  left: 10%;
  animation: breathe 6s ease-in-out infinite;
}

.landscape-tree {
  bottom: 30%;
  right: 15%;
  animation: treeWave 8s ease-in-out infinite;
}

@keyframes breathe {
  0%, 100% { opacity: 0.05; transform: scale(1); }
  50% { opacity: 0.12; transform: scale(1.02); }
}

@keyframes treeWave {
  0%, 100% { transform: rotate(0deg); }
  50% { transform: rotate(1deg); }
}
</style>
</head>
<body>
    <div class="scene-aura"></div>
    <div class="text-scene-layer" id="textSceneLayer"></div>
    <div class="particles" id="particles"></div>
    
    <!-- å³ä¸Šè§’æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
        <button class="control-btn" id="btnStoryStart">å¼€å§‹æ•…äº‹</button>
        <button class="control-btn" id="btnRestart">é‡æ–°å¼€å§‹</button>
        <button class="control-btn" id="btnPanel">é¢æ¿</button>
    </div>

    <!-- å·¦ä¸‹è§’çŠ¶æ€æ˜¾ç¤º -->
    <div class="status-display">
        <div class="status-item">æ—¶é•¿: <span class="status-value" id="gameTime">00:00</span></div>
        <div class="status-item">å® ç‰©: <span class="status-value" id="petCount">0</span></div>
        <div class="status-item">ç¨€æœ‰: <span class="status-value" id="bestRarity">-</span></div>
        <div class="status-item">è¿›åŒ–: <span class="status-value" id="evolutionCount">0</span></div>
        <div class="status-item">æ¢ç´¢å€¼: <span class="status-value" id="explorationValue">100</span></div>
        <div class="status-item">å½“æ—¥æ—¥å¸¸: <span class="status-value" id="dailyCountDisplay">0</span></div>
    </div>

    <!-- æ²‰æµ¸å¼ä¸»èˆå° -->
    <!-- å³ä¸Šè§’æ–‡å­—é¢æ¿ï¼ˆå±•å¼€åæ˜¾ç¤ºä»»åŠ¡/é“å…·/çŠ¶æ€ï¼‰ -->
    <div id="sideDrawer" style="position: fixed; top: 70px; right: 20px; z-index: 999; display: none; background: rgba(0,0,0,0.7); border: 1px solid #333; border-radius: 12px; padding: 14px 16px; color: #ddd; min-width: 240px; backdrop-filter: blur(8px);">
        <div style="font-size: 0.95em; color: #ffd700; margin-bottom: 8px;">é¢æ¿</div>
        <div id="panelTasks" style="margin-bottom: 10px;">
            <div style="color:#bbb; font-size:0.9em;">ä»»åŠ¡</div>
            <div id="taskList" style="margin-top:6px;"></div>
        </div>
        <div id="panelItems" style="margin-bottom: 10px;">
            <div style="color:#bbb; font-size:0.9em;">é“å…·</div>
            <div id="itemList" style="margin-top:6px;"></div>
        </div>
        <div id="panelStatus">
            <div style="color:#bbb; font-size:0.9em;">çŠ¶æ€</div>
            <div id="statusText" style="margin-top:6px;"></div>
        </div>
        <div id="panelMenu" style="margin-top: 12px;">
            <div onclick="toggleSubmenu('gameActions')" style="color:#87ceeb; font-size:1em; cursor:pointer; padding:8px; background:rgba(70,130,180,0.2); border-radius:6px; margin:4px 0;">ğŸ® æ¸¸æˆæ“ä½œ â–¼</div>
            <div id="gameActions" style="margin-left:12px; display:none;">
                <button onclick="startAdventure()" style="width:100%; padding:6px; margin:2px 0; background:rgba(42,74,107,0.8); color:#e0e0e0; border:1px solid #4a6b8a; border-radius:4px; cursor:pointer;">å¼€å§‹å†’é™©</button>
                <button onclick="triggerDaily()" style="width:100%; padding:6px; margin:2px 0; background:rgba(42,74,107,0.8); color:#e0e0e0; border:1px solid #4a6b8a; border-radius:4px; cursor:pointer;">æ—¥å¸¸äº’åŠ¨</button>
                <button onclick="triggerBattle()" style="width:100%; padding:6px; margin:2px 0; background:rgba(42,74,107,0.8); color:#e0e0e0; border:1px solid #4a6b8a; border-radius:4px; cursor:pointer;">çµå¢ƒå¯¹å†³</button>
                <button onclick="showPetInteraction()" style="width:100%; padding:6px; margin:2px 0; background:rgba(42,74,107,0.8); color:#e0e0e0; border:1px solid #4a6b8a; border-radius:4px; cursor:pointer;">ä¸å® ç‰©äº’åŠ¨</button>
            </div>
            
            <div onclick="toggleSubmenu('petManage')" style="color:#87ceeb; font-size:1em; cursor:pointer; padding:8px; background:rgba(70,130,180,0.2); border-radius:6px; margin:4px 0;">ğŸ¾ å® ç‰©ç®¡ç† â–¼</div>
            <div id="petManage" style="margin-left:12px; display:none;">
                <button onclick="viewCharacteristics()" style="width:100%; padding:6px; margin:2px 0; background:rgba(42,74,107,0.8); color:#e0e0e0; border:1px solid #4a6b8a; border-radius:4px; cursor:pointer;">æŸ¥çœ‹å±æ€§</button>
                <button onclick="openStory()" style="width:100%; padding:6px; margin:2px 0; background:rgba(42,74,107,0.8); color:#e0e0e0; border:1px solid #4a6b8a; border-radius:4px; cursor:pointer;">å¼€å§‹æ•…äº‹</button>
            </div>
            
            <div onclick="toggleSubmenu('systemMenu')" style="color:#87ceeb; font-size:1em; cursor:pointer; padding:8px; background:rgba(70,130,180,0.2); border-radius:6px; margin:4px 0;">âš™ï¸ ç³»ç»ŸåŠŸèƒ½ â–¼</div>
            <div id="systemMenu" style="margin-left:12px; display:none;">
                <button onclick="saveGame()" style="width:100%; padding:6px; margin:2px 0; background:rgba(42,74,107,0.8); color:#e0e0e0; border:1px solid #4a6b8a; border-radius:4px; cursor:pointer;">ä¿å­˜æ¸¸æˆ</button>
                <button onclick="loadGame()" style="width:100%; padding:6px; margin:2px 0; background:rgba(42,74,107,0.8); color:#e0e0e0; border:1px solid #4a6b8a; border-radius:4px; cursor:pointer;">åŠ è½½æ¸¸æˆ</button>
                <button onclick="showHelp()" style="width:100%; padding:6px; margin:2px 0; background:rgba(42,74,107,0.8); color:#e0e0e0; border:1px solid #4a6b8a; border-radius:4px; cursor:pointer;">æ¸¸æˆå¸®åŠ©</button>
            </div>
        </div>
    </div>

    <div class="immersive-container">
        <div class="story-stage">
            <div class="story-meta" id="storyMeta" style="margin-bottom: 16px; display: none;">
                <div style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center;">
                    <span class="meta-badge" data-key="scene">åœºæ™¯ï¼š-</span>
                    <span class="meta-badge" data-key="actors">å¯¹è±¡ï¼š-</span>
                    <span class="meta-badge" data-key="task">ä»»åŠ¡ï¼š-</span>
                    <span class="meta-badge" data-key="plot">å‰§æƒ…ï¼š-</span>
                    <span class="meta-badge" data-key="item">é“å…·ï¼š-</span>
                </div>
            </div>
            <div class="story-content" id="storyContent">
                <div class="loading">æ­£åœ¨å”¤é†’ä¸–ç•Œæ ‘çš„è®°å¿†</div>
            </div>
            <div class="choices-container" id="choicesContainer" style="display: none;">
                <!-- é€‰æ‹©æŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="pet-reveal" id="petReveal" style="display: none;">
                <!-- å® ç‰©å±•ç¤ºå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            startTime: Date.now(),
            currentPet: null,
            petCount: 0,
            evolutionCount: 0,
            bestRarity: 'N',
            gamePhase: 'intro', // intro, choosing, playing
            exp: 0,
            bond: 0,
            lastProgress: null,
            exploration: 100, // å½“æ—¥æ¢ç´¢å€¼
            dailyCount: 0,    // å½“æ—¥æ—¥å¸¸æ•…äº‹è®¡æ•°
            lastDay: new Date().toDateString(),
            storyLoop: false,
            loopHandle: null,
            tasks: [],
            items: [],
            chatCount: 0
        };

        // åˆå§‹åŒ–ç²’å­æ•ˆæœ
        function initParticles() {
            const particlesContainer = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // æ›´æ–°æ¸¸æˆæ—¶é—´
        function updateGameTime() {
            const elapsed = Date.now() - gameState.startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            document.getElementById('gameTime').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // æ˜¾ç¤ºæ•…äº‹æ–‡æœ¬ï¼ˆä¸€è¡Œä¸€è¡Œæµ®ç°ï¼‰
        function showStoryLines(lines, container, callback) {
            container.innerHTML = '';
            lines.forEach((line, index) => {
                setTimeout(() => {
                    const lineElement = document.createElement('div');
                    lineElement.className = 'story-line';
                    lineElement.textContent = line;
                    container.appendChild(lineElement);
                    
                    // è§¦å‘æ˜¾ç¤ºåŠ¨ç”»
                    setTimeout(() => {
                        lineElement.classList.add('show');
                    }, 100);
                    
                    // æœ€åä¸€è¡Œæ˜¾ç¤ºå®Œæˆåæ‰§è¡Œå›è°ƒ
                    if (index === lines.length - 1) {
                        setTimeout(() => {
                            if (callback) callback();
                        }, 800);
                    }
                }, index * 1000);
            });
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            const introLines = [
                { text: "çµå¢ƒæ–—å® å½•", class: "title" },
                { text: "AIé©±åŠ¨çš„æ–‡å­—å® ç‰©å…»æˆæ¸¸æˆ", class: "subtitle" },
                { text: "ä½œè€…: æ ‘æ | å¾®ä¿¡: wzq8083", class: "author" },
                { text: "åœ¨é¥è¿œçš„è™šæ— ä¹‹ä¸­ï¼Œä¸€é¢—å¤è€çš„ä¸–ç•Œæ ‘ç§å­ç¼“ç¼“é£˜è½...", class: "normal" },
                { text: "ç§å­è§¦åŠå¤§åœ°çš„ç¬é—´ï¼Œæ— æ•°çš„å¯èƒ½æ€§å¦‚èŠ±æœµèˆ¬ç»½æ”¾ã€‚", class: "normal" },
                { text: "å±±æµ·ç»ä¸­çš„ç¥å…½ã€ä¸Šå¤çš„ç²¾çµã€ä¼ è¯´çš„é¾™æ—...", class: "normal" },
                { text: "å®ƒä»¬éƒ½åœ¨è¿™ç‰‡æ–°ç”Ÿçš„åœŸåœ°ä¸Šç­‰å¾…ç€ä¸ä½ ç›¸é‡ã€‚", class: "normal" },
                { text: "ç°åœ¨ï¼Œè¯·è†å¬å†…å¿ƒçš„å£°éŸ³ï¼Œåšå‡ºä½ çš„é€‰æ‹©...", class: "normal" }
            ];

            const storyContent = document.getElementById('storyContent');
            showStoryLinesWithClasses(introLines, storyContent, () => {
                setTimeout(() => {
                    showChoices();
                }, 1000);
            });
        }

        // æ˜¾ç¤ºå¸¦æ ·å¼ç±»çš„æ•…äº‹æ–‡æœ¬
        function showStoryLinesWithClasses(lines, container, callback) {
            container.innerHTML = '';
            lines.forEach((line, index) => {
                setTimeout(() => {
                    const lineElement = document.createElement('div');
                    lineElement.className = `story-line ${line.class}`;
                    // ä½¿ç”¨innerHTMLè€Œä¸æ˜¯textContentæ¥æ”¯æŒHTMLæ ‡è®°
                    lineElement.innerHTML = line.text;
                    container.appendChild(lineElement);
                    try { container.scrollTop = container.scrollHeight; } catch {}
                    
                    // è§¦å‘æ˜¾ç¤ºåŠ¨ç”»
                    setTimeout(() => {
                        lineElement.classList.add('show');
                    }, 200);
                    
                    // æœ€åä¸€è¡Œæ˜¾ç¤ºå®Œæˆåæ‰§è¡Œå›è°ƒ
                    if (index === lines.length - 1 && callback) {
                        setTimeout(callback, 1500);
                    }
                }, index * 1500); // å¢åŠ é—´éš”æ—¶é—´ï¼Œè¥é€ æ›´å¥½çš„æ¼”å‡ºæ•ˆæœ
            });
        }

        // æ˜¾ç¤ºé€‰æ‹©
        function showChoices() {
            // æ‰©å±•çš„é€‰æ‹©æ± ï¼ŒåŒ…å«æ›´å¤šéšæœºå…ƒç´ 
            const basePool = [
                { text: "æˆ‘å¬åˆ°äº†å¤è€çš„é¾™åŸå£°ï¼Œä»¿ä½›æ¥è‡ªæ—¶é—´çš„æ·±å¤„ï¼Œå……æ»¡äº†å¨ä¸¥ä¸ç¥ç§˜...", type: "dragon", rarity: 0.15 },
                { text: "æˆ‘æ„Ÿå—åˆ°äº†è‡ªç„¶çš„å‘¼å”¤ï¼ŒèŠ±è‰æ ‘æœ¨éƒ½åœ¨å‘æˆ‘è¯‰è¯´ç€ç”Ÿå‘½çš„å¥¥ç§˜...", type: "nature", rarity: 0.1 },
                { text: "æˆ‘çœ‹è§äº†æ˜Ÿç©ºä¸­çš„å¹»è±¡ï¼Œæ— æ•°çš„å¯èƒ½æ€§åœ¨è™šç©ºä¸­é—ªçƒç€å…‰èŠ’...", type: "mystic", rarity: 0.12 },
                { text: "å¤œå¹•ä½å‚ï¼Œå½±å­åœ¨æ—é—´ç©¿æ¢­ï¼Œä½ ä»¿ä½›å¬è§æ®‹å½±å‘¼å”¤â€¦", type: "shadow", rarity: 0.08 },
                { text: "æ—¶é—´åƒæ°´æµå€’è½¬ï¼Œå¤è€çš„é’Ÿé¸£åœ¨å¿ƒåº•å›å“â€¦", type: "chrono", rarity: 0.2 },
                { text: "ç¾¤æ˜Ÿç¼“ç¼“æ—‹è½¬ï¼Œå¤©è±¡ä¼¼åœ¨æš—ç¤ºå‘½è¿çš„åˆ†å²”â€¦", type: "stellar", rarity: 0.18 },
                { text: "æ½®æ±æ‹å²¸ï¼Œä½ åœ¨é›¾æµ·ä¸­çœ‹è§å·¨é²²çš„è½®å»“â€¦", type: "ocean", rarity: 0.14 },
                { text: "è¿œæ–¹å±±è„‰éœ‡åŠ¨ï¼Œå²©åœŸä¹‹åŠ›å›åº”ä½ çš„è„šæ­¥â€¦", type: "earth", rarity: 0.06 },
                { text: "ç‚½ç„°å‡è…¾ï¼Œç«ç¾½åœ¨ç©ºä¸­åˆ’å‡ºç¼äº®çš„è½¨è¿¹â€¦", type: "flame", rarity: 0.11 },
                { text: "å¯’éœœé™ä¸´ï¼Œæ™¶èŠ±åœ¨æŒ‡å°–ç»½æ”¾â€¦", type: "frost", rarity: 0.09 },
                { text: "é›·éœ†è´¯ç©ºï¼Œç”µçº¹åœ¨åœ°é¢èœ¿èœ’â€¦", type: "thunder", rarity: 0.13 },
                { text: "çµæ³‰æ¶ŒåŠ¨ï¼Œä½ æ„Ÿåˆ°çµè¯†è¢«è½»è§¦â€¦", type: "spirit", rarity: 0.07 }
            ];

            // éšæœºäº‹ä»¶æ±  - ä½æ¦‚ç‡è§¦å‘ç‰¹æ®Šé€‰é¡¹
            const specialEvents = [
                { text: "â€» ä¸–ç•Œæ ‘çš„æå¶çªç„¶å‘å…‰ï¼Œä½ æ„Ÿå—åˆ°äº†åˆ›ä¸–çš„åŠ›é‡åœ¨å¬å”¤...", type: "genesis", rarity: 0.5 },
                { text: "â€» è™šç©ºè£‚ç¼å‡ºç°ï¼Œå¼‚ç•Œçš„æ°”æ¯ä»ä¸­æ¶Œå‡º...", type: "void", rarity: 0.4 },
                { text: "â€» è¿œå¤å°å°æ¾åŠ¨ï¼Œè¢«ç¦é”¢çš„ç¥å…½å‘å‡ºä½åŸ...", type: "ancient", rarity: 0.45 },
                { text: "â€» å‘½è¿ä¹‹è½®è½¬åŠ¨ï¼Œä½ å¬è§äº†å®¿å‘½çš„å‘¼å”¤...", type: "destiny", rarity: 0.35 },
                { text: "â€» æ··æ²Œä¹‹åŠ›æ¶ŒåŠ¨ï¼ŒåŸå§‹çš„åˆ›é€ åŠ›åœ¨ä½ å‘¨å›´èšé›†...", type: "chaos", rarity: 0.3 }
            ];

            // ç¯å¢ƒå˜åŒ–å½±å“é€‰æ‹©
            const timeOfDay = new Date().getHours();
            const isNight = timeOfDay >= 18 || timeOfDay <= 6;
            const isMidnight = timeOfDay >= 23 || timeOfDay <= 1;
            
            let pool = [...basePool];
            
            // å¤œæ™šå¢åŠ æš—ç³»é€‰æ‹©æƒé‡
            if (isNight) {
                pool.forEach(choice => {
                    if (['shadow', 'mystic', 'void', 'chaos'].includes(choice.type)) {
                        choice.rarity += 0.05;
                    }
                });
            }
            
            // åˆå¤œæ—¶åˆ†æœ‰æ¦‚ç‡è§¦å‘ç‰¹æ®Šäº‹ä»¶
            if (isMidnight && Math.random() < 0.3) {
                pool.push(...specialEvents);
            }
            
            // éšæœºæ·»åŠ ç‰¹æ®Šäº‹ä»¶ï¼ˆä½æ¦‚ç‡ï¼‰
            if (Math.random() < 0.15) {
                const randomEvent = specialEvents[Math.floor(Math.random() * specialEvents.length)];
                pool.push(randomEvent);
            }

            // æ ¹æ®ç¨€æœ‰åº¦æƒé‡é€‰æ‹©
            const count = Math.floor(3 + Math.random() * 2); // 3-4ä¸ªé€‰é¡¹
            const choices = [];
            const usedIndices = new Set();
            
            while (choices.length < count && choices.length < pool.length) {
                let selectedIndex;
                let attempts = 0;
                
                do {
                    // ä½¿ç”¨æƒé‡éšæœºé€‰æ‹©
                    const rand = Math.random();
                    selectedIndex = pool.findIndex((choice, index) => {
                        if (usedIndices.has(index)) return false;
                        return rand < choice.rarity;
                    });
                    
                    if (selectedIndex === -1) {
                        // å¦‚æœæƒé‡é€‰æ‹©å¤±è´¥ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªæœªä½¿ç”¨çš„
                        const availableIndices = pool.map((_, i) => i).filter(i => !usedIndices.has(i));
                        if (availableIndices.length > 0) {
                            selectedIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
                        }
                    }
                    attempts++;
                } while (usedIndices.has(selectedIndex) && attempts < 10);
                
                if (selectedIndex !== -1 && !usedIndices.has(selectedIndex)) {
                    choices.push(pool[selectedIndex]);
                    usedIndices.add(selectedIndex);
                }
            }
            
            // å¦‚æœé€‰æ‹©ä¸è¶³ï¼Œè¡¥å……éšæœºé€‰æ‹©
            while (choices.length < 3) {
                const availableChoices = pool.filter((_, i) => !usedIndices.has(i));
                if (availableChoices.length === 0) break;
                
                const randomChoice = availableChoices[Math.floor(Math.random() * availableChoices.length)];
                choices.push(randomChoice);
                usedIndices.add(pool.indexOf(randomChoice));
            }

            const choicesContainer = document.getElementById('choicesContainer');
            choicesContainer.innerHTML = '';
            
            choices.forEach((choice, index) => {
                setTimeout(() => {
                    const button = document.createElement('button');
                    button.className = 'choice-button';
                    button.textContent = choice.text;
                    button.addEventListener('click', () => selectChoice(choice));
                    button.style.opacity = '0';
                    button.style.transform = 'translateY(20px)';
                    choicesContainer.appendChild(button);
                    
                    // å»¶è¿Ÿæ˜¾ç¤ºåŠ¨ç”»
                    setTimeout(() => {
                        button.style.transition = 'all 0.8s ease';
                        button.style.opacity = '1';
                        button.style.transform = 'translateY(0)';
                    }, 100);
                }, index * 500);
            });

            choicesContainer.style.display = 'block';
            setTimeout(() => {
                choicesContainer.classList.add('show');
            }, 500);
        }

        // é€‰æ‹©å¤„ç†
        async function selectChoice(choice) {
            // æ·¡å‡ºé€‰æ‹©æŒ‰é’®
            const choicesContainer = document.getElementById('choicesContainer');
            choicesContainer.style.transition = 'all 0.8s ease';
            choicesContainer.style.opacity = '0';
            choicesContainer.style.transform = 'translateY(-20px)';
            
            setTimeout(() => {
                choicesContainer.style.display = 'none';
                
                const loadingLines = [
                    { text: "ä½ çš„é€‰æ‹©å¼•èµ·äº†ä¸–ç•Œæ ‘çš„å…±é¸£...", class: "normal" },
                    { text: "ç¥ç§˜çš„åŠ›é‡æ­£åœ¨ä¸ºä½ å¯»æ‰¾æœ€åˆé€‚çš„ä¼™ä¼´...", class: "normal" },
                    { text: "è¯·ç¨ç­‰ï¼Œå¥‡è¿¹å³å°†é™ä¸´...", class: "normal" }
                ];

                const storyContent = document.getElementById('storyContent');
                showStoryLinesWithClasses(loadingLines, storyContent, () => {
                    generatePet(choice.type);
                });
            }, 800);
        }

        // ç”Ÿæˆå® ç‰©
        async function generatePet(choiceType) {
            try {
                // æ¨¡æ‹ŸAIç”Ÿæˆè¿‡ç¨‹
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // æ ¹æ®é€‰æ‹©ç±»å‹ç”Ÿæˆå® ç‰©
                const pet = await mockPetGeneration(choiceType);
                
                // æ›´æ–°æ¸¸æˆçŠ¶æ€ï¼ˆä¸­å¿ƒä¸å±•ç¤ºå® ç‰©ï¼Œä¿¡æ¯æ”¶æ‹¢åˆ°å³ä¸Šè§’é¢æ¿ï¼‰
                gameState.currentPet = pet;
                gameState.petCount++;
                updateBestRarity(pet.rarity);
                updateStats();
                try { renderPetInfoInPanel(); } catch {}
                
                // ç›´æ¥æ˜¾ç¤ºå® ç‰©æ•…äº‹ï¼Œè·³è¿‡å–åç¯èŠ‚
                pet.displayName = pet.name; // ç›´æ¥ä½¿ç”¨ç”Ÿæˆçš„åç§°
                showPetStory(pet);
                
            } catch (error) {
                console.error('ç”Ÿæˆå® ç‰©å¤±è´¥:', error);
                showError('ç”Ÿæˆå® ç‰©æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // æ¨¡æ‹Ÿå® ç‰©ç”Ÿæˆï¼ˆæœ¬åœ°ç‰ˆæœ¬ï¼‰
        async function mockPetGeneration(choiceType) {
            // å¢å¼ºçš„ç¨€æœ‰åº¦ç³»ç»Ÿ - æ ¹æ®é€‰æ‹©ç±»å‹è°ƒæ•´æ¦‚ç‡
            let rarityModifier = 0;
            const specialTypes = ['genesis', 'void', 'ancient', 'destiny', 'chaos'];
            
            if (specialTypes.includes(choiceType)) {
                rarityModifier = 0.1; // ç‰¹æ®Šäº‹ä»¶å¢åŠ ç¨€æœ‰åº¦
            }
            
            // æ—¶é—´å› ç´ å½±å“ç¨€æœ‰åº¦
            const hour = new Date().getHours();
            if (hour >= 23 || hour <= 1) rarityModifier += 0.05; // åˆå¤œåŠ æˆ
            if (hour >= 6 && hour <= 8) rarityModifier += 0.03; // é»æ˜åŠ æˆ
            
            // éšæœºå¹¸è¿åŠ æˆ
            if (Math.random() < 0.1) rarityModifier += 0.08; // 10%æ¦‚ç‡å¹¸è¿åŠ æˆ
            
            const rarityRoll = Math.random() - rarityModifier;
            let rarity, rarityClass;
            
            if (rarityRoll < 0.005) {
                rarity = 'LEGEND';
                rarityClass = 'rarity-legend';
            } else if (rarityRoll < 0.02) {
                rarity = 'SSS';
                rarityClass = 'rarity-sss';
            } else if (rarityRoll < 0.08) {
                rarity = 'SSR';
                rarityClass = 'rarity-ssr';
            } else if (rarityRoll < 0.20) {
                rarity = 'SR';
                rarityClass = 'rarity-sr';
            } else if (rarityRoll < 0.45) {
                rarity = 'R';
                rarityClass = 'rarity-r';
            } else {
                rarity = 'N';
                rarityClass = 'rarity-n';
            }

            const petTemplates = {
                dragon: {
                    species: ['ç«é¾™', 'å†°é¾™', 'é›·é¾™', 'æš—é¾™', 'å…‰é¾™', 'é’é¾™', 'é‡‘é¾™', 'é“¶é¾™', 'é»‘é¾™', 'ç™½é¾™', 'è¡€é¾™', 'éª¨é¾™'],
                    attributes: ['çƒˆç„°', 'å¯’å†°', 'é›·é¸£', 'æš—å½±', 'åœ£å…‰', 'æ¯ç­', 'åˆ›é€ ', 'æ··æ²Œ', 'ç§©åº', 'è™šæ— '],
                    specials: ['ç»è¿¹', 'ä¼ è¯´', 'å¤è€', 'ç¥ç§˜', 'æ°¸æ’', 'ä¸æœ½', 'è‡³å°Š', 'éœ¸ä¸»', 'å¸ç‹', 'ç¥åœ£'],
                    emoji: 'ğŸ‰',
                    baseDescription: 'æ¥è‡ªé¾™ç•Œçš„å¤è€å­˜åœ¨ï¼Œæ‹¥æœ‰ç€è¶…è¶Šæ—¶é—´çš„æ™ºæ…§å’ŒåŠ›é‡ã€‚'
                },
                nature: {
                    species: ['æœ¨ç²¾', 'èŠ±ä»™', 'æ ‘çµ', 'è‰å¦–', 'è—¤æ€ª', 'æ£®ç‹', 'èŠ±ç¥', 'æ ‘ç¥–', 'å¶å¦–', 'æ ¹é­”', 'æœçµ', 'è•¨ä»™'],
                    attributes: ['ç”Ÿæœº', 'æ²»æ„ˆ', 'æˆé•¿', 'ç¹èŒ‚', 'æ–°ç”Ÿ', 'å‡‹é›¶', 'è½®å›', 'å­£èŠ‚', 'ä¸°æ”¶', 'æ¯è£'],
                    specials: ['ç›ç„¶', 'ç¿ ç»¿', 'èŠ¬èŠ³', 'èŒ‚ç››', 'ç”Ÿæœº', 'åŸå§‹', 'é‡æ€§', 'çº¯å‡€', 'å’Œè°', 'æ°¸ç”Ÿ'],
                    emoji: 'ğŸŒ¿',
                    baseDescription: 'è‡ªç„¶ä¹‹å­ï¼Œä¸å¤§åœ°å’Œè°å…±ç”Ÿï¼Œæ‹¥æœ‰æ²»æ„ˆå’Œæˆé•¿çš„ç¥å¥‡åŠ›é‡ã€‚'
                },
                mystic: {
                    species: ['å¹»çµ', 'æ˜Ÿå…½', 'è™šå½±', 'æ¢¦é­‡', 'æ—¶çµ', 'ç©ºçµ', 'é­‚ä½“', 'æ„å¿µ', 'é¢„è¨€', 'å åœ', 'å‘½è¿', 'å› æœ'],
                    attributes: ['å¹»è±¡', 'æ˜Ÿå…‰', 'è™šæ— ', 'æ¢¦å¢ƒ', 'æ—¶é—´', 'ç©ºé—´', 'çµé­‚', 'æ„è¯†', 'é¢„çŸ¥', 'å®¿å‘½'],
                    specials: ['ç¥ç§˜', 'ç¼¥ç¼ˆ', 'è™šå¹»', 'æ°¸æ’', 'æ— é™', 'è¶…è„±', 'è§‰é†’', 'å¯ç¤º', 'çœŸç†', 'æ™ºæ…§'],
                    emoji: 'âœ¨',
                    baseDescription: 'æ¥è‡ªè™šç©ºçš„ç¥ç§˜å­˜åœ¨ï¼ŒæŒæ¡ç€ç°å®ä¸å¹»è±¡ä¹‹é—´çš„å¥¥ç§˜ã€‚'
                },
                genesis: {
                    species: ['åˆ›ä¸–', 'åŸåˆ', 'æ··æ²Œ', 'å¤ªåˆ', 'å¼€å¤©', 'è¾Ÿåœ°', 'é€ ç‰©', 'ç”Ÿå‘½', 'æ„å¿—', 'æœ¬æº'],
                    attributes: ['åˆ›é€ ', 'æ¯ç­', 'é‡ç”Ÿ', 'æ¼”åŒ–', 'èµ·æº', 'ç»ˆç»“', 'å¾ªç¯', 'å¹³è¡¡', 'å’Œè°', 'ç»Ÿä¸€'],
                    specials: ['è‡³é«˜', 'æ— ä¸Š', 'å”¯ä¸€', 'ç»å¯¹', 'å®Œç¾', 'æ°¸æ’', 'æ— é™', 'å…¨çŸ¥', 'å…¨èƒ½', 'è¶…è¶Š'],
                    emoji: 'ğŸŒŸ',
                    baseDescription: 'ä¸–ç•Œæ ‘çš„ç›´ç³»åè£”ï¼Œæ‹¥æœ‰åˆ›é€ å’Œæ¯ç­ä¸–ç•Œçš„ç»ˆæåŠ›é‡ã€‚'
                },
                void: {
                    species: ['è™šç©º', 'æ·±æ¸Š', 'é»‘æ´', 'è£‚éš™', 'ç©ºæ— ', 'æ¹®ç­', 'åå™¬', 'å¯‚ç­', 'ç»ˆæœ«', 'å½’å¢Ÿ'],
                    attributes: ['è™šæ— ', 'åå™¬', 'æ¹®ç­', 'å¯‚é™', 'ç©ºæ´', 'é»‘æš—', 'å†·å¯‚', 'ç»æœ›', 'ç»ˆç»“', 'å½’é›¶'],
                    specials: ['ç¦å¿Œ', 'ææ€–', 'æœªçŸ¥', 'æ·±é‚ƒ', 'æ— åº•', 'æ°¸æš—', 'å¯‚ç­', 'ç»ˆæ', 'ç»å¯¹', 'è¶…è„±'],
                    emoji: 'ğŸ•³ï¸',
                    baseDescription: 'æ¥è‡ªè™šç©ºæ·±æ¸Šçš„å­˜åœ¨ï¼Œä»£è¡¨ç€ç»ˆæçš„è™šæ— ä¸å¯‚ç­ã€‚'
                },
                ancient: {
                    species: ['è¿œå¤', 'ä¸Šå¤', 'å¤ªå¤', 'æ´ªè’', 'å…ˆæ°‘', 'ç¥–çµ', 'å¤ç¥', 'æ—§æ—¥', 'å°å°', 'é—è¿¹'],
                    attributes: ['å¤è€', 'æ²§æ¡‘', 'åšé‡', 'æ·±é‚ƒ', 'ç¥ç§˜', 'å¨ä¸¥', 'åº„é‡', 'è‚ƒç©†', 'ç¥åœ£', 'ä¸æœ½'],
                    specials: ['è¿œå¤', 'ä¼ è¯´', 'ç¥è¯', 'å²è¯—', 'æ°¸æ’', 'ä¸æœ½', 'ç¥åœ£', 'è‡³å°Š', 'æ— ä¸Š', 'è¶…å‡¡'],
                    emoji: 'ğŸ›ï¸',
                    baseDescription: 'ä»è¿œå¤æ—¶ä»£è‹é†’çš„å­˜åœ¨ï¼Œæ‰¿è½½ç€è¢«é—å¿˜çš„å¤è€æ™ºæ…§ã€‚'
                },
                destiny: {
                    species: ['å‘½è¿', 'å®¿å‘½', 'å¤©å‘½', 'å› æœ', 'è½®å›', 'åŠ«æ•°', 'å¤©é“', 'æ³•åˆ™', 'è§„å¾‹', 'ç§©åº'],
                    attributes: ['å‘½è¿', 'å®¿å‘½', 'å› æœ', 'è½®å›', 'å¤©é“', 'æ³•åˆ™', 'ç§©åº', 'å¹³è¡¡', 'æ­£ä¹‰', 'å®¡åˆ¤'],
                    specials: ['ä¸å¯è¿', 'å¿…ç„¶', 'ç»å¯¹', 'æ°¸æ’', 'æ— å¯é€ƒ', 'å¤©å®š', 'æ³¨å®š', 'å®¿å‘½', 'å› æœ', 'è½®å›'],
                    emoji: 'âš–ï¸',
                    baseDescription: 'å‘½è¿çš„åŒ–èº«ï¼ŒæŒæ¡ç€å› æœè½®å›çš„ç»ˆææ³•åˆ™ã€‚'
                },
                chaos: {
                    species: ['æ··æ²Œ', 'æ— åº', 'ç‹‚ä¹±', 'ç–¯ç‹‚', 'æ‰­æ›²', 'å˜å¼‚', 'çªå˜', 'å¼‚åŒ–', 'ç•¸å˜', 'è¯¡å¼‚'],
                    attributes: ['æ··ä¹±', 'æ— åº', 'ç‹‚æš´', 'ç–¯ç‹‚', 'æ‰­æ›²', 'å˜å¼‚', 'ä¸ç¨³', 'éšæœº', 'çªå˜', 'å¼‚å¸¸'],
                    specials: ['ä¸å¯é¢„æµ‹', 'å˜å¹»', 'è¯¡å¼‚', 'ç–¯ç‹‚', 'æ··ä¹±', 'æ— åº', 'æ‰­æ›²', 'å¼‚åŒ–', 'çªå˜', 'æœªçŸ¥'],
                    emoji: 'ğŸŒ€',
                    baseDescription: 'æ··æ²Œçš„äº§ç‰©ï¼Œæ‹¥æœ‰æ— æ³•é¢„æµ‹çš„å˜åŒ–èƒ½åŠ›ã€‚'
                }
            };

            const typeMap = {
                shadow: 'mystic',
                chrono: 'mystic',
                stellar: 'mystic',
                spirit: 'mystic',
                ocean: 'nature',
                earth: 'nature',
                flame: 'dragon',
                frost: 'dragon',
                thunder: 'dragon'
            };
            const resolvedType = petTemplates[choiceType] ? choiceType : (typeMap[choiceType] || 'nature');
            const template = petTemplates[resolvedType];
            const species = template.species[Math.floor(Math.random() * template.species.length)];
            const attribute = template.attributes[Math.floor(Math.random() * template.attributes.length)];
            const special = template.specials[Math.floor(Math.random() * template.specials.length)];

            // æ ¹æ®ç¨€æœ‰åº¦è°ƒæ•´å±æ€§
            const rarityMultiplier = {
                'SSS': 2.0,
                'SSR': 1.5,
                'SR': 1.3,
                'R': 1.1,
                'N': 1.0
            };
            
            const multiplier = rarityMultiplier[rarity];
            
            return {
                id: Date.now().toString(),
                name: `${species}*${attribute}*${special}`,
                species: species,
                attribute: attribute,
                special: special,
                rarity: rarity,
                rarityClass: rarityClass,
                emoji: template.emoji,
                description: template.baseDescription,
                attributes: {
                    hp: Math.floor((80 + Math.floor(Math.random() * 40)) * multiplier),
                    attack: Math.floor((15 + Math.floor(Math.random() * 20)) * multiplier),
                    defense: Math.floor((10 + Math.floor(Math.random() * 15)) * multiplier),
                    speed: Math.floor((8 + Math.floor(Math.random() * 12)) * multiplier),
                    magic: Math.floor((12 + Math.floor(Math.random() * 18)) * multiplier)
                },
                lore: generatePetLore(species, attribute, special, rarity),
                customName: null,
                displayName: null
            };
        }

        // ç”Ÿæˆå® ç‰©èƒŒæ™¯æ•…äº‹
        function generatePetLore(species, attribute, special, rarity) {
            const loreTemplates = {
                'SSS': `ä¼ è¯´ä¸­çš„${species}ï¼Œæ‹¥æœ‰${attribute}ä¹‹åŠ›ï¼Œè¢«èª‰ä¸º${special}çš„å­˜åœ¨ã€‚æ®å¤ç±è®°è½½ï¼Œåªæœ‰åœ¨ä¸–ç•Œæ ‘ç§å­é™ä¸´æ—¶ï¼Œæ‰ä¼šæœ‰å¦‚æ­¤ç¥åœ£çš„ç”Ÿçµè¯ç”Ÿã€‚å®ƒçš„åŠ›é‡è¶³ä»¥æ”¹å˜æ•´ä¸ªä¸–ç•Œçš„å‘½è¿ã€‚`,
                'SSR': `ç¨€æœ‰çš„${species}ï¼ŒæŒæ¡ç€${attribute}çš„å¥¥ç§˜ï¼Œæ˜¯${special}çš„åŒ–èº«ã€‚åœ¨æ— æ•°ä¸ªçºªå…ƒä¸­ï¼Œåªæœ‰æå°‘æ•°çš„å‹‡è€…èƒ½å¤Ÿè·å¾—å®ƒçš„è®¤å¯ã€‚`,
                'SR': `çè´µçš„${species}ï¼Œå…·æœ‰${attribute}çš„ç‰¹è´¨ï¼Œå±•ç°å‡º${special}çš„å“æ ¼ã€‚å®ƒæ¥è‡ªä¸–ç•Œæ ‘çš„æ·±å±‚æ„è¯†ï¼Œæ‰¿è½½ç€å¤è€çš„è®°å¿†ã€‚`,
                'R': `ä¼˜ç§€çš„${species}ï¼Œæ‹¥æœ‰${attribute}çš„èƒ½åŠ›ï¼Œä½“ç°äº†${special}çš„ç²¾ç¥ã€‚è™½ç„¶ä¸æ˜¯æœ€ç¨€æœ‰çš„å­˜åœ¨ï¼Œä½†åŒæ ·å€¼å¾—çæƒœã€‚`,
                'N': `æ™®é€šçš„${species}ï¼Œå…·å¤‡åŸºç¡€çš„${attribute}åŠ›é‡ï¼Œè™½ç„¶${special}ç¨‹åº¦ä¸€èˆ¬ï¼Œä½†æ¯ä¸ªç”Ÿå‘½éƒ½æœ‰å…¶ç‹¬ç‰¹çš„ä»·å€¼ã€‚`
            };

            return loreTemplates[rarity] || loreTemplates['N'];
        }

        // æ˜¾ç¤ºå® ç‰©
        function displayPet(pet) {
            const petReveal = document.getElementById('petReveal');
            petReveal.innerHTML = `
                <div class="pet-avatar" style="border-color: ${getRarityColor(pet.rarity)};">
                    <img id="petImage" alt="å½¢è±¡" style="width:120px;height:120px;border-radius:50%;display:none"/>
                    <span id="petEmoji">${pet.emoji}</span>
                </div>
                <div class="pet-name-container">
                    <input type="text" class="pet-custom-name" placeholder="ä¸ºä½ çš„ä¼™ä¼´èµ·ä¸ªåå­—..." maxlength="20" id="customPetName">
                    <div class="pet-attributes">(${pet.species} Â· ${pet.rarity}çº§ Â· ${pet.attributes.hp}HP)</div>
                    <button class="name-confirm-btn" id="btnConfirmName">ç¡®è®¤å‘½å</button>
                    <button class="name-confirm-btn" id="btnGenAvatar" style="margin-left:8px;">ç”Ÿæˆå½¢è±¡</button>
                </div>
                <div class="pet-rarity ${pet.rarityClass}" style="display: none;" id="petRarityDisplay">${pet.rarity}</div>
                <div class="pet-description" style="font-size: 0.95em;">${pet.description}</div>
                <div class="pet-description" style="margin-top: 15px; font-style: italic; opacity: 0.8; font-size: 0.9em;">
                    ${pet.lore}
                </div>
            `;
            
            petReveal.style.display = 'block';
            setTimeout(() => {
                petReveal.classList.add('show');
                const nameInput = document.getElementById('customPetName');
                const confirmBtn = document.getElementById('btnConfirmName');
                const genBtn = document.getElementById('btnGenAvatar');
                if (nameInput) {
                  nameInput.focus();
                  nameInput.addEventListener('keydown', (ev) => {
                    if (ev.key === 'Enter') confirmPetName();
                  });
                }
                if (confirmBtn) confirmBtn.addEventListener('click', confirmPetName);
                if (genBtn) genBtn.addEventListener('click', generatePetImage);
            }, 500);
        }

        // ç¡®è®¤å® ç‰©å‘½åï¼ˆå¢å¼ºåé¦ˆï¼‰
        function confirmPetName() {
            try {
                const inputEl = document.getElementById('customPetName');
                const petReveal = document.getElementById('petReveal');
                const pet = gameState.currentPet;
                if (!petReveal || !pet) {
                    alert('è¿˜æ²¡æœ‰ç”Ÿæˆå® ç‰©ï¼Œè¯·å…ˆé€‰æ‹©åˆ†æ”¯è·å¾—ä¼™ä¼´ã€‚');
                    return;
                }
                const customName = (inputEl && inputEl.value ? inputEl.value.trim() : '');

                // åº”ç”¨æ˜¾ç¤ºåï¼ˆç©ºååˆ™ä½¿ç”¨é»˜è®¤ï¼‰
                if (customName) {
                    pet.customName = customName;
                    pet.displayName = `${pet.species}Â·<span style="color: #4a9eff">${pet.attribute || 'æ–°ç”Ÿ'}</span>Â·<span style="color: #ff6b6b">${pet.rarity || 'N'}</span>`;
                } else {
                    // è§£æåŸå§‹åç§°ï¼Œåˆ†ç¦»ä¸»åå’Œè¯ç¼€
                    const nameParts = pet.name.split('Â·');
                    if (nameParts.length > 1) {
                        const mainName = nameParts[0];
                        const suffixes = nameParts.slice(1);
                        pet.displayName = `${mainName}Â·<span style="color: #4a9eff">${suffixes[0] || 'æ–°ç”Ÿ'}</span>Â·<span style="color: #ff6b6b">${suffixes[1] || pet.rarity || 'N'}</span>`;
                    } else {
                        pet.displayName = `${pet.name}Â·<span style="color: #4a9eff">æ–°ç”Ÿ</span>Â·<span style="color: #ff6b6b">${pet.rarity || 'N'}</span>`;
                    }
                }

                // ç«‹å³æ›´æ–°å±•ç¤ºå¹¶ç»™å‡ºæ¸…æ™°åé¦ˆ
                petReveal.innerHTML = `
                    <div class="pet-avatar" style="border-color: ${getRarityColor(pet.rarity)};">
                        ${pet.emoji}
                    </div>
                    <div class="pet-name ${pet.rarityClass}">${pet.displayName}</div>
                    <div class="pet-rarity ${pet.rarityClass}">${pet.rarity}</div>
                    <div class="pet-description" style="font-size: 0.95em;">${pet.description}</div>
                    <div class="pet-description" style="margin-top: 15px; font-style: italic; opacity: 0.8; font-size: 0.9em;">
                        ${pet.lore}
                    </div>
                    <div class="pet-description" style="margin-top: 18px; line-height: 1.7;">
                        å±æ€§è¯¦æƒ…ï¼š<br/>
                        â€¢ ç”Ÿå‘½å€¼: ${pet.attributes.hp}<br/>
                        â€¢ æ”»å‡»åŠ›: ${pet.attributes.attack}<br/>
                        â€¢ é˜²å¾¡åŠ›: ${pet.attributes.defense}<br/>
                        â€¢ é€Ÿåº¦: ${pet.attributes.speed}<br/>
                        â€¢ é­”åŠ›: ${pet.attributes.magic}
                    </div>
                `;
                // è‡ªåŠ¨å¼€å§‹æ•…äº‹å¾ªç¯
                startStoryLoop();
            } catch (e) {
                console.error('ç¡®è®¤å‘½åå¼‚å¸¸:', e);
                alert('å‘½åæ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œè¯·é‡è¯•ã€‚');
            }
        }

        // è¾“å…¥æ¡†æ”¯æŒå›è½¦ç¡®è®¤
        document.addEventListener('DOMContentLoaded', () => {
            const el = document.getElementById('customPetName');
            if (el) {
                el.addEventListener('keydown', (ev) => {
                    if (ev.key === 'Enter') {
                        confirmPetName();
                    }
                });
            }
        });

        // æ˜¾ç¤ºå® ç‰©å±æ€§
        function showPetStats() {
            const pet = gameState.currentPet;
            const statsText = `
å±æ€§è¯¦æƒ…ï¼š
â€¢ ç”Ÿå‘½å€¼: ${pet.attributes.hp}
â€¢ æ”»å‡»åŠ›: ${pet.attributes.attack}
â€¢ é˜²å¾¡åŠ›: ${pet.attributes.defense}
â€¢ é€Ÿåº¦: ${pet.attributes.speed}
â€¢ é­”åŠ›: ${pet.attributes.magic}`;
            
            alert(statsText);
        }

        // å¼€å§‹å†’é™©
        async function generatePetImage() {
            try {
                const pet = gameState.currentPet;
                if (!pet) return alert('è¯·å…ˆç”Ÿæˆå® ç‰©');
                const resp = await fetch('/api/media/pet-image', {
                    method: 'POST',
                    headers: { 'Content-Type':'application/json' },
                    body: JSON.stringify({ pet: {
                      name: pet.name,
                      displayName: pet.displayName || '',
                      rarity: pet.rarity
                    }})
                });
                const data = await resp.json();
                const img = document.getElementById('petImage');
                const emoji = document.getElementById('petEmoji');
                if (data.ok && data.url) {
                  img.src = data.url;
                  img.style.display = 'inline-block';
                  if (emoji) emoji.style.display = 'none';
                } else {
                  alert('å½¢è±¡ç”Ÿæˆæš‚ä¸å¯ç”¨ï¼Œå·²ä½¿ç”¨é»˜è®¤å›¾æ ‡');
                }
            } catch (e) {
                console.error('generatePetImage error:', e);
                alert('å½¢è±¡ç”Ÿæˆå¤±è´¥ï¼Œå·²ä½¿ç”¨é»˜è®¤å›¾æ ‡');
            }
        }

        // å…³é”®ä¿¡æ¯æ ‡è¯†ï¼šåœºæ™¯/å¯¹è±¡/ä»»åŠ¡/å‰§æƒ…/é“å…·ï¼ˆå¹¶è‡ªåŠ¨è”åŠ¨æ°›å›´ä¸æ’­æŠ¥ï¼‰
        function setStoryMeta(meta) {
            try {
                const box = document.getElementById('storyMeta');
                if (!box) return;
                const map = { scene:'åœºæ™¯', actors:'å¯¹è±¡', task:'ä»»åŠ¡', plot:'å‰§æƒ…', item:'é“å…·' };
                const setOne = (key, val) => {
                    const el = box.querySelector(`.meta-badge[data-key="${key}"]`);
                    if (el) el.textContent = `${map[key]}ï¼š${val && String(val).trim() ? String(val) : '-'}`;
                };
                setOne('scene', meta?.scene || '-');
                setOne('actors', Array.isArray(meta?.actors) ? meta.actors.join('ã€') : (meta?.actors || '-'));
                setOne('task', meta?.task || '-');
                setOne('plot', meta?.plot || '-');
                setOne('item', meta?.item || '-');

                // è‡ªåŠ¨æ˜ å°„ï¼šæ ¹æ® scene å…³é”®è¯åˆ‡æ¢æ°›å›´ï¼Œå¹¶æ¨é€æ–°é—»æ’­æŠ¥
                try {
                    const sceneText = String(meta?.scene || '').toLowerCase();
                    let key = 'forest';
                    if (/[ç«å±±|å²©æµ†|ç†”|ç‚½ç„°]/.test(sceneText)) key = 'volcano';
                    else if (/[å¤©ç©º|äº‘|ä¸´ç•Œ|é«˜ç©º|é£]/.test(sceneText)) key = 'sky';
                    else if (/[æ²™æ¼ |è’åŸ|æˆˆå£]/.test(sceneText)) key = 'desert';
                    else if (/[æ—|é’æœ¨|è¥åœ°|æ¹–|æºª]/.test(sceneText)) key = 'forest';
                    if (typeof setSceneVisuals === 'function') setSceneVisuals(key);
                    if (typeof window.pushNews === 'function') {
                        const actors = Array.isArray(meta?.actors) ? meta.actors.join('ã€') : (meta?.actors || '');
                        const task = meta?.task || '';
                        window.pushNews(`åœºæ™¯è½¬æ¢ï¼š${meta?.scene || '-'}ï¼›å¯¹è±¡ï¼š${actors || '-'}ï¼›ä»»åŠ¡ï¼š${task || '-'}`);
                    }
                } catch (e2) { console.error('metaâ†’visuals/news mapping error:', e2); }

                box.style.display = 'block';
            } catch (e) { console.error('setStoryMeta error:', e); }
        }

        async function startAdventure() {
            try {
                try { setSceneVisuals('forest'); window.pushNews && window.pushNews('å†’é™©å¯ç¨‹ï¼šé’æœ¨çµå¢ƒçš„æ—å¾„è½»å“ã€‚'); } catch {}
                const pet = gameState.currentPet ? {
                    name: gameState.currentPet.displayName || gameState.currentPet.name,
                    base_prompt: `${gameState.currentPet.species}Â·${gameState.currentPet.attribute || ''}`,
                    hp: gameState.currentPet.attributes?.hp || 100,
                    attack: gameState.currentPet.attributes?.attack || 20
                } : { name:'æ— å', base_prompt:'ç¥ç§˜ä¼™ä¼´', hp:100, attack:20 };
                const ctx = 'è½»é£æ‹‚é¢ï¼Œè¿œå¤„éšçº¦æœ‰æ°´æµå£°ã€‚';
                setStoryMeta({
                    scene: 'é’æœ¨çµå¢ƒÂ·æ—å¾„',
                    actors: [pet.name],
                    task: 'å†’é™©æ¢ç´¢',
                    plot: 'æ–‡æœ¬äº‹ä»¶',
                    item: '-'
                });
                let resp = await fetch('/api/adventure/text-event', {
                    method: 'POST',
                    headers: { 'Content-Type':'application/json' },
                    body: JSON.stringify({ pet, context: ctx })
                });
                // 404æˆ–å¤±è´¥è‡ªåŠ¨é™çº§åˆ°æ—¥å¸¸
                if (!resp.ok) {
                  showToast('å¥‡é‡æ¥å£æš‚ä¸å¯ç”¨ï¼Œå·²é™çº§ä¸ºæ—¥å¸¸äº’åŠ¨');
                  resp = await fetch('/api/daily/tick', {
                    method: 'POST',
                    headers: { 'Content-Type':'application/json' },
                    body: JSON.stringify({ pet, context: 'ä»Šæ—¥çš„ç®€å•é™ªä¼´ä¸ç…§æ–™ã€‚' })
                  });
                }
                const data = await resp.json();
                const storyContent = document.getElementById('storyContent');
                const lines = (data.event || 'ä½ çœºæœ›è¿œæ–¹ï¼Œå†³å®šç»§ç»­å‰è¡Œã€‚').split(/(?<=[ã€‚ï¼ï¼Ÿ])/).filter(s=>s.trim());
                showStoryLines(lines, storyContent, () => { applyProgress({ exp: 10, bond: 5 }); });
            } catch (e) {
                console.error('startAdventure error:', e);
                showToast('æ¨¡å‹æš‚ä¸å¯ç”¨ï¼Œæ¼”å‡ºä½¿ç”¨æœ¬åœ°æ–‡æ¡ˆ');
                // æœ€åé™çº§ä¸ºæœ¬åœ°å ä½æ–‡æœ¬
                const storyContent = document.getElementById('storyContent');
                const lines = ['ä½ è°ƒæ•´äº†å‘¼å¸ï¼Œå†³å®šä»å°äº‹åšèµ·ã€‚','è½»æŠšå®ƒçš„é¢å¤´ï¼Œå®ƒçš„å¿ƒæƒ…é€æ¸å¹³å¤ã€‚','ä½ ä»¬ç»§ç»­å‰è¡Œï¼Œä¸‹ä¸€æ¬¡é‚‚é€…æˆ–è®¸æ›´å¥‡å¦™ã€‚'];
                showStoryLines(lines, storyContent, () => {});
            }
        }

        // è·å–ç¨€æœ‰åº¦é¢œè‰²
        function getRarityColor(rarity) {
            const colors = {
                'SSS': '#ffd700',
                'SSR': '#ff4444',
                'SR': '#8a2be2',
                'R': '#4169e1',
                'N': '#808080'
            };
            return colors[rarity] || colors['N'];
        }

        // æ ¼å¼åŒ–å® ç‰©åç§°ï¼ˆç®€æ´ç‰ˆï¼Œåªæ˜¾ç¤ºåŸºç¡€åç§°ï¼‰
        function formatPetNameWithColors(name) {
            if (!name) return '<span class="pet-name-base">æœªçŸ¥çµå…½</span>';
            
            const parts = name.split('*');
            const baseName = parts[0] || name; // åªå–åŸºç¡€åç§°éƒ¨åˆ†
            return `<span class="pet-name-base">${baseName}</span>`;
        }

        // åº”ç”¨ç‰¹æ®Šæ ‡è®°åˆ°æ–‡æœ¬
        function applySpecialMarkers(text) {
            if (!text) return '';
            
            // ç¨€æœ‰åº¦æ ‡è®° - ä½¿ç”¨ç‰¹æ®Šç¬¦å·å’Œé¢œè‰²
            text = text.replace(/(ä¼ è¯´)/g, '<span class="rarity-legendary">âœ¦ $1 âœ¦</span>');
            text = text.replace(/(å²è¯—)/g, '<span class="rarity-epic">â—† $1 â—†</span>');
            text = text.replace(/(ç¨€æœ‰)/g, '<span class="rarity-rare">â—‡ $1 â—‡</span>');
            
            // å±æ€§æ ‡è®° - ä½¿ç”¨ç¬¦å·æ›¿ä»£emoji
            text = text.replace(/(é‡‘å±æ€§|é‡‘ç³»|é‡‘çµ)/g, '<span class="element-metal">âš¡ $1</span>');
            text = text.replace(/(æœ¨å±æ€§|æœ¨ç³»|æœ¨çµ)/g, '<span class="element-wood">â€» $1</span>');
            text = text.replace(/(æ°´å±æ€§|æ°´ç³»|æ°´çµ)/g, '<span class="element-water">â—ˆ $1</span>');
            text = text.replace(/(ç«å±æ€§|ç«ç³»|ç«çµ)/g, '<span class="element-fire">â—‰ $1</span>');
            text = text.replace(/(åœŸå±æ€§|åœŸç³»|åœŸçµ)/g, '<span class="element-earth">â— $1</span>');
            
            // é“å…·æ ‡è®° - ä½¿ç”¨ç‰¹æ®Šç¬¦å·
            text = text.replace(/(ç¥å™¨)/g, '<span class="item-artifact">âš” $1 âš”</span>');
            text = text.replace(/(ä»™å®)/g, '<span class="item-treasure">â—† $1 â—†</span>');
            text = text.replace(/(çµè¯)/g, '<span class="item-medicine">âœ¿ $1 âœ¿</span>');
            text = text.replace(/(ç¬¦å’’)/g, '<span class="item-talisman">â—ˆ $1 â—ˆ</span>');
            text = text.replace(/(å¤©é›·ç )/g, '<span class="item-artifact">âš¡ $1 âš¡</span>');
            text = text.replace(/(ç‘¶æ± èŠ±)/g, '<span class="item-medicine">âœ¿ $1 âœ¿</span>');
            
            // åœ°åŸŸæ ‡è®° - ä½¿ç”¨ç‰¹æ®Šç¬¦å·
            text = text.replace(/(æ˜†ä»‘)/g, '<span class="region-kunlun">â–² $1 â–²</span>');
            text = text.replace(/(è“¬è±)/g, '<span class="region-penglai">â— $1 â—</span>');
            text = text.replace(/(ç‘¶æ± )/g, '<span class="region-yaochi">â—ˆ $1 â—ˆ</span>');
            text = text.replace(/(ä¸–ç•Œæ ‘|å»ºæœ¨)/g, '<span class="region-worldtree">â€» $1 â€»</span>');
            
            // ç”Ÿç‰©æ ‡è®°
            text = text.replace(/(çµå…½|ç¥å…½|å¦–å…½)/g, '<span class="creature-beast">â—‰ $1 â—‰</span>');
            text = text.replace(/(é¾™|å‡¤|éº’éºŸ)/g, '<span class="creature-divine">âœ¦ $1 âœ¦</span>');
            
            return text;
        }

        // æ˜¾ç¤ºå® ç‰©è·å¾—æ•…äº‹ï¼ˆç®€æ´ç‰ˆï¼‰
        function showPetStory(pet) {
            // æ ¼å¼åŒ–å® ç‰©åç§°ï¼Œåªæ˜¾ç¤ºåŸºç¡€åç§°
            const formattedName = formatPetNameWithColors(pet.name);
            
            const storyLines = [
                { text: applySpecialMarkers("â€» ä¸–ç•Œæ ‘ â€» çš„å…‰èŠ’æ´’å‘å¤§åœ°ï¼Œä¸€ä¸ªç¥ç§˜çš„èº«å½±ç¼“ç¼“æµ®ç°..."), class: "normal" },
                { text: `"${formattedName}"ï¼Œè¿™å°±æ˜¯å®ƒçš„çœŸåã€‚`, class: "normal" },
                { text: applySpecialMarkers("ä½ æ„Ÿå—åˆ°äº†ä¸å®ƒä¹‹é—´çš„æ·±æ·±ç¾ç»Šï¼Œè¿™å°†æ˜¯ä¸€æ®µä¼ å¥‡çš„å¼€å§‹..."), class: "normal" },
                { text: "é€‰æ‹©ä½ ä»¬çš„ç¬¬ä¸€æ¬¡äº’åŠ¨æ–¹å¼ï¼š", class: "normal" }
            ];

            const storyContent = document.getElementById('storyContent');
            showStoryLinesWithClasses(storyLines, storyContent, () => {
                // ç›´æ¥æ˜¾ç¤ºAIäº’åŠ¨é€‰æ‹©
                setTimeout(() => {
                    showAIInteractionChoices(gameState.currentPet);
                }, 1000);
            });
        }

        // æ·»åŠ ç‚¹å‡»ç»§ç»­åŠŸèƒ½
        function addClickToContinue() {
            const storyContent = document.getElementById('storyContent');
            storyContent.style.cursor = 'pointer';
            
            const clickHandler = () => {
                storyContent.removeEventListener('click', clickHandler);
                storyContent.style.cursor = 'default';
                startTutorialInteraction();
            };
            
            storyContent.addEventListener('click', clickHandler);
        }

=======
        // å¼€å§‹æ–°æ‰‹å¼•å¯¼äº’åŠ¨
        function startTutorialInteraction() {
            const pet = gameState.currentPet;
            

        // å¼€å§‹æ–°æ‰‹å¼•å¯¼äº’åŠ¨
=======
        // å¼€å§‹æ–°æ‰‹å¼•å¯¼äº’åŠ¨
=======

        // æ˜¾ç¤ºå–åç•Œé¢
        function showNamingInterface(pet) {
            const storyContent = document.getElementById('storyContent');
            const choicesContainer = document.getElementById('choicesContainer');
            
            if (!storyContent || !choicesContainer) {
                console.error('Required elements not found!', { storyContent, choicesContainer });
                return;
            }
            
            // æ¸…ç©ºå†…å®¹
            storyContent.innerHTML = '';
            choicesContainer.innerHTML = '';
            
            // ç›´æ¥åœ¨æ•…äº‹åŒºåŸŸæ˜¾ç¤ºå–åç•Œé¢
            storyContent.innerHTML = `
                <div class="story-line title show">âœ¦ æ­å–œï¼${pet.species} å·²æˆä¸ºä½ çš„ä¼™ä¼´ï¼</div>
                <div class="story-line normal show">ç°åœ¨è®©æˆ‘ä»¬å¼€å§‹æ–°æ‰‹å¼•å¯¼ï¼Œå­¦ä¹ å¦‚ä½•ä¸ä½ çš„ â—‰ çµå…½ â—‰ ä¼™ä¼´äº’åŠ¨ã€‚</div>
                <div class="story-line normal show">åœ¨è¿™ä¸ªç”± â€» ä¸–ç•Œæ ‘ â€» æ”¯æ’‘çš„ç¥è¯ä¸–ç•Œä¸­ï¼Œä½ ä»¬å°†ä¸€èµ·æˆé•¿ã€å†’é™©ã€‚</div>
                <div class="story-line normal show">è¯·ä¸ºä½ çš„ä¼™ä¼´å–ä¸€ä¸ªæ±‰å­—åç§°ï¼š</div>
            `;
            
            // åœ¨é€‰æ‹©åŒºåŸŸæ˜¾ç¤ºå–åè¾“å…¥
            const namingDiv = document.createElement('div');
            namingDiv.className = 'naming-container';
            namingDiv.innerHTML = `
                <input type="text" id="petNameInput" class="pet-name-input" placeholder="è¯·è¾“å…¥æ±‰å­—åç§°" maxlength="6">
                <div class="naming-buttons">
                    <button class="choice-button" id="confirmNameBtn">ç¡®è®¤åç§°</button>
                    <button class="choice-button" id="randomNameBtn">éšæœºå–å</button>
                </div>
                <div class="naming-hint">åªå…è®¸è¾“å…¥æ±‰å­—ï¼Œ2-6ä¸ªå­—ç¬¦</div>
            `;
            
            choicesContainer.appendChild(namingDiv);
            choicesContainer.style.display = 'block';
            choicesContainer.classList.add('show');
            
            // ç«‹å³ç»‘å®šäº‹ä»¶
            setTimeout(() => {
                console.log('Trying to bind naming events...');
                const nameInput = document.getElementById('petNameInput');
                const confirmBtn = document.getElementById('confirmNameBtn');
                const randomBtn = document.getElementById('randomNameBtn');
                
                console.log('Found elements:', {nameInput, confirmBtn, randomBtn});
                console.log('choicesContainer display:', choicesContainer.style.display);
                console.log('choicesContainer visibility:', window.getComputedStyle(choicesContainer).visibility);
                
                if (nameInput && confirmBtn && randomBtn) {
                    // é™åˆ¶åªèƒ½è¾“å…¥æ±‰å­—
                    nameInput.addEventListener('input', (e) => {
                        const value = e.target.value;
                        const chineseOnly = value.replace(/[^\u4e00-\u9fa5]/g, '');
                        if (value !== chineseOnly) {
                            e.target.value = chineseOnly;
                        }
                    });
                    
                    // ç¡®è®¤åç§°
                    confirmBtn.addEventListener('click', () => {
                        const name = nameInput.value.trim();
                        if (name.length >= 2 && name.length <= 6) {
                            pet.customName = name;
                            pet.displayName = name;
                            showTutorialChoices();
                        } else {
                            alert('è¯·è¾“å…¥2-6ä¸ªæ±‰å­—ä½œä¸ºåç§°');
                        }
                    });
                    
                    // éšæœºå–å
                    randomBtn.addEventListener('click', () => {
                        const randomNames = ['é’äº‘', 'æ˜Ÿè¾°', 'æœˆå½±', 'é£å', 'é›ªè²', 'ç´«éœ', 'é‡‘ç¾½', 'é“¶ç¿¼', 'ç¢§æµ·', 'ä¸¹å¿ƒ'];
                        const randomName = randomNames[Math.floor(Math.random() * randomNames.length)];
                        nameInput.value = randomName;
                    });
                    
                    // å›è½¦ç¡®è®¤
                    nameInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            confirmBtn.click();
                        }
                    });
                    
                    // è‡ªåŠ¨èšç„¦
                    nameInput.focus();
                    console.log('Naming interface ready!');
                } else {
                    console.error('Failed to find naming elements');
                }
            }, 100);
        }

        // æ˜¾ç¤ºå–åè¾“å…¥æ¡†
        function showNamingInput(pet) {
            console.log('showNamingInput called with pet:', pet);
            const choicesContainer = document.getElementById('choicesContainer');
            
            if (!choicesContainer) {
                console.error('choicesContainer not found!');
                return;
            }
            
            choicesContainer.innerHTML = '';
            
            // åˆ›å»ºå–åè¾“å…¥åŒºåŸŸ
            const namingDiv = document.createElement('div');
            namingDiv.className = 'naming-container';
            namingDiv.innerHTML = `
                <input type="text" id="petNameInput" class="pet-name-input" placeholder="è¯·è¾“å…¥æ±‰å­—åç§°" maxlength="6">
                <div class="naming-buttons">
                    <button class="choice-button" id="confirmNameBtn">ç¡®è®¤åç§°</button>
                    <button class="choice-button" id="randomNameBtn">éšæœºå–å</button>
                </div>
                <div class="naming-hint">åªå…è®¸è¾“å…¥æ±‰å­—ï¼Œ2-6ä¸ªå­—ç¬¦</div>
            `;
            
            choicesContainer.appendChild(namingDiv);
            choicesContainer.style.display = 'block';
            choicesContainer.classList.add('show');
            
            console.log('Naming interface created, waiting for DOM update...');
            
            // å»¶è¿Ÿç»‘å®šäº‹ä»¶ï¼Œç¡®ä¿DOMå·²æ›´æ–°
            setTimeout(() => {
                const nameInput = document.getElementById('petNameInput');
                const confirmBtn = document.getElementById('confirmNameBtn');
                const randomBtn = document.getElementById('randomNameBtn');
                
                console.log('Elements found:', { nameInput, confirmBtn, randomBtn });
                
                if (!nameInput || !confirmBtn || !randomBtn) {
                    console.error('Some elements not found after timeout!');
                    return;
                }
                
                // é™åˆ¶åªèƒ½è¾“å…¥æ±‰å­—
                nameInput.addEventListener('input', (e) => {
                    const value = e.target.value;
                    const chineseOnly = value.replace(/[^\u4e00-\u9fa5]/g, '');
                    if (value !== chineseOnly) {
                        e.target.value = chineseOnly;
                    }
                });
                
                // ç¡®è®¤åç§°
                confirmBtn.addEventListener('click', () => {
                    const name = nameInput.value.trim();
                    console.log('Confirm clicked, name:', name);
                    if (name.length >= 2 && name.length <= 6) {
                        pet.customName = name;
                        pet.displayName = name;
                        console.log('Name set, showing tutorial choices...');
                        showTutorialChoices();
                    } else {
                        alert('è¯·è¾“å…¥2-6ä¸ªæ±‰å­—ä½œä¸ºåç§°');
                    }
                });
                
                // éšæœºå–å
                randomBtn.addEventListener('click', () => {
                    const randomNames = ['é’äº‘', 'æ˜Ÿè¾°', 'æœˆå½±', 'é£å', 'é›ªè²', 'ç´«éœ', 'é‡‘ç¾½', 'é“¶ç¿¼', 'ç¢§æµ·', 'ä¸¹å¿ƒ'];
                    const randomName = randomNames[Math.floor(Math.random() * randomNames.length)];
                    nameInput.value = randomName;
                    console.log('Random name set:', randomName);
                });
                
                // å›è½¦ç¡®è®¤
                nameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        confirmBtn.click();
                    }
                });
                
                // è‡ªåŠ¨èšç„¦
                nameInput.focus();
                console.log('Events bound and input focused');
            }, 100);
        }

        // æ˜¾ç¤ºæ–°æ‰‹å¼•å¯¼é€‰æ‹©ï¼ˆå›ºå®šä¸‰ä¸ªé€‰é¡¹ï¼‰
        function showTutorialChoices() {
            const choicesContainer = document.getElementById('choicesContainer');
            choicesContainer.innerHTML = '';
            
            const choices = [
                { 
                    text: "â— å¼€å§‹ç¬¬ä¸€æ¬¡å†’é™©", 
                    action: () => startFirstAdventure()
                },
                { 
                    text: "â—‰ ä¸ä¼™ä¼´æ·±å…¥äº¤æµ", 
                    action: () => startPetInteraction()
                },
                { 
                    text: "â—ˆ æŸ¥çœ‹ä¼™ä¼´å±æ€§", 
                    action: () => showDetailedStats()
                }
            ];
            
            choices.forEach((choice, index) => {
                setTimeout(() => {
                    const button = document.createElement('button');
                    button.className = 'choice-button';
                    button.textContent = choice.text;
                    button.addEventListener('click', choice.action);
                    button.style.opacity = '0';
                    button.style.transform = 'translateY(20px)';
                    choicesContainer.appendChild(button);
                    
                    setTimeout(() => {
                        button.style.transition = 'all 0.8s ease';
                        button.style.opacity = '1';
                        button.style.transform = 'translateY(0)';
                    }, 100);
                }, index * 200);
            });

            choicesContainer.style.display = 'block';
            setTimeout(() => {
                choicesContainer.classList.add('show');
            }, 300);
        }

        // æ›´æ–°æœ€ä½³ç¨€æœ‰åº¦
        function updateBestRarity(rarity) {
            const rarityOrder = ['N', 'R', 'SR', 'SSR', 'SSS'];
            const currentIndex = rarityOrder.indexOf(gameState.bestRarity);
            const newIndex = rarityOrder.indexOf(rarity);
            
            if (newIndex > currentIndex) {
                gameState.bestRarity = rarity;
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('petCount').textContent = gameState.petCount;
            document.getElementById('bestRarity').textContent = gameState.bestRarity;
            document.getElementById('evolutionCount').textContent = gameState.evolutionCount;
            const ev = document.getElementById('explorationValue');
            const dc = document.getElementById('dailyCountDisplay');
            if (ev) ev.textContent = gameState.exploration;
            if (dc) dc.textContent = gameState.dailyCount;
        }

        // æ¸¸æˆæ§åˆ¶å‡½æ•°
        function restartGame() {
            if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹æ¸¸æˆå—ï¼Ÿå½“å‰è¿›åº¦å°†ä¼šä¸¢å¤±ã€‚')) {
                gameState = {
                    startTime: Date.now(),
                    currentPet: null,
                    petCount: 0,
                    evolutionCount: 0,
                    bestRarity: 'N',
                    gamePhase: 'intro'
                };
                updateStats();
                startGame();
            }
        }

        function saveGame() {
            try {
                localStorage.setItem('spiritPetGame', JSON.stringify(gameState));
                alert('æ¸¸æˆå·²ä¿å­˜åˆ°æœ¬åœ°ï¼');
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
            }
        }

        function loadGame() {
            try {
                const saved = localStorage.getItem('spiritPetGame');
                if (saved) {
                    gameState = JSON.parse(saved);
                    updateStats();
                    if (gameState.currentPet) {
                        displayPet(gameState.currentPet);
                    }
                    alert('æ¸¸æˆå·²åŠ è½½ï¼');
                } else {
                    alert('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„æ¸¸æˆæ•°æ®ã€‚');
                }
            } catch (error) {
                alert('åŠ è½½å¤±è´¥ï¼š' + error.message);
            }
        }

        function showHelp() {
            alert(`ã€Šçµå¢ƒæ–—å® å½•ã€‹æ¸¸æˆå¸®åŠ©

ğŸ® æ¸¸æˆç©æ³•ï¼š
â€¢ é€šè¿‡é€‰æ‹©ä¸åŒçš„ç¥ç§˜æè¿°æ¥è·å¾—ç‹¬ç‰¹çš„å® ç‰©ä¼™ä¼´
â€¢ æ¯ä¸ªå® ç‰©éƒ½æœ‰ç‹¬ç‰¹çš„åç§°ã€å±æ€§å’ŒèƒŒæ™¯æ•…äº‹
â€¢ ç¨€æœ‰åº¦ä»ä½åˆ°é«˜ï¼šN < R < SR < SSR < SSS

ğŸŒŸ ç¨€æœ‰åº¦è¯´æ˜ï¼š
â€¢ SSS (ä¸ƒå½©è‰²): ä¼ è¯´çº§ï¼Œæå…¶ç¨€æœ‰
â€¢ SSR (çº¢è‰²): è¶…ç¨€æœ‰ï¼Œ1%æ¦‚ç‡
â€¢ SR (ç´«è‰²): ç¨€æœ‰
â€¢ R (è“è‰²): æ™®é€š
â€¢ N (ç°è‰²): å¸¸è§

ğŸ’¾ æœ¬åœ°æ¸¸ç©ï¼š
â€¢ æ— éœ€æ³¨å†Œï¼Œç›´æ¥æ¸¸ç©
â€¢ æ”¯æŒæœ¬åœ°ä¿å­˜å’ŒåŠ è½½
â€¢ æ•°æ®å­˜å‚¨åœ¨æµè§ˆå™¨ä¸­

ğŸ‘¨â€ğŸ’» ä½œè€…ä¿¡æ¯ï¼š
â€¢ ä½œè€…ï¼šæ ‘æ
â€¢ å¾®ä¿¡ï¼šwzq8083`);
        }

        function showError(message) {
            const storyContent = document.getElementById('storyContent');
            storyContent.innerHTML = `<div style="color: #ff4444; text-align: center; font-size: 1.2em;">${message}</div>`;
        }

        // è½»æç¤ºï¼ˆåº•éƒ¨çŸ­æš‚å‡ºç°ï¼‰
        function showToast(text) {
            try {
                let toast = document.getElementById('globalToast');
                if (!toast) {
                    toast = document.createElement('div');
                    toast.id = 'globalToast';
                    toast.style.position = 'fixed';
                    toast.style.bottom = '30px';
                    toast.style.left = '50%';
                    toast.style.transform = 'translateX(-50%)';
                    toast.style.background = 'rgba(0,0,0,0.7)';
                    toast.style.color = '#ffd700';
                    toast.style.padding = '10px 16px';
                    toast.style.border = '1px solid rgba(255,215,0,0.3)';
                    toast.style.borderRadius = '12px';
                    toast.style.fontSize = '0.9em';
                    toast.style.zIndex = '2000';
                    toast.style.backdropFilter = 'blur(6px)';
                    toast.style.boxShadow = '0 8px 20px rgba(0,0,0,0.4)';
                    document.body.appendChild(toast);
                }
                toast.textContent = text;
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.4s ease';
                requestAnimationFrame(() => {
                    toast.style.opacity = '1';
                });
                setTimeout(() => {
                    toast.style.opacity = '0';
                }, 2200);
            } catch (e) {
                console.error('showToast error:', e);
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        document.addEventListener('DOMContentLoaded', function() {
            initParticles();
            startGame();
            
            // å¼€å§‹è®¡æ—¶
            setInterval(updateGameTime, 1000);

            // ç»‘å®šæ§åˆ¶é¢æ¿äº‹ä»¶
            const btnRestart = document.getElementById('btnRestart');
            const btnSave = document.getElementById('btnSave');
            const btnLoad = document.getElementById('btnLoad');
            const btnHelp = document.getElementById('btnHelp');
            if (btnRestart) btnRestart.addEventListener('click', restartGame);
            if (btnSave) btnSave.addEventListener('click', saveGame);
            if (btnLoad) btnLoad.addEventListener('click', loadGame);
            if (btnHelp) btnHelp.addEventListener('click', showHelp);

            // å³ä¸Šè§’äº’åŠ¨æŒ‰é’®
            const btnStartAdventure = document.getElementById('btnStartAdventure');
            const btnDaily = document.getElementById('btnDaily');
            const btnBattle = document.getElementById('btnBattle');
            const btnStats = document.getElementById('btnStats');
            const btnPanel = document.getElementById('btnPanel');
            const btnPetChat = document.getElementById('btnPetChat');
            const btnStoryStart = document.getElementById('btnStoryStart');
            const btnStoryPause = document.getElementById('btnStoryPause');
            if (btnStartAdventure) btnStartAdventure.addEventListener('click', startAdventure);
            if (btnDaily) btnDaily.addEventListener('click', triggerDaily);
            if (btnBattle) btnBattle.addEventListener('click', triggerBattle);
            if (btnStats) btnStats.addEventListener('click', showPetStats);
            if (btnPanel) btnPanel.addEventListener('click', togglePanel);
            if (btnPetChat) btnPetChat.addEventListener('click', openPetChatGuide);
            if (btnStoryStart) btnStoryStart.addEventListener('click', startStoryLoop);
            if (btnStoryPause) btnStoryPause.addEventListener('click', stopStoryLoop);
        });
        async function triggerBattle() {
            try {
                try { setSceneVisuals('sky'); window.pushNews && window.pushNews('å¯¹å†³å¼€å¯ï¼šä¸´ç•Œä¹‹ç©ºé£èµ·äº‘æ¶Œã€‚'); } catch {}
                const pet = gameState.currentPet ? {
                    name: gameState.currentPet.displayName || gameState.currentPet.name,
                    base_prompt: `${gameState.currentPet.species}Â·${gameState.currentPet.attribute || ''}`,
                    hp: gameState.currentPet.attributes?.hp || 100,
                    attack: gameState.currentPet.attributes?.attack || 20,
                    defense: gameState.currentPet.attributes?.defense || 15,
                    speed: gameState.currentPet.attributes?.speed || 10,
                    magic: gameState.currentPet.attributes?.magic || 12
                } : { name:'æ— å', base_prompt:'ç¥ç§˜ä¼™ä¼´', hp:100, attack:20, defense:15, speed:10, magic:12 };
                setStoryMeta({
                    scene: 'ä¸´ç•ŒÂ·ç‹­è·¯',
                    actors: [pet.name, 'æœªçŸ¥å¯¹æ‰‹'],
                    task: 'çµå¢ƒå¯¹å†³',
                    plot: 'å›åˆæ¼”å‡º',
                    item: '-'
                });
                // å¼€åœºåŒ¹é…
                let resp = await fetch('/api/battle/match', {
                    method: 'POST',
                    headers: { 'Content-Type':'application/json' },
                    body: JSON.stringify({ pet })
                });
                let data = await resp.json();
                const storyContent = document.getElementById('storyContent');
                let lines = (data.intro || 'é£å‹åœ¨ç‹­è·¯ä¸­å›æ—‹ï¼Œä½ ä»¬å¯¹æœ›ç‰‡åˆ»ã€‚').split(/(?<=[ã€‚ï¼ï¼Ÿ])/).filter(s=>s.trim());
                showStoryLines(lines, storyContent, async () => {
                  try {
                    // å›åˆæ¼”å‡º
                    const resp2 = await fetch('/api/battle/resolve', {
                      method: 'POST',
                      headers: { 'Content-Type':'application/json' },
                      body: JSON.stringify({ pet, opponent: data.opponent })
                    });
                    const res2 = await resp2.json();
                    const lines2 = (res2.rounds || 'ä½ ä»¬å„é€€åŠæ­¥ï¼ŒåŠ¿å‡åŠ›æ•Œã€‚').split(/(?<=[ã€‚ï¼ï¼Ÿ])/).filter(s=>s.trim());
                    showStoryLines(lines2, storyContent, () => { const o = res2.outcome; applyProgress({ exp: o==='win' ? 12 : (o==='draw' ? 8 : 6), bond: o==='win' ? 6 : (o==='draw' ? 5 : 4) }); });
                  } catch (e2) {
                    console.error('battle resolve error:', e2);
                    const fallback = ['ä½ å…ˆæ‰‹æ¢æ­¥ï¼Œå½±ä¸é£ä¸€èµ·åˆºå‘å‰æ–¹ã€‚','å¯¹æ‰‹æŠ¬è‡‚æ ¼æŒ¡ï¼Œé’¢å£°æ²‰ç¨³ã€‚','åŒæ–¹å„é€€åŠæ­¥ï¼ŒåŠ¿å‡åŠ›æ•Œã€‚'];
                    showStoryLines(fallback, storyContent, () => {});
                  }
                });
            } catch (e) {
                console.error('triggerBattle error:', e);
                const storyContent = document.getElementById('storyContent');
                const fallback = ['ä½ è°ƒæ•´å‘¼å¸ï¼Œæš‚ç¼“äº¤é”‹ã€‚','ä¸‹ä¸€æ¬¡çš„è¾ƒé‡æˆ–è®¸æ›´ç²¾å½©ã€‚'];
                showStoryLines(fallback, storyContent, () => {});
            }
        }

        // æ•…äº‹å¾ªç¯ï¼šç»Ÿä¸€ç®¡ç† daily/special/sideï¼ˆå¥‡é‡ï¼‰/battle
        function startStoryLoop() {
            try {
                gameState.storyLoop = true;
                if (gameState.loopHandle) return;
                // æ¯æ®µæ•…äº‹ä¹‹é—´çš„é—´éš”ï¼ˆæ¯«ç§’ï¼‰
                gameState.loopHandle = setInterval(nextStoryTick, 6000);
                showToast('æ•…äº‹å¾ªç¯å·²å¼€å§‹');
            } catch (e) { console.error('startStoryLoop error:', e); }
        }
        function stopStoryLoop() {
            try {
                gameState.storyLoop = false;
                if (gameState.loopHandle) {
                    clearInterval(gameState.loopHandle);
                    gameState.loopHandle = null;
                }
                showToast('æ•…äº‹å¾ªç¯å·²æš‚åœ');
            } catch (e) { console.error('stopStoryLoop error:', e); }
        }
        function resetDailyIfNeeded() {
            const now = new Date().toDateString();
            if (gameState.lastDay !== now) {
                gameState.lastDay = now;
                gameState.dailyCount = 0;
                gameState.exploration = 100;
                const dcEl = document.getElementById('dailyCountDisplay');
                const exEl = document.getElementById('explorationValue');
                if (dcEl) dcEl.textContent = gameState.dailyCount;
                if (exEl) exEl.textContent = gameState.exploration;
            }
        }
        async function nextStoryTick() {
            try {
                resetDailyIfNeeded();
                if (!gameState.currentPet || !gameState.storyLoop) return;
                if (gameState.dailyCount >= 5 || gameState.exploration <= 0) {
                    stopStoryLoop();
                    showToast('å½“æ—¥å·²å®Œæˆï¼Œæ¢ç´¢å€¼è€—å°½');
                    return;
                }
                // è¯·æ±‚åç«¯ç»Ÿä¸€ç¼–æ’ï¼›å¤±è´¥åˆ™ä½¿ç”¨æœ¬åœ°ç”Ÿæˆ
                const pet = {
                    name: gameState.currentPet.displayName || gameState.currentPet.name,
                    base_prompt: `${gameState.currentPet.species}Â·${gameState.currentPet.attribute || ''}`,
                    hp: gameState.currentPet.attributes?.hp || 100,
                    attack: gameState.currentPet.attributes?.attack || 20
                };
                let resp, data;
                try {
                    resp = await fetch('/api/story/next', {
                        method: 'POST',
                        headers: { 'Content-Type':'application/json' },
                        body: JSON.stringify({ pet, state: { dailyCount: gameState.dailyCount, exploration: gameState.exploration } })
                    });
                    if (resp.ok) data = await resp.json();
                } catch {}
                const storyContent = document.getElementById('storyContent');
                const type = data?.type || pickLocalType(gameState.dailyCount);
                const text = data?.text || localStoryText(type);
                const lines = text.split(/(?<=[ã€‚ï¼ï¼Ÿ])/).filter(s=>s.trim());
                showStoryLines(lines, storyContent, () => {
                    if (type === 'daily') {
                        gameState.dailyCount += 1;
                        const dcEl = document.getElementById('dailyCountDisplay');
                        if (dcEl) dcEl.textContent = gameState.dailyCount;
                        applyProgress({ exp: 3, bond: 4 });
                    } else if (type === 'special') {
                        applyProgress({ exp: 8, bond: 6 });
                    } else if (type === 'side') {
                        applyProgress({ exp: 6, bond: 5 });
                    }
                    gameState.exploration = Math.max(0, gameState.exploration - (type === 'daily' ? 18 : type === 'special' ? 22 : 20));
                    const exEl = document.getElementById('explorationValue');
                    if (exEl) exEl.textContent = gameState.exploration;
                });
            } catch (e) {
                console.error('nextStoryTick error:', e);
            }
        }
        function pickLocalType(count) {
            const r = Math.random();
            if (count <= 1 && r < 0.2) return 'special';
            if (r < 0.15) return 'side';
            return 'daily';
        }
        function localStoryText(type) {
            const dailySamples = [
                'æ¸…æ™¨è–„é›¾æœªæ•£ï¼Œä½ ä¸å®ƒå¹¶è‚©åœ¨æ—å¾„ç¼“è¡Œï¼Œè½å¶è½»å“ã€‚',
                'åˆåå¾®é£æ‹‚è¿‡æ¹–é¢ï¼Œæ¶Ÿæ¼ªåƒå®ƒçš„ç¬‘æ„ä¸€æ ·æŸ”è½¯ã€‚',
                'é»„æ˜çš„äº‘è¢«æ™šéœæŸ“é€ï¼Œä½ ä»¬åœ¨æºªç•”ç»ƒä¹ è½»å·§çš„æ­¥ä¼ã€‚',
                'å¤œå¹•ä¸‹çš„ç¯ç«ç»†è¯­ï¼Œä½ è®²èµ·æ—§äº‹ï¼Œå®ƒå®‰é™å¬ç€ã€‚'
            ];
            const specialSamples = [
                'çµå…‰åœ¨å®ƒçš„çœ‰é—´æ±‡èšï¼Œä½ å¿½è§‰å…¶æ°”æ¯æ›´ç¨³ï¼Œåƒè¿æ¥ä¸€æ¬¡æ— å£°çš„å‡é˜¶ã€‚',
                'ä¸–ç•Œæ ‘çš„çº¹ç†çŸ­æš‚å‘äº®ï¼ŒæŸç§å¤©èµ‹ä¼¼è¢«å”¤é†’ã€‚'
            ];
            const sideSamples = [
                'å²”è·¯ä¼ æ¥æ¸…é“ƒï¼Œä½ å¾ªå£°è€Œå»ï¼Œé‡è§ä¸€ä½æç¯çš„æ—…äººã€‚',
                'æ—é—´æ®‹ç¢‘è¦†è‹”ï¼Œä½ ä»¬æŠšå»æµ®å°˜ï¼Œçœ‹è§å¤å­—éšçº¦ã€‚'
            ];
            const pick = arr => arr[Math.floor(Math.random()*arr.length)];
            if (type === 'special') return pick(specialSamples);
            if (type === 'side') return pick(sideSamples);
            return pick(dailySamples);
        }
        function togglePanel() {
            try {
                const panel = document.getElementById('sideDrawer');
                if (!panel) return;
                const visible = panel.style.display !== 'none';
                panel.style.display = visible ? 'none' : 'block';
                if (!visible) renderPanel();
            } catch (e) { console.error('togglePanel error:', e); }
        }
        function renderPanel() {
            try {
                const tasksEl = document.getElementById('taskList');
                const itemsEl = document.getElementById('itemList');
                const statusEl = document.getElementById('statusText');
                if (tasksEl) {
                    tasksEl.innerHTML = (gameState.tasks && gameState.tasks.length)
                      ? gameState.tasks.map((t,i)=>`â€¢ ${i+1}. ${t}`).join('<br/>')
                      : '<span style="color:#666">æš‚æ— ä»»åŠ¡</span>';
                }
                if (itemsEl) {
                    itemsEl.innerHTML = (gameState.items && gameState.items.length)
                      ? gameState.items.map((it,i)=>`â€¢ ${i+1}. ${it}`).join('<br/>')
                      : '<span style="color:#666">æš‚æ— é“å…·</span>';
                }
                if (statusEl) {
                    statusEl.innerHTML = `æ¢ç´¢å€¼ï¼š${gameState.exploration}<br/>å½“æ—¥æ—¥å¸¸ï¼š${gameState.dailyCount}/5<br/>è¿›åŒ–æ¬¡æ•°ï¼š${gameState.evolutionCount}`;
                }
            } catch (e) { console.error('renderPanel error:', e); }
        }

        // å°†å® ç‰©ä¿¡æ¯æ¸²æŸ“åˆ°å³ä¸Šè§’é¢æ¿
        function renderPetInfoInPanel() {
            try {
                const pet = gameState.currentPet;
                const el = document.getElementById('petInfoText');
                if (!el || !pet) return;
                const name = pet.displayName || pet.name || 'æœªå‘½å';
                const attrs = pet.attributes || {};
                el.innerHTML = `
<span style="color:#ffd700">åç§°ï¼š</span>${name}<br/>
<span style="color:#ffd700">ç¨€æœ‰ï¼š</span>${pet.rarity || '-'}<br/>
<span style="color:#ffd700">ç§ç±»ï¼š</span>${pet.species || '-'} / <span style="color:#ffd700">å±æ€§ï¼š</span>${pet.attribute || '-'}<br/>
<span style="color:#bbb">ç®€è¿°ï¼š</span>${pet.description || ''}<br/>
<span style="color:#ffd700">å±æ€§ï¼š</span>
ç”Ÿå‘½å€¼${attrs.hp ?? '-'}ã€æ”»å‡»${attrs.attack ?? '-'}ã€é˜²å¾¡${attrs.defense ?? '-'}ã€é€Ÿåº¦${attrs.speed ?? '-'}ã€é­”åŠ›${attrs.magic ?? '-'}
                `;
            } catch (e) { console.error('renderPetInfoInPanel error:', e); }
        }

        // åˆ‡æ¢åœºæ™¯æ°›å›´æ¡çº¹ï¼ˆç«å±±/å¤©ç©º/æ£®æ—/æ²™æ¼ ï¼‰+ çº¯æ–‡å­—åœºæ™¯æ¼”å‡º
        function setSceneVisuals(key) {
            const root = document.documentElement;
            const map = {
                volcano: ['rgba(255,60,60,0.14)','rgba(255,140,0,0.12)'],
                sky:     ['rgba(70,140,255,0.12)','rgba(160,120,255,0.10)'],
                forest:  ['rgba(60,200,120,0.10)','rgba(40,120,80,0.12)'],
                desert:  ['rgba(240,200,120,0.12)','rgba(200,160,80,0.10)']
            };
            const [c1, c2] = map[key] || map.forest;
            root.style.setProperty('--aura-1', c1);
            root.style.setProperty('--aura-2', c2);
            
            // å¯åŠ¨çº¯æ–‡å­—åœºæ™¯æ¼”å‡º
            renderTextScene(key);
        }

        // çº¯æ–‡å­—åœºæ™¯æ¼”å‡ºç³»ç»Ÿ
        function renderTextScene(sceneKey) {
            const layer = document.getElementById('textSceneLayer');
            if (!layer) return;
            
            // æ¸…é™¤æ—§æ•ˆæœ
            layer.innerHTML = '';
            
            const sceneEffects = {
                volcano: {
                    particles: ['â—†', 'â—‡', 'â–²', 'â–³', 'â—', 'â—‹'],
                    colors: ['rgba(255,100,0,0.4)', 'rgba(255,60,0,0.3)', 'rgba(255,140,0,0.2)'],
                    animation: 'scene-fire',
                    landscape: `    â–²â–²â–²
   â–²â–²â–²â–²â–²
  â–²â–²â–²â–²â–²â–²â–²
 â–²â–²â–²â–²â–²â–²â–²â–²â–²`,
                    count: 15
                },
                sky: {
                    particles: ['â˜', 'âœ¦', 'âœ§', 'â‹†', 'âˆ˜', 'â—¦'],
                    colors: ['rgba(200,230,255,0.3)', 'rgba(160,200,255,0.2)', 'rgba(220,240,255,0.4)'],
                    animation: 'scene-wind',
                    landscape: `  â˜  â˜â˜    â˜
    â˜    â˜â˜
â˜      â˜    â˜`,
                    count: 12
                },
                forest: {
                    particles: ['ğŸŒ¿', 'ğŸƒ', 'â—ˆ', 'â—‰', 'â¬¢', 'â¬¡'],
                    colors: ['rgba(100,200,100,0.3)', 'rgba(60,180,60,0.2)', 'rgba(80,220,80,0.4)'],
                    animation: 'scene-wind',
                    landscape: `    ğŸŒ²
   ğŸŒ²ğŸŒ²ğŸŒ²
  ğŸŒ²ğŸŒ²ğŸŒ²ğŸŒ²
 ğŸŒ²ğŸŒ²ğŸŒ²ğŸŒ²ğŸŒ²`,
                    count: 18
                },
                desert: {
                    particles: ['â—¦', 'âˆ˜', 'â‹„', 'â—Š', 'â–«', 'â–ª'],
                    colors: ['rgba(240,200,120,0.3)', 'rgba(220,180,100,0.2)', 'rgba(200,160,80,0.4)'],
                    animation: 'scene-wind',
                    landscape: `   âˆ©âˆ©âˆ©âˆ©
  âˆ©âˆ©âˆ©âˆ©âˆ©âˆ©
 âˆ©âˆ©âˆ©âˆ©âˆ©âˆ©âˆ©âˆ©`,
                    count: 10
                }
            };
            
            const effect = sceneEffects[sceneKey] || sceneEffects.forest;
            
            // ç”Ÿæˆç²’å­æ•ˆæœ
            for (let i = 0; i < effect.count; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = `scene-text-effect ${effect.animation}`;
                    particle.textContent = effect.particles[Math.floor(Math.random() * effect.particles.length)];
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.color = effect.colors[Math.floor(Math.random() * effect.colors.length)];
                    particle.style.animationDelay = Math.random() * 3 + 's';
                    particle.style.animationDuration = (3 + Math.random() * 4) + 's';
                    layer.appendChild(particle);
                    
                    // ç²’å­ç”Ÿå‘½å‘¨æœŸ
                    setTimeout(() => {
                        if (particle.parentNode) particle.remove();
                    }, 8000 + Math.random() * 4000);
                }, i * 200);
            }
            
            // æ·»åŠ åœºæ™¯è½®å»“
            if (effect.landscape) {
                const landscape = document.createElement('div');
                landscape.className = `text-landscape landscape-${sceneKey}`;
                landscape.textContent = effect.landscape;
                layer.appendChild(landscape);
            }
        }

        // å¢å¼ºç‰ˆæ–‡å­—æ¼”å‡ºï¼šæ·»åŠ åœºæ™¯æè¿°æ–‡å­—
        function addSceneDescription(sceneKey) {
            const descriptions = {
                volcano: ['ç†”å²©ç¿»æ»š', 'ç«å…‰å†²å¤©', 'å²©æµ†æµæ·Œ', 'çƒ­æµªè¢­äºº'],
                sky: ['äº‘å·äº‘èˆ’', 'å¤©é«˜äº‘æ·¡', 'å¾®é£å¾æ¥', 'ç¢§ç©ºå¦‚æ´—'],
                forest: ['ç»¿æ„ç›ç„¶', 'é¸Ÿè¯­èŠ±é¦™', 'æå¶æ‘‡æ›³', 'ç”Ÿæœºå‹ƒå‹ƒ'],
                desert: ['é»„æ²™æ¼«å¤©', 'çƒˆæ—¥å½“ç©º', 'æ²™ä¸˜èµ·ä¼', 'å¯‚é™æ— å£°']
            };
            
            const layer = document.getElementById('textSceneLayer');
            if (!layer) return;
            
            const texts = descriptions[sceneKey] || descriptions.forest;
            texts.forEach((text, i) => {
                setTimeout(() => {
                    const desc = document.createElement('div');
                    desc.className = 'scene-text-effect';
                    desc.textContent = text;
                    desc.style.position = 'absolute';
                    desc.style.left = (20 + Math.random() * 60) + '%';
                    desc.style.top = (20 + Math.random() * 60) + '%';
                    desc.style.fontSize = '0.9em';
                    desc.style.color = 'rgba(255,255,255,0.15)';
                    desc.style.animation = 'sceneFloat 6s ease-in-out infinite';
                    desc.style.animationDelay = Math.random() * 2 + 's';
                    layer.appendChild(desc);
                    
                    setTimeout(() => {
                        if (desc.parentNode) desc.remove();
                    }, 6000);
                }, i * 1500);
            });
        }

        async function triggerDaily() {
            try {
                try { setSceneVisuals('forest'); window.pushNews && window.pushNews('æ—¥å¸¸äº’åŠ¨ï¼šè¥åœ°é™å¥½ï¼Œå¾®é£æ‹‚å¶ã€‚'); } catch {}
                const pet = gameState.currentPet ? {
                    name: gameState.currentPet.displayName || gameState.currentPet.name,
                    base_prompt: `${gameState.currentPet.species}Â·${gameState.currentPet.attribute || ''}`,
                    hp: gameState.currentPet.attributes?.hp || 100,
                    attack: gameState.currentPet.attributes?.attack || 20
                } : { name:'æ— å', base_prompt:'ç¥ç§˜ä¼™ä¼´', hp:100, attack:20 };
                const ctx = 'æ¸…æ™¨çš„éœ²æ°´æ²¾åœ¨è‰å¶ä¸Šã€‚';
                setStoryMeta({
                    scene: 'è¥åœ°Â·æ—¥å¸¸',
                    actors: [pet.name],
                    task: 'é™ªä¼´ä¸ç…§æ–™',
                    plot: 'æ²»æ„ˆç‰‡æ®µ',
                    item: '-'
                });
                let resp = await fetch('/api/daily/tick', {
                    method: 'POST',
                    headers: { 'Content-Type':'application/json' },
                    body: JSON.stringify({ pet, context: ctx })
                });
                const data = await resp.json();
                const storyContent = document.getElementById('storyContent');
                const lines = (data.event || 'ä½ ä»¬å®‰é™åœ°ç›¸ä¼´ï¼Œå¿ƒç»ªæ›´ç¨³äº†ã€‚').split(/(?<=[ã€‚ï¼ï¼Ÿ])/).filter(s=>s.trim());
                showStoryLines(lines, storyContent, () => { applyProgress({ exp: 4, bond: 7 }); });
            } catch (e) {
                console.error('triggerDaily error:', e);
                const storyContent = document.getElementById('storyContent');
                const lines = ['ä½ æ•´ç†äº†å®ƒçš„æ¯›å‘ï¼Œæ°”æ¯æ›´å¹³ç¨³äº†ã€‚','å®ƒé åœ¨ä½ èº«æ—å°æ†©ã€‚','å°å°çš„æ¸©æš–ï¼Œç§¯ç´¯æˆæ›´é•¿çš„æ—…ç¨‹ã€‚'];
                showStoryLines(lines, storyContent, () => {});
            }
        }
        // è¿›åº¦åº”ç”¨ä¸è¿›åŒ–å€™é€‰å¼¹çª—
        async function applyProgress(delta) {
            try {
                gameState.exp += Number(delta?.exp || 0);
                gameState.bond += Number(delta?.bond || 0);
                const pet = gameState.currentPet || null;
                const resp = await fetch('/api/progress/apply', {
                    method: 'POST',
                    headers: { 'Content-Type':'application/json' },
                    body: JSON.stringify({ pet, delta: { exp: delta?.exp || 0, bond: delta?.bond || 0 } })
                });
                const data = await resp.json();
                gameState.lastProgress = data;
                if (data?.eligible && Array.isArray(data.candidates) && data.candidates.length) {
                    showEvolutionCandidates(data.candidates);
                }
            } catch (e) {
                console.error('applyProgress error:', e);
            }
        }

        function showEvolutionCandidates(candidates) {
            const storyContent = document.getElementById('storyContent');
            storyContent.innerHTML = '';
            const intro = ['ä¸–ç•Œæ ‘è½»å“ï¼Œä½ çš„ç¾ç»Šä¸å†ç»ƒè§¦è¾¾ä¸€å¤„é—¨æ§›ã€‚','æ•°ä¸ªå¯èƒ½çš„å½¢æ€åœ¨çµå…‰ä¸­æµ®ç°ï¼Œè¯·æ‹©å…¶ä¸€ã€‚'];
            showStoryLines(intro, storyContent, () => {
                // æ–‡å­—å¡ç‰‡å¼æ ‡é¢˜ä¸è¯´æ˜
                const header = document.createElement('div');
                header.className = 'story-line subtitle';
                header.textContent = 'è¿›åŒ–å€™é€‰ï¼ˆç»“åˆå›ºå®šç®—æ³•ä¸ä¸‰å±‚æç¤ºè¯ï¼‰';
                storyContent.appendChild(header);

                const tip = document.createElement('div');
                tip.className = 'story-line';
                tip.style.fontSize = '0.9em';
                tip.style.color = '#bbb';
                tip.style.margin = '10px 0 18px';
                tip.textContent = 'è¯·é€‰æ‹©å…¶ä¸€ï¼Œéšåå°†è§¦å‘ Evolutionâ†’Storyâ†’Numerical çš„æ–‡å­—æ¼”å‡ºã€‚';
                storyContent.appendChild(tip);

                const list = document.createElement('div');
                list.className = 'choices-container show';
                candidates.slice(0,3).forEach((c, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'choice-button';
                    btn.textContent = `${idx+1}. ${c.to}ï¼ˆç¨€æœ‰åº¦ï¼š${c.rarityShift}ï¼‰`;
                    btn.addEventListener('click', () => confirmEvolutionChoice(c));
                    list.appendChild(btn);
                });
                storyContent.appendChild(list);
            });
        }

        async function confirmEvolutionChoice(candidate) {
            try {
                const pet = gameState.currentPet;
                if (!pet) return alert('è¯·å…ˆç”Ÿæˆå® ç‰©');
                const core = {
                    species: pet.species,
                    rarity: pet.rarity,
                    level: Math.max(1, Math.floor((pet.attributes.hp || 100)/20)),
                    baseStats: {
                        health: pet.attributes.hp,
                        attack: pet.attributes.attack,
                        defense: pet.attributes.defense,
                        speed: pet.attributes.speed,
                        magic: pet.attributes.magic
                    },
                    specialTraits: []
                };
                const ctx = { environment: 'çµå¢ƒ', playerBond: gameState.bond || 0, evolutionChoice: candidate?.to || '' };
                const resp = await fetch('/api/story-agent/preview', {
                    method: 'POST',
                    headers: { 'Content-Type':'application/json' },
                    body: JSON.stringify({ petCoreData: core, context: ctx })
                });
                const data = await resp.json();
                const storyContent = document.getElementById('storyContent');
                const lines = (data?.story?.text || 'çµå…‰æ±‡èšï¼Œå½¢æ€æ¸å®šã€‚ä½ ä»¬ç»§ç»­å‘å‰ã€‚').split(/(?<=[ã€‚ï¼ï¼Ÿ])/).filter(s=>s.trim());
                showStoryLines(lines, storyContent, () => {
                    gameState.evolutionCount += 1;
                    updateStats();
                });
            } catch (e) {
                console.error('confirmEvolutionChoice error:', e);
            }
        }

        // ç»Ÿä¸€æ¸²æŸ“è‡ªç”±äº’åŠ¨æŒ‰é’®ï¼ˆå³ä¸Šè§’é¢æ¿ä¸­ï¼‰
        function renderInteractionChoices() {
            try {
                // ç§»é™¤ä¸­å¿ƒåŒºåŸŸçš„æ—§äº’åŠ¨å®¹å™¨ï¼Œä¿æŒçº¯æ–‡å­—æ¼”å‡º
                const storyContent = document.getElementById('storyContent');
                if (storyContent) {
                    const old = storyContent.querySelector('.choices-container');
                    if (old) { try { old.remove(); } catch {} }
                }
                // åœ¨é¢æ¿å®¹å™¨ä¸­æ¸²æŸ“äº’åŠ¨é€‰é¡¹
                const listEl = document.getElementById('choicesList');
                if (!listEl) return;
                const container = document.createElement('div');
                container.className = 'choices-container show';
                const actions = [
                  { text: 'å¼€å§‹å†’é™©', handler: startAdventure },
                  { text: 'æ—¥å¸¸äº’åŠ¨', handler: triggerDaily },
                  { text: 'çµå¢ƒå¯¹å†³', handler: triggerBattle },
                  { text: 'æŸ¥çœ‹å±æ€§', handler: showPetStats }
                ];
                container.innerHTML = '';
                actions.forEach(a => {
                  const btn = document.createElement('button');
                  btn.className = 'choice-button';
                  btn.style.marginBottom = '10px';
                  btn.textContent = a.text;
                  btn.addEventListener('click', a.handler);
                  container.appendChild(btn);
                });
                listEl.innerHTML = '';
                listEl.appendChild(container);
            } catch (e) {
                console.error('renderInteractionChoices error:', e);
            }
        }

        // èœå•æŠ˜å åŠŸèƒ½
        function toggleSubmenu(id) {
            const submenu = document.getElementById(id);
            if (!submenu) return;
            const isVisible = submenu.style.display !== 'none';
            submenu.style.display = isVisible ? 'none' : 'block';
            
            // æ›´æ–°æŒ‰é’®æ–‡å­—
            const btn = submenu.previousElementSibling;
            if (btn) {
                const text = btn.textContent.replace(/[â–¼â–²]/, isVisible ? 'â–¼' : 'â–²');
                btn.textContent = text;
            }
        }
        
        // é»„é‡‘3ç§’é€‰æ‹©æœºåˆ¶
        let quickChoiceTimeout = null;
        function showQuickChoices() {
            hideQuickChoices();
            
            const choices = document.createElement('div');
            choices.id = 'quickChoices';
            choices.style.cssText = `
                position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
                background: rgba(20, 30, 40, 0.95); border: 1px solid #4a6b8a;
                border-radius: 12px; padding: 16px; display: flex; gap: 12px;
                z-index: 1000; backdrop-filter: blur(10px);
            `;
            
            const options = [
                { text: 'ç»§ç»­æ¢ç´¢', action: () => { hideQuickChoices(); continueExplore(); } },
                { text: 'ä¼‘æ¯ç‰‡åˆ»', action: () => { hideQuickChoices(); takeRest(); } },
                { text: 'æ·±å…¥è°ƒæŸ¥', action: () => { hideQuickChoices(); investigate(); } }
            ];
            
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.textContent = opt.text;
                btn.style.cssText = `
                    padding: 8px 16px; background: linear-gradient(135deg, #2a4a6b, #1e3a5f);
                    color: #e0e0e0; border: 1px solid #4a6b8a; border-radius: 6px;
                    cursor: pointer; font-size: 0.9em; transition: all 0.3s ease;
                    white-space: nowrap;
                `;
                btn.onmouseover = () => btn.style.background = 'linear-gradient(135deg, #3a5a7b, #2e4a6f)';
                btn.onmouseout = () => btn.style.background = 'linear-gradient(135deg, #2a4a6b, #1e3a5f)';
                btn.onclick = opt.action;
                choices.appendChild(btn);
            });
            
            document.body.appendChild(choices);
        }
        
        function hideQuickChoices() {
            const choices = document.getElementById('quickChoices');
            if (choices) choices.remove();
            if (quickChoiceTimeout) {
                clearTimeout(quickChoiceTimeout);
                quickChoiceTimeout = null;
            }
        }
        (function initNewsTicker(){
            try {
                if (document.getElementById('newsTicker')) return;
                const bar = document.createElement('div');
                bar.id = 'newsTicker';
                bar.style.position = 'fixed';
                bar.style.left = '0';
                bar.style.right = '0';
                bar.style.bottom = '0';
                bar.style.zIndex = '1000';
                bar.style.padding = '8px 16px';
                bar.style.background = 'rgba(0,0,0,0.6)';
                bar.style.borderTop = '1px solid rgba(255,255,255,0.1)';
                bar.style.color = '#ddd';
                bar.style.fontSize = '0.9em';
                bar.style.backdropFilter = 'blur(6px)';
                bar.textContent = 'æ–°é—»æ’­æŠ¥ï¼šä¸–ç•Œæ ‘çš„ä½è¯­æ­£åœ¨è‹é†’â€¦â€¦';
                document.body.appendChild(bar);
                // å¯é€‰ï¼šæš´éœ²ä¸€ä¸ªç®€æ˜“çš„æ›´æ–°å‡½æ•°
                window.pushNews = function(msg){
                    const el = document.getElementById('newsTicker');
                    if (el && msg) el.textContent = 'æ–°é—»æ’­æŠ¥ï¼š' + msg;
                };
            } catch (e) { console.error('initNewsTicker error:', e); }
        })();

/* ä¸å® ç‰©äº’åŠ¨å¼•å¯¼å¼¹å±‚ä¸å‰§æƒ…æ¨è¿›ï¼ˆå›ºå®šä¸‰é€‰é¡¹ + é•¿å‰§æƒ…åˆ†æ®µï¼‰ */
(function(){
  function openPetChatGuide(){
    closePetChatGuide();
    const layer = document.createElement('div');
    layer.id = 'petChatGuide';
    Object.assign(layer.style, {
      position:'fixed', inset:'0', background:'rgba(0,0,0,0.6)', backdropFilter:'blur(6px)',
      zIndex:'2000', display:'flex', alignItems:'center', justifyContent:'center'
    });
    const box = document.createElement('div');
    Object.assign(box.style, {
      background:'rgba(0,0,0,0.85)', border:'1px solid #333', borderRadius:'14px',
      padding:'18px 20px', color:'#ddd', width:'520px', maxWidth:'90%'
    });
    box.innerHTML = `
      <div style="font-size:1.05em;color:#ffd700;margin-bottom:8px;">ä¸å® ç‰©äº’åŠ¨ Â· å¼•å¯¼</div>
      <div style="font-size:0.92em;color:#bbb;margin-bottom:12px;">å…ˆå’Œå®ƒèŠèŠï¼šé€‰æ‹©ä¸€ä¸ªè¯é¢˜ï¼Œç³»ç»Ÿå°†è®°å½•å›åˆæ•°ã€‚è¾¾åˆ°3å›åˆåä¼šè‡ªåŠ¨å¼¹å‡ºå‰§æƒ…æ¨è¿›å¯¹è¯æ¡†ï¼ˆå›ºå®š3ä¸ªé€‰é¡¹ï¼‰ã€‚</div>
      <div id="chatTopics"></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
        <button id="chatClose" class="choice-button" style="width:auto;padding:10px 16px;">æ”¶èµ·</button>
      </div>
    `;
    layer.appendChild(box);
    document.body.appendChild(layer);
    const topics = [
      { t:'ä»Šå¤©çš„å¿ƒæƒ…å¦‚ä½•ï¼Ÿ', k:'mood' },
      { t:'ä½ æœ€å–œæ¬¢çš„è®­ç»ƒæ˜¯ä»€ä¹ˆï¼Ÿ', k:'train' },
      { t:'å¯¹è¿™ç‰‡çµå¢ƒæœ‰ä»€ä¹ˆæ„Ÿè§‰ï¼Ÿ', k:'realm' },
      { t:'æœ‰æ²¡æœ‰æƒ³å°è¯•çš„æŒ‘æˆ˜ï¼Ÿ', k:'challenge' }
    ];
    const list = document.createElement('div');
    topics.forEach(tp=>{
      const btn = document.createElement('button');
      btn.className='choice-button';
      btn.textContent = 'â€¢ ' + tp.t;
      btn.addEventListener('click', ()=>sendChatTopic(tp));
      list.appendChild(btn);
    });
    box.querySelector('#chatTopics').appendChild(list);
    box.querySelector('#chatClose').addEventListener('click', closePetChatGuide);
  }
  function closePetChatGuide(){
    const el = document.getElementById('petChatGuide');
    if (el) try{ el.remove(); }catch{}
  }
  function sendChatTopic(tp){
    const sc = document.getElementById('storyContent');
    const pet = (window.gameState && window.gameState.currentPet) || { name:'ä¼™ä¼´' };
    const lines = [
      { text:`ä½ ï¼š${tp.t}`, class:'normal' },
      { text:`${pet.displayName||pet.name||'ä¼™ä¼´'}ï¼šæˆ‘ä¹Ÿåœ¨æ€è€ƒè¿™ä»¶äº‹ã€‚ä½ çš„æƒ³æ³•æ€»èƒ½è®©æˆ‘æ›´å¹³ç¨³ã€‚`, class:'normal' }
    ];
    window.gameState.chatCount = (window.gameState.chatCount||0) + 1;
    showStoryLinesWithClasses(lines, sc, ()=>{
      if (window.gameState.chatCount >= 3) {
        showPlotModal();
      }
    });
  }
  function showPlotModal(){
    closePlotModal();
    const layer = document.createElement('div');
    layer.id='plotModal';
    Object.assign(layer.style, {
      position:'fixed', inset:'0', background:'rgba(0,0,0,0.55)', backdropFilter:'blur(6px)',
      zIndex:'2100', display:'flex', alignItems:'center', justifyContent:'center'
    });
    const box = document.createElement('div');
    Object.assign(box.style, {
      background:'rgba(0,0,0,0.85)', border:'1px solid #444', borderRadius:'14px',
      padding:'18px', color:'#ddd', width:'560px', maxWidth:'92%'
    });
    const options = [
      { key:'explore', text:'ç»§ç»­æ¢ç´¢é’æœ¨çµå¢ƒçš„æ—å¾„ï¼Œå¯»æ‰¾éšç§˜çº¿ç´¢' },
      { key:'train',   text:'è¿›è¡Œä¸€åœºç³»ç»Ÿè®­ç»ƒï¼Œå·©å›ºå½“å‰ç¾ç»Šä¸èƒ½åŠ›' },
      { key:'encounter', text:'å“åº”è¿œå¤„çš„å¬å”¤ï¼Œè§¦å‘ä¸€æ¬¡å¥‡é‡äº‹ä»¶' }
    ];
    box.innerHTML = `<div style="font-size:1.05em;color:#ffd700;margin-bottom:8px;">å‰§æƒ…æ¨è¿›</div>
      <div style="font-size:0.92em;color:#bbb;margin-bottom:10px;">é€‰æ‹©å…¶ä¸€ï¼ˆå›ºå®šä¸‰é€‰é¡¹ï¼‰ï¼Œç³»ç»Ÿå°†ç”Ÿæˆä¸€æ®µâ‰¥800å­—çš„è¿ç»­å‰§æƒ…ï¼Œå¹¶æŒ‰â€œèµ·æ‰¿è½¬åˆâ€åˆ†æ®µé€æ­¥æ¼”å‡ºã€‚</div>`;
    const list = document.createElement('div');
    options.forEach(op=>{
      const btn = document.createElement('button');
      btn.className='choice-button';
      btn.textContent = 'â€¢ ' + op.text;
      btn.addEventListener('click', ()=>{ closePlotModal(); generateLongPlot(op); });
      list.appendChild(btn);
    });
    const closeBtn = document.createElement('button');
    closeBtn.className='choice-button';
    closeBtn.textContent='æš‚ç¼“æ¨è¿›';
    closeBtn.style.padding='10px 16px'; closeBtn.style.width='auto';
    closeBtn.addEventListener('click', closePlotModal);
    box.appendChild(list);
    box.appendChild(closeBtn);
    layer.appendChild(box);
    document.body.appendChild(layer);
  }
  function closePlotModal(){
    const el = document.getElementById('plotModal');
    if (el) try{ el.remove(); }catch{}
  }
  async function generateLongPlot(op){
    const pet = (window.gameState && window.gameState.currentPet) || null;
    const payload = { 
      option: op?.key, 
      pet: pet ? { name: pet.displayName||pet.name, species:pet.species, rarity:pet.rarity } : null,
      requireLength: 800,
      provider: 'deepseek' // æŒ‡å®šä½¿ç”¨DeepSeekæ–‡æœ¬æ¨¡å‹
    };
    let text = '';
    try {
      const resp = await fetch('/api/deepseek/long-plot', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
      if (resp.ok) {
        const data = await resp.json();
        text = String(data?.text || '');
      }
    } catch (e) {
      console.log('DeepSeek APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°é™çº§:', e);
    }
    if (!text || text.length < 400) {
      text = localLongPlot(op?.key||'explore', pet);
    }
    const segs = segmentPlot(text);
    renderSegmentedPlot(segs);
    const sceneKey = op?.key==='train' ? 'forest' : (op?.key==='encounter' ? 'sky' : 'forest');
    try { 
      setSceneVisuals(sceneKey); 
      addSceneDescription(sceneKey);
      window.pushNews && window.pushNews('å‰§æƒ…æ¨è¿›ï¼š' + (op?.text||'')); 
    } catch {}
    setStoryMeta({ scene: op?.key==='encounter' ? 'ä¸´ç•ŒÂ·å¥‡é‡' : 'é’æœ¨çµå¢ƒÂ·æ—å¾„', actors: [pet ? (pet.displayName||pet.name) : 'ä½ '], task: 'å‰§æƒ…æ¨è¿›', plot: 'è¿ç»­æ¼”å‡º', item: '-' });
  }
  function localLongPlot(key, pet){
    const name = pet ? (pet.displayName||pet.name) : 'ä½ ';
    const base = [
      `èµ·ï¼šè–„é›¾è£¹ç€æ—å¾„çš„æ¸…æ°”ï¼Œ${name}ä¸ä¼™ä¼´æ²¿ç€ä¸–ç•Œæ ‘çš„çº¹ç†ç¼“æ­¥è€Œè¡Œã€‚ç¢å…‰è½åœ¨å¶å°–ï¼Œåƒä¸æ„¿æƒŠæ‰°çš„æ—§äº‹ï¼Œä¸€ç‚¹ä¸€ç‚¹è¢«æ§åˆ°çœ¼å‰â€¦â€¦`,
      `æ‰¿ï¼šé“è·¯å¹¶ä¸ç¬”ç›´ã€‚ææ¡æ¨ªæ–œï¼ŒæºªçŸ³åœ†æ¶¦ï¼Œå¾®å°çš„é˜»åŠ›è®©äººçš„è„šæ­¥æ›´ç¨³ã€‚ä¸€è·¯ä¸Šï¼Œä½ ä»¬äº¤æ¢ç€ç»†å°çš„æƒ³æ³•ä¸è§‚å¯Ÿï¼Œå…³äºè®­ç»ƒçš„èŠ‚å¥ã€å…³äºä»Šæ—¥çš„ä½“åŠ›ä¸å¿ƒæ„ï¼Œä¹Ÿå…³äºå¦‚ä½•åˆ†é…ä¸‹ä¸€æ¬¡çš„å°è¯•â€¦â€¦`,
      `è½¬ï¼šå¿½ç„¶ï¼Œä¸€é˜µçœ‹ä¸è§çš„é£åœ¨æ ‘å† ä¹‹é—´è¿ç¼€æˆçº¿ï¼Œåƒæœ‰äººè½»æ•²ä¸€é¢è—åœ¨è¿œå¤„çš„é“ƒã€‚ä¼™ä¼´çš„ç›®å…‰å…ˆä½ ä¸€æ­¥æœ›å‘æ·±å¤„â€”â€”é‚£é‡Œæœ‰ä¸å¯»å¸¸çš„å…‰çº¹åœ¨æ³¥åœŸä¸‹å‘¼å¸ã€‚å®ƒä¸çŒ›çƒˆï¼Œå´åœ¨æŒç»­åœ°å˜æ¢å½¢çŠ¶ï¼Œåƒè¦æŠŠæŸä¸ªè¢«é—å¿˜çš„åå­—é‡æ–°å†™å‡ºæ¥â€¦â€¦`,
      `åˆï¼šä½ ä»¬å¹¶ä¸æ€¥äºç»™å‡ºç»“è®ºã€‚æ²¿ç€å…‰çº¹çš„è¾¹ç¼˜è¯•æ¢ï¼Œè®°å½•æ¯ä¸€æ¬¡å¾®å°çš„å˜åŒ–ï¼ŒæŠŠå¿ƒè·³æŒ‰åœ¨æœ€æ…¢çš„èŠ‚æ‹ä¸Šã€‚å½“æ‰€æœ‰çš„ç¢ç‰‡å‡‘åˆ°ä¸€èµ·ï¼Œé‚£åå­—ç»ˆäºä»åœŸå£¤é‡ŒæŠ¬èµ·å¤´æ¥ã€‚ä½ ä»¬çœ‹è§äº†è‡ªå·±çš„å½±åƒï¼Œä¹Ÿçœ‹è§äº†ä¸‹ä¸€æ®µæ—…ç¨‹çš„æ–¹å‘ã€‚`
    ];
    const detail = `ä½ å°è¯•æŠŠæ‰€è§æ‰€æ„Ÿç¼–ç»‡æˆæ›´æ¸…æ™°çš„çº¿ç´¢ï¼šè„šä¸‹çš„çº¹ç†ä¼¼ä¹ä¸ä¸–ç•Œæ ‘çš„å¹´è½®ç›¸äº’ç…§åº”ï¼Œæå¶çš„æŠ–åŠ¨å¹¶ééšæœºï¼Œè€Œæ˜¯ä¸å‘¼å¸åŒæ­¥çš„æš—å·ï¼›ä¼™ä¼´çš„è€³å°–éšé£è½»é¢¤ï¼Œåƒåœ¨æ•æ‰ä¸€é¦–å°šæœªå†™å®Œçš„è¯—ã€‚ä½ ä»¬å°†è®­ç»ƒä¸­å­¦åˆ°çš„èŠ‚å¥æ”¾è¿›è¡Œèµ°ï¼ŒæŠŠè¿‡å¾€çš„çŠ¹ç–‘å½“ä½œä»Šå¤©çš„å‚ç…§ï¼Œæ…¢æ…¢æŠ›å…‰æ¯ä¸€æ¬¡åœé¡¿ï¼Œè®©å®ƒå˜æˆä½ ä»¬å…±åŒçš„æ­¥æ³•ã€‚ç­‰åˆ°å¤œè‰²æŠŠæ—å¾„çš„è½®å»“æ”¶æ‹¢ï¼Œä½ ä»¬æ‰æ„è¯†åˆ°ï¼Œä¸€æ•´å¤©çš„äº¤æµå·²ç»æŠŠæœªçŸ¥æ‹‰è¿‘ï¼šé‚£åå­—ä¸å†é™Œç”Ÿï¼Œä¸‹ä¸€æ­¥ä¸å†é¥è¿œã€‚`;
    const text = base.join('') + detail.repeat(2);
    return text;
  }
  function segmentPlot(text){
    const sentences = text.split(/(?<=[ã€‚ï¼ï¼Ÿ])/).filter(s=>s.trim());
    if (sentences.length < 8) return [
      { phase:'èµ·', content:text },
    ];
    const chunkSize = Math.ceil(sentences.length / 4);
    const segs = [
      { phase:'èµ·',  content: sentences.slice(0, chunkSize).join('') },
      { phase:'æ‰¿',  content: sentences.slice(chunkSize, chunkSize*2).join('') },
      { phase:'è½¬',  content: sentences.slice(chunkSize*2, chunkSize*3).join('') },
      { phase:'åˆ',  content: sentences.slice(chunkSize*3).join('') },
    ];
    return segs;
  }
  function renderSegmentedPlot(segs){
    const sc = document.getElementById('storyContent');
    if (!sc) return;
    sc.innerHTML = '';
    let i = 0;
    function renderOne(){
      if (i >= segs.length) return;
      const seg = segs[i];
      const lines = [
        { text: `ã€${seg.phase}ã€‘`, class:'subtitle' },
        { text: seg.content, class:'normal' }
      ];
      showStoryLinesWithClasses(lines, sc, ()=>{
        i += 1;
        setTimeout(renderOne, 1000);
      });
    }
    renderOne();
  }
  window.openPetChatGuide = openPetChatGuide;
})();

/* äº‹ä»¶å§”æ‰˜ï¼šæ‹¦æˆªæ•…äº‹ä¸­çš„æ–‡æœ¬é“¾æ¥ï¼ŒæŒ‰ data-action è§¦å‘è€Œéè·³è½¬ */
(function(){
  try {
    const sc = document.getElementById('storyContent');
    if (sc) {
      sc.addEventListener('click', (e) => {
        const link = e.target.closest('a');
        if (!link) return;
        e.preventDefault();
        e.stopPropagation();
        const act = link.getAttribute('data-action') || '';
        if (act === 'startAdventure') return startAdventure();
        if (act === 'triggerDaily')   return triggerDaily();
        if (act === 'triggerBattle')  return triggerBattle();
      });
    }
  } catch (err) { console.error('storyContent delegation error:', err); }
})();

// æ–°å¢ï¼šé»„é‡‘3ç§’é€‰æ‹©æœºåˆ¶å’Œèœå•åŠŸèƒ½
function toggleSubmenu(id) {
  const submenu = document.getElementById(id);
  if (!submenu) return;
  const isVisible = submenu.style.display !== 'none';
  submenu.style.display = isVisible ? 'none' : 'block';
  
  // æ›´æ–°æŒ‰é’®æ–‡å­—
  const btn = submenu.previousElementSibling;
  if (btn) {
    const text = btn.textContent.replace(/[â–¼â–²]/, isVisible ? 'â–¼' : 'â–²');
    btn.textContent = text;
  }
}

// é»„é‡‘3ç§’å¿«é€Ÿé€‰æ‹©
window.quickChoiceTimeout = window.quickChoiceTimeout || null;
function showQuickChoices() {
  hideQuickChoices();
  
  const choices = document.createElement('div');
  choices.id = 'quickChoices';
  choices.style.cssText = `
    position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
    background: rgba(20, 30, 40, 0.95); border: 1px solid #4a6b8a;
    border-radius: 12px; padding: 16px; display: flex; gap: 12px;
    z-index: 1000; backdrop-filter: blur(10px);
  `;
  
  const options = [
    { text: 'ç»§ç»­æ¢ç´¢', action: () => { hideQuickChoices(); continueExplore(); } },
    { text: 'ä¼‘æ¯ç‰‡åˆ»', action: () => { hideQuickChoices(); takeRest(); } },
    { text: 'æ·±å…¥è°ƒæŸ¥', action: () => { hideQuickChoices(); investigate(); } }
  ];
  
  options.forEach(opt => {
    const btn = document.createElement('button');
    btn.textContent = opt.text;
    btn.style.cssText = `
      padding: 8px 16px; background: linear-gradient(135deg, #2a4a6b, #1e3a5f);
      color: #e0e0e0; border: 1px solid #4a6b8a; border-radius: 6px;
      cursor: pointer; font-size: 0.9em; transition: all 0.3s ease;
      white-space: nowrap;
    `;
    btn.onmouseover = () => btn.style.background = 'linear-gradient(135deg, #3a5a7b, #2e4a6f)';
    btn.onmouseout = () => btn.style.background = 'linear-gradient(135deg, #2a4a6b, #1e3a5f)';
    btn.onclick = opt.action;
    choices.appendChild(btn);
  });
  
  document.body.appendChild(choices);
}

function hideQuickChoices() {
  const choices = document.getElementById('quickChoices');
  if (choices) choices.remove();
  if (quickChoiceTimeout) {
    clearTimeout(quickChoiceTimeout);
    quickChoiceTimeout = null;
  }
}

// å¿«é€Ÿé€‰æ‹©å¤„ç†å‡½æ•°
function continueExplore() {
  const pet = gameState.currentPet;
  const text = `${pet?.name || 'ä½ çš„ä¼™ä¼´'}ç»§ç»­å‘å‰æ¢ç´¢ï¼Œè„šæ­¥è½»ç›ˆè€Œåšå®šã€‚`;
  addStoryLineWithChoices(text, false);
  setTimeout(() => generateNextSegment('explore'), 2000);
}

function takeRest() {
  const pet = gameState.currentPet;
  const text = `${pet?.name || 'ä½ çš„ä¼™ä¼´'}æ‰¾äº†ä¸ªèˆ’é€‚çš„åœ°æ–¹ä¼‘æ¯ï¼Œæ¢å¤ä½“åŠ›ã€‚`;
  addStoryLineWithChoices(text, false);
  setTimeout(() => generateNextSegment('rest'), 2000);
}

function investigate() {
  const pet = gameState.currentPet;
  const text = `${pet?.name || 'ä½ çš„ä¼™ä¼´'}ä»”ç»†è§‚å¯Ÿå‘¨å›´ï¼Œå¯»æ‰¾éšè—çš„çº¿ç´¢ã€‚`;
  addStoryLineWithChoices(text, false);
  setTimeout(() => generateNextSegment('investigate'), 2000);
}

// ç”Ÿæˆä¸‹ä¸€æ®µå‰§æƒ…ï¼ˆæ§åˆ¶åœ¨15-25å­—ï¼Œ3ç§’é˜…è¯»æ—¶é—´ï¼‰
function generateNextSegment(type) {
  const pet = gameState.currentPet;
  const segments = {
    explore: [`å‰æ–¹å‡ºç°äº†ç¥ç§˜çš„å…‰èŠ’ã€‚`, `${pet?.name || 'ä¼™ä¼´'}å°å¿ƒç¿¼ç¿¼åœ°é è¿‘ã€‚`, `é‚£é‡Œä¼¼ä¹éšè—ç€ç§˜å¯†ã€‚`],
    rest: [`ä¼‘æ¯è®©${pet?.name || 'ä¼™ä¼´'}ç²¾ç¥ç„•å‘ã€‚`, `å®ƒæ„Ÿåˆ°åŠ›é‡åœ¨ä½“å†…æµæ·Œã€‚`, `å‡†å¤‡è¿æ¥æ–°çš„æŒ‘æˆ˜ã€‚`],
    investigate: [`${pet?.name || 'ä¼™ä¼´'}å‘ç°äº†å¥‡æ€ªçš„ç—•è¿¹ã€‚`, `è¿™äº›ç—•è¿¹æŒ‡å‘æ·±å¤„ã€‚`, `ä¸€ä¸ªæ–°çš„è°œå›¢æµ®ç°ã€‚`]
  };
  
  const segs = segments[type] || segments.explore;
  renderSegmentedPlot(segs);
}

// åˆ†æ®µæ¼”å‡ºï¼ˆé»„é‡‘3ç§’èŠ‚å¥ï¼‰
async function renderSegmentedPlot(segments) {
  for (let i = 0; i < segments.length; i++) {
    const seg = segments[i];
    const isLast = i === segments.length - 1;
    addStoryLineWithChoices(seg, false);
    
    if (!isLast) {
      await new Promise(resolve => setTimeout(resolve, 3500)); // 3ç§’é˜…è¯» + 0.5ç§’ç¼“å†²
    }
  }
  // æœ€åä¸€æ®µå®Œæˆåæ˜¾ç¤ºé€‰æ‹©
  setTimeout(() => showQuickChoices(), 3000);
}

// å¸¦é€‰æ‹©æœºåˆ¶çš„æ•…äº‹è¡Œæ·»åŠ 
function addStoryLineWithChoices(text, showChoices = true) {
  const storyContent = document.getElementById('storyContent');
  if (!storyContent) return;
  
  const line = document.createElement('div');
  line.className = 'story-line';
  line.textContent = text;
  storyContent.appendChild(line);
  storyContent.scrollTop = storyContent.scrollHeight;
  
  // é»„é‡‘3ç§’åæ˜¾ç¤ºé€‰æ‹©ï¼ˆå¦‚æœå¯ç”¨ï¼‰
  if (showChoices) {
    quickChoiceTimeout = setTimeout(() => {
      showQuickChoices();
    }, 3000);
  }
}

// æ¸¸æˆåŠŸèƒ½å‡½æ•°
function startAdventure() {
  hideQuickChoices();
  addStoryLineWithChoices('ğŸŒŸ å¼€å§‹æ–°çš„å†’é™©æ—…ç¨‹...', true);
  window.pushNews && window.pushNews('å¼€å§‹å†’é™©æ¢ç´¢');
}

function triggerDaily() {
  hideQuickChoices();
  addStoryLineWithChoices('â˜€ï¸ å¼€å§‹ä»Šæ—¥çš„æ—¥å¸¸äº’åŠ¨...', true);
  window.pushNews && window.pushNews('è¿›è¡Œæ—¥å¸¸äº’åŠ¨');
}

function triggerBattle() {
  hideQuickChoices();
  addStoryLineWithChoices('âš”ï¸ è¿›å…¥çµå¢ƒå¯¹å†³æ¨¡å¼...', true);
  window.pushNews && window.pushNews('å¼€å§‹çµå¢ƒå¯¹å†³');
}

function showPetInteraction() {
  hideQuickChoices();
  addStoryLineWithChoices('ğŸ’« ä¸å® ç‰©å¼€å§‹æ·±åº¦äº’åŠ¨...', true);
  window.pushNews && window.pushNews('å® ç‰©äº’åŠ¨ä¸­');
}

function viewCharacteristics() {
  hideQuickChoices();
  const pet = gameState.currentPet;
  const text = `ğŸ“Š ${pet?.name || 'æœªçŸ¥'} - ç­‰çº§:${pet?.level || 1} ç¨€æœ‰åº¦:${pet?.rarity || 'N'}`;
  addStoryLineWithChoices(text, true);
}

function openStory() {
  hideQuickChoices();
  addStoryLineWithChoices('ğŸ“– æ•…äº‹æ¨¡å¼å¼€å¯...', true);
}

function saveGame() {
  window.pushNews && window.pushNews('æ¸¸æˆå·²ä¿å­˜');
}

function loadGame() {
  window.pushNews && window.pushNews('æ¸¸æˆå·²åŠ è½½');
}

function showHelp() {
  addStoryLineWithChoices('â“ æ¸¸æˆå¸®åŠ©ï¼šä½¿ç”¨å³ä¾§èœå•è¿›è¡Œå„ç§æ“ä½œï¼Œæ¯æ®µå‰§æƒ…åä¼šå‡ºç°é€‰æ‹©æŒ‰é’®ã€‚', true);
}

// å¯¹è¯æ¡†åŠŸèƒ½
function showDialog(title, content, buttons = [{ text: 'ç¡®å®š', action: () => closeDialog() }]) {
    // åˆ›å»ºå¯¹è¯æ¡†å…ƒç´ 
    const overlay = document.createElement('div');
    overlay.className = 'dialog-overlay';
    overlay.id = 'dialogOverlay';
    
    const dialogBox = document.createElement('div');
    dialogBox.className = 'dialog-box';
    
    const titleElement = document.createElement('div');
    titleElement.className = 'dialog-title';
    titleElement.innerHTML = title;
    
    const contentElement = document.createElement('div');
    contentElement.className = 'dialog-content';
    contentElement.innerHTML = content;
    
    const buttonsContainer = document.createElement('div');
    buttonsContainer.className = 'dialog-buttons';
    
    buttons.forEach(button => {
        const btn = document.createElement('button');
        btn.className = 'dialog-button';
        btn.textContent = button.text;
        btn.addEventListener('click', () => {
            closeDialog();
            if (button.action) button.action();
        });
        buttonsContainer.appendChild(btn);
    });
    
    dialogBox.appendChild(titleElement);
    dialogBox.appendChild(contentElement);
    dialogBox.appendChild(buttonsContainer);
    overlay.appendChild(dialogBox);
    
    document.body.appendChild(overlay);
    
    // æ˜¾ç¤ºåŠ¨ç”»
    setTimeout(() => {
        overlay.classList.add('show');
    }, 10);
    
    // ç‚¹å‡»èƒŒæ™¯å…³é—­
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
            closeDialog();
        }
    });
}

// å…³é—­å¯¹è¯æ¡†
function closeDialog() {
    const overlay = document.getElementById('dialogOverlay');
    if (overlay) {
        overlay.classList.remove('show');
        setTimeout(() => {
            overlay.remove();
        }, 300);
    }
}

// æ–°æ‰‹å¼•å¯¼ç›¸å…³åŠŸèƒ½å‡½æ•°
function startFirstAdventure() {
    const pet = gameState.currentPet;
    const petName = pet.displayName || pet.name;
    
    showDialog(
        'â— ç¬¬ä¸€æ¬¡å†’é™©',
        `${petName} å…´å¥‹åœ°æ‘†åŠ¨ç€å°¾å·´ï¼Œå‡†å¤‡å¼€å§‹ç¬¬ä¸€æ¬¡å†’é™©ï¼<br><br>ä½ ä»¬æ¥åˆ°äº† â–² æ˜†ä»‘ â–² å±±è„šä¸‹çš„ç¥ç§˜æ£®æ—è¾¹ç¼˜...<br><br>å‰æ–¹çš„é“è·¯åˆ†ä¸ºä¸‰æ¡ï¼Œé€‰æ‹©ä½ ä»¬çš„æ¢ç´¢ç›®æ ‡ï¼š`,
        [
            { text: 'â€» ç¿ ç»¿å°å¾„', action: () => exploreGreenPath() },
            { text: 'â—‰ ç«ç„°å³¡è°·', action: () => exploreFireCanyon() },
            { text: 'â—ˆ æ¸…æ³‰æºªæµ', action: () => exploreWaterStream() }
        ]
    );
}

function showAdventureChoices() {
    const choicesContainer = document.getElementById('choicesContainer');
    choicesContainer.innerHTML = '';
    
    const choices = [
        { 
            text: "â€» ç¿ ç»¿å°å¾„", 
            action: () => exploreGreenPath()
        },
        { 
            text: "â—‰ ç«ç„°å³¡è°·", 
            action: () => exploreFireCanyon()
        },
        { 
            text: "â—ˆ æ¸…æ³‰æºªæµ", 
            action: () => exploreWaterStream()
        },
        { 
            text: "â— è¿”å›å®‰å…¨åŒºåŸŸ", 
            action: () => returnToSafeArea()
        }
    ];
    
    choices.forEach((choice, index) => {
        setTimeout(() => {
            const button = document.createElement('button');
            button.className = 'choice-button';
            button.textContent = choice.text;
            button.addEventListener('click', choice.action);
            button.style.opacity = '0';
            button.style.transform = 'translateY(20px)';
            choicesContainer.appendChild(button);
            
            setTimeout(() => {
                button.style.transition = 'all 0.8s ease';
                button.style.opacity = '1';
                button.style.transform = 'translateY(0)';
            }, 100);
        }, index * 200);
    });

    choicesContainer.style.display = 'block';
    setTimeout(() => {
        choicesContainer.classList.add('show');
    }, 300);
}

function startPetInteraction() {
    const pet = gameState.currentPet;
    const petName = pet.displayName || pet.name;
    
    showDialog(
        'â—‰ ä¸ä¼™ä¼´æ·±å…¥äº¤æµ',
        `${petName} ç”¨æ¸©æŸ”çš„çœ¼ç¥çœ‹ç€ä½ ...<br><br>åœ¨ â€» ä¸–ç•Œæ ‘ â€» çš„åº‡æŠ¤ä¸‹ï¼Œä½ ä»¬ä¹‹é—´çš„ç¾ç»Šæ­£åœ¨åŠ æ·±ã€‚<br><br>é€‰æ‹©ä½ æƒ³è¦çš„äº’åŠ¨æ–¹å¼ï¼š`,
        [
            { text: 'ğŸ’¬ å¯¹è¯äº¤æµ', action: () => showPetDialog() },
            { text: 'ğŸ® ä¸€èµ·æ¸¸æˆ', action: () => showPetPlay() },
            { text: 'ğŸ– å–‚é£Ÿç…§æ–™', action: () => showPetCare() }
        ]
    );
}

function showDetailedStats() {
    const pet = gameState.currentPet;
    const petName = pet.displayName || pet.name;
    
    const statsContent = `
        <strong>ğŸ·ï¸ ç§æ—ï¼š</strong>${pet.species}<br>
        <strong>â­ ç¨€æœ‰åº¦ï¼š</strong><span class="rarity-${pet.rarity?.toLowerCase() || 'n'}">${pet.rarity || 'N'}</span><br>
        <strong>ğŸ’ª ä½“åŠ›ï¼š</strong>${pet.stats?.stamina || 100}/100<br>
        <strong>ğŸ§  æ™ºåŠ›ï¼š</strong>${pet.stats?.intelligence || 100}/100<br>
        <strong>â¤ï¸ å¿ƒæƒ…ï¼š</strong>${pet.mood || 'æ„‰å¿«'}<br>
        <strong>ğŸ¯ ç­‰çº§ï¼š</strong>${pet.level || 1}
    `;
    
    showDialog(
        `â—ˆ ${petName} çš„è¯¦ç»†å±æ€§`,
        statsContent,
        [
            { text: 'è¿”å›é€‰æ‹©', action: () => showTutorialChoices() }
        ]
    );
}

function showGameTutorial() {
    const tutorialLines = [
        { text: applySpecialMarkers("ğŸ® æ¸¸æˆåŸºç¡€æ“ä½œæŒ‡å—"), class: "title" },
        { text: applySpecialMarkers("ğŸ—£ï¸ å¯¹è¯ï¼šä¸ä½ çš„ğŸŒ¿çµå…½ä¼™ä¼´äº¤æµï¼Œäº†è§£å®ƒçš„æƒ³æ³•"), class: "normal" },
        { text: applySpecialMarkers("ğŸ¯ è®­ç»ƒï¼šæå‡ä¼™ä¼´çš„èƒ½åŠ›å’ŒæŠ€èƒ½"), class: "normal" },
        { text: applySpecialMarkers("ğŸ—ºï¸ å†’é™©ï¼šæ¢ç´¢ğŸ”ï¸æ˜†ä»‘ã€ğŸï¸è“¬è±ç­‰ç¥ç§˜åŒºåŸŸ"), class: "normal" },
        { text: applySpecialMarkers("ğŸ– ç…§æ–™ï¼šé€šè¿‡å–‚é£Ÿå’Œä¼‘æ¯ä¿æŒä¼™ä¼´çŠ¶æ€"), class: "normal" },
        { text: applySpecialMarkers("ğŸ“ˆ æˆé•¿ï¼šéšç€äº’åŠ¨å¢åŠ ï¼Œä¼™ä¼´ä¼šä¸æ–­è¿›åŒ–"), class: "normal" }
    ];

    const storyContent = document.getElementById('storyContent');
    storyContent.innerHTML = '';
    showStoryLinesWithClasses(tutorialLines, storyContent, () => {
        setTimeout(() => {
            showTutorialChoices(); // è¿”å›æ–°æ‰‹å¼•å¯¼é€‰æ‹©
        }, 3000);
    });
}

function returnToSafeArea() {
    const pet = gameState.currentPet;
    const petName = formatPetNameWithColors(pet.name);
    
    const safeLines = [
        { text: applySpecialMarkers(`ğŸ  ${petName} è·Ÿç€ä½ å›åˆ°äº†ğŸŒ³ä¸–ç•Œæ ‘ä¸‹çš„å®‰å…¨åŒºåŸŸã€‚`), class: "normal" },
        { text: applySpecialMarkers("è¿™é‡Œæ˜¯ä½ ä»¬çš„å®¶å›­ï¼Œå¯ä»¥å®‰å¿ƒåœ°è¿›è¡Œå„ç§æ´»åŠ¨ã€‚"), class: "normal" },
        { text: "ç°åœ¨ä½ å¯ä»¥é€‰æ‹©å„ç§äº’åŠ¨æ–¹å¼ï¼š", class: "normal" }
    ];

    const storyContent = document.getElementById('storyContent');
    storyContent.innerHTML = '';
    showStoryLinesWithClasses(safeLines, storyContent, () => {
        renderInteractionChoices();
    });
}

// å†’é™©è·¯å¾„æ¢ç´¢å‡½æ•°
function exploreGreenPath() {
    const pet = gameState.currentPet;
    const petName = formatPetNameWithColors(pet.name);
    
    const greenLines = [
        { text: applySpecialMarkers(`ğŸŒ¿ ${petName} è¸ä¸Šäº†ç¿ ç»¿å°å¾„...`), class: "normal" },
        { text: applySpecialMarkers("å¤æœ¨å‚å¤©ï¼ŒğŸŒ¸çµè¯çš„é¦™æ°”åœ¨ç©ºæ°”ä¸­é£˜æ•£ã€‚"), class: "normal" },
        { text: applySpecialMarkers("ä½ ä»¬å‘ç°äº†ä¸€æ ªğŸŒ¸ç‘¶æ± èŠ±ï¼Œè¿™æ˜¯çè´µçš„æ²»ç–—çµè¯ï¼"), class: "normal" },
        { text: applySpecialMarkers(`${petName} çš„ğŸŒ¿æœ¨å±æ€§å¾—åˆ°äº†å¢å¼ºï¼`), class: "normal" }
    ];

    const storyContent = document.getElementById('storyContent');
    storyContent.innerHTML = '';
    showStoryLinesWithClasses(greenLines, storyContent, () => {
        setTimeout(() => {
            addStoryLineWithChoices('ğŸ‰ å†’é™©å®Œæˆï¼ç»§ç»­æ¢ç´¢è¿˜æ˜¯è¿”å›ï¼Ÿ', true);
        }, 2000);
    });
}

function exploreFireCanyon() {
    const pet = gameState.currentPet;
    const petName = formatPetNameWithColors(pet.name);
    
    const fireLines = [
        { text: applySpecialMarkers(`ğŸ”¥ ${petName} å‹‡æ•¢åœ°èµ°å‘ç«ç„°å³¡è°·...`), class: "normal" },
        { text: applySpecialMarkers("å²©æµ†ç¿»æ»šï¼ŒğŸ”¥å¤©é›·ç åœ¨ç†”å²©ä¸­é—ªé—ªå‘å…‰ã€‚"), class: "normal" },
        { text: applySpecialMarkers("ä½ ä»¬æˆåŠŸè·å¾—äº†ğŸ”¥å¤©é›·ç ï¼Œè¿™æ˜¯å¼ºå¤§çš„ç«ç³»ç¥å™¨ï¼"), class: "normal" },
        { text: applySpecialMarkers(`${petName} çš„ğŸ”¥ç«å±æ€§å¾—åˆ°äº†æå‡ï¼`), class: "normal" }
    ];

    const storyContent = document.getElementById('storyContent');
    storyContent.innerHTML = '';
    showStoryLinesWithClasses(fireLines, storyContent, () => {
        setTimeout(() => {
            addStoryLineWithChoices('ğŸ‰ å†’é™©å®Œæˆï¼ç»§ç»­æ¢ç´¢è¿˜æ˜¯è¿”å›ï¼Ÿ', true);
        }, 2000);
    });
}

function exploreWaterStream() {
    const pet = gameState.currentPet;
    const petName = pet.displayName || pet.name;
    
    showDialog(
        'â—ˆ æ¸…æ³‰æºªæµæ¢ç´¢',
        `${petName} æ²¿ç€æ¸…æ³‰æºªæµå‰è¿›...<br><br>æ¸…æ¾ˆçš„æºªæ°´ä¸­ï¼Œâœ¿ ç‘¶æ± èŠ± âœ¿ é™é™ç»½æ”¾ã€‚<br><br>ä½ ä»¬é‡‡é›†åˆ°äº† âœ¿ ç‘¶æ± èŠ± âœ¿ï¼Œè¿™æ˜¯ç¥åœ£çš„æ°´ç³»çµè¯ï¼<br><br>${petName} çš„ â—ˆ æ°´å±æ€§ å¾—åˆ°äº†å‡€åŒ–ï¼`,
        [
            { text: 'ç»§ç»­å†’é™©', action: () => startFirstAdventure() },
            { text: 'è¿”å›é€‰æ‹©', action: () => showTutorialChoices() }
        ]
    );
}

// å® ç‰©äº¤äº’å¯¹è¯å‡½æ•°
function showPetDialog() {
    const pet = gameState.currentPet;
    const petName = pet.displayName || pet.name;
    
    showDialog(
        'ğŸ’¬ å¯¹è¯äº¤æµ',
        `ä½ è½»å£°å‘¼å”¤ ${petName} çš„åå­—...<br><br>${petName} å‘å‡ºæ¸©æŸ”çš„å›åº”å£°ï¼Œä¼¼ä¹åœ¨è¯‰è¯´ç€ä»€ä¹ˆã€‚<br><br>ä½ ä»¬ä¹‹é—´çš„ç¾ç»Šæ›´åŠ æ·±åšäº†ï¼`,
        [
            { text: 'ç»§ç»­äº¤æµ', action: () => showPetDialog() },
            { text: 'è¿”å›é€‰æ‹©', action: () => showTutorialChoices() }
        ]
    );
}

function showPetPlay() {
    const pet = gameState.currentPet;
    const petName = pet.displayName || pet.name;
    
    showDialog(
        'ğŸ® ä¸€èµ·æ¸¸æˆ',
        `${petName} å…´å¥‹åœ°å›´ç»•ç€ä½ è½¬åœˆï¼Œé‚€è¯·ä½ ä¸€èµ·æ¸¸æˆã€‚<br><br>ä½ ä»¬åœ¨ â€» ä¸–ç•Œæ ‘ â€» ä¸‹å¿«ä¹åœ°ç©è€ï¼Œ${petName} æ˜¾å¾—æ ¼å¤–å¼€å¿ƒï¼<br><br>æ¸¸æˆè®©ä½ ä»¬çš„å‹è°Šæ›´åŠ ç‰¢å›ºï¼`,
        [
            { text: 'å†ç©ä¸€æ¬¡', action: () => showPetPlay() },
            { text: 'è¿”å›é€‰æ‹©', action: () => showTutorialChoices() }
        ]
    );
}

function showPetCare() {
    const pet = gameState.currentPet;
    const petName = pet.displayName || pet.name;
    
    showDialog(
        'ğŸ– å–‚é£Ÿç…§æ–™',
        `ä½ æ‹¿å‡ºç²¾å¿ƒå‡†å¤‡çš„é£Ÿç‰©ï¼Œ${petName} æ„Ÿæ¿€åœ°çœ‹ç€ä½ ã€‚<br><br>åœ¨ä½ çš„æ‚‰å¿ƒç…§æ–™ä¸‹ï¼Œ${petName} æ¢å¤äº†ä½“åŠ›å’Œç²¾ç¥ã€‚<br><br>ä½ çš„å…³çˆ±è®© ${petName} æ„Ÿåˆ°æ— æ¯”æ¸©æš–ï¼`,
        [
            { text: 'ç»§ç»­ç…§æ–™', action: () => showPetCare() },
            { text: 'è¿”å›é€‰æ‹©', action: () => showTutorialChoices() }
        ]
    );
}

</script>
</body>
</html>