<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>çµå¢ƒæ–—å® å½• - ç§»åŠ¨ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* æ¸¸æˆä¸»ç•Œé¢ */
        .game-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .status-bar {
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        .pet-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pet-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .activity-points {
            background: rgba(255,215,0,0.2);
            padding: 5px 10px;
            border-radius: 15px;
            border: 1px solid #ffd700;
        }

        /* å¯¹è¯åŒºåŸŸ */
        .dialogue-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
        }

        .message {
            margin-bottom: 15px;
            animation: fadeInUp 0.3s ease;
        }

        .message.system {
            text-align: center;
            color: #87ceeb;
            font-style: italic;
            font-size: 14px;
        }

        .message.pet {
            background: rgba(255,255,255,0.9);
            padding: 12px 16px;
            border-radius: 18px 18px 18px 5px;
            max-width: 80%;
            color: #333;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .message.user {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 12px 16px;
            border-radius: 18px 18px 5px 18px;
            max-width: 80%;
            margin-left: auto;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        /* åŠ¨ä½œé€‰é¡¹å¡ç‰‡ */
        .action-cards {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            overflow-x: auto;
            padding: 5px 0;
        }

        .action-card {
            min-width: 120px;
            background: rgba(255,255,255,0.9);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid transparent;
        }

        .action-card:hover, .action-card:active {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border-color: #667eea;
        }

        .action-card .icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .action-card .title {
            font-size: 12px;
            font-weight: bold;
            color: #333;
        }

        /* åº•éƒ¨è¾“å…¥åŒº */
        .input-area {
            background: rgba(0,0,0,0.8);
            padding: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .chat-input {
            flex: 1;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            padding: 12px 20px;
            color: white;
            font-size: 16px;
            outline: none;
        }

        .chat-input::placeholder {
            color: rgba(255,255,255,0.6);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        /* èœå•æŒ‰é’® */
        .menu-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(0,0,0,0.6);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        /* å³ä¸Šè§’å¸¸é©»é¢æ¿æŒ‰é’® */
        .panel-btn {
            position: fixed;
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(0,0,0,0.6);
            color: #fff;
            border: none;
            cursor: pointer;
            z-index: 1000;
            backdrop-filter: blur(10px);
            font-size: 18px;
        }
        .panel-btn.pet {
            top: 80px;
        }
        .panel-btn.explore {
            top: 132px;
        }

        /* ä¾§è¾¹èœå• */
        .side-menu {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100vh;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(20px);
            transition: right 0.3s ease;
            z-index: 999;
            padding: 80px 20px 20px;
            color: white;
        }

        .side-menu.open {
            right: 0;
        }

        .menu-item {
            padding: 15px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.1);
            margin: 0 -20px;
            padding-left: 20px;
            padding-right: 20px;
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        /* åŠ¨ç”» */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        .bounce {
            animation: bounce 1s;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 480px) {
            .status-bar {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .pet-avatar {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
            
            .dialogue-area {
                padding: 15px;
            }
            
            .action-card {
                min-width: 100px;
                padding: 10px;
            }
            
            .input-area {
                padding: 12px;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* å® ç‰©çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .pet-status {
            display: flex;
            gap: 5px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
        }

        .status-dot.hungry {
            background: #FF9800;
        }

        .status-dot.tired {
            background: #F44336;
        }

        .status-dot.happy {
            background: #2196F3;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <div class="status-bar">
            <div class="pet-info">
                <div class="pet-avatar" id="petAvatar">ğŸ¥š</div>
                <div>
                    <div id="petName">é€‰æ‹©å® ç‰©</div>
                    <div class="pet-status">
                        <span class="status-dot" id="healthStatus"></span>
                        <span class="status-dot hungry" id="hungerStatus"></span>
                        <span class="status-dot happy" id="moodStatus"></span>
                    </div>
                </div>
            </div>
            <div class="activity-points">
                âš¡ <span id="activityPoints">100</span>/100
            </div>
        </div>

        <!-- å¯¹è¯åŒºåŸŸ -->
        <div class="dialogue-area" id="dialogueArea">
            <div class="message system">
                ğŸŒŸ æ¬¢è¿æ¥åˆ°çµå¢ƒä¸–ç•Œï¼åœ¨è¿™é‡Œï¼Œä½ å°†é‡åˆ°å±äºä½ çš„çµå® ä¼™ä¼´...
            </div>
        </div>

        <!-- åº•éƒ¨è¾“å…¥åŒº -->
        <div class="input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="å’Œä½ çš„çµå® è¯´è¯..." maxlength="100">
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">ğŸ“¤</button>
        </div>
    </div>

    <!-- èœå•æŒ‰é’® -->
    <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
    <!-- å¸¸é©»å…¥å£ï¼šå® ç‰©é¢æ¿ / æ¢å¯»é¢æ¿ -->
    <button class="panel-btn pet" title="å® ç‰©é¢æ¿ / Pet" onclick="openPetPanel()">ğŸ¾</button>
    <button class="panel-btn explore" title="æ¢å¯»é¢æ¿ / Explore" onclick="openExplorePanel()">ğŸ—ºï¸</button>

    <!-- ä¾§è¾¹èœå• -->
    <div class="side-menu" id="sideMenu">
        <div class="menu-item" onclick="showPetStatus()">
            <span>ğŸ“Š</span> å® ç‰©çŠ¶æ€
        </div>
        <div class="menu-item" onclick="showInventory()">
            <span>ğŸ’</span> èƒŒåŒ…é“å…·
        </div>
        <div class="menu-item" onclick="showAdventureLog()">
            <span>ğŸ“–</span> å†’é™©æ—¥å¿—
        </div>
        <div class="menu-item" onclick="showSettings()">
            <span>âš™ï¸</span> æ¸¸æˆè®¾ç½®
        </div>
        <div class="menu-item" onclick="showHelp()">
            <span>â“</span> æ¸¸æˆå¸®åŠ©
        </div>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div class="modal" id="gameModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div id="modalContent">
                <!-- åŠ¨æ€å†…å®¹ -->
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            currentPet: null,
            activityPoints: 100,
            isMenuOpen: false,
            conversationContext: [],
            lastActionTime: Date.now()
        };

        // åŸºç¡€å¤šè¯­è¨€ï¼ˆæ ¹æ®è·¯å¾„ /en/ è‡ªåŠ¨åˆ‡è‹±æ–‡ï¼‰
        const lang = location.pathname.startsWith('/en') ? 'en' : 'zh';
        const i18n = {
            zh: {
                petPanel: 'å® ç‰©é¢æ¿',
                explorePanel: 'æ¢å¯»é¢æ¿',
                petStatus: 'å® ç‰©çŠ¶æ€',
                rarity: 'ç¨€æœ‰åº¦',
                level: 'ç­‰çº§',
                hp: 'ç”Ÿå‘½å€¼',
                atk: 'æ”»å‡»åŠ›',
                def: 'é˜²å¾¡åŠ›',
                spd: 'é€Ÿåº¦',
                elem: 'å…ƒç´ ',
                traits: 'ç‰¹æ€§æè¿°',
                exploreTitle: 'é€‰æ‹©æ¢ç´¢åœ°ç‚¹',
                exploreTip: 'ä¸åŒåœ°ç‚¹å°†å¸¦æ¥ä¸åŒçš„å¥‡é‡ä¸è¯æ¡å˜åŒ–',
                startExplore: 'å¼€å§‹æ¢ç´¢',
                comingSoon: 'åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…...',
                noPet: 'ä½ è¿˜æ²¡æœ‰å® ç‰©å“¦ï¼'
            },
            en: {
                petPanel: 'Pet Panel',
                explorePanel: 'Explore Panel',
                petStatus: 'Pet Status',
                rarity: 'Rarity',
                level: 'Level',
                hp: 'HP',
                atk: 'Attack',
                def: 'Defense',
                spd: 'Speed',
                elem: 'Element',
                traits: 'Trait Description',
                exploreTitle: 'Choose a Location',
                exploreTip: 'Different locations bring different adventures and traits',
                startExplore: 'Start Exploring',
                comingSoon: 'Coming soon...',
                noPet: 'No pet yet!'
            }
        };
        const t = (key) => (i18n[lang] && i18n[lang][key]) || i18n.zh[key] || key;

        // åˆå§‹åŒ–æ¸¸æˆ
        document.addEventListener('DOMContentLoaded', function() {
            initializeGame();
            setupEventListeners();
            startGameLoop();
        });

        function initializeGame() {
            addSystemMessage('ğŸ® æ­£åœ¨åˆå§‹åŒ–çµå¢ƒä¸–ç•Œ...');
            
            setTimeout(() => {
                loadGameData();
                showWelcomeSequence();
            }, 1000);
        }

        function setupEventListeners() {
            // å›è½¦å‘é€æ¶ˆæ¯
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // ç‚¹å‡»ç©ºç™½åŒºåŸŸå…³é—­èœå•
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.side-menu') && !e.target.closest('.menu-btn')) {
                    closeMenu();
                }
            });
        }

        function startGameLoop() {
            // æ¯30ç§’æ›´æ–°ä¸€æ¬¡æ¸¸æˆçŠ¶æ€
            setInterval(() => {
                updateActivityPoints();
                checkPetStatus();
                triggerRandomEvents();
            }, 30000);
        }

        async function loadGameData() {
            try {
                // åŠ è½½æ´»åŠ¨ç‚¹æ•°
                const activityResponse = await fetch('/api/pets/activity-status');
                const activityData = await activityResponse.json();
                
                if (activityData.success) {
                    gameState.activityPoints = activityData.data.currentPoints;
                    updateActivityDisplay();
                }

                // åŠ è½½å® ç‰©åˆ—è¡¨
                const petsResponse = await fetch('/api/pets/user/mobile-user');
                const petsData = await petsResponse.json();
                
                if (petsData.success && petsData.data.length > 0) {
                    gameState.currentPet = petsData.data[0];
                    updatePetDisplay();
                } else {
                    showCreatePetPrompt();
                }
            } catch (error) {
                console.error('Failed to load game data:', error);
                addSystemMessage('âš ï¸ è¿æ¥çµå¢ƒä¸–ç•Œæ—¶é‡åˆ°é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•...');
            }
        }

        function showWelcomeSequence() {
            const welcomeMessages = [
                'âœ¨ çµå¢ƒä¸–ç•Œçš„å¤§é—¨å·²ç»ä¸ºä½ æ‰“å¼€...',
                'ğŸŒ¸ åœ¨è¿™é‡Œï¼Œæ¯ä¸€åªç”Ÿç‰©éƒ½æ‹¥æœ‰ç‹¬ç‰¹çš„çµé­‚...',
                'ğŸ’« ä½ çš„è¯è¯­å°†æˆä¸ºå®ƒä»¬æˆé•¿çš„å…»åˆ†...',
                'ğŸ¯ ç°åœ¨ï¼Œè®©æˆ‘ä»¬å¼€å§‹è¿™æ®µå¥‡å¦™çš„æ—…ç¨‹å§ï¼'
            ];

            welcomeMessages.forEach((message, index) => {
                setTimeout(() => {
                    addSystemMessage(message);
                }, index * 2000);
            });
        }

        function showCreatePetPrompt() {
            setTimeout(() => {
                addSystemMessage('ğŸ¥š ä½ è¿˜æ²¡æœ‰çµå® ä¼™ä¼´ï¼Œè®©æˆ‘ä»¬åˆ›é€ ä¸€ä¸ªæ–°çš„ç”Ÿå‘½å§ï¼');
                showActionCards([
                    { icon: 'ğŸ£', title: 'å­µåŒ–æ–°å® ', action: 'createPet' },
                    { icon: 'ğŸ²', title: 'éšæœºè·å¾—', action: 'randomPet' },
                    { icon: 'ğŸ“š', title: 'äº†è§£æ›´å¤š', action: 'learnMore' }
                ]);
            }, 8000);
        }

        function addMessage(content, type = 'system', showActions = null) {
            const dialogueArea = document.getElementById('dialogueArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = content;
            
            dialogueArea.appendChild(messageDiv);
            
            // å¦‚æœæœ‰åŠ¨ä½œé€‰é¡¹ï¼Œæ·»åŠ åŠ¨ä½œå¡ç‰‡
            if (showActions) {
                showActionCards(showActions);
            }
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            dialogueArea.scrollTop = dialogueArea.scrollHeight;
        }

        function addSystemMessage(content) {
            addMessage(content, 'system');
        }

        function addPetMessage(content, showActions = null) {
            addMessage(content, 'pet', showActions);
        }

        function addUserMessage(content) {
            addMessage(content, 'user');
        }

        function showActionCards(actions) {
            const dialogueArea = document.getElementById('dialogueArea');
            const cardsContainer = document.createElement('div');
            cardsContainer.className = 'action-cards';
            
            actions.forEach(action => {
                const card = document.createElement('div');
                card.className = 'action-card';
                card.innerHTML = `
                    <div class="icon">${action.icon}</div>
                    <div class="title">${action.title}</div>
                `;
                card.onclick = () => handleAction(action.action, action.params);
                cardsContainer.appendChild(card);
            });
            
            dialogueArea.appendChild(cardsContainer);
            dialogueArea.scrollTop = dialogueArea.scrollHeight;
        }

        async function handleAction(actionType, params = {}) {
            // ç§»é™¤æ‰€æœ‰åŠ¨ä½œå¡ç‰‡
            document.querySelectorAll('.action-cards').forEach(cards => cards.remove());
            
            switch (actionType) {
                case 'createPet':
                    await createNewPet();
                    break;
                case 'randomPet':
                    await createRandomPet();
                    break;
                case 'feed':
                    await feedPet(params.food);
                    break;
                case 'explore':
                    await explorePet(params.location);
                    break;
                case 'battle':
                    await startBattle();
                    break;
                case 'adventure':
                    await startAdventure();
                    break;
                case 'learnMore':
                    showGameGuide();
                    break;
                default:
                    addSystemMessage(`ğŸ¤” æœªçŸ¥çš„è¡ŒåŠ¨ï¼š${actionType}`);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addUserMessage(message);
            input.value = '';
            
            // å¦‚æœæ²¡æœ‰å® ç‰©ï¼Œå¼•å¯¼åˆ›å»º
            if (!gameState.currentPet) {
                setTimeout(() => {
                    addPetMessage('å’•å’•ï¼Ÿ(æˆ‘è¿˜ä¸å­˜åœ¨å‘¢ï¼Œå…ˆåˆ›é€ æˆ‘å§ï¼)', [
                        { icon: 'ğŸ£', title: 'åˆ›é€ å® ç‰©', action: 'createPet' }
                    ]);
                }, 500);
                return;
            }
            
            // å‘é€èŠå¤©è¯·æ±‚
            try {
                addPetMessage('<div class="loading"></div>');
                
                const response = await fetch('/api/pets/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        petId: gameState.currentPet.id,
                        message: message
                    })
                });
                
                const data = await response.json();
                
                // ç§»é™¤åŠ è½½åŠ¨ç”»
                const loadingMessages = document.querySelectorAll('.message.pet');
                const lastMessage = loadingMessages[loadingMessages.length - 1];
                if (lastMessage && lastMessage.innerHTML.includes('loading')) {
                    lastMessage.remove();
                }
                
                if (data.success) {
                    const petResponse = data.data.response;
                    const suggestedActions = analyzePetResponse(message, petResponse);
                    
                    addPetMessage(petResponse, suggestedActions);
                    
                    // æ›´æ–°å¯¹è¯ä¸Šä¸‹æ–‡
                    gameState.conversationContext.push({
                        user: message,
                        pet: petResponse,
                        timestamp: Date.now()
                    });
                    
                    // ä¿æŒä¸Šä¸‹æ–‡åœ¨åˆç†èŒƒå›´å†…
                    if (gameState.conversationContext.length > 10) {
                        gameState.conversationContext.shift();
                    }
                } else {
                    addPetMessage('å˜¤å˜¤...(æˆ‘ç°åœ¨æœ‰ç‚¹ç´¯ï¼Œç¨åå†èŠå§)');
                }
            } catch (error) {
                console.error('Chat error:', error);
                addPetMessage('å’•å’•...(ç½‘ç»œä¼¼ä¹æœ‰é—®é¢˜)');
            }
        }

        function analyzePetResponse(userMessage, petResponse) {
            const actions = [];
            
            // æ ¹æ®ç”¨æˆ·æ¶ˆæ¯å’Œå® ç‰©å›åº”åˆ†æå¯èƒ½çš„è¡ŒåŠ¨
            if (userMessage.includes('é¥¿') || userMessage.includes('åƒ') || petResponse.includes('é¥¿')) {
                actions.push({ icon: 'ğŸ', title: 'å–‚é£Ÿ', action: 'feed', params: { food: 'apple' } });
                actions.push({ icon: 'ğŸ¥•', title: 'å–‚èƒ¡èåœ', action: 'feed', params: { food: 'carrot' } });
            }
            
            if (userMessage.includes('ç©') || userMessage.includes('æ— èŠ') || userMessage.includes('æ¢ç´¢')) {
                actions.push({ icon: 'ğŸ—ºï¸', title: 'æ¢ç´¢', action: 'explore', params: { location: 'forest' } });
                actions.push({ icon: 'ğŸ”ï¸', title: 'ç™»å±±', action: 'explore', params: { location: 'mountain' } });
            }
            
            if (userMessage.includes('æˆ˜æ–—') || userMessage.includes('æ‰“æ¶') || userMessage.includes('æ¯”è¯•')) {
                actions.push({ icon: 'âš”ï¸', title: 'æˆ˜æ–—', action: 'battle' });
            }
            
            if (userMessage.includes('å†’é™©') || userMessage.includes('æ—…è¡Œ')) {
                actions.push({ icon: 'ğŸ’', title: 'æ‰˜ç®¡å†’é™©', action: 'adventure' });
            }
            
            // å¦‚æœæ²¡æœ‰ç‰¹å®šè¡ŒåŠ¨ï¼Œæä¾›åŸºç¡€é€‰é¡¹
            if (actions.length === 0) {
                const randomActions = [
                    { icon: 'ğŸ¯', title: 'å–‚èœ‚èœœ', action: 'feed', params: { food: 'honey' } },
                    { icon: 'ğŸŒ¸', title: 'èŠ±å›­æ•£æ­¥', action: 'explore', params: { location: 'garden' } },
                    { icon: 'ğŸ’¤', title: 'è®©å®ƒä¼‘æ¯', action: 'rest' }
                ];
                actions.push(randomActions[Math.floor(Math.random() * randomActions.length)]);
            }
            
            return actions.length > 0 ? actions : null;
        }

        async function createNewPet() {
            addSystemMessage('ğŸŒŸ æ­£åœ¨å­µåŒ–æ–°çš„ç”Ÿå‘½...');
            
            try {
                const response = await fetch('/api/pets/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: 'mobile-user',
                        petName: generateRandomPetName()
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    gameState.currentPet = data.data;
                    updatePetDisplay();
                    
                    addSystemMessage(`ğŸ‰ æ­å–œï¼${data.data.name} è¯ç”Ÿäº†ï¼`);
                    
                    setTimeout(() => {
                        addPetMessage('å’•å’•ï¼(ä½ å¥½ï¼Œæˆ‘æ˜¯æ–°ç”Ÿçš„å°å®¶ä¼™ï¼)', [
                            { icon: 'ğŸ‘‹', title: 'æ‰“æ‹›å‘¼', action: 'greet' },
                            { icon: 'ğŸ¼', title: 'ç¬¬ä¸€æ¬¡å–‚é£Ÿ', action: 'feed', params: { food: 'milk' } },
                            { icon: 'ğŸµ', title: 'å”±æ‘‡ç¯®æ›²', action: 'sing' }
                        ]);
                    }, 1500);
                } else {
                    addSystemMessage('âŒ å­µåŒ–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•...');
                }
            } catch (error) {
                console.error('Create pet error:', error);
                addSystemMessage('âš ï¸ åˆ›å»ºå® ç‰©æ—¶é‡åˆ°é—®é¢˜');
            }
        }

        async function createRandomPet() {
            const randomNames = ['å°ç«', 'æ°´æ»´', 'é£å„¿', 'çŸ³å¤´', 'é—ªç”µ', 'æœˆå…‰', 'æ˜Ÿå°˜', 'å½©è™¹'];
            const randomName = randomNames[Math.floor(Math.random() * randomNames.length)];
            
            addSystemMessage(`ğŸ² éšæœºå¬å”¤ä¸­... å‡ºç°äº† ${randomName}ï¼`);
            
            // è°ƒç”¨åˆ›å»ºå® ç‰©APIï¼Œä½¿ç”¨éšæœºåå­—
            try {
                const response = await fetch('/api/pets/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: 'mobile-user',
                        petName: randomName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    gameState.currentPet = data.data;
                    updatePetDisplay();
                    
                    addSystemMessage(`âœ¨ ${randomName} ä»è™šç©ºä¸­ç°èº«ï¼`);
                    addPetMessage('å˜¤å˜¤ï¼Ÿ(æˆ‘æ˜¯è°ï¼Ÿæˆ‘åœ¨å“ªï¼Ÿ)', [
                        { icon: 'ğŸ¤—', title: 'å®‰æ…°å®ƒ', action: 'comfort' },
                        { icon: 'ğŸ ', title: 'å¸¦å®ƒå›å®¶', action: 'goHome' }
                    ]);
                }
            } catch (error) {
                addSystemMessage('âŒ å¬å”¤å¤±è´¥...');
            }
        }

        function generateRandomPetName() {
            const prefixes = ['å°', 'å¤§', 'é—ª', 'æš—', 'é‡‘', 'é“¶', 'å½©', 'æ¢¦'];
            const suffixes = ['ç«', 'æ°´', 'é£', 'åœŸ', 'å…‰', 'å½±', 'æ˜Ÿ', 'æœˆ', 'äº‘', 'é›·'];
            
            const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
            const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];
            
            return prefix + suffix;
        }

        function updatePetDisplay() {
            if (!gameState.currentPet) return;
            
            const petName = document.getElementById('petName');
            const petAvatar = document.getElementById('petAvatar');
            
            petName.textContent = gameState.currentPet.name;
            
            // æ ¹æ®å® ç‰©ç­‰çº§å’Œç¨€æœ‰åº¦æ›´æ–°å¤´åƒ
            const avatars = {
                'N': 'ğŸ£', 'R': 'ğŸ°', 'SR': 'ğŸ¦Š', 'SSR': 'ğŸ‰', 'SSS': 'ğŸ‘‘'
            };
            petAvatar.textContent = avatars[gameState.currentPet.rarity] || 'ğŸ¥š';
            
            // æ·»åŠ å¼¹è·³åŠ¨ç”»
            petAvatar.classList.add('bounce');
            setTimeout(() => petAvatar.classList.remove('bounce'), 1000);
        }

        function updateActivityDisplay() {
            document.getElementById('activityPoints').textContent = gameState.activityPoints;
        }

        function updateActivityPoints() {
            // æ¯30ç§’æ¢å¤1ç‚¹æ´»åŠ¨ç‚¹æ•°ï¼ˆå¦‚æœæœªæ»¡ï¼‰
            if (gameState.activityPoints < 100) {
                gameState.activityPoints = Math.min(100, gameState.activityPoints + 1);
                updateActivityDisplay();
            }
        }

        function checkPetStatus() {
            if (!gameState.currentPet) return;
            
            // æ¨¡æ‹Ÿå® ç‰©çŠ¶æ€å˜åŒ–
            const timeSinceLastAction = Date.now() - gameState.lastActionTime;
            
            if (timeSinceLastAction > 300000) { // 5åˆ†é’Ÿæ— æ“ä½œ
                if (Math.random() < 0.3) {
                    triggerPetEvent();
                }
            }
        }

        function triggerPetEvent() {
            const events = [
                {
                    message: 'å’•å’•å’•...(æˆ‘æœ‰ç‚¹é¥¿äº†)',
                    actions: [
                        { icon: 'ğŸ', title: 'å–‚è‹¹æœ', action: 'feed', params: { food: 'apple' } },
                        { icon: 'ğŸ¥›', title: 'å–‚ç‰›å¥¶', action: 'feed', params: { food: 'milk' } }
                    ]
                },
                {
                    message: 'å˜¤å˜¤~(å¥½æ— èŠå•Šï¼Œæˆ‘ä»¬åšç‚¹ä»€ä¹ˆå§)',
                    actions: [
                        { icon: 'ğŸ¾', title: 'ç©çƒ', action: 'play' },
                        { icon: 'ğŸŒ³', title: 'æ•£æ­¥', action: 'explore', params: { location: 'park' } }
                    ]
                },
                {
                    message: 'å‘¼å™œå™œ...(æˆ‘æƒ³ç¡è§‰äº†)',
                    actions: [
                        { icon: 'ğŸ›ï¸', title: 'å“„ç¡', action: 'sleep' },
                        { icon: 'ğŸµ', title: 'å”±æ‘‡ç¯®æ›²', action: 'sing' }
                    ]
                }
            ];
            
            const randomEvent = events[Math.floor(Math.random() * events.length)];
            addPetMessage(randomEvent.message, randomEvent.actions);
        }

        function triggerRandomEvents() {
            if (Math.random() < 0.1) { // 10% æ¦‚ç‡è§¦å‘éšæœºäº‹ä»¶
                const events = [
                    'ğŸŒŸ ä½ çš„å® ç‰©åœ¨æ¢ç´¢ä¸­å‘ç°äº†é—ªäº®çš„ä¸œè¥¿ï¼',
                    'ğŸ¦‹ ä¸€åªç¾ä¸½çš„è´è¶é£è¿‡ï¼Œä½ çš„å® ç‰©å¾ˆå¼€å¿ƒï¼',
                    'ğŸŒ™ å¤œæ™šé™ä¸´ï¼Œä½ çš„å® ç‰©çœ‹èµ·æ¥å¾ˆå¹³é™...',
                    'â˜€ï¸ é˜³å…‰æ´’ä¸‹ï¼Œä½ çš„å® ç‰©ç²¾ç¥ç„•å‘ï¼'
                ];
                
                const randomEvent = events[Math.floor(Math.random() * events.length)];
                addSystemMessage(randomEvent);
            }
        }

        // èœå•ç›¸å…³å‡½æ•°
        function toggleMenu() {
            const menu = document.getElementById('sideMenu');
            gameState.isMenuOpen = !gameState.isMenuOpen;
            menu.classList.toggle('open', gameState.isMenuOpen);
        }

        function closeMenu() {
            const menu = document.getElementById('sideMenu');
            gameState.isMenuOpen = false;
            menu.classList.remove('open');
        }

        function showModal(content) {
            const modal = document.getElementById('gameModal');
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = content;
            modal.style.display = 'flex';
        }

        function closeModal() {
            const modal = document.getElementById('gameModal');
            modal.style.display = 'none';
        }

        function showPetStatus() {
            closeMenu();
            if (!gameState.currentPet) {
                showModal(`<h2>ğŸ“Š ${t('petStatus')}</h2><p>${t('noPet')}</p>`);
                return;
            }
            
            const pet = gameState.currentPet;
            const content = `
                <h2>ğŸ“Š ${t('petStatus')}</h2>
                <div style="margin: 20px 0;">
                    <p><strong>${t('rarity')}:</strong> ${pet.rarity}</p>
                    <p><strong>${t('level')}:</strong> ${pet.level || 1}</p>
                    <p><strong>${t('hp')}:</strong> ${pet.hp}</p>
                    <p><strong>${t('atk')}:</strong> ${pet.attack}</p>
                    <p><strong>${t('def')}:</strong> ${pet.defense}</p>
                    <p><strong>${t('spd')}:</strong> ${pet.speed}</p>
                    <p><strong>${t('elem')}:</strong> ${pet.element}</p>
                </div>
                <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-top: 20px;">
                    <h3>ğŸ§¬ ${t('traits')}</h3>
                    <p style="font-style: italic;">${pet.base_prompt}</p>
                </div>
            `;
            showModal(content);
        }

        function showInventory() {
            closeMenu();
            showModal(`
                <h2>ğŸ’ èƒŒåŒ…é“å…·</h2>
                <p>åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…...</p>
                <div style="margin: 20px 0;">
                    <div style="padding: 10px; border: 1px solid #ddd; margin: 5px 0;">ğŸ è‹¹æœ x3</div>
                    <div style="padding: 10px; border: 1px solid #ddd; margin: 5px 0;">ğŸ¥› ç‰›å¥¶ x2</div>
                    <div style="padding: 10px; border: 1px solid #ddd; margin: 5px 0;">ğŸ¯ èœ‚èœœ x1</div>
                </div>
            `);
        }

        function showAdventureLog() {
            closeMenu();
            showModal(`
                <h2>ğŸ“– å†’é™©æ—¥å¿—</h2>
                <p>è®°å½•ä½ å’Œå® ç‰©çš„ç²¾å½©å†’é™©...</p>
                <div style="margin: 20px 0;">
                    <div style="padding: 15px; border-left: 4px solid #667eea; margin: 10px 0; background: #f8f9ff;">
                        <strong>ä»Šå¤© 14:30</strong><br>
                        ${gameState.currentPet ? gameState.currentPet.name : 'å°å® ç‰©'} åœ¨æ£®æ—ä¸­å‘ç°äº†ç¥ç§˜çš„å…‰èŠ’...
                    </div>
                    <div style="padding: 15px; border-left: 4px solid #4CAF50; margin: 10px 0; background: #f1f8e9;">
                        <strong>æ˜¨å¤© 16:45</strong><br>
                        æˆåŠŸå­µåŒ–äº†æ–°çš„å® ç‰©ä¼™ä¼´ï¼
                    </div>
                </div>
            `);
        }

        function showSettings() {
            closeMenu();
            showModal(`
                <h2>âš™ï¸ æ¸¸æˆè®¾ç½®</h2>
                <div style="margin: 20px 0;">
                    <label style="display: block; margin: 15px 0;">
                        <input type="checkbox" checked> éŸ³æ•ˆå¼€å¯
                    </label>
                    <label style="display: block; margin: 15px 0;">
                        <input type="checkbox" checked> æ¨é€é€šçŸ¥
                    </label>
                    <label style="display: block; margin: 15px 0;">
                        <input type="checkbox"> è‡ªåŠ¨ä¿å­˜
                    </label>
                </div>
                <button style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-top: 20px;">
                    ä¿å­˜è®¾ç½®
                </button>
            `);
        }

        function showHelp() {
            closeMenu();
            showModal(`
                <h2>â“ æ¸¸æˆå¸®åŠ©</h2>
                <div style="margin: 20px 0; line-height: 1.6;">
                    <h3>ğŸ® å¦‚ä½•æ¸¸æˆ</h3>
                    <p>1. é€šè¿‡å¯¹è¯ä¸ä½ çš„å® ç‰©äº’åŠ¨</p>
                    <p>2. æ ¹æ®å® ç‰©çš„å›åº”é€‰æ‹©ç›¸åº”çš„è¡ŒåŠ¨</p>
                    <p>3. å–‚é£Ÿã€æ¢ç´¢ã€æˆ˜æ–—æ¥åŸ¹å…»ä½ çš„å® ç‰©</p>
                    
                    <h3>âš¡ æ´»åŠ¨ç‚¹æ•°</h3>
                    <p>æ¯æ¬¡è¡ŒåŠ¨æ¶ˆè€—æ´»åŠ¨ç‚¹æ•°ï¼Œæ¯å°æ—¶è‡ªåŠ¨æ¢å¤</p>
                    
                    <h3>ğŸŒŸ ç¨€æœ‰åº¦ç³»ç»Ÿ</h3>
                    <p>N â†’ R â†’ SR â†’ SSR â†’ SSS</p>
                    <p>é€šè¿‡åŸ¹å…»å¯ä»¥æå‡å® ç‰©ç¨€æœ‰åº¦</p>
                </div>
            `);
        }

        function showGameGuide() {
            if (lang === 'en') {
                addSystemMessage('ğŸ“š Guide to the Spirit Realm');
                addSystemMessage('Your words will shape your petâ€™s growth...');
                addSystemMessage('Talk, feed, and explore to witness evolution!');
                showActionCards([
                    { icon: 'ğŸ£', title: 'Hatch', action: 'createPet' },
                    { icon: 'â“', title: 'Help', action: 'showHelp' }
                ]);
            } else {
                addSystemMessage('ğŸ“š çµå¢ƒä¸–ç•ŒæŒ‡å—');
                addSystemMessage('åœ¨è¿™ä¸ªä¸–ç•Œé‡Œï¼Œä½ çš„æ¯ä¸€å¥è¯éƒ½ä¼šå½±å“å® ç‰©çš„æˆé•¿...');
                addSystemMessage('é€šè¿‡å¯¹è¯ã€å–‚é£Ÿã€æ¢ç´¢ï¼Œè§è¯å®ƒä»¬çš„å¥‡å¦™å˜åŒ–ï¼');
                showActionCards([
                    { icon: 'ğŸ£', title: 'å¼€å§‹å­µåŒ–', action: 'createPet' },
                    { icon: 'â“', title: 'è¯¦ç»†å¸®åŠ©', action: 'showHelp' }
                ]);
            }
        }

        // å¤„ç†å…¶ä»–è¡ŒåŠ¨
        async function feedPet(food) {
            if (gameState.activityPoints < 10) {
                addSystemMessage('âš¡ æ´»åŠ¨ç‚¹æ•°ä¸è¶³ï¼Œè¯·ç¨åå†è¯•');
                return;
            }
            
            addSystemMessage(`ğŸ½ï¸ ä½ ç»™ ${gameState.currentPet.name} å–‚äº† ${getFoodName(food)}`);
            
            try {
                const response = await fetch('/api/pets/feed', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        petId: gameState.currentPet.id,
                        food: food
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    gameState.activityPoints -= 10;
                    updateActivityDisplay();
                    
                    addPetMessage('å˜¤å˜¤ï¼(å¥½å¥½åƒï¼è°¢è°¢ä½ ï¼)', [
                        { icon: 'ğŸ¾', title: 'ä¸€èµ·ç©', action: 'play' },
                        { icon: 'ğŸ˜´', title: 'è®©å®ƒä¼‘æ¯', action: 'rest' }
                    ]);
                } else {
                    addSystemMessage('âŒ å–‚é£Ÿå¤±è´¥');
                }
            } catch (error) {
                addSystemMessage('âš ï¸ ç½‘ç»œé”™è¯¯');
            }
        }

        function getFoodName(food) {
            const zh = {
                'apple': 'ğŸ è‹¹æœ',
                'milk': 'ğŸ¥› ç‰›å¥¶',
                'honey': 'ğŸ¯ èœ‚èœœ',
                'carrot': 'ğŸ¥• èƒ¡èåœ'
            };
            const en = {
                'apple': 'ğŸ Apple',
                'milk': 'ğŸ¥› Milk',
                'honey': 'ğŸ¯ Honey',
                'carrot': 'ğŸ¥• Carrot'
            };
            return (lang === 'en' ? en[food] : zh[food]) || food;
        }

        // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // é¡µé¢éšè—æ—¶æš‚åœæŸäº›åŠŸèƒ½
            } else {
                // é¡µé¢æ˜¾ç¤ºæ—¶æ¢å¤åŠŸèƒ½
                loadGameData();
            }
        });

        // å¸¸é©»å…¥å£é€»è¾‘ï¼šæ‰“å¼€å® ç‰©é¢æ¿
        function openPetPanel() {
            showPetStatus();
        }

        // å¸¸é©»å…¥å£é€»è¾‘ï¼šæ‰“å¼€æ¢å¯»é¢æ¿
        function openExplorePanel() {
            closeMenu();
            if (!gameState.currentPet) {
                showModal(`<h2>ğŸ—ºï¸ ${t('explorePanel')}</h2><p>${t('noPet')}</p>`);
                return;
            }
            const locations = [
                { key: 'forest', name_zh: 'ğŸŒ³ æ£®æ—', name_en: 'ğŸŒ³ Forest' },
                { key: 'mountain', name_zh: 'ğŸ”ï¸ é«˜å±±', name_en: 'ğŸ”ï¸ Mountain' },
                { key: 'river', name_zh: 'ğŸï¸ æ²³è°·', name_en: 'ğŸï¸ River Valley' },
                { key: 'ruins', name_zh: 'ğŸ›ï¸ å¤è¿¹', name_en: 'ğŸ›ï¸ Ruins' },
                { key: 'cave', name_zh: 'ğŸ•³ï¸ æ´ç©´', name_en: 'ğŸ•³ï¸ Cave' }
            ];
            const list = locations.map(l => {
                const label = lang === 'en' ? l.name_en : l.name_zh;
                return `<button style="display:block;width:100%;text-align:left;margin:8px 0;padding:10px;border:1px solid #ddd;border-radius:8px;background:#f8f9ff;cursor:pointer;" onclick="explorePet('${l.key}')">${label}</button>`;
            }).join('');
            showModal(`
                <h2>ğŸ—ºï¸ ${t('exploreTitle')}</h2>
                <p style="color:#666;margin:10px 0 15px;">${t('exploreTip')}</p>
                ${list}
            `);
        }

        // æ¢ç´¢è¡Œä¸ºï¼ˆå®¹é”™ï¼šåç«¯æ— å®ç°ä¹Ÿæœ‰ä¼˜é›…é™çº§ï¼‰
        async function explorePet(locationKey = 'forest') {
            if (!gameState.currentPet) return;
            addSystemMessage(lang === 'en' ? `ğŸ—ºï¸ Exploring ${locationKey}...` : `ğŸ—ºï¸ å‰å¾€ ${locationKey} æ¢ç´¢ä¸­...`);
            try {
                const resp = await fetch('/api/pets/explore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ petId: gameState.currentPet.id, location: locationKey })
                });
                const data = await resp.json();
                if (data.success) {
                    addPetMessage(lang === 'en' ? 'Yay! That was fun!' : 'å˜¤å˜¤ï¼(å¥½æœ‰è¶£ï¼)');
                    if (data.data && data.data.description) {
                        addSystemMessage(data.data.description);
                    }
                } else {
                    addPetMessage(lang === 'en' ? 'Hmm... maybe later.' : 'å’•å’•...(ä¸‹æ¬¡å†å»å§)');
                }
            } catch (e) {
                addPetMessage(lang === 'en' ? 'Network seems unstable.' : 'ç½‘ç»œä¼¼ä¹ä¸ç¨³å®šã€‚');
            }
            closeModal();
        }

        // æ‰˜ç®¡å†’é™©ï¼ˆå®¹é”™ï¼‰
        async function startAdventure() {
            if (!gameState.currentPet) return;
            addSystemMessage(lang === 'en' ? 'ğŸ’ Starting managed adventure...' : 'ğŸ’ å¼€å§‹æ‰˜ç®¡å¥‡é‡...');
            try {
                const resp = await fetch('/api/pets/adventure/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ petId: gameState.currentPet.id, durationMinutes: 60 })
                });
                const data = await resp.json();
                if (data.success) {
                    addPetMessage(lang === 'en' ? 'See you later!' : 'å’•å’•ï¼(æˆ‘å»å»å°±å›ï¼)');
                } else {
                    addPetMessage(lang === 'en' ? 'Maybe later.' : 'å˜¤å˜¤...(ç¨åå§)');
                }
            } catch (e) {
                addPetMessage(lang === 'en' ? 'Network seems unstable.' : 'ç½‘ç»œä¼¼ä¹ä¸ç¨³å®šã€‚');
            }
        }

        // æ ¹æ®è¯­è¨€è°ƒæ•´æ ‡é¢˜ä¸å ä½ç¬¦
        (function applyLang() {
            if (lang === 'en') {
                document.title = 'Spirit Pet Chronicles - Mobile';
                const input = document.getElementById('chatInput');
                if (input) input.placeholder = 'Talk to your spirit pet...';
            }
        })();
    </script>
</body>
</html>