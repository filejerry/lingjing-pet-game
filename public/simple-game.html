<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±±æµ·ç»çµå¢ƒæ–—å® å½•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .game-container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .game-title {
            text-align: center;
            font-size: 28px;
            color: #ffd700;
            margin-bottom: 30px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .story-display {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 300px;
            line-height: 1.8;
            font-size: 16px;
        }

        .special-highlight {
            color: #ffd700;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
        }

        .mythical-creature {
            color: #ff6b6b;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(255, 107, 107, 0.3);
        }

        .scene-image {
            max-width: 100%;
            border-radius: 8px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .pet-status {
            display: flex;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .pet-info {
            flex: 1;
        }

        .evolution-info {
            flex: 1;
            text-align: right;
        }

        .evolution-progress {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }

        .evolution-bar {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ff6b6b);
            transition: width 0.5s ease;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .action-button {
            padding: 12px 20px;
            background: linear-gradient(45deg, #2c3e50, #34495e);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            text-align: center;
        }

        .action-button:hover {
            background: linear-gradient(45deg, #34495e, #3c5a78);
            border-color: #ffd700;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.2);
        }

        .choices-container {
            margin-top: 20px;
        }

        .choice-button {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            text-align: left;
        }

        .choice-button:hover {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .hidden {
            display: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .footer {
            text-align: center;
            margin-top: 20px;
            font-size: 12px;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="game-title">ğŸ‰ å±±æµ·ç»çµå¢ƒæ–—å® å½• ğŸ‰</h1>
        
        <div class="pet-status">
            <div class="pet-info">
                <div>ğŸ¾ <span class="special-highlight" id="petName">å°çµ</span></div>
                <div>ç­‰çº§: <span id="petLevel">1</span> | ç¾ç»Š: <span id="petBond">0</span></div>
                <div>ç§æ—: <span id="petSpecies">æœªçŸ¥çµä½“</span></div>
            </div>
            <div class="evolution-info">
                <div>âœ¨ <span id="evolutionStatus">å¹¼å¹´æœŸ</span></div>
                <div class="evolution-progress">
                    <div id="evolutionBar" class="evolution-bar" style="width: 25%"></div>
                </div>
                <div id="evolutionTip" style="font-size: 12px;">ç®€å•äº’åŠ¨å³å¯æˆé•¿</div>
            </div>
        </div>

        <div class="story-display">
            <div id="storyText">
                æ¬¢è¿æ¥åˆ°<span class="special-highlight">å±±æµ·ç»çµå¢ƒæ–—å® å½•</span>ï¼<br><br>
                åœ¨è¿™ä¸ªç¥ç§˜çš„ä¸–ç•Œä¸­ï¼Œä½ å°†é‡åˆ°å„ç§<span class="mythical-creature">å±±æµ·ç»ç¥è¯ç”Ÿç‰©</span>ï¼Œ
                é€šè¿‡ç®€å•çš„äº’åŠ¨åŸ¹å…»å®ƒä»¬ï¼Œè§è¯å®ƒä»¬çš„æˆé•¿ä¸è¿›åŒ–ã€‚<br><br>
                ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹ä½ çš„çµå® ä¹‹æ—…ï¼
            </div>
            <div id="sceneImage" class="hidden"></div>
            <div id="choicesContainer" class="choices-container hidden"></div>
        </div>

        <div class="action-buttons">
            <button id="startAdventure" class="action-button">ğŸ® å¼€å§‹å†’é™©</button>
            <button id="dailyInteraction" class="action-button">ğŸ  æ—¥å¸¸äº’åŠ¨</button>
            <button id="exploreWorld" class="action-button">ğŸŒ æ¢ç´¢ä¸–ç•Œ</button>
            <button id="checkEvolution" class="action-button">âœ¨ æ£€æŸ¥è¿›åŒ–</button>
        </div>

        <div class="footer">
            AIé©±åŠ¨çš„æ–‡å­—å® ç‰©å…»æˆæ¸¸æˆ | ä¸‰å±‚æ¨¡å‹æ¶æ„ | å››å±‚æ¸è¿›å¼æˆé•¿
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            pet: {
                name: 'å°çµ',
                level: 1,
                bond: 0,
                species: 'æœªçŸ¥çµä½“',
                stage: 'juvenile',
                experience: 0
            },
            isLoading: false
        };

        // DOMå…ƒç´ 
        const elements = {
            storyText: document.getElementById('storyText'),
            sceneImage: document.getElementById('sceneImage'),
            choicesContainer: document.getElementById('choicesContainer'),
            petName: document.getElementById('petName'),
            petLevel: document.getElementById('petLevel'),
            petBond: document.getElementById('petBond'),
            petSpecies: document.getElementById('petSpecies'),
            evolutionStatus: document.getElementById('evolutionStatus'),
            evolutionBar: document.getElementById('evolutionBar'),
            evolutionTip: document.getElementById('evolutionTip')
        };

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            updatePetDisplay();
            updateEvolutionDisplay();
            
            // ç»‘å®šäº‹ä»¶
            document.getElementById('startAdventure').addEventListener('click', startAdventure);
            document.getElementById('dailyInteraction').addEventListener('click', dailyInteraction);
            document.getElementById('exploreWorld').addEventListener('click', exploreWorld);
            document.getElementById('checkEvolution').addEventListener('click', checkEvolution);
            
            // åŠ è½½ä¿å­˜çš„è¿›åº¦
            loadProgress();
        }

        // æ›´æ–°å® ç‰©æ˜¾ç¤º
        function updatePetDisplay() {
            elements.petName.textContent = gameState.pet.name;
            elements.petLevel.textContent = gameState.pet.level;
            elements.petBond.textContent = gameState.pet.bond;
            elements.petSpecies.textContent = gameState.pet.species;
        }

        // æ›´æ–°è¿›åŒ–æ˜¾ç¤º
        function updateEvolutionDisplay() {
            const stages = {
                juvenile: { name: 'å¹¼å¹´æœŸ', progress: 25, tip: 'ç®€å•äº’åŠ¨å³å¯æˆé•¿' },
                growth: { name: 'æˆé•¿æœŸ', progress: 50, tip: 'éœ€è¦æ›´å¤šç»éªŒå’Œç¾ç»Š' },
                mature: { name: 'æˆç†ŸæœŸ', progress: 75, tip: 'æ¥è¿‘å®Œå…¨ä½“è¿›åŒ–' },
                complete: { name: 'å®Œå…¨ä½“', progress: 100, tip: 'å·²è¾¾åˆ°æœ€é«˜å½¢æ€' }
            };

            const stage = stages[gameState.pet.stage] || stages.juvenile;
            elements.evolutionStatus.textContent = stage.name;
            elements.evolutionBar.style.width = stage.progress + '%';
            elements.evolutionTip.textContent = stage.tip;
        }

        // æ˜¾ç¤ºæ•…äº‹æ–‡æœ¬
        function displayStory(text, choices = []) {
            elements.storyText.innerHTML = text;
            elements.storyText.classList.add('fade-in');
            
            // æ˜¾ç¤ºé€‰æ‹©
            if (choices.length > 0) {
                elements.choicesContainer.innerHTML = '';
                choices.forEach((choice, index) => {
                    const button = document.createElement('button');
                    button.className = 'choice-button';
                    button.textContent = choice.text;
                    button.addEventListener('click', () => makeChoice(choice, index));
                    elements.choicesContainer.appendChild(button);
                });
                elements.choicesContainer.classList.remove('hidden');
            } else {
                elements.choicesContainer.classList.add('hidden');
            }
            
            // è‡ªåŠ¨ä¿å­˜è¿›åº¦
            saveProgress();
        }

        // å¼€å§‹å†’é™©
        async function startAdventure() {
            if (gameState.isLoading) return;
            
            setLoading(true);
            try {
                const response = await fetch('/api/story-growth/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pet: gameState.pet })
                });
                
                const data = await response.json();
                if (data.success) {
                    displayStory(data.story, data.choices || []);
                } else {
                    displayStory('å†’é™©å¼€å§‹æ—¶é‡åˆ°äº†é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚');
                }
            } catch (error) {
                console.error('å¼€å§‹å†’é™©å¤±è´¥:', error);
                displayStory('å†’é™©å¼€å§‹æ—¶é‡åˆ°äº†é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚');
            }
            setLoading(false);
        }

        // æ—¥å¸¸äº’åŠ¨
        async function dailyInteraction() {
            if (gameState.isLoading) return;
            
            setLoading(true);
            try {
                const response = await fetch('/api/daily/tick', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        pet: gameState.pet,
                        context: 'æ¸©é¦¨çš„æ—¥å¸¸æ—¶å…‰'
                    })
                });
                
                const data = await response.json();
                if (data.ok) {
                    displayStory(`<span class="special-highlight">æ—¥å¸¸äº’åŠ¨</span><br><br>${data.event}`);
                    
                    // å¢åŠ ç»éªŒå’Œç¾ç»Š
                    gameState.pet.experience += 5;
                    gameState.pet.bond += 3;
                    checkLevelUp();
                    updatePetDisplay();
                    updateEvolutionDisplay();
                } else {
                    displayStory('ä¸çµå® çš„äº’åŠ¨é‡åˆ°äº†é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚');
                }
            } catch (error) {
                console.error('æ—¥å¸¸äº’åŠ¨å¤±è´¥:', error);
                displayStory('ä¸çµå® çš„äº’åŠ¨é‡åˆ°äº†é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚');
            }
            setLoading(false);
        }

        // æ¢ç´¢ä¸–ç•Œ
        async function exploreWorld() {
            if (gameState.isLoading) return;
            
            setLoading(true);
            try {
                const response = await fetch('/api/adventure/text-event', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        pet: gameState.pet,
                        context: 'ç¥ç§˜çš„å±±æµ·ç»ä¸–ç•Œ'
                    })
                });
                
                const data = await response.json();
                if (data.ok) {
                    displayStory(`<span class="mythical-creature">ä¸–ç•Œæ¢ç´¢</span><br><br>${data.event}`);
                    
                    // å¢åŠ æ›´å¤šç»éªŒ
                    gameState.pet.experience += 10;
                    gameState.pet.bond += 5;
                    checkLevelUp();
                    updatePetDisplay();
                    updateEvolutionDisplay();
                } else {
                    displayStory('æ¢ç´¢è¿‡ç¨‹ä¸­é‡åˆ°äº†é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚');
                }
            } catch (error) {
                console.error('æ¢ç´¢ä¸–ç•Œå¤±è´¥:', error);
                displayStory('æ¢ç´¢è¿‡ç¨‹ä¸­é‡åˆ°äº†é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚');
            }
            setLoading(false);
        }

        // æ£€æŸ¥è¿›åŒ–
        async function checkEvolution() {
            if (gameState.isLoading) return;
            
            setLoading(true);
            try {
                const response = await fetch('/api/evolution/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pet: gameState.pet })
                });
                
                const data = await response.json();
                if (data.success && data.canEvolve) {
                    const evolutionText = `<span class="special-highlight">è¿›åŒ–æœºä¼šï¼</span><br><br>` +
                        `ä½ çš„${gameState.pet.name}å·²ç»æ»¡è¶³äº†è¿›åŒ–æ¡ä»¶ï¼<br><br>` +
                        `å¯èƒ½çš„è¿›åŒ–æ–¹å‘ï¼š<br>` +
                        data.evolutionOptions.map(option => 
                            `â€¢ <span class="mythical-creature">${option.name}</span> - ${option.description}`
                        ).join('<br>');
                    
                    displayStory(evolutionText, data.evolutionOptions.map(option => ({
                        text: `è¿›åŒ–ä¸º ${option.name}`,
                        action: 'evolve',
                        target: option
                    })));
                } else {
                    displayStory(`<span class="special-highlight">è¿›åŒ–æ£€æŸ¥</span><br><br>` +
                        `${gameState.pet.name}è¿˜éœ€è¦æ›´å¤šçš„æˆé•¿æ‰èƒ½è¿›åŒ–ã€‚<br><br>` +
                        `å½“å‰çŠ¶æ€ï¼šç­‰çº§${gameState.pet.level}ï¼Œç¾ç»Š${gameState.pet.bond}<br>` +
                        `ç»§ç»­äº’åŠ¨å’Œæ¢ç´¢æ¥æå‡æˆé•¿ï¼`);
                }
            } catch (error) {
                console.error('æ£€æŸ¥è¿›åŒ–å¤±è´¥:', error);
                displayStory('æ£€æŸ¥è¿›åŒ–æ—¶é‡åˆ°äº†é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚');
            }
            setLoading(false);
        }

        // åšå‡ºé€‰æ‹©
        function makeChoice(choice, index) {
            if (choice.action === 'evolve') {
                evolvePet(choice.target);
            } else {
                // å¤„ç†å…¶ä»–é€‰æ‹©
                gameState.pet.experience += 8;
                gameState.pet.bond += 4;
                checkLevelUp();
                updatePetDisplay();
                updateEvolutionDisplay();
                
                displayStory(`ä½ é€‰æ‹©äº†ï¼š${choice.text}<br><br>è¿™ä¸ªé€‰æ‹©è®©ä½ å’Œ${gameState.pet.name}çš„å…³ç³»æ›´åŠ æ·±åšäº†ã€‚`);
            }
        }

        // è¿›åŒ–å® ç‰©
        function evolvePet(evolutionTarget) {
            gameState.pet.name = evolutionTarget.name;
            gameState.pet.species = evolutionTarget.species || evolutionTarget.name;
            gameState.pet.level += 5;
            gameState.pet.bond += 20;
            
            // æ›´æ–°è¿›åŒ–é˜¶æ®µ
            if (gameState.pet.stage === 'juvenile') gameState.pet.stage = 'growth';
            else if (gameState.pet.stage === 'growth') gameState.pet.stage = 'mature';
            else if (gameState.pet.stage === 'mature') gameState.pet.stage = 'complete';
            
            updatePetDisplay();
            updateEvolutionDisplay();
            
            displayStory(`<span class="special-highlight">è¿›åŒ–æˆåŠŸï¼</span><br><br>` +
                `${gameState.pet.name}æˆåŠŸè¿›åŒ–äº†ï¼å®ƒç°åœ¨å˜å¾—æ›´åŠ å¼ºå¤§ï¼Œ` +
                `ä½ ä»¬ä¹‹é—´çš„ç¾ç»Šä¹Ÿæ›´åŠ æ·±åšã€‚<br><br>` +
                `<span class="mythical-creature">æ–°çš„å†’é™©æ­£åœ¨ç­‰å¾…ç€ä½ ä»¬ï¼</span>`);
        }

        // æ£€æŸ¥å‡çº§
        function checkLevelUp() {
            const expNeeded = gameState.pet.level * 10;
            if (gameState.pet.experience >= expNeeded) {
                gameState.pet.level++;
                gameState.pet.experience = 0;
                
                displayStory(`<span class="special-highlight">ç­‰çº§æå‡ï¼</span><br><br>` +
                    `${gameState.pet.name}å‡çº§åˆ°äº†${gameState.pet.level}çº§ï¼`);
            }
        }

        // ä¿å­˜è¿›åº¦
        function saveProgress() {
            localStorage.setItem('spiritPetGame', JSON.stringify(gameState));
        }

        // åŠ è½½è¿›åº¦
        function loadProgress() {
            const saved = localStorage.getItem('spiritPetGame');
            if (saved) {
                try {
                    gameState = JSON.parse(saved);
                    updatePetDisplay();
                    updateEvolutionDisplay();
                } catch (error) {
                    console.error('åŠ è½½è¿›åº¦å¤±è´¥:', error);
                }
            }
        }

        // è®¾ç½®åŠ è½½çŠ¶æ€
        function setLoading(loading) {
            gameState.isLoading = loading;
            document.body.classList.toggle('loading', loading);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>