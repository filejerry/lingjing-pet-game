<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµå¢ƒæ–—å® å½• - ç¥è¯è§‰é†’ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e8e8e8;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .title {
            font-size: 2.5em;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2em;
            color: #87ceeb;
            margin-bottom: 20px;
        }

        .activity-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 215, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #ffd700;
        }

        .activity-points {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffd700;
        }

        .recovery-info {
            font-size: 0.9em;
            color: #87ceeb;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section-title {
            font-size: 1.5em;
            color: #ffd700;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 2px solid #ffd700;
            padding-bottom: 10px;
        }

        .pet-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .pet-name {
            font-size: 1.8em;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .pet-rarity {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .rarity-N { background: #808080; color: white; }
        .rarity-R { background: #4169e1; color: white; }
        .rarity-SR { background: #9932cc; color: white; }
        .rarity-SSR { background: #ff6347; color: white; }
        .rarity-SSS { background: linear-gradient(45deg, #ffd700, #ff6347); color: white; }

        .pet-characteristics {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .characteristics-title {
            color: #87ceeb;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .characteristic-item {
            margin: 8px 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            border-left: 3px solid #ffd700;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #4169e1, #6495ed);
            color: white;
            min-width: 80px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .btn-primary { background: linear-gradient(45deg, #ffd700, #ffb347); color: #333; }
        .btn-success { background: linear-gradient(45deg, #32cd32, #90ee90); }
        .btn-danger { background: linear-gradient(45deg, #ff6347, #ff7f7f); }
        .btn-info { background: linear-gradient(45deg, #87ceeb, #b0e0e6); color: #333; }

        .text-display {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-height: 150px;
            max-height: 400px;
            overflow-y: auto;
        }

        .story-text {
            font-size: 1.1em;
            line-height: 1.8;
            color: #e8e8e8;
            text-align: justify;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            border: 2px solid #ffd700;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .modal-title {
            color: #ffd700;
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
        }

        .option-list {
            display: grid;
            gap: 10px;
            margin: 20px 0;
        }

        .option-item {
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .option-item:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
            transform: translateX(5px);
        }

        .option-title {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .option-description {
            color: #87ceeb;
            font-size: 0.9em;
        }

        .option-cost {
            color: #ff6347;
            font-size: 0.8em;
            margin-top: 5px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #ffd700;
        }

        .loading {
            text-align: center;
            color: #87ceeb;
            font-style: italic;
        }

        .error {
            color: #ff6347;
            background: rgba(255, 99, 71, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            color: #32cd32;
            background: rgba(50, 205, 50, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .title {
                font-size: 2em;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ä¿¡æ¯ -->
        <div class="header">
            <h1 class="title">ğŸ‰ çµå¢ƒæ–—å® å½•</h1>
            <p class="subtitle">ç¥è¯è§‰é†’ç‰ˆ - æ¢ç´¢å±±æµ·ç»çš„ç¥ç§˜ä¸–ç•Œ</p>
            
            <!-- æ´»åŠ¨ç‚¹æ•°çŠ¶æ€ -->
            <div class="activity-status">
                <div class="activity-points">
                    âš¡ æ´»åŠ¨ç‚¹æ•°: <span id="currentPoints">100</span>/<span id="maxPoints">100</span>
                </div>
                <div class="recovery-info">
                    ä¸‹æ¬¡æ¢å¤: <span id="nextRecovery">2å°æ—¶å</span>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- å® ç‰©ä¿¡æ¯åŒºåŸŸ -->
            <div class="section">
                <h2 class="section-title">ğŸ¾ æˆ‘çš„çµå® </h2>
                <div id="petInfo" class="pet-info">
                    <div class="loading">æš‚æ— å® ç‰©ï¼Œè¯·å…ˆåˆ›å»ºä¸€åªçµå® ...</div>
                </div>
                
                <!-- ä¸»è¦æ“ä½œæŒ‰é’® -->
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showCreatePetModal()">åˆ›å»ºçµå® </button>
                    <button class="btn btn-success" onclick="showFeedModal()" id="feedBtn" disabled>å–‚é£Ÿ</button>
                    <button class="btn btn-info" onclick="showExploreModal()" id="exploreBtn" disabled>æ¢ç´¢</button>
                    <button class="btn btn-danger" onclick="showBattleModal()" id="battleBtn" disabled>æˆ˜æ–—</button>
                    <button class="btn" onclick="showChatModal()" id="chatBtn" disabled style="background: linear-gradient(45deg, #9370db, #ba55d3);">ğŸ’¬ èŠå¤©</button>
                </div>
            </div>

            <!-- æ•…äº‹æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="section">
                <h2 class="section-title">ğŸ“– çµå¢ƒçºªäº‹</h2>
                <div id="storyDisplay" class="text-display">
                    <div class="story-text">
                        æ¬¢è¿æ¥åˆ°çµå¢ƒæ–—å® å½•çš„ç¥è¯ä¸–ç•Œï¼åœ¨è¿™é‡Œï¼Œæ¯ä¸€åªå® ç‰©éƒ½æ‹¥æœ‰ç‹¬ç‰¹çš„çµæ€§ï¼Œå®ƒä»¬çš„æˆé•¿è½¨è¿¹å®Œå…¨ç”±ä½ çš„é€‰æ‹©å†³å®šã€‚
                        <br><br>
                        ğŸŒŸ åˆ›å»ºä½ çš„ç¬¬ä¸€åªçµå® ï¼Œå¼€å§‹è¿™æ®µå¥‡å¦™çš„æ—…ç¨‹å§ï¼
                        <br><br>
                        ğŸ’¡ å°è´´å£«ï¼šä¸åŒçš„å–‚é£Ÿå’Œæ¢ç´¢é€‰æ‹©ä¼šè®©ä½ çš„å® ç‰©æœç€ä¸åŒçš„æ–¹å‘è¿›åŒ–ï¼Œç”šè‡³å¯èƒ½è§‰é†’ä¸ºå±±æµ·ç»ä¸­çš„ä¼ è¯´ç”Ÿç‰©ï¼
                    </div>
                </div>
            </div>

            <!-- æœ€è¿‘æ´»åŠ¨ -->
            <div class="section">
                <h2 class="section-title">â° æœ€è¿‘æ´»åŠ¨</h2>
                <div id="recentActivities" class="text-display">
                    <div class="loading">æš‚æ— æ´»åŠ¨è®°å½•...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºå® ç‰©æ¨¡æ€æ¡† -->
    <div id="createPetModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('createPetModal')">&times;</span>
            <h2 class="modal-title">ğŸŒŸ åˆ›å»ºæ–°çš„çµå® </h2>
            <div>
                <label for="petName" style="color: #ffd700; display: block; margin-bottom: 10px;">ä¸ºä½ çš„çµå® èµ·ä¸ªåå­—ï¼š</label>
                <input type="text" id="petName" placeholder="è¾“å…¥å® ç‰©åç§°..." style="width: 100%; padding: 10px; border-radius: 5px; border: none; background: rgba(255,255,255,0.1); color: white; margin-bottom: 20px;">
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="createPet()">åˆ›å»ºçµå® </button>
                <button class="btn" onclick="closeModal('createPetModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å–‚é£Ÿé€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="feedModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('feedModal')">&times;</span>
            <h2 class="modal-title">ğŸƒ é€‰æ‹©é£Ÿç‰©</h2>
            <div class="option-list" id="feedOptions">
                <!-- åŠ¨æ€ç”Ÿæˆå–‚é£Ÿé€‰é¡¹ -->
            </div>
        </div>
    </div>

    <!-- æ¢ç´¢é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="exploreModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('exploreModal')">&times;</span>
            <h2 class="modal-title">ğŸ—ºï¸ é€‰æ‹©æ¢ç´¢åœ°ç‚¹</h2>
            <div class="option-list" id="exploreOptions">
                <!-- åŠ¨æ€ç”Ÿæˆæ¢ç´¢é€‰é¡¹ -->
            </div>
        </div>
    </div>

    <!-- æˆ˜æ–—é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="battleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('battleModal')">&times;</span>
            <h2 class="modal-title">âš”ï¸ é€‰æ‹©æˆ˜æ–—å¯¹æ‰‹</h2>
            <div class="option-list" id="battleOptions">
                <!-- åŠ¨æ€ç”Ÿæˆæˆ˜æ–—é€‰é¡¹ -->
            </div>
        </div>
    </div>

    <!-- èŠå¤©æ¨¡æ€æ¡† -->
    <div id="chatModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeModal('chatModal')">&times;</span>
            <h2 class="modal-title">ğŸ’¬ ä¸çµå® å¯¹è¯</h2>
            
            <!-- å® ç‰©è¯­è¨€èƒ½åŠ›æ˜¾ç¤º -->
            <div id="speechInfo" class="pet-characteristics" style="margin-bottom: 20px;">
                <div class="characteristics-title">ğŸ—£ï¸ è¯­è¨€èƒ½åŠ›</div>
                <div id="speechLevel">åŠ è½½ä¸­...</div>
            </div>
            
            <!-- èŠå¤©å†å² -->
            <div id="chatHistory" class="text-display" style="height: 300px; margin-bottom: 15px;">
                <div class="loading">åŠ è½½èŠå¤©è®°å½•ä¸­...</div>
            </div>
            
            <!-- è¾“å…¥åŒºåŸŸ -->
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="text" id="chatInput" placeholder="è¾“å…¥ä½ æƒ³å¯¹å® ç‰©è¯´çš„è¯..." 
                       style="flex: 1; padding: 10px; border-radius: 20px; border: 2px solid #ffd700; background: rgba(255,255,255,0.1); color: white;"
                       onkeypress="handleChatKeyPress(event)">
                <button class="btn btn-primary" onclick="sendMessage()" style="min-width: 80px;">å‘é€</button>
            </div>
            
            <!-- å¿«æ·å›å¤ -->
            <div style="margin-top: 15px;">
                <div style="color: #87ceeb; margin-bottom: 10px; font-size: 0.9em;">ğŸ’¡ å¿«æ·å›å¤ï¼š</div>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <button class="btn" onclick="quickChat('ä½ å¥½')" style="font-size: 0.8em; padding: 5px 10px;">ä½ å¥½</button>
                    <button class="btn" onclick="quickChat('ä½ é¥¿äº†å—ï¼Ÿ')" style="font-size: 0.8em; padding: 5px 10px;">ä½ é¥¿äº†å—ï¼Ÿ</button>
                    <button class="btn" onclick="quickChat('æˆ‘ä»¬ä¸€èµ·ç©å§')" style="font-size: 0.8em; padding: 5px 10px;">æˆ‘ä»¬ä¸€èµ·ç©å§</button>
                    <button class="btn" onclick="quickChat('ä½ ä»Šå¤©æ€ä¹ˆæ ·ï¼Ÿ')" style="font-size: 0.8em; padding: 5px 10px;">ä½ ä»Šå¤©æ€ä¹ˆæ ·ï¼Ÿ</button>
                    <button class="btn" onclick="getPetSpeech()" style="font-size: 0.8em; padding: 5px 10px;">è®©å®ƒä¸»åŠ¨è¯´è¯</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPet = null;
        let activityPoints = 100;

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            loadActivityStatus();
            loadCurrentPet();
            loadRecentActivities();
            
            // æ¯30ç§’æ›´æ–°ä¸€æ¬¡æ´»åŠ¨ç‚¹æ•°
            setInterval(loadActivityStatus, 30000);
        });

        // åŠ è½½æ´»åŠ¨ç‚¹æ•°çŠ¶æ€
        async function loadActivityStatus() {
            try {
                const response = await fetch('/api/pets/activity-status');
                const data = await response.json();
                
                if (data.success) {
                    const status = data.data;
                    document.getElementById('currentPoints').textContent = status.currentPoints;
                    document.getElementById('maxPoints').textContent = status.maxPoints;
                    
                    if (status.nextRecoveryIn.total > 0) {
                        const hours = status.nextRecoveryIn.hours;
                        const minutes = status.nextRecoveryIn.minutes;
                        document.getElementById('nextRecovery').textContent = 
                            `${hours}å°æ—¶${minutes}åˆ†é’Ÿå`;
                    } else {
                        document.getElementById('nextRecovery').textContent = 'å¯ç«‹å³æ¢å¤';
                    }
                    
                    activityPoints = status.currentPoints;
                }
            } catch (error) {
                console.error('åŠ è½½æ´»åŠ¨çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // åŠ è½½å½“å‰å® ç‰©
        async function loadCurrentPet() {
            try {
                const response = await fetch('/api/pets');
                const data = await response.json();
                
                if (data.success && data.data.length > 0) {
                    currentPet = data.data[0];
                    displayPetInfo(currentPet);
                    enableActionButtons();
                }
            } catch (error) {
                console.error('åŠ è½½å® ç‰©å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºå® ç‰©ä¿¡æ¯
        function displayPetInfo(pet) {
            const petInfoDiv = document.getElementById('petInfo');
            
            petInfoDiv.innerHTML = `
                <div class="pet-name">${pet.name}</div>
                <div class="pet-rarity rarity-${pet.rarity}">${getRarityName(pet.rarity)}</div>
                
                <div class="pet-characteristics">
                    <div class="characteristics-title">ğŸŒŸ å½“å‰ç‰¹æ€§</div>
                    <div class="characteristic-item">
                        <strong>ç”Ÿå‘½åŠ›:</strong> ${pet.hp} | <strong>æ”»å‡»åŠ›:</strong> ${pet.attack}
                    </div>
                    <div class="characteristic-item">
                        <strong>é˜²å¾¡åŠ›:</strong> ${pet.defense} | <strong>æ•æ·åº¦:</strong> ${pet.speed}
                    </div>
                    <div class="characteristic-item">
                        <strong>é­”æ³•åŠ›:</strong> ${pet.magic} | <strong>å…ƒç´ :</strong> ${getElementName(pet.element)}
                    </div>
                    <div class="characteristic-item">
                        <strong>ç­‰çº§:</strong> ${pet.level} | <strong>ç»éªŒ:</strong> ${pet.experience}
                    </div>
                    ${pet.mythology_type ? `
                    <div class="characteristic-item">
                        <strong>ç¥è¯è¡€ç»Ÿ:</strong> ${pet.mythology_type}
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // å¯ç”¨æ“ä½œæŒ‰é’®
        function enableActionButtons() {
            document.getElementById('feedBtn').disabled = false;
            document.getElementById('exploreBtn').disabled = false;
            document.getElementById('battleBtn').disabled = false;
            document.getElementById('chatBtn').disabled = false;
        }

        // æ˜¾ç¤ºåˆ›å»ºå® ç‰©æ¨¡æ€æ¡†
        function showCreatePetModal() {
            document.getElementById('createPetModal').style.display = 'block';
        }

        // åˆ›å»ºå® ç‰©
        async function createPet() {
            const name = document.getElementById('petName').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥å® ç‰©åç§°ï¼');
                return;
            }

            try {
                const response = await fetch('/api/pets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                const data = await response.json();
                if (data.success) {
                    currentPet = data.data;
                    displayPetInfo(currentPet);
                    enableActionButtons();
                    closeModal('createPetModal');
                    
                    addStoryText(`ğŸŒŸ ä¸€åªåä¸º"${name}"çš„ç¥ç§˜ç”Ÿç‰©åœ¨çµå¢ƒä¸­è¯ç”Ÿäº†ï¼å®ƒçå¼€å¥½å¥‡çš„çœ¼ç›ï¼Œå¼€å§‹æ¢ç´¢è¿™ä¸ªå……æ»¡å¥‡è¿¹çš„ä¸–ç•Œ...`);
                } else {
                    alert('åˆ›å»ºå® ç‰©å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('åˆ›å»ºå® ç‰©å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºå–‚é£Ÿæ¨¡æ€æ¡†
        function showFeedModal() {
            if (!currentPet) return;
            
            const feedOptions = [
                {
                    name: 'æ™®é€šè‰å¶',
                    description: 'æœ€åŸºç¡€çš„é£Ÿç‰©ï¼Œèƒ½å¤Ÿç»´æŒåŸºæœ¬çš„ç”Ÿå‘½åŠ›',
                    cost: 5,
                    keywords: ['è‡ªç„¶', 'å¹³å’Œ']
                },
                {
                    name: 'çµèŠ',
                    description: 'çè´µçš„çµè¯ï¼Œèƒ½å¤Ÿå¢å¼ºå® ç‰©çš„é­”æ³•èƒ½åŠ›',
                    cost: 15,
                    keywords: ['çµæ€§', 'é­”æ³•', 'ä»™æ°”']
                },
                {
                    name: 'é¾™è¡€æœ',
                    description: 'ä¼ è¯´ä¸­çš„ç¥æœï¼Œè•´å«ç€é¾™æ—çš„åŠ›é‡',
                    cost: 25,
                    keywords: ['é¾™æ—', 'åŠ›é‡', 'éœ¸æ°”', 'ä¼ è¯´']
                },
                {
                    name: 'å‡¤å‡°ç¾½æ¯›',
                    description: 'å‡¤å‡°æ‰è½çš„ç¾½æ¯›ï¼Œèƒ½å¤Ÿæ¿€å‘ç«ç³»æ½œèƒ½',
                    cost: 30,
                    keywords: ['å‡¤å‡°', 'ç«ç„°', 'é‡ç”Ÿ', 'ç¥åœ£']
                },
                {
                    name: 'èŸ æ¡ƒ',
                    description: 'ç‹æ¯å¨˜å¨˜çš„èŸ æ¡ƒï¼Œé£Ÿç”¨åå¯èƒ½è·å¾—ä»™ä½“',
                    cost: 50,
                    keywords: ['ä»™ç•Œ', 'é•¿ç”Ÿ', 'ç¥ä»™', 'èŸ æ¡ƒä¼š']
                }
            ];

            displayOptions('feedOptions', feedOptions, performFeed);
            document.getElementById('feedModal').style.display = 'block';
        }

        // æ˜¾ç¤ºæ¢ç´¢æ¨¡æ€æ¡†
        function showExploreModal() {
            if (!currentPet) return;
            
            const exploreOptions = [
                {
                    name: 'å¹½é™æ£®æ—',
                    description: 'å¤è€çš„æ£®æ—ä¸­éšè—ç€è®¸å¤šç§˜å¯†ï¼Œé€‚åˆåˆæ¬¡æ¢ç´¢',
                    cost: 10,
                    keywords: ['æ£®æ—', 'è‡ªç„¶', 'ç¥ç§˜']
                },
                {
                    name: 'æ˜†ä»‘å±±è„‰',
                    description: 'ä¼ è¯´ä¸­çš„ä»™å±±ï¼Œå¯èƒ½é‡åˆ°ä»™äººæˆ–ç¥å…½',
                    cost: 20,
                    keywords: ['æ˜†ä»‘', 'ä»™å±±', 'ç¥å…½', 'ä»™äºº']
                },
                {
                    name: 'ä¸œæµ·é¾™å®«',
                    description: 'é¾™ç‹çš„å®«æ®¿ï¼Œå……æ»¡äº†æ°´ç³»çš„ç¥ç§˜åŠ›é‡',
                    cost: 25,
                    keywords: ['é¾™å®«', 'æ°´ç³»', 'é¾™ç‹', 'æµ·æ´‹']
                },
                {
                    name: 'è“¬è±ä»™å²›',
                    description: 'ä¸‰ä»™å²›ä¹‹ä¸€ï¼Œæ®è¯´èƒ½å¤Ÿè·å¾—ä»™ç¼˜',
                    cost: 35,
                    keywords: ['è“¬è±', 'ä»™å²›', 'ä»™ç¼˜', 'ä¸‰ä»™']
                },
                {
                    name: 'ä¹é‡å¤©',
                    description: 'å¤©ç•Œçš„æœ€é«˜å±‚ï¼Œåªæœ‰æœ€å¼ºçš„çµå® æ‰èƒ½åˆ°è¾¾',
                    cost: 50,
                    keywords: ['å¤©ç•Œ', 'ä¹é‡å¤©', 'ç¥ç•Œ', 'è‡³é«˜']
                }
            ];

            displayOptions('exploreOptions', exploreOptions, performExplore);
            document.getElementById('exploreModal').style.display = 'block';
        }

        // æ˜¾ç¤ºæˆ˜æ–—æ¨¡æ€æ¡†
        function showBattleModal() {
            if (!currentPet) return;
            
            const battleOptions = [
                {
                    name: 'é‡ç”Ÿå°å¦–',
                    description: 'æ£®æ—ä¸­çš„å°å¦–æ€ªï¼Œå®åŠ›è¾ƒå¼±ï¼Œé€‚åˆç»ƒæ‰‹',
                    cost: 8,
                    difficulty: 'ç®€å•'
                },
                {
                    name: 'å±±ç²¾',
                    description: 'å±±ä¸­çš„ç²¾æ€ªï¼Œæ‹¥æœ‰åœŸç³»æ³•æœ¯',
                    cost: 15,
                    difficulty: 'æ™®é€š'
                },
                {
                    name: 'æ°´æ€ª',
                    description: 'æ¹–æ³Šä¸­çš„æ°´ç³»å¦–æ€ªï¼Œæ”»å‡»åŠ›è¾ƒå¼º',
                    cost: 20,
                    difficulty: 'å›°éš¾'
                },
                {
                    name: 'ç«éº’éºŸå¹¼å´½',
                    description: 'ä¼ è¯´ä¸­çš„ç¥å…½å¹¼å´½ï¼Œæˆ˜æ–—ç»éªŒä¸°å¯Œ',
                    cost: 30,
                    difficulty: 'æéš¾'
                }
            ];

            displayOptions('battleOptions', battleOptions, performBattle);
            document.getElementById('battleModal').style.display = 'block';
        }

        // æ˜¾ç¤ºé€‰é¡¹åˆ—è¡¨
        function displayOptions(containerId, options, actionFunction) {
            const container = document.getElementById(containerId);
            container.innerHTML = options.map((option, index) => `
                <div class="option-item" onclick="${actionFunction.name}(${index}, '${option.name}')">
                    <div class="option-title">${option.name}</div>
                    <div class="option-description">${option.description}</div>
                    <div class="option-cost">æ¶ˆè€—æ´»åŠ¨ç‚¹æ•°: ${option.cost}</div>
                </div>
            `).join('');
        }

        // æ‰§è¡Œå–‚é£Ÿ
        async function performFeed(index, foodName) {
            const feedOptions = [
                { name: 'æ™®é€šè‰å¶', cost: 5, keywords: ['è‡ªç„¶', 'å¹³å’Œ'] },
                { name: 'çµèŠ', cost: 15, keywords: ['çµæ€§', 'é­”æ³•', 'ä»™æ°”'] },
                { name: 'é¾™è¡€æœ', cost: 25, keywords: ['é¾™æ—', 'åŠ›é‡', 'éœ¸æ°”', 'ä¼ è¯´'] },
                { name: 'å‡¤å‡°ç¾½æ¯›', cost: 30, keywords: ['å‡¤å‡°', 'ç«ç„°', 'é‡ç”Ÿ', 'ç¥åœ£'] },
                { name: 'èŸ æ¡ƒ', cost: 50, keywords: ['ä»™ç•Œ', 'é•¿ç”Ÿ', 'ç¥ä»™', 'èŸ æ¡ƒä¼š'] }
            ];

            const option = feedOptions[index];
            
            if (activityPoints < option.cost) {
                alert(`æ´»åŠ¨ç‚¹æ•°ä¸è¶³ï¼éœ€è¦ ${option.cost} ç‚¹ï¼Œå½“å‰åªæœ‰ ${activityPoints} ç‚¹`);
                return;
            }

            try {
                const response = await fetch(`/api/pets/${currentPet.id}/feed`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ food: option.name })
                });

                const data = await response.json();
                if (data.success) {
                    closeModal('feedModal');
                    
                    // ç”Ÿæˆå–‚é£Ÿæ•…äº‹
                    const stories = [
                        `${currentPet.name}å°å¿ƒç¿¼ç¿¼åœ°å—…äº†å—…${option.name}ï¼Œç„¶åå¤§å£åƒäº†èµ·æ¥ã€‚ä½ èƒ½æ„Ÿè§‰åˆ°å®ƒä½“å†…æœ‰æŸç§åŠ›é‡åœ¨è§‰é†’...`,
                        `å½“${currentPet.name}åä¸‹${option.name}åï¼Œå®ƒçš„çœ¼ä¸­é—ªè¿‡ä¸€é“å¥‡å¼‚çš„å…‰èŠ’ï¼Œä»¿ä½›è·å¾—äº†æ–°çš„æ„Ÿæ‚Ÿã€‚`,
                        `${option.name}æ•£å‘å‡ºçš„é¦™æ°”è®©${currentPet.name}é™¶é†‰ä¸å·²ï¼Œå®ƒçš„èº«ä½“å¼€å§‹å‘ç”Ÿå¾®å¦™çš„å˜åŒ–...`,
                        `${currentPet.name}äº«ç”¨${option.name}æ—¶ï¼Œå‘¨å›´çš„çµæ°”ä¼¼ä¹éƒ½è¢«å¸å¼•è¿‡æ¥ï¼Œå½¢æˆäº†ä¸€ä¸ªå°å°çš„æ¼©æ¶¡ã€‚`
                    ];
                    
                    const randomStory = stories[Math.floor(Math.random() * stories.length)];
                    addStoryText(`ğŸƒ ${randomStory}`);
                    
                    // æ›´æ–°å® ç‰©ä¿¡æ¯å’Œæ´»åŠ¨ç‚¹æ•°
                    loadCurrentPet();
                    loadActivityStatus();
                    loadRecentActivities();
                } else {
                    alert('å–‚é£Ÿå¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('å–‚é£Ÿå¤±è´¥: ' + error.message);
            }
        }

        // æ‰§è¡Œæ¢ç´¢
        async function performExplore(index, locationName) {
            const exploreOptions = [
                { name: 'å¹½é™æ£®æ—', cost: 10 },
                { name: 'æ˜†ä»‘å±±è„‰', cost: 20 },
                { name: 'ä¸œæµ·é¾™å®«', cost: 25 },
                { name: 'è“¬è±ä»™å²›', cost: 35 },
                { name: 'ä¹é‡å¤©', cost: 50 }
            ];

            const option = exploreOptions[index];
            
            if (activityPoints < option.cost) {
                alert(`æ´»åŠ¨ç‚¹æ•°ä¸è¶³ï¼éœ€è¦ ${option.cost} ç‚¹ï¼Œå½“å‰åªæœ‰ ${activityPoints} ç‚¹`);
                return;
            }

            try {
                const response = await fetch(`/api/pets/${currentPet.id}/explore`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ location: option.name })
                });

                const data = await response.json();
                if (data.success) {
                    closeModal('exploreModal');
                    
                    // ç”Ÿæˆæ¢ç´¢æ•…äº‹
                    const stories = [
                        `${currentPet.name}è¸å…¥äº†${option.name}ï¼Œè¿™é‡Œçš„æ¯ä¸€å¯¸åœŸåœ°éƒ½å……æ»¡äº†ç¥ç§˜çš„åŠ›é‡ã€‚å®ƒå°å¿ƒåœ°æ¢ç´¢ç€ï¼Œå¯»æ‰¾ç€å±äºè‡ªå·±çš„æœºç¼˜...`,
                        `åœ¨${option.name}çš„æ·±å¤„ï¼Œ${currentPet.name}å‘ç°äº†ä¸€äº›å¤è€çš„ç—•è¿¹ã€‚è¿™äº›ç—•è¿¹ä¼¼ä¹åœ¨è¯‰è¯´ç€è¿œå¤çš„ä¼ è¯´...`,
                        `${option.name}çš„å¥‡å¼‚æ™¯è±¡è®©${currentPet.name}å¤§å¼€çœ¼ç•Œï¼Œå®ƒæ„Ÿè§‰è‡ªå·±çš„è§è¯†å’Œèƒ½åŠ›éƒ½å¾—åˆ°äº†æå‡ã€‚`,
                        `å½“${currentPet.name}åœ¨${option.name}ä¸­æ¼«æ­¥æ—¶ï¼Œå®ƒé‡åˆ°äº†ä¸€äº›ç¥ç§˜çš„å­˜åœ¨ï¼Œè™½ç„¶æ²¡æœ‰äº¤æµï¼Œä½†å½¼æ­¤éƒ½æ„Ÿå—åˆ°äº†å¯¹æ–¹çš„åŠ›é‡ã€‚`
                    ];
                    
                    const randomStory = stories[Math.floor(Math.random() * stories.length)];
                    addStoryText(`ğŸ—ºï¸ ${randomStory}`);
                    
                    // æ›´æ–°ä¿¡æ¯
                    loadCurrentPet();
                    loadActivityStatus();
                    loadRecentActivities();
                } else {
                    alert('æ¢ç´¢å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('æ¢ç´¢å¤±è´¥: ' + error.message);
            }
        }

        // æ‰§è¡Œæˆ˜æ–—
        async function performBattle(index, enemyName) {
            const battleOptions = [
                { name: 'é‡ç”Ÿå°å¦–', cost: 8 },
                { name: 'å±±ç²¾', cost: 15 },
                { name: 'æ°´æ€ª', cost: 20 },
                { name: 'ç«éº’éºŸå¹¼å´½', cost: 30 }
            ];

            const option = battleOptions[index];
            
            if (activityPoints < option.cost) {
                alert(`æ´»åŠ¨ç‚¹æ•°ä¸è¶³ï¼éœ€è¦ ${option.cost} ç‚¹ï¼Œå½“å‰åªæœ‰ ${activityPoints} ç‚¹`);
                return;
            }

            try {
                // åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿå¯¹æ‰‹è¿›è¡Œæˆ˜æ–—
                const response = await fetch('/api/pets/battle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        pet1Id: currentPet.id,
                        enemyName: option.name
                    })
                });

                const data = await response.json();
                if (data.success) {
                    closeModal('battleModal');
                    
                    // æ˜¾ç¤ºè¯¦ç»†çš„æˆ˜æ–—è¿‡ç¨‹
                    const battleResult = data.data;
                    let battleStory = `âš”ï¸ ${currentPet.name} ä¸ ${option.name} å±•å¼€äº†æ¿€çƒˆçš„æˆ˜æ–—ï¼\n\n`;
                    
                    if (battleResult.rounds && battleResult.rounds.length > 0) {
                        battleResult.rounds.forEach((round, i) => {
                            battleStory += `ç¬¬${i+1}å›åˆ: ${round}\n`;
                        });
                    } else {
                        battleStory += `${currentPet.name}è¿ç”¨è‡ªå·±çš„ç‰¹æ®Šèƒ½åŠ›ï¼Œä¸${option.name}è¿›è¡Œäº†ä¸€åœºç²¾å½©çš„å¯¹å†³ã€‚`;
                    }
                    
                    battleStory += `\n\næˆ˜æ–—ç»“æœ: ${battleResult.winner === currentPet.id ? 'èƒœåˆ©ï¼' : 'è´¥åŒ—...'}`;
                    
                    if (battleResult.winner === currentPet.id) {
                        battleStory += `\n${currentPet.name}åœ¨æˆ˜æ–—ä¸­è·å¾—äº†å®è´µçš„ç»éªŒï¼Œå®åŠ›å¾—åˆ°äº†æå‡ï¼`;
                    } else {
                        battleStory += `\nè™½ç„¶è´¥åŒ—ï¼Œä½†${currentPet.name}ä»è¿™æ¬¡æˆ˜æ–—ä¸­å­¦åˆ°äº†å¾ˆå¤šï¼Œè¿™å°†æˆä¸ºå®ƒæˆé•¿çš„å…»åˆ†ã€‚`;
                    }
                    
                    addStoryText(battleStory);
                    
                    // æ›´æ–°ä¿¡æ¯
                    loadCurrentPet();
                    loadActivityStatus();
                    loadRecentActivities();
                } else {
                    alert('æˆ˜æ–—å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('æˆ˜æ–—å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½æœ€è¿‘æ´»åŠ¨
        async function loadRecentActivities() {
            try {
                const response = await fetch('/api/pets/recent-activities');
                const data = await response.json();
                
                const activitiesDiv = document.getElementById('recentActivities');
                if (data.success && data.data.length > 0) {
                    activitiesDiv.innerHTML = data.data.map(activity => `
                        <div class="characteristic-item">
                            <strong>${formatTime(activity.timestamp)}:</strong> ${activity.description}
                        </div>
                    `).join('');
                } else {
                    activitiesDiv.innerHTML = '<div class="loading">æš‚æ— æ´»åŠ¨è®°å½•...</div>';
                }
            } catch (error) {
                console.error('åŠ è½½æ´»åŠ¨è®°å½•å¤±è´¥:', error);
            }
        }

        // æ·»åŠ æ•…äº‹æ–‡æœ¬
        function addStoryText(text) {
            const storyDiv = document.getElementById('storyDisplay');
            const timestamp = new Date().toLocaleTimeString();
            
            storyDiv.innerHTML = `
                <div class="story-text">
                    <strong>[${timestamp}]</strong><br>
                    ${text}
                </div>
            ` + storyDiv.innerHTML;
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // è¾…åŠ©å‡½æ•°
        function getRarityName(rarity) {
            const names = {
                'N': 'æ™®é€š',
                'R': 'ç¨€æœ‰',
                'SR': 'å²è¯—',
                'SSR': 'ä¼ è¯´',
                'SSS': 'ç¥è¯'
            };
            return names[rarity] || 'æœªçŸ¥';
        }

        function getElementName(element) {
            const names = {
                'neutral': 'æ— å±æ€§',
                'fire': 'ç«',
                'water': 'æ°´',
                'earth': 'åœŸ',
                'air': 'é£',
                'light': 'å…‰',
                'dark': 'æš—'
            };
            return names[element] || element;
        }

        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleString();
        }

        // ==================== èŠå¤©ç³»ç»Ÿç›¸å…³å‡½æ•° ====================

        // æ˜¾ç¤ºèŠå¤©æ¨¡æ€æ¡†
        function showChatModal() {
            if (!currentPet) return;
            
            document.getElementById('chatModal').style.display = 'block';
            loadSpeechInfo();
            loadChatHistory();
        }

        // åŠ è½½å® ç‰©è¯­è¨€èƒ½åŠ›ä¿¡æ¯
        async function loadSpeechInfo() {
            try {
                const response = await fetch(`/api/pets/${currentPet.id}/speech-info`);
                const data = await response.json();
                
                if (data.success) {
                    const info = data.data;
                    const speechInfoDiv = document.getElementById('speechLevel');
                    
                    let upgradeInfo = '';
                    if (info.nextLevel) {
                        upgradeInfo = `<div style="color: #87ceeb; font-size: 0.9em; margin-top: 5px;">
                            å‡çº§æ¡ä»¶: ${info.nextLevel.upgradeCondition}
                        </div>`;
                    }
                    
                    speechInfoDiv.innerHTML = `
                        <div class="characteristic-item">
                            <strong>å½“å‰ç­‰çº§:</strong> ${info.currentLevel.name} (Lv.${info.currentLevel.level})
                        </div>
                        <div class="characteristic-item">
                            <strong>å¯¹è¯èƒ½åŠ›:</strong> ${info.currentLevel.canRespond ? 'å¯ä»¥å›åº”' : 'åªä¼šå‘å£°'}
                        </div>
                        <div class="characteristic-item">
                            <strong>è¡¨è¾¾é•¿åº¦:</strong> æœ€å¤š ${info.currentLevel.maxLength} ä¸ªè¯
                        </div>
                        ${upgradeInfo}
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½è¯­è¨€èƒ½åŠ›å¤±è´¥:', error);
            }
        }

        // åŠ è½½èŠå¤©å†å²
        async function loadChatHistory() {
            try {
                const response = await fetch(`/api/pets/${currentPet.id}/chat-history?limit=20`);
                const data = await response.json();
                
                const historyDiv = document.getElementById('chatHistory');
                
                if (data.success && data.data.chatHistory.length > 0) {
                    const history = data.data.chatHistory;
                    historyDiv.innerHTML = history.map(chat => `
                        <div style="margin-bottom: 15px;">
                            <div style="background: rgba(100, 149, 237, 0.2); padding: 10px; border-radius: 10px; margin-bottom: 5px;">
                                <strong style="color: #6495ed;">ä½ :</strong> ${chat.player_message}
                            </div>
                            <div style="background: rgba(255, 215, 0, 0.2); padding: 10px; border-radius: 10px;">
                                <strong style="color: #ffd700;">${currentPet.name}:</strong> ${chat.pet_response}
                                <div style="font-size: 0.8em; color: #87ceeb; margin-top: 5px;">
                                    ${formatTime(chat.created_at)} | è¯­è¨€ç­‰çº§: ${chat.speech_level}
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    historyDiv.innerHTML = `
                        <div style="text-align: center; color: #87ceeb; padding: 20px;">
                            è¿˜æ²¡æœ‰èŠå¤©è®°å½•ï¼Œå¼€å§‹å’Œä½ çš„å® ç‰©å¯¹è¯å§ï¼<br>
                            <small>ğŸ’¡ å® ç‰©çš„è¯­è¨€èƒ½åŠ›ä¼šéšç€ç­‰çº§æå‡è€Œå¢å¼º</small>
                        </div>
                    `;
                }
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                historyDiv.scrollTop = historyDiv.scrollHeight;
            } catch (error) {
                console.error('åŠ è½½èŠå¤©å†å²å¤±è´¥:', error);
            }
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹ï¼');
                return;
            }
            
            if (!currentPet) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€åªå® ç‰©ï¼');
                return;
            }
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            
            // æ˜¾ç¤ºå‘é€ä¸­çŠ¶æ€
            addChatMessage('ä½ ', message, 'player');
            addChatMessage(currentPet.name, 'æ€è€ƒä¸­...', 'pet', true);
            
            try {
                const response = await fetch(`/api/pets/${currentPet.id}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // ç§»é™¤"æ€è€ƒä¸­"æ¶ˆæ¯
                    removeTempMessage();
                    
                    // æ·»åŠ å® ç‰©å›åº”
                    const petResponse = data.data.petResponse;
                    addChatMessage(currentPet.name, petResponse.text, 'pet', false, {
                        level: petResponse.level,
                        levelName: petResponse.levelName,
                        context: petResponse.context
                    });
                    
                    // æ›´æ–°è¯­è¨€èƒ½åŠ›ä¿¡æ¯
                    loadSpeechInfo();
                } else {
                    removeTempMessage();
                    addChatMessage('ç³»ç»Ÿ', 'å‘é€å¤±è´¥: ' + data.message, 'system');
                }
            } catch (error) {
                removeTempMessage();
                addChatMessage('ç³»ç»Ÿ', 'å‘é€å¤±è´¥: ' + error.message, 'system');
            }
        }

        // å¿«æ·èŠå¤©
        function quickChat(message) {
            document.getElementById('chatInput').value = message;
            sendMessage();
        }

        // è®©å® ç‰©ä¸»åŠ¨è¯´è¯
        async function getPetSpeech() {
            if (!currentPet) return;
            
            addChatMessage(currentPet.name, 'å‡†å¤‡è¯´è¯...', 'pet', true);
            
            try {
                const response = await fetch(`/api/pets/${currentPet.id}/speak?context=idle`);
                const data = await response.json();
                
                if (data.success) {
                    removeTempMessage();
                    
                    const speech = data.data.petSpeech;
                    addChatMessage(currentPet.name, speech.text, 'pet', false, {
                        level: speech.level,
                        levelName: speech.levelName,
                        context: speech.context
                    });
                } else {
                    removeTempMessage();
                    addChatMessage('ç³»ç»Ÿ', 'è·å–å® ç‰©å‘è¨€å¤±è´¥', 'system');
                }
            } catch (error) {
                removeTempMessage();
                addChatMessage('ç³»ç»Ÿ', 'è·å–å® ç‰©å‘è¨€å¤±è´¥: ' + error.message, 'system');
            }
        }

        // æ·»åŠ èŠå¤©æ¶ˆæ¯åˆ°ç•Œé¢
        function addChatMessage(sender, message, type, isTemp = false, extra = null) {
            const historyDiv = document.getElementById('chatHistory');
            
            let bgColor, textColor;
            switch (type) {
                case 'player':
                    bgColor = 'rgba(100, 149, 237, 0.2)';
                    textColor = '#6495ed';
                    break;
                case 'pet':
                    bgColor = 'rgba(255, 215, 0, 0.2)';
                    textColor = '#ffd700';
                    break;
                case 'system':
                    bgColor = 'rgba(255, 99, 71, 0.2)';
                    textColor = '#ff6347';
                    break;
            }
            
            let extraInfo = '';
            if (extra) {
                extraInfo = `<div style="font-size: 0.8em; color: #87ceeb; margin-top: 5px;">
                    ${new Date().toLocaleTimeString()} | ${extra.levelName} | ${extra.context}
                </div>`;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.style.marginBottom = '15px';
            if (isTemp) messageDiv.classList.add('temp-message');
            
            messageDiv.innerHTML = `
                <div style="background: ${bgColor}; padding: 10px; border-radius: 10px;">
                    <strong style="color: ${textColor};">${sender}:</strong> ${message}
                    ${extraInfo}
                </div>
            `;
            
            historyDiv.appendChild(messageDiv);
            historyDiv.scrollTop = historyDiv.scrollHeight;
        }

        // ç§»é™¤ä¸´æ—¶æ¶ˆæ¯
        function removeTempMessage() {
            const tempMessages = document.querySelectorAll('.temp-message');
            tempMessages.forEach(msg => msg.remove());
        }

        // å¤„ç†èŠå¤©è¾“å…¥æ¡†å›è½¦äº‹ä»¶
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
    </script>
</body>
</html>