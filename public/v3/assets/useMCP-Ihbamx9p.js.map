{"version":3,"file":"useMCP-Ihbamx9p.js","sources":["../../../client/src/services/mcp.ts","../../../client/src/composables/useMCP.ts"],"sourcesContent":["/**\r\n * MCP (Model Context Protocol) 客户端服务\r\n * 负责与MCP服务器通信,调用AI推理工具\r\n */\r\n\r\nimport type {\r\n  MCPConfig,\r\n  MCPToolRequest,\r\n  MCPToolResponse,\r\n  GenerateStoryParams,\r\n  CalculateEvolutionParams,\r\n  GeneratePetImageParams\r\n} from '@/types/mcp'\r\n\r\nexport class MCPClient {\r\n  private config: MCPConfig\r\n  private connected: boolean = false\r\n\r\n  constructor(config: MCPConfig) {\r\n    this.config = {\r\n      timeout: 30000,\r\n      retryCount: 3,\r\n      ...config\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 连接到MCP服务器\r\n   */\r\n  async connect(): Promise<void> {\r\n    try {\r\n      const response = await fetch(`${this.config.serverUrl}/health`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'Content-Type': 'application/json'\r\n        }\r\n      })\r\n\r\n      if (response.ok) {\r\n        this.connected = true\r\n        console.log('✅ MCP客户端连接成功')\r\n      } else {\r\n        throw new Error('MCP服务器健康检查失败')\r\n      }\r\n    } catch (error) {\r\n      console.error('❌ MCP连接失败:', error)\r\n      this.connected = false\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 调用MCP工具\r\n   */\r\n  async callTool(toolName: string, args: Record<string, any>): Promise<MCPToolResponse> {\r\n    if (!this.connected) {\r\n      console.warn('⚠️  MCP未连接,尝试重连...')\r\n      await this.connect()\r\n    }\r\n\r\n    const request: MCPToolRequest = {\r\n      name: toolName,\r\n      arguments: args\r\n    }\r\n\r\n    try {\r\n      const response = await this.fetchWithRetry(\r\n        `${this.config.serverUrl}/tools/${toolName}`,\r\n        {\r\n          method: 'POST',\r\n          headers: {\r\n            'Content-Type': 'application/json'\r\n          },\r\n          body: JSON.stringify(request)\r\n        }\r\n      )\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`MCP工具调用失败: ${response.statusText}`)\r\n      }\r\n\r\n      const data = await response.json()\r\n      return data as MCPToolResponse\r\n    } catch (error) {\r\n      console.error(`❌ MCP工具 \"${toolName}\" 调用失败:`, error)\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 生成剧情文本\r\n   */\r\n  async generateStory(params: GenerateStoryParams): Promise<string> {\r\n    try {\r\n      const response = await this.callTool('generate_story', params)\r\n\r\n      if (response.isError) {\r\n        throw new Error('AI生成剧情失败')\r\n      }\r\n\r\n      // 提取文本内容\r\n      const textContent = response.content.find(c => c.type === 'text')\r\n      return textContent?.text || ''\r\n    } catch (error) {\r\n      console.error('剧情生成失败,使用降级模板:', error)\r\n      return this.getFallbackStory(params.type)\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 计算进化路径\r\n   */\r\n  async calculateEvolution(params: CalculateEvolutionParams): Promise<any> {\r\n    const response = await this.callTool('calculate_evolution', params)\r\n\r\n    if (response.isError) {\r\n      throw new Error('进化计算失败')\r\n    }\r\n\r\n    const textContent = response.content.find(c => c.type === 'text')\r\n    return textContent?.text ? JSON.parse(textContent.text) : null\r\n  }\r\n\r\n  /**\r\n   * 生成宠物图片\r\n   */\r\n  async generatePetImage(params: GeneratePetImageParams): Promise<string | null> {\r\n    try {\r\n      const response = await this.callTool('generate_pet_image', params)\r\n\r\n      if (response.isError) {\r\n        return null\r\n      }\r\n\r\n      // 提取图片数据 (URL或Base64)\r\n      const imageContent = response.content.find(c => c.type === 'image' || c.type === 'text')\r\n      return imageContent?.data || imageContent?.text || null\r\n    } catch (error) {\r\n      console.error('图片生成失败:', error)\r\n      return null\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 带重试的fetch请求\r\n   */\r\n  private async fetchWithRetry(url: string, options: RequestInit, retries = this.config.retryCount!): Promise<Response> {\r\n    try {\r\n      const controller = new AbortController()\r\n      const timeout = setTimeout(() => controller.abort(), this.config.timeout)\r\n\r\n      const response = await fetch(url, {\r\n        ...options,\r\n        signal: controller.signal\r\n      })\r\n\r\n      clearTimeout(timeout)\r\n      return response\r\n    } catch (error) {\r\n      if (retries > 0) {\r\n        console.log(`⚠️  请求失败,重试中... (剩余${retries}次)`)\r\n        await this.delay(1000)\r\n        return this.fetchWithRetry(url, options, retries - 1)\r\n      }\r\n      throw error\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 降级模板\r\n   */\r\n  private getFallbackStory(type: string): string {\r\n    const templates: Record<string, string> = {\r\n      adventure: '你的宠物在未知的领域开始了一段冒险,前方充满了神秘与未知...',\r\n      daily: '平静的一天,你与宠物度过了愉快的时光,羁绊悄然增长。',\r\n      battle: '战斗的号角已经吹响!你的宠物蓄势待发,准备迎接挑战!',\r\n      evolution: '一股神秘的能量包围着宠物,它的身体开始发生奇妙的变化...'\r\n    }\r\n    return templates[type] || '故事继续展开...'\r\n  }\r\n\r\n  /**\r\n   * 延迟函数\r\n   */\r\n  private delay(ms: number): Promise<void> {\r\n    return new Promise(resolve => setTimeout(resolve, ms))\r\n  }\r\n\r\n  /**\r\n   * 断开连接\r\n   */\r\n  disconnect(): void {\r\n    this.connected = false\r\n    console.log('MCP客户端已断开连接')\r\n  }\r\n\r\n  /**\r\n   * 获取连接状态\r\n   */\r\n  isConnected(): boolean {\r\n    return this.connected\r\n  }\r\n}\r\n\r\n// 创建单例实例\r\nexport const mcpClient = new MCPClient({\r\n  serverUrl: import.meta.env.VITE_MCP_SERVER_URL || 'http://localhost:3001/mcp'\r\n})\r\n\r\n// 自动连接\r\nmcpClient.connect().catch(error => {\r\n  console.error('MCP自动连接失败:', error)\r\n})\r\n","/**\r\n * MCP Composable\r\n * 封装MCP客户端调用逻辑\r\n */\r\n\r\nimport { ref } from 'vue'\r\nimport { mcpClient } from '@/services/mcp'\r\nimport type { StoryContext } from '@/types/story'\r\n\r\nexport function useMCP() {\r\n  const loading = ref(false)\r\n  const error = ref<string | null>(null)\r\n\r\n  /**\r\n   * 生成剧情文本\r\n   */\r\n  async function generateStory(context: StoryContext) {\r\n    loading.value = true\r\n    error.value = null\r\n\r\n    try {\r\n      const story = await mcpClient.generateStory({\r\n        type: context.type,\r\n        context\r\n      })\r\n\r\n      return story\r\n    } catch (err: any) {\r\n      error.value = err.message || '生成剧情失败'\r\n      throw err\r\n    } finally {\r\n      loading.value = false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取进化候选\r\n   */\r\n  async function getEvolutionCandidates(petId: string, behaviors: any[]) {\r\n    loading.value = true\r\n    error.value = null\r\n\r\n    try {\r\n      const result = await mcpClient.calculateEvolution({\r\n        petId,\r\n        behaviors\r\n      })\r\n\r\n      return result\r\n    } catch (err: any) {\r\n      error.value = err.message || '获取进化候选失败'\r\n      throw err\r\n    } finally {\r\n      loading.value = false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 生成宠物图片\r\n   */\r\n  async function generatePetImage(prompt: string, style: string = 'shanhaijing') {\r\n    loading.value = true\r\n    error.value = null\r\n\r\n    try {\r\n      const imageUrl = await mcpClient.generatePetImage({\r\n        prompt,\r\n        style,\r\n        provider: 'vim'\r\n      })\r\n\r\n      return imageUrl\r\n    } catch (err: any) {\r\n      error.value = err.message || '生成图片失败'\r\n      // 图片生成失败不抛出错误\r\n      return null\r\n    } finally {\r\n      loading.value = false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 检查MCP连接状态\r\n   */\r\n  function isConnected() {\r\n    return mcpClient.isConnected()\r\n  }\r\n\r\n  /**\r\n   * 重新连接MCP\r\n   */\r\n  async function reconnect() {\r\n    loading.value = true\r\n    error.value = null\r\n\r\n    try {\r\n      await mcpClient.connect()\r\n    } catch (err: any) {\r\n      error.value = err.message || 'MCP连接失败'\r\n      throw err\r\n    } finally {\r\n      loading.value = false\r\n    }\r\n  }\r\n\r\n  return {\r\n    loading,\r\n    error,\r\n    generateStory,\r\n    getEvolutionCandidates,\r\n    generatePetImage,\r\n    isConnected,\r\n    reconnect\r\n  }\r\n}\r\n"],"names":["MCPClient","config","__publicField","error","toolName","args","request","response","params","textContent","c","imageContent","url","options","retries","controller","timeout","type","ms","resolve","mcpClient","useMCP","loading","ref","generateStory","context","err","getEvolutionCandidates","petId","behaviors","generatePetImage","prompt","style","isConnected","reconnect"],"mappings":"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"}