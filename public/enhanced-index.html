<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>çµå¢ƒæ–—å® å½• Â· æ–‡å­—å¯¹è¯ç‰ˆ</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box }
    :root {
      --bg:#0f1220; --panel:rgba(255,255,255,0.08); --muted:#9bb0ff;
      --accent:#7c9cff; --accent2:#b8ffda; --warn:#ffb86b; --danger:#ff6b6b; --ok:#79ffa1;
      --text:#e8edff; --soft:#c7d2ff;
    }
    body { font-family: 'Microsoft YaHei', Arial, sans-serif; background:linear-gradient(160deg,#0b0e1a,#101538 60%,#0b0e1a); color:var(--text); min-height:100vh; }
    .wrap { height:100vh; display:flex; flex-direction:column }
    /* é¡¶éƒ¨çŠ¶æ€æ¡ */
    .topbar { display:flex; align-items:center; justify-content:space-between; padding:12px 14px; background:rgba(0,0,0,.35); border-bottom:1px solid rgba(255,255,255,.06); backdrop-filter: blur(12px); }
    .petMini { display:flex; align-items:center; gap:10px }
    .egg { width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; background: linear-gradient(135deg,#6b7bff,#8aa9ff); box-shadow: 0 0 10px rgba(124,156,255,.35); }
    .name { font-weight:700; letter-spacing:.5px }
    .ap { background: rgba(124,156,255,.16); border:1px solid rgba(124,156,255,.35); padding:6px 10px; border-radius:16px; font-size:12px; }
    /* ä¸»å¯¹è¯èˆå° */
    .stage { flex:1; padding:16px 14px; overflow-y:auto; }
    .msg { margin:10px 0; animation:fade .25s ease; line-height:1.6 }
    .msg .from { font-size:12px; opacity:.8; margin-bottom:3px }
    .msg .bubble { display:inline-block; padding:10px 12px; border-radius:12px; background:var(--panel); border:1px solid rgba(255,255,255,.08); white-space:pre-wrap }
    .msg.system .bubble { color:var(--muted) }
    .msg.user .bubble { border-color: rgba(124,156,255,.45); box-shadow: inset 0 0 0 1px rgba(124,156,255,.25) }
    .msg.pet .bubble { border-color: rgba(184,255,218,.45); box-shadow: inset 0 0 0 1px rgba(184,255,218,.2) }
    @keyframes fade{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)} }
    /* åº•éƒ¨è¾“å…¥åŒº */
    .dock { display:flex; gap:10px; padding:12px; border-top:1px solid rgba(255,255,255,.06); background:rgba(0,0,0,.35); backdrop-filter: blur(12px) }
    .ipt { flex:1; background:var(--panel); border:1px solid rgba(255,255,255,.12); color:var(--text); padding:12px 14px; border-radius:12px; outline:none }
    .send { width:46px; height:46px; border-radius:12px; border:1px solid rgba(124,156,255,.45); background:linear-gradient(135deg,#5d77ff,#6e9bff); color:white; cursor:pointer }
    /* å³ä¸Šè§’èœå•æŒ‰é’®ä¸ä¾§æŠ½å±‰ */
    .menuBtn { position:fixed; top:14px; right:14px; width:42px; height:42px; border-radius:50%; border:1px solid rgba(255,255,255,.15); background:rgba(0,0,0,.5); color:#fff; cursor:pointer; z-index:10 }
    .drawer { position:fixed; top:0; right:-280px; width:280px; height:100vh; background:rgba(10,13,27,.96); border-left:1px solid rgba(255,255,255,.08); transition:right .25s ease; z-index:9; padding:70px 14px 14px }
    .drawer.open { right:0 }
    .item { padding:12px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.04); border-radius:10px; margin:10px 0; cursor:pointer }
    .item:hover { border-color: rgba(124,156,255,.45) }
    .item .t { font-weight:700 }
    .item .d { opacity:.75; font-size:12px; margin-top:4px }
    /* æ¨¡æ€æ¡† */
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.55); z-index:20 }
    .modal.open { display:flex }
    .card { width:min(92vw,540px); max-height:80vh; overflow:auto; background: #0b0f24; border:1px solid rgba(255,255,255,.1); border-radius:14px; padding:16px }
    .card h3 { margin-bottom:8px }
    .opt { padding:10px; border:1px dashed rgba(255,255,255,.15); border-radius:10px; margin:8px 0; cursor:pointer }
    .opt:hover { border-color: var(--accent) }
    .sub { font-size:12px; opacity:.75; margin-top:4px }
    .okay { background: linear-gradient(135deg,#59d69f,#7af1bd); border:none; color:#0b0f24; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700 }
    .ghost { background:transparent; border:1px solid rgba(255,255,255,.18); color:var(--soft); padding:10px 12px; border-radius:10px; cursor:pointer; margin-left:8px }
    .row { display:flex; gap:8px; margin-top:10px }
    .muted { color:var(--muted) }
    .hr { height:1px; background:rgba(255,255,255,.08); margin:10px 0 }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="petMini">
        <div class="egg" id="petAvatar">ğŸ¥š</div>
        <div>
          <div class="name" id="petName">æœªç»‘å®šå® ç‰©</div>
          <div class="muted" id="petHint" style="font-size:12px">è¾“å…¥ä»»æ„å†…å®¹å¼€å§‹ä¸çµå® å»ºç«‹è”ç³»</div>
        </div>
      </div>
      <div class="ap">âš¡ <span id="ap">--</span></div>
    </div>

    <div class="stage" id="stage">
      <div class="msg system"><div class="from">ç³»ç»Ÿ</div><div class="bubble">ğŸŒŸ çµå¢ƒå·²å¼€å¯ã€‚è¿™é‡Œä¸€åˆ‡çš†ç”±ä½ çš„è¨€è¯­å¼•å¯¼ã€‚</div></div>
    </div>
    <div id="worldBar" style="border-top:1px solid rgba(255,255,255,.06); background:rgba(0,0,0,.28); padding:8px 12px; font-size:12px; white-space:nowrap; overflow:hidden;">
      <div id="worldTicker" style="display:inline-block; will-change: transform;"></div>
    </div>

    <div class="dock">
      <input class="ipt" id="ipt" placeholder="å¯¹ä½ çš„çµå® è¯´ç‚¹ä»€ä¹ˆ..." maxlength="120" />
      <button class="send" id="btnSend">ğŸ“¤</button>
    </div>
  </div>

  <button class="menuBtn" id="menuBtn">â‰¡</button>
  <div class="drawer" id="drawer">
    <div class="item" id="actCreate">
      <div class="t">å­µåŒ–/ç»‘å®šçµå® </div>
      <div class="d">ç¬¬ä¸€æ¬¡æ¥ï¼Ÿä¸€é”®åˆ›é€ å±äºä½ çš„ä¼™ä¼´</div>
    </div>
    <div class="item" id="actStatus">
      <div class="t">æŸ¥çœ‹çŠ¶æ€</div>
      <div class="d">ç¨€æœ‰åº¦/å…ƒç´ /åŸºç¡€èƒ½åŠ›ä¸æœ€è¿‘è®°äº‹</div>
    </div>
    <div class="item" id="actBattle">
      <div class="t">å¿«é€Ÿå¯¹æˆ˜</div>
      <div class="d">åŒ¹é…è¯•ç‚¼å¯¹æ‰‹ï¼Œæ–‡å­—æˆ˜æŠ¥+ç»“ç®—</div>
    </div>
    <div class="item" id="actAdventure">
      <div class="t">æ‰˜ç®¡å¥‡é‡</div>
      <div class="d">åå°æ¢ç´¢ï¼Œå¼‚æ­¥è¿”å›æ–‡å­—å¥‡é‡</div>
    </div>
    <div class="item" id="actHelp">
      <div class="t">ç©æ³•è¯´æ˜</div>
      <div class="d">è¡Œä¸ºâ†’æç¤ºè¯â†’è¿›åŒ– çš„éçº¿æ€§æˆé•¿</div>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="card" id="modalCard"></div>
  </div>

  <script>
    const stage = document.getElementById('stage');
    const ipt = document.getElementById('ipt');
    const btnSend = document.getElementById('btnSend');
    const petNameEl = document.getElementById('petName');
    const petHintEl = document.getElementById('petHint');
    const petAvatar = document.getElementById('petAvatar');
    const apEl = document.getElementById('ap');
    const menuBtn = document.getElementById('menuBtn');
    const drawer = document.getElementById('drawer');
    const modal = document.getElementById('modal');
    const modalCard = document.getElementById('modalCard');

    let state = { pet:null, ap:0, userId:'mobile-user' };

    function addMsg(type, text) {
      const div = document.createElement('div');
      div.className = `msg ${type}`;
      div.innerHTML = `<div class="from">${type==='user'?'ä½ ':(type==='pet'?(state.pet?.name||'çµå® '):'ç³»ç»Ÿ')}</div><div class="bubble">${escapeHtml(text)}</div>`;
      stage.appendChild(div);
      stage.scrollTop = stage.scrollHeight;
    }
    function escapeHtml(s){ return (s||'').replace(/[&<>"]/g,c=>({ '&':'&','<':'<','>':'>','"':'"' }[c])) }

    async function refreshAP(){
      try {
        const r = await fetch('/api/pets/activity-status'); const j = await r.json();
        if(j.success){ state.ap=j.data.currentPoints; apEl.textContent = `${state.ap}/${j.data.maxPoints}`; }
      } catch {}
    }
    async function loadPet(){
      try{
        const r = await fetch('/api/pets/user/'+state.userId);
        const j = await r.json();
        if(j.success && j.data.length){ state.pet=j.data[0]; syncPetMini(); }
      }catch{}
    }
    function syncPetMini(){
      if(!state.pet){ petNameEl.textContent='æœªç»‘å®šå® ç‰©'; petHintEl.textContent='è¾“å…¥ä»»æ„å†…å®¹å¼€å§‹ä¸çµå® å»ºç«‹è”ç³»'; petAvatar.textContent='ğŸ¥š'; return; }
      petNameEl.textContent = state.pet.name;
      petHintEl.textContent = `ç¨€æœ‰åº¦ ${state.pet.rarity||'N'} Â· å…ƒç´  ${state.pet.element||'neutral'}`;
      const avMap={N:'ğŸ£',R:'ğŸ°',SR:'ğŸ¦Š',SSR:'ğŸ‰',SSS:'ğŸ‘‘'};
      petAvatar.textContent = avMap[state.pet.rarity] || 'ğŸ¾';
    }

    async function createPetFlow(){
      openModal(`
        <h3>ğŸ£ å­µåŒ–/ç»‘å®š</h3>
        <div class="muted">ä¸ºä½ çš„çµå® èµ·ä¸€ä¸ªåå­—ï¼ˆå¯ç•™ç©ºéšæœºï¼‰ï¼š</div>
        <div class="row"><input class="ipt" id="newPetName" placeholder="å¦‚ï¼šå½©é£ã€æ˜Ÿå°˜..."/></div>
        <div class="row">
          <button class="okay" onclick="confirmCreate()">å­µåŒ–</button>
          <button class="ghost" onclick="closeModal()">å–æ¶ˆ</button>
        </div>
      `);
    }
    async function confirmCreate(){
      const name = (document.getElementById('newPetName').value||'').trim() || randomName();
      try{
        const r = await fetch('/api/pets/create',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId: state.userId, petName: name })});
        const j = await r.json();
        if(j.success){ state.pet=j.data; syncPetMini(); addMsg('system',`âœ¨ ${name} åœ¨çµå¢ƒä¸­è‹é†’ã€‚`); pushWorldNews('hatch', {name, rarity: state.pet.rarity, elem: state.pet.element}); closeModal(); }
        else addMsg('system','âŒ å­µåŒ–å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
      }catch{ addMsg('system','âš ï¸ ç½‘ç»œå¼‚å¸¸'); }
    }
    function randomName(){ const a=['å°','çµ','æ˜Ÿ','é£','äº‘','æœˆ','å½±','ç”µ','å²š','æ›¦']; const b=['ç«','æ°´','é£','åœŸ','å…‰','æš—','é›·','äº‘','æ˜Ÿ','æœˆ']; return a[Math.random()*a.length|0]+b[Math.random()*b.length|0] }

    async function chatSend(){
      const text = ipt.value.trim(); if(!text) return;
      addMsg('user', text); ipt.value='';
      if(!state.pet){ addMsg('pet','å’•å’•ï¼Ÿï¼ˆå…ˆå­µåŒ–æˆ‘å§ï¼ï¼‰'); return; }
      try{
        addMsg('pet','â€¦â€¦ï¼ˆæ€è€ƒä¸­ï¼‰');
        const r = await fetch(`/api/pets/${state.pet.id}/chat`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ message: text })});
        const j = await r.json();
        // æ›¿æ¢æœ€åä¸€æ¡â€œæ€è€ƒä¸­â€
        stage.lastElementChild.querySelector('.bubble').textContent = (j.success ? j.data.petResponse.text : 'å˜¤å˜¤...(ç¨åå†èŠ)');
      }catch{ stage.lastElementChild.querySelector('.bubble').textContent = 'ç½‘ç»œä¼¼ä¹ä¸ç¨³å®šâ€¦'; }
    }

    async function quickBattle(){
      if(!state.pet){ addMsg('system','è¯·å…ˆå­µåŒ–çµå® '); return; }
      addMsg('system','âš”ï¸ æ­£åœ¨åŒ¹é…å¯¹æ‰‹...');
      try{
        const r = await fetch('/api/battle/matchmaking',{method:'POST',headers:{'Content-Type':'application/json'}, body: JSON.stringify({ userId: state.userId, petId: state.pet.id })});
        const j = await r.json();
        if(j.success){
          const d=j.data;
          addMsg('system','â€” æˆ˜æ–—å¼€å§‹ â€”');
          addMsg('system', d.report.replace(/\n/g,'\n'));
          const win = d.winner===state.pet.id;
          addMsg('system', `ç»“æœï¼š${win?'èƒœåˆ©':'è½è´¥'} Â· è¯„çº§ ${d.settlement.rating} Â· å›åˆ ${d.settlement.rounds} Â· ç»éªŒ +${d.settlement.exp} Â· é‡‘å¸ +${d.settlement.gold}${d.settlement.drops?.length?(' Â· æ‰è½ '+d.settlement.drops.map(x=>x.name).join('ã€')):''}`);
          pushWorldNews('battle', {pet: state.pet.name, win, rating: d.settlement.rating});
        } else addMsg('system','åŒ¹é…å¤±è´¥');
      }catch{ addMsg('system','ç½‘ç»œæ³¢åŠ¨ï¼Œç¨åå†è¯•'); }
    }

    async function quickAdventure(){
      if(!state.pet){ addMsg('system','è¯·å…ˆå­µåŒ–çµå® '); return; }
      addMsg('system','ğŸ’ æ‰˜ç®¡å¥‡é‡å·²å¯åŠ¨ï¼Œç¨åå°†æœ‰æ–‡å­—å›ä¿¡ã€‚');
      try{
        const r = await fetch('/api/pets/adventure/start',{method:'POST',headers:{'Content-Type':'application/json'}, body: JSON.stringify({ petId: state.pet.id, durationMinutes: 60 })});
        await r.json(); // å³ä½¿å¤±è´¥ä¹Ÿä¸æ‰“æ–­ä½“éªŒ
      }catch{}
    }

    function openStatus(){
      if(!state.pet){ openModal('<h3>ğŸ“Š çŠ¶æ€</h3><div class="muted">å°šæœªç»‘å®šçµå® </div>'); return; }
      openModal(`
        <h3>ğŸ“Š ${state.pet.name}</h3>
        <div class="hr"></div>
        <div class="muted">ç¨€æœ‰åº¦ï¼š${state.pet.rarity||'N'} Â· å…ƒç´ ï¼š${state.pet.element||'neutral'}</div>
        <div class="sub">ç”Ÿå‘½ ${state.pet.hp} Â· æ”»å‡» ${state.pet.attack} Â· é˜²å¾¡ ${state.pet.defense} Â· é€Ÿåº¦ ${state.pet.speed}</div>
        <div class="hr"></div>
        <div class="muted">æœ€è¿‘è®°äº‹å°†é€šè¿‡ä¸»èˆå°æ»šåŠ¨å±•ç¤ºã€‚</div>
        <div class="row"><button class="ghost" onclick="closeModal()">å…³é—­</button></div>
      `);
    }

    function openHelp(){
      openModal(`
        <h3>â“ ç©æ³•è¯´æ˜</h3>
        <div class="hr"></div>
        <div class="muted">æœ¬ä½œä»¥â€œæ–‡å­—å¯¹è¯â€ä¸ºä¸»ã€‚ä½ çš„æ¯æ¬¡å¯¹è¯ä¸é€‰æ‹©ï¼Œéƒ½ä¼šæ½œç§»é»˜åŒ–å½±å“äºŒ/ä¸‰å±‚æç¤ºè¯ä¸è¯æ¡å›ºåŒ–ï¼ˆå½“å‰ä¸ç›´æ¥æ”¹åŠ¨æˆ˜æ–—æ•°å€¼ï¼Œå·²é¢„ç•™ä½ï¼‰ã€‚</div>
        <div class="sub">å»ºè®®ä»å­µåŒ–å¼€å§‹ï¼Œå°è¯•èŠå¤©ã€å¿«é€Ÿå¯¹æˆ˜ã€æ‰˜ç®¡å¥‡é‡ã€‚</div>
        <div class="row"><button class="ghost" onclick="closeModal()">å…³é—­</button></div>
      `);
    }

    // UI helpers
    function toggleDrawer(){ drawer.classList.toggle('open'); }
    function openModal(html){ modalCard.innerHTML=html; modal.classList.add('open'); }
    function closeModal(){ modal.classList.remove('open'); }
    document.addEventListener('click', (e)=>{ if(modal.classList.contains('open') && e.target===modal) closeModal(); });

    // events
    btnSend.onclick = chatSend;
    ipt.addEventListener('keypress', e=>{ if(e.key==='Enter') chatSend(); });
    menuBtn.onclick = toggleDrawer;
    document.getElementById('actCreate').onclick = ()=>{ toggleDrawer(); createPetFlow(); };
    document.getElementById('actStatus').onclick = ()=>{ toggleDrawer(); openStatus(); };
    document.getElementById('actBattle').onclick = ()=>{ toggleDrawer(); quickBattle(); };
    document.getElementById('actAdventure').onclick = ()=>{ toggleDrawer(); quickAdventure(); };
    document.getElementById('actHelp').onclick = ()=>{ toggleDrawer(); openHelp(); };

    // init
    (async function init(){
      addMsg('system','âœ¨ æ¬¢è¿æ¥åˆ°â€œæ–‡å­—å¯¹è¯â€ä¸»èˆå°ã€‚');
      await Promise.all([refreshAP(), loadPet()]);
      // å®šæ—¶åˆ·æ–° AP
      setInterval(refreshAP, 30000);
      startWorldTicker();
      if(!state.pet){
        addMsg('pet','å’•å’•â€¦ï¼ˆæˆ‘åœ¨ç­‰å¾…è¯ç”Ÿï¼‰');
        addMsg('system','å¯åœ¨å³ä¸Šè§’â€œâ‰¡â€å­µåŒ–æ–°å® ã€‚');
      } else {
        addMsg('pet','å˜¤å˜¤ï¼(ä¸€èµ·å»çœ‹çœ‹è¿™ä¸ªä¸–ç•Œå§)');
      }
    })();

    // ================= ä¸–ç•Œè¦é—» =================
    const ticker = document.getElementById('worldTicker');
    let newsQueue = [];
    function pushWorldNews(type, payload={}){
      const now = new Date().toLocaleTimeString();
      const lines = {
        hatch: () => `ã€${now}ã€‘ç©å®¶æŠ½ä¸­ ${payload.rarity||'N'} çº§çµå® ã€Œ${payload.name}ã€Â· å…ƒç´  ${payload.elem||'neutral'}`,
        evolve: () => `ã€${now}ã€‘ã€Œ${payload.name}ã€é€†å¤©è¿›åŒ–ï¼Œè·å¾—æ–°è¯æ¡ã€Œ${payload.trait||'ç¥ç§˜çƒˆç„°'}ã€`,
        battle: () => `ã€${now}ã€‘ã€Œ${payload.pet}ã€åœ¨æ¯”è¯•ä¸­${payload.win?'è±ªå–èƒœåˆ©':'æƒœè´¥'} Â· è¯„çº§ ${payload.rating||'A'}`
      };
      const text = (lines[type] || (()=>`ã€${now}ã€‘çµå¢ƒæ·±å¤„æ€èµ·æ¶Ÿæ¼ªâ€¦`))();
      newsQueue.push(text);
      renderTicker();
    }
    function renderTicker(){
      const content = newsQueue.slice(-10).join('    |    ');
      if (ticker) {
        ticker.textContent = content || 'çµå¢ƒé™å€™æ–°çš„ä¼ è¯´â€¦';
      }
    }
    function startWorldTicker(){
      seedWorldNews();
      renderTicker();
      setInterval(()=>{ autoGenerateNews(); renderTicker(); }, 15000);
    }
    function seedWorldNews(){
      const sample = [
        'ç©å®¶ã€Œæ¸…é£ã€æŠ½ä¸­ SSS çº§ã€Œä¹å°¾ã€Â· å…ƒç´  å¹»',
        'ã€Œç™½æ³½ã€äºæ˜†ä»‘æ‚Ÿé“ï¼Œè¯æ¡ã€Œæ´æ‚‰ä¸‡è±¡ã€è§‰é†’',
        'ã€Œèµ¤ç„°é›€ã€è¿èƒœä¸‰åœºï¼Œè¯„çº§ S',
        'ç©å®¶ã€Œç„æœˆã€åœ¨è“¬è±é‡ç§˜ä½¿ï¼Œè·å¾—ã€Œçµé›¾å¶ã€'
      ];
      const now = new Date().toLocaleTimeString();
      newsQueue.push(...sample.map(s=>`ã€${now}ã€‘${s}`));
    }
    function autoGenerateNews(){
      const pets = ['é’éºŸ','å½©é£','å¤œé­‡','äº‘å²š','æ˜Ÿæ¸Š','éœœå½±','ç‚é¾™','æ²§é²¤'];
      const traits = ['ç¥ç§˜çƒˆç„°','å†°å¿ƒæ˜ æœˆ','é›·éœ†ä¸‡é’§','é£è¡Œæ— è¸ª','çµæœ¨ç¹ç”Ÿ','å¹½å½±ç¼ ç»•'];
      const rar = ['N','R','SR','SSR','SSS'];
      const elem = ['fire','water','earth','air','light','dark','poison','ice'];
      const pick = arr => arr[Math.random()*arr.length|0];
      const kind = Math.random();
      if(kind<0.34){
        pushWorldNews('hatch',{name: pick(pets), rarity: pick(rar), elem: pick(elem)});
      } else if(kind<0.67){
        pushWorldNews('evolve',{name: pick(pets), trait: pick(traits)});
      } else {
        pushWorldNews('battle',{pet: pick(pets), win: Math.random()>0.5, rating: ['S','A','B'][Math.random()*3|0]});
      }
    }
  </script>
</body>
</html>