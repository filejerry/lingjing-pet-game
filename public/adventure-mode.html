<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµå¢ƒæ–—å® å½• - æ²‰æµ¸å¼å†’é™©æ¨¡å¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', 'Microsoft YaHei', monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0a0a0a 100%);
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .game-container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        .story-panel {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-right: 2px solid rgba(255, 215, 0, 0.2);
            position: relative;
        }

        .story-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent 0%, rgba(255, 215, 0, 0.02) 50%, transparent 100%);
            pointer-events: none;
        }

        .pet-panel {
            width: 350px;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(15px);
            border-left: 1px solid rgba(255, 215, 0, 0.3);
            padding: 30px;
            overflow-y: auto;
            position: relative;
        }

        .story-content {
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.8;
            font-size: 16px;
        }

        .story-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
        }

        .story-title {
            font-size: 2.5em;
            color: #ffd700;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            animation: glow-pulse 3s ease-in-out infinite alternate;
        }

        @keyframes glow-pulse {
            from { text-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
            to { text-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.3); }
        }

        .story-subtitle {
            font-size: 1.1em;
            color: #888;
            font-style: italic;
        }

        .story-text {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(20, 20, 20, 0.6);
            border-left: 3px solid #ffd700;
            border-radius: 0 8px 8px 0;
            animation: fadeInUp 0.8s ease-out;
            position: relative;
            overflow: hidden;
        }

        .story-text::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .story-text.new {
            animation: typewriter 2s steps(100) forwards, fadeInUp 0.8s ease-out;
        }

        .story-text.system {
            background: rgba(30, 30, 60, 0.6);
            border-left-color: #4169e1;
            color: #b0c4de;
            font-style: italic;
        }

        .story-text.pet-speech {
            background: rgba(60, 30, 30, 0.6);
            border-left-color: #ff6347;
            color: #ffb6c1;
        }

        .story-text.important {
            background: rgba(60, 60, 30, 0.6);
            border-left-color: #ffd700;
            color: #fff8dc;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
        }

        @keyframes typewriter {
            from { width: 0; }
            to { width: 100%; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .choices-container {
            margin: 40px 0;
            padding: 30px;
            background: rgba(15, 15, 15, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            position: relative;
        }

        .choices-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ffd700, #ff6347, #4169e1, #ffd700);
            border-radius: 12px;
            z-index: -1;
            opacity: 0.3;
            animation: border-glow 3s linear infinite;
        }

        @keyframes border-glow {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .choices-title {
            text-align: center;
            font-size: 1.3em;
            color: #ffd700;
            margin-bottom: 25px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .choice-card {
            background: rgba(30, 30, 30, 0.9);
            border: 2px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .choice-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(45deg, #ffd700, #ff6347);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .choice-card:hover {
            border-color: #ffd700;
            background: rgba(40, 40, 40, 0.9);
            transform: translateX(10px);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.2);
        }

        .choice-card:hover::before {
            transform: scaleY(1);
        }

        .choice-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .choice-title {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 8px;
            font-size: 18px;
        }

        .choice-description {
            color: #ccc;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .choice-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .choice-tag {
            display: inline-block;
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .choice-tag.risk {
            background: rgba(255, 99, 71, 0.2);
            color: #ff6347;
            border-color: rgba(255, 99, 71, 0.3);
        }

        .choice-tag.safe {
            background: rgba(65, 105, 225, 0.2);
            color: #4169e1;
            border-color: rgba(65, 105, 225, 0.3);
        }

        .pet-info {
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .pet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .pet-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .pet-rarity {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .rarity-N { background: #666; color: white; }
        .rarity-R { background: #4169e1; color: white; }
        .rarity-SR { background: #9932cc; color: white; }
        .rarity-SSR { background: #ff6347; color: white; }
        .rarity-SSS { 
            background: linear-gradient(45deg, #ffd700, #ff6347, #9932cc, #4169e1);
            background-size: 300% 300%;
            animation: rainbow-glow 3s ease-in-out infinite;
            color: white;
        }

        @keyframes rainbow-glow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .pet-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 8px;
            background: rgba(30, 30, 30, 0.8);
            border-radius: 5px;
            border: 1px solid #555;
        }

        .stat-label {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 3px;
        }

        .stat-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #ffd700;
        }

        .pet-mood {
            text-align: center;
            padding: 10px;
            background: rgba(40, 40, 40, 0.8);
            border-radius: 8px;
            border: 1px solid #555;
            margin-bottom: 15px;
        }

        .mood-label {
            font-size: 0.9em;
            color: #888;
            margin-bottom: 5px;
        }

        .mood-value {
            font-size: 1.2em;
            font-weight: bold;
        }

        .mood-happy { color: #4CAF50; }
        .mood-excited { color: #ffd700; }
        .mood-calm { color: #4169e1; }
        .mood-tired { color: #888; }
        .mood-angry { color: #ff6347; }

        .chat-panel {
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chat-title {
            color: #ffd700;
            font-size: 1.1em;
            margin-bottom: 15px;
            text-align: center;
        }

        .chat-input {
            width: 100%;
            background: rgba(30, 30, 30, 0.9);
            border: 1px solid #555;
            color: #e0e0e0;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            margin-bottom: 10px;
            resize: vertical;
            min-height: 60px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }

        .chat-button {
            width: 100%;
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            border: 1px solid rgba(255, 215, 0, 0.5);
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .chat-button:hover {
            background: rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            background: rgba(40, 40, 40, 0.9);
            color: #e0e0e0;
            border: 1px solid #666;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: rgba(50, 50, 50, 0.9);
            border-color: #ffd700;
            color: #ffd700;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 215, 0, 0.3);
            border-top: 3px solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #ffd700;
            margin-top: 20px;
            font-size: 1.1em;
            text-align: center;
        }

        @media (max-width: 768px) {
            .game-container {
                flex-direction: column;
            }
            
            .story-panel {
                border-right: none;
                border-bottom: 2px solid rgba(255, 215, 0, 0.2);
            }
            
            .pet-panel {
                width: 100%;
                border-left: none;
                border-top: 1px solid rgba(255, 215, 0, 0.3);
            }
            
            .pet-stats {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div>
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">AIæ­£åœ¨ç¼–ç»‡ä½ çš„å†’é™©æ•…äº‹...</div>
        </div>
    </div>

    <div class="game-container">
        <div class="story-panel">
            <div class="story-content">
                <div class="story-header">
                    <h1 class="story-title">ğŸŒŸ çµå¢ƒå†’é™©å½•</h1>
                    <p class="story-subtitle">æ¯ä¸€ä¸ªé€‰æ‹©ï¼Œéƒ½å°†æ”¹å†™å‘½è¿çš„è½¨è¿¹</p>
                    <div style="font-size: 0.8em; color: #888; margin-top: 10px;">
                        ä½œè€…ï¼šæ ‘æ (å¾®ä¿¡: wzq8083) | 100+ç§å±±æµ·ç»ç¥å…½ç­‰ä½ å‘ç°
                    </div>
                </div>

                <div id="storyFlow">
                    <div class="story-text important">
                        åœ¨é¥è¿œçš„çµå¢ƒå¤§é™†æ·±å¤„ï¼Œå¤è€çš„é­”æ³•èƒ½é‡åœ¨ç©ºæ°”ä¸­è½»æŸ”åœ°æµæ·Œç€ã€‚ä½ ï¼Œä½œä¸ºä¸€ååˆšåˆšè¸å…¥è¿™ä¸ªç¥ç§˜ä¸–ç•Œçš„çµå¸ˆï¼Œæ„Ÿå—åˆ°äº†å‰æ‰€æœªæœ‰çš„åŠ›é‡åœ¨ä½“å†…è§‰é†’...
                    </div>
                    
                    <div class="story-text">
                        æ™¨å…‰é€è¿‡å¤è€æ£®æ—çš„æå¶æ´’ä¸‹ï¼Œåœ¨ä½ é¢å‰çš„ç©ºåœ°ä¸Šå½¢æˆäº†ä¸€ä¸ªç¥ç§˜çš„å¬å”¤æ³•é˜µã€‚æ³•é˜µä¸­å¤®ï¼Œä¸‰é“ä¸åŒé¢œè‰²çš„å…‰èŠ’æ­£åœ¨ç¼“ç¼“æ—‹è½¬ï¼Œæ¯ä¸€é“å…‰èŠ’éƒ½æ•£å‘ç€ç‹¬ç‰¹çš„çµåŠ›æ³¢åŠ¨ã€‚
                    </div>
                    
                    <div class="story-text system">
                        ã€ç³»ç»Ÿæç¤ºã€‘ä½ æ„Ÿå—åˆ°äº†ä¸‰ç§ä¸åŒçš„çµé­‚å…±é¸£ï¼Œå®ƒä»¬æ­£åœ¨ç­‰å¾…ä½ çš„é€‰æ‹©...
                    </div>
                </div>

                <div class="choices-container">
                    <div class="choices-title">âœ¨ å¬å”¤ä½ çš„å±±æµ·ç»ä¼™ä¼´ âœ¨</div>
                    
                    <div class="choice-card" onclick="makeChoice('random_summon')">
                        <div class="choice-title">ğŸ² ç¥ç§˜å¬å”¤</div>
                        <div class="choice-description">
                            è®©å‘½è¿æ¥å†³å®šä½ çš„ä¼™ä¼´ï¼ä»100+ç§å±±æµ·ç»ç¥å…½ä¸­éšæœºå¬å”¤ï¼Œå¯èƒ½æ˜¯ä¼ è¯´ä¸­çš„ä¹å¤©åº”é¾™ï¼Œä¹Ÿå¯èƒ½æ˜¯å¯çˆ±çš„æœˆå…‰ç‰å…”ã€‚æ¯ä¸€æ¬¡å¬å”¤éƒ½æ˜¯æœªçŸ¥çš„æƒŠå–œï¼
                        </div>
                        <div class="choice-tags">
                            <span class="choice-tag">éšæœº</span>
                            <span class="choice-tag">æƒŠå–œ</span>
                            <span class="choice-tag">å‘½è¿</span>
                            <span class="choice-tag">100+ç§</span>
                        </div>
                    </div>

                    <div class="choice-card" onclick="makeChoice('legendary_summon')">
                        <div class="choice-title">â­ ä¼ è¯´å¬å”¤</div>
                        <div class="choice-description">
                            å°è¯•å¬å”¤ä¼ è¯´çº§çš„ç¥å…½ï¼è™½ç„¶æ¦‚ç‡æä½(0.05%)ï¼Œä½†ä¸€æ—¦æˆåŠŸï¼Œä½ å°†è·å¾—ä¹å¤©åº”é¾™ã€æ¶…æ§ƒå‡¤å‡°ã€ç‘å…½éº’éºŸç­‰ä¼ è¯´ä¸­çš„è‡³é«˜å­˜åœ¨ã€‚é£é™©ä¸æ”¶è·å¹¶å­˜ï¼
                        </div>
                        <div class="choice-tags">
                            <span class="choice-tag">ä¼ è¯´</span>
                            <span class="choice-tag">SSSçº§</span>
                            <span class="choice-tag">æç¨€æœ‰</span>
                            <span class="choice-tag risk">æä½æ¦‚ç‡</span>
                        </div>
                    </div>

                    <div class="choice-card" onclick="makeChoice('stable_summon')">
                        <div class="choice-title">ğŸ›¡ï¸ ç¨³å®šå¬å”¤</div>
                        <div class="choice-description">
                            é€‰æ‹©ä¸€ä¸ªç›¸å¯¹ç¨³å®šçš„å¬å”¤æ–¹å¼ï¼Œä¿è¯è·å¾—Rçº§ä»¥ä¸Šçš„ç¨€æœ‰ä¼™ä¼´ã€‚è™½ç„¶ä¸ä¼šæœ‰ä¼ è¯´çº§çš„æƒŠå–œï¼Œä½†èƒ½ç¡®ä¿è·å¾—ä¸€ä¸ªå®åŠ›ä¸ä¿—çš„å¯é ä¼™ä¼´ã€‚
                        </div>
                        <div class="choice-tags">
                            <span class="choice-tag">ç¨³å®š</span>
                            <span class="choice-tag">Rçº§ä¿åº•</span>
                            <span class="choice-tag">å¯é </span>
                            <span class="choice-tag safe">å®‰å…¨</span>
                        </div>
                    </div>

                    <div class="choice-card" onclick="makeChoice('keyword_summon')">
                        <div class="choice-title">ğŸ” å®šå‘å¬å”¤</div>
                        <div class="choice-description">
                            é€šè¿‡å…³é”®è¯æ¥å¬å”¤ç‰¹å®šç±»å‹çš„ä¼™ä¼´ã€‚ä½ å¯ä»¥è¾“å…¥"é¾™"ã€"å‡¤å‡°"ã€"é²²"ã€"ç‹ç‹¸"ç­‰å…³é”®è¯ï¼Œç³»ç»Ÿä¼šä»å¯¹åº”çš„ç¥å…½ä¸­ä¸ºä½ åŒ¹é…æœ€åˆé€‚çš„ä¼™ä¼´ã€‚
                        </div>
                        <div class="choice-tags">
                            <span class="choice-tag">å®šå‘</span>
                            <span class="choice-tag">å…³é”®è¯</span>
                            <span class="choice-tag">åŒ¹é…</span>
                            <span class="choice-tag">ç²¾å‡†</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="pet-panel">
            <div class="pet-info" id="petInfo" style="display: none;">
                <div class="pet-header">
                    <div class="pet-name" id="petName">æœªçŸ¥ä¼™ä¼´</div>
                    <div class="pet-rarity rarity-N" id="petRarity">æ™®é€š</div>
                </div>
                
                <div class="pet-stats" id="petStats">
                    <!-- å® ç‰©å±æ€§å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                
                <div class="pet-mood">
                    <div class="mood-label">å½“å‰å¿ƒæƒ…</div>
                    <div class="mood-value mood-calm" id="petMood">å¹³é™</div>
                </div>
            </div>

            <div class="chat-panel">
                <div class="chat-title">ğŸ’¬ ä¸ä¼™ä¼´äº¤æµ</div>
                <textarea class="chat-input" id="chatInput" placeholder="è¾“å…¥ä½ æƒ³å¯¹ä¼™ä¼´è¯´çš„è¯...&#10;&#10;ä¾‹å¦‚ï¼š&#10;- ä½ æ„Ÿè§‰æ€ä¹ˆæ ·ï¼Ÿ&#10;- æˆ‘ä»¬æ¥ä¸‹æ¥å»å“ªé‡Œï¼Ÿ&#10;- ä½ æœ‰ä»€ä¹ˆæƒ³æ³•å—ï¼Ÿ" rows="3"></textarea>
                <button class="chat-button" onclick="sendChat()">å‘é€æ¶ˆæ¯</button>
            </div>

            <div class="action-buttons">
                <button class="action-btn" onclick="showPetDetails()">ğŸ“Š æŸ¥çœ‹è¯¦ç»†å±æ€§</button>
                <button class="action-btn" onclick="showEvolutionStatus()">ğŸŒŸ è¿›åŒ–çŠ¶æ€</button>
                <button class="action-btn" onclick="saveProgress()">ğŸ’¾ ä¿å­˜è¿›åº¦</button>
                <button class="action-btn" onclick="showSettings()">âš™ï¸ æ¸¸æˆè®¾ç½®</button>
                <button class="action-btn" onclick="returnToMain()">ğŸ  è¿”å›ä¸»ç•Œé¢</button>
            </div>
        </div>
    </div>

    <script src="evolution-system.js"></script>
    <script>
        // å…¨å±€æ¸¸æˆçŠ¶æ€
        let gameState = {
            currentPet: null,
            storyProgress: 0,
            currentScene: 'pet_selection',
            playerChoices: [],
            storyHistory: [],
            evolutionData: {
                behaviorHistory: [],
                evolutionQueue: null,
                lastAnalysis: null,
                evolutionCooldown: 0
            }
        };

        // AI APIé…ç½®
        const API_CONFIG = {
            baseURL: '/api/ai',
            timeout: 30000
        };

        // è¿›åŒ–ç³»ç»Ÿé…ç½®
        const EVOLUTION_CONFIG = {
            // è¡Œä¸ºæƒé‡é…ç½®
            behaviorWeights: {
                aggressive: { power: 0.8, fire: 0.6, chaos: 0.4 },
                defensive: { balance: 0.7, justice: 0.8, fortune: 0.3 },
                strategic: { wisdom: 0.9, prophecy: 0.7, balance: 0.5 },
                healing: { healing: 1.0, divine: 0.8, balance: 0.6 },
                curious: { wisdom: 0.6, prophecy: 0.4, chaos: 0.3 },
                cautious: { balance: 0.7, justice: 0.5, fortune: 0.4 },
                reckless: { power: 0.5, fire: 0.7, chaos: 0.8 },
                helpful: { healing: 0.8, divine: 0.9, balance: 0.6 },
                leadership: { power: 0.6, justice: 0.8, divine: 0.7 },
                cooperation: { balance: 0.9, healing: 0.7, fortune: 0.6 },
                independence: { chaos: 0.7, fire: 0.5, prophecy: 0.4 },
                moral: { divine: 1.0, justice: 0.9, balance: 0.7 },
                sacrifice: { divine: 1.0, healing: 0.8, balance: 0.6 },
                power_seeking: { power: 1.0, fire: 0.7, chaos: 0.5 },
                knowledge: { wisdom: 1.0, prophecy: 0.8, balance: 0.4 }
            },
            
            // è¿›åŒ–é˜ˆå€¼
            evolutionThresholds: {
                stage1: { level: 10, experience: 1000, bond: 50 },
                stage2: { level: 25, experience: 5000, bond: 100 },
                stage3: { level: 50, experience: 20000, bond: 150 }
            },
            
            // å†·å´æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
            cooldowns: {
                analysis: 300000,    // 5åˆ†é’Ÿ
                evolution: 3600000   // 1å°æ—¶
            }
        };

        // å® ç‰©æ•°æ®æ¨¡æ¿
        const PET_TEMPLATES = {
            dragon: {
                species: 'å¹¼é¾™',
                baseStats: { hp: 90, attack: 35, defense: 25, speed: 20, magic: 40 },
                traits: ['é¾™æ—è¡€è„‰', 'é­”æ³•äº²å’Œ', 'å¨ä¸¥æ°”åœº'],
                personality: 'é«˜å‚²è€Œæ™ºæ…§ï¼Œå¯¹ä¸»äººå¿ è¯šä½†æœ‰è‡ªå·±çš„åŸåˆ™',
                rarity: 'SSR'
            },
            phoenix: {
                species: 'å‡¤å‡°é›é¸Ÿ',
                baseStats: { hp: 80, attack: 25, defense: 20, speed: 30, magic: 35 },
                traits: ['æµ´ç«é‡ç”Ÿ', 'æ²»æ„ˆä¹‹å…‰', 'ç¥åœ£åº‡æŠ¤'],
                personality: 'æ¸©å’Œæ…ˆæ‚²ï¼Œå……æ»¡åŒæƒ…å¿ƒï¼Œæ„¿æ„ä¸ºä»–äººç‰ºç‰²',
                rarity: 'SSR'
            },
            kirin: {
                species: 'éº’éºŸå¹¼å´½',
                baseStats: { hp: 85, attack: 20, defense: 30, speed: 25, magic: 30 },
                traits: ['ç¥¥ç‘ä¹‹åŠ›', 'é¢„çŸ¥å±é™©', 'å‡€åŒ–é‚ªæ¶'],
                personality: 'æ¸©å’Œå–„è‰¯ï¼Œå–œæ¬¢å’Œå¹³ï¼Œæ‹¥æœ‰æ•é”çš„ç›´è§‰',
                rarity: 'SR'
            }
        };

        // æ•…äº‹ç”Ÿæˆæç¤ºè¯æ¨¡æ¿
        const STORY_PROMPTS = {
            petCreation: (petType) => `
                ç©å®¶é€‰æ‹©äº†${petType}ä½œä¸ºä¼™ä¼´ã€‚è¯·ç”Ÿæˆä¸€ä¸ªç”ŸåŠ¨çš„å® ç‰©è¯ç”Ÿåœºæ™¯æè¿°ï¼ŒåŒ…æ‹¬ï¼š
                1. å¬å”¤è¿‡ç¨‹çš„è¯¦ç»†æè¿°ï¼ˆ200-300å­—ï¼‰
                2. å® ç‰©çš„å¤–è§‚ç‰¹å¾
                3. å® ç‰©çš„ç¬¬ä¸€ååº”å’Œè¡Œä¸º
                4. ç©å®¶ä¸å® ç‰©çš„åˆæ¬¡äº’åŠ¨
                5. ä¸ºæ¥ä¸‹æ¥çš„å†’é™©è®¾ç½®3-4ä¸ªä¸åŒçš„é€‰æ‹©æ–¹å‘
                
                è¦æ±‚ï¼šæ–‡å­—ä¼˜ç¾ï¼Œå¯Œæœ‰ç”»é¢æ„Ÿï¼Œä½“ç°${petType}çš„ç‰¹è‰²
            `,
            
            adventureChoice: (choice, petInfo, history) => `
                åŸºäºä»¥ä¸‹ä¿¡æ¯ç”Ÿæˆä¸‹ä¸€æ®µå†’é™©æ•…äº‹ï¼š
                - ç©å®¶é€‰æ‹©ï¼š${choice}
                - å® ç‰©ä¿¡æ¯ï¼š${JSON.stringify(petInfo)}
                - å†å²é€‰æ‹©ï¼š${history.slice(-3).join(', ')}
                
                è¯·ç”Ÿæˆï¼š
                1. é€‰æ‹©ç»“æœçš„è¯¦ç»†æè¿°ï¼ˆ300-400å­—ï¼‰
                2. é‡åˆ°çš„æ–°æƒ…å†µæˆ–æŒ‘æˆ˜
                3. å® ç‰©çš„ååº”å’Œå˜åŒ–
                4. 2-4ä¸ªæ–°çš„é€‰æ‹©é€‰é¡¹ï¼Œæ¯ä¸ªé€‰é¡¹åŒ…å«æ ‡é¢˜ã€æè¿°å’Œæ ‡ç­¾
                
                è¦æ±‚ï¼šæƒ…èŠ‚è¿è´¯ï¼Œå¯Œæœ‰å˜åŒ–ï¼Œä½“ç°å® ç‰©çš„æˆé•¿
            `
        };

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            console.log('ğŸ® çµå¢ƒå†’é™©å½•å·²å¯åŠ¨');
            
            // æ·»åŠ é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', handleKeyboard);
            
            // è‡ªåŠ¨ä¿å­˜åŠŸèƒ½
            setInterval(autoSave, 60000); // æ¯åˆ†é’Ÿè‡ªåŠ¨ä¿å­˜
        }

        // è®°å½•å® ç‰©è¡Œä¸ºï¼ˆé›†æˆè¿›åŒ–ç³»ç»Ÿï¼‰
        function recordPetBehavior(behaviorType, context) {
            if (window.evolutionSystem && gameState.currentPet) {
                evolutionSystem.recordBehavior(behaviorType, context);
            }
        }

        // å¤„ç†é€‰æ‹©
        async function makeChoice(choiceType) {
            if (document.querySelector('.choice-card.disabled')) return;
            
            showLoading('AIæ­£åœ¨ç¼–ç»‡ä½ çš„å†’é™©æ•…äº‹...');
            
            try {
                // ç¦ç”¨æ‰€æœ‰é€‰æ‹©æŒ‰é’®
                document.querySelectorAll('.choice-card').forEach(card => {
                    card.classList.add('disabled');
                });
                
                // è®°å½•å® ç‰©è¡Œä¸ºï¼ˆç”¨äºè¿›åŒ–ç³»ç»Ÿï¼‰
                if (gameState.currentPet) {
                    recordPetBehavior('choice', {
                        choiceId: choiceType,
                        scene: gameState.currentScene,
                        timestamp: Date.now()
                    });
                }
                
                if (gameState.currentScene === 'pet_selection') {
                    await handlePetCreation(choiceType);
                } else {
                    await handleAdventureChoice(choiceType);
                }
                
                // è®°å½•é€‰æ‹©å†å²
                gameState.playerChoices.push({
                    choice: choiceType,
                    timestamp: Date.now(),
                    scene: gameState.currentScene
                });
                
                // æ£€æŸ¥è¿›åŒ–å¯èƒ½æ€§
                if (window.evolutionSystem && gameState.currentPet) {
                    await evolutionSystem.analyzeEvolutionPotential();
                }
                
            } catch (error) {
                console.error('é€‰æ‹©å¤„ç†å¤±è´¥:', error);
                addStoryText('ç³»ç»Ÿé”™è¯¯ï¼šæ— æ³•å¤„ç†ä½ çš„é€‰æ‹©ï¼Œè¯·é‡è¯•ã€‚', 'system');
            } finally {
                hideLoading();
                
                // é‡æ–°å¯ç”¨é€‰æ‹©æŒ‰é’®
                setTimeout(() => {
                    document.querySelectorAll('.choice-card').forEach(card => {
                        card.classList.remove('disabled');
                    });
                }, 1000);
            }
        }

        // å¤„ç†å® ç‰©åˆ›å»º
        async function handlePetCreation(petType) {
            const template = PET_TEMPLATES[petType];
            if (!template) throw new Error('æœªçŸ¥çš„å® ç‰©ç±»å‹');
            
            // åˆ›å»ºå® ç‰©å®ä¾‹
            gameState.currentPet = {
                id: Date.now(),
                name: `å¹¼å¹´${template.species}`,
                species: template.species,
                type: petType,
                rarity: template.rarity,
                level: 1,
                exp: 0,
                mood: 'excited',
                ...template.baseStats,
                traits: [...template.traits],
                personality: template.personality,
                bond: 10 // åˆå§‹ç¾ç»Šå€¼
            };
            
            // æ›´æ–°å® ç‰©æ˜¾ç¤º
            updatePetDisplay();
            
            // ç”Ÿæˆå® ç‰©è¯ç”Ÿæ•…äº‹
            try {
                const storyResponse = await generateStory(STORY_PROMPTS.petCreation(template.species));
                await displayStorySequence(storyResponse);
            } catch (error) {
                // å¤‡ç”¨æ•…äº‹å†…å®¹
                await displayPetCreationFallback(template);
            }
            
            gameState.currentScene = 'adventure';
            gameState.storyProgress++;
        }

        // å¤‡ç”¨å® ç‰©åˆ›å»ºæ•…äº‹
        async function displayPetCreationFallback(template) {
            const stories = [
                `æ³•é˜µä¸­çš„å…‰èŠ’è¶Šæ¥è¶Šäº®ï¼Œä½ æ„Ÿå—åˆ°äº†å¼ºçƒˆçš„é­”æ³•æ³¢åŠ¨...`,
                `çªç„¶ï¼Œä¸€é“è€€çœ¼çš„å…‰æŸ±å†²å¤©è€Œèµ·ï¼å½“å…‰èŠ’æ•£å»æ—¶ï¼Œä¸€åª${template.species}å‡ºç°åœ¨ä½ é¢å‰ã€‚`,
                `è¿™åª${template.species}${getPetAppearanceDescription(template.species)}ï¼Œæ­£ç”¨å¥½å¥‡çš„çœ¼ç¥æ‰“é‡ç€ä½ ã€‚`,
                `ä½ ä¼¸å‡ºæ‰‹ï¼Œ${template.species}çŠ¹è±«äº†ä¸€ä¸‹ï¼Œç„¶åè½»è½»ç¢°è§¦äº†ä½ çš„æ‰‹æŒã€‚ä¸€è‚¡æ¸©æš–çš„æ„Ÿè§‰ä¼ éå…¨èº«ï¼Œä½ ä»¬ä¹‹é—´å»ºç«‹äº†ç¥ç§˜çš„å¥‘çº¦ã€‚`
            ];
            
            for (let story of stories) {
                addStoryText(story);
                await sleep(2000);
            }
            
            addStoryText(`ã€å¥‘çº¦å®Œæˆã€‘ä½ ä¸${template.species}å»ºç«‹äº†çµé­‚å¥‘çº¦ï¼`, 'important');
            await sleep(1500);
            
            generateFirstAdventureChoices();
        }

        // è·å–å® ç‰©å¤–è§‚æè¿°
        function getPetAppearanceDescription(species) {
            const descriptions = {
                'å¹¼é¾™': 'èº«ä½“è™½å°ä½†é³ç‰‡é—ªé—ªå‘å…‰ï¼Œå°å°çš„ç¿…è†€è¿˜æ— æ³•æ”¯æ’‘é£è¡Œï¼Œä½†çœ¼ä¸­å·²æœ‰é¾™æ—ç‰¹æœ‰çš„å¨ä¸¥',
                'å‡¤å‡°é›é¸Ÿ': 'ç¾½æ¯›å‘ˆç°å‡ºç¾ä¸½çš„çº¢é‡‘è‰²æ¸å˜ï¼Œè™½ç„¶è¿˜å¾ˆå¹¼å°ï¼Œä½†å·²èƒ½æ„Ÿå—åˆ°å…¶ä½“å†…è•´å«çš„ç¥åœ£ç«ç„°',
                'éº’éºŸå¹¼å´½': 'é€šä½“æ´ç™½å¦‚é›ªï¼Œé¢å¤´ä¸Šæœ‰ä¸€ä¸ªå°å°çš„è§’èŠ½ï¼Œå‘¨èº«æ•£å‘ç€æ·¡æ·¡çš„ç¥¥ç‘å…‰èŠ’'
            };
            return descriptions[species] || 'å¤–è¡¨ç¥ç§˜è€Œç¾ä¸½';
        }

        // ç”Ÿæˆç¬¬ä¸€æ¬¡å†’é™©é€‰æ‹©
        function generateFirstAdventureChoices() {
            const choices = [
                {
                    id: 'explore_forest',
                    title: 'ğŸŒ² æ¢ç´¢ç¥ç§˜æ£®æ—',
                    description: 'æ·±å…¥è¿™ç‰‡å¤è€çš„æ£®æ—ï¼Œå¯»æ‰¾éšè—çš„å®è—å’Œç§˜å¯†ã€‚æ£®æ—ä¸­å¯èƒ½æœ‰çè´µçš„è‰è¯ï¼Œä¹Ÿå¯èƒ½æ½œä¼ç€å±é™©çš„é­”å…½ã€‚',
                    tags: ['æ¢ç´¢', 'å†’é™©', 'é£é™©', 'æ”¶è·']
                },
                {
                    id: 'visit_village',
                    title: 'ğŸ˜ï¸ å‰å¾€é™„è¿‘æ‘åº„',
                    description: 'åˆ°æœ€è¿‘çš„æ‘åº„äº†è§£å½“åœ°æƒ…å†µï¼Œè´­ä¹°å¿…éœ€å“ï¼Œä¹Ÿè®¸è¿˜èƒ½æ¥åˆ°ä¸€äº›ä»»åŠ¡ã€‚è¿™æ˜¯ç›¸å¯¹å®‰å…¨çš„é€‰æ‹©ã€‚',
                    tags: ['å®‰å…¨', 'ä¿¡æ¯', 'ä»»åŠ¡', 'è¡¥ç»™']
                },
                {
                    id: 'training_ground',
                    title: 'âš”ï¸ å¯»æ‰¾è®­ç»ƒåœºåœ°',
                    description: 'æ‰¾ä¸€ä¸ªå®‰å…¨çš„åœ°æ–¹è®­ç»ƒä½ å’Œä¼™ä¼´çš„é…åˆï¼Œæå‡æˆ˜æ–—æŠ€å·§ã€‚è™½ç„¶è¿›å±•ç¼“æ…¢ï¼Œä½†å¾ˆç¨³å¦¥ã€‚',
                    tags: ['è®­ç»ƒ', 'æˆé•¿', 'ç¨³å¦¥', 'æŠ€èƒ½']
                },
                {
                    id: 'ancient_ruins',
                    title: 'ğŸ›ï¸ è°ƒæŸ¥å¤ä»£é—è¿¹',
                    description: 'è¿œå¤„æœ‰ä¸€åº§å¤è€çš„é—è¿¹ï¼Œæ•£å‘ç€ç¥ç§˜çš„é­”æ³•æ°”æ¯ã€‚é‚£é‡Œå¯èƒ½æœ‰å¼ºå¤§çš„å®ç‰©ï¼Œä½†ä¹Ÿå……æ»¡æœªçŸ¥çš„å±é™©ã€‚',
                    tags: ['é—è¿¹', 'å®ç‰©', 'é­”æ³•', 'æé™©']
                }
            ];
            
            displayChoices(choices, 'ğŸ—ºï¸ é€‰æ‹©ä½ ä»¬çš„ç¬¬ä¸€ä¸ªç›®çš„åœ°');
        }

        // å¤„ç†å†’é™©é€‰æ‹©
        async function handleAdventureChoice(choiceId) {
            try {
                const storyResponse = await generateStory(
                    STORY_PROMPTS.adventureChoice(
                        choiceId, 
                        gameState.currentPet, 
                        gameState.playerChoices.map(c => c.choice)
                    )
                );
                
                await displayStorySequence(storyResponse);
                
                // æ ¹æ®é€‰æ‹©æ›´æ–°å® ç‰©çŠ¶æ€
                updatePetFromChoice(choiceId);
                
            } catch (error) {
                console.error('å†’é™©é€‰æ‹©å¤„ç†å¤±è´¥:', error);
                await displayAdventureFallback(choiceId);
            }
            
            gameState.storyProgress++;
        }

        // å¤‡ç”¨å†’é™©å†…å®¹
        async function displayAdventureFallback(choiceId) {
            const outcomes = {
                'explore_forest': {
                    story: 'ä½ ä»¬æ·±å…¥æ£®æ—ï¼Œå‘ç°äº†ä¸€ç‰‡é—ªé—ªå‘å…‰çš„è˜‘è‡æ—ã€‚ä½ çš„ä¼™ä¼´ä¼¼ä¹å¯¹è¿™äº›è˜‘è‡å¾ˆæ„Ÿå…´è¶£...',
                    effect: { exp: 15, mood: 'excited' }
                },
                'visit_village': {
                    story: 'æ‘æ°‘ä»¬å¯¹ä½ çš„ä¼™ä¼´æ„Ÿåˆ°æƒŠå¥‡ï¼Œä¸€ä½è€è€…å‘Šè¯‰ä½ å…³äºé™„è¿‘å¤è€ä¼ è¯´çš„æ•…äº‹...',
                    effect: { bond: 5, mood: 'happy' }
                },
                'training_ground': {
                    story: 'ç»è¿‡ä¸€ç•ªè®­ç»ƒï¼Œä½ å’Œä¼™ä¼´çš„é…åˆæ›´åŠ é»˜å¥‘äº†ã€‚ä½ æ„Ÿè§‰åˆ°äº†æ˜æ˜¾çš„è¿›æ­¥...',
                    effect: { exp: 10, attack: 2, mood: 'calm' }
                },
                'ancient_ruins': {
                    story: 'é—è¿¹ä¸­å……æ»¡äº†å±é™©ï¼Œä½†ä½ ä»¬æˆåŠŸè·å¾—äº†ä¸€å—ç¥ç§˜çš„æ°´æ™¶ã€‚ä½ çš„ä¼™ä¼´ä¼¼ä¹å˜å¾—æ›´å¼ºäº†...',
                    effect: { exp: 25, magic: 5, mood: 'excited' }
                }
            };
            
            const outcome = outcomes[choiceId] || outcomes['explore_forest'];
            
            addStoryText(outcome.story);
            await sleep(2000);
            
            // åº”ç”¨æ•ˆæœ
            if (outcome.effect) {
                applyEffectToPet(outcome.effect);
                addStoryText(`ä½ çš„ä¼™ä¼´è·å¾—äº†æˆé•¿ï¼`, 'important');
            }
            
            await sleep(1500);
            generateRandomChoices();
        }

        // ç”Ÿæˆéšæœºé€‰æ‹©
        function generateRandomChoices() {
            const randomChoices = [
                {
                    id: 'continue_adventure',
                    title: 'ğŸš€ ç»§ç»­å½“å‰å†’é™©',
                    description: 'æ·±å…¥æ¢ç´¢å½“å‰åŒºåŸŸï¼Œå¯»æ‰¾æ›´å¤šçš„æœºé‡å’ŒæŒ‘æˆ˜ã€‚',
                    tags: ['æŒç»­', 'æ·±å…¥']
                },
                {
                    id: 'change_direction',
                    title: 'ğŸ”„ æ”¹å˜æ–¹å‘',
                    description: 'å‰å¾€æ–°çš„åŒºåŸŸï¼Œä½“éªŒä¸åŒçš„å†’é™©å†…å®¹ã€‚',
                    tags: ['å˜åŒ–', 'æ–°å¥‡']
                },
                {
                    id: 'rest_and_bond',
                    title: 'ğŸ˜´ ä¼‘æ¯å¹¶å¢è¿›æ„Ÿæƒ…',
                    description: 'æ‰¾ä¸ªå®‰å…¨çš„åœ°æ–¹ä¼‘æ¯ï¼Œä¸ä¼™ä¼´å¢è¿›æ„Ÿæƒ…ã€‚',
                    tags: ['ä¼‘æ¯', 'ç¾ç»Š']
                }
            ];
            
            displayChoices(randomChoices, 'ğŸ¯ é€‰æ‹©ä¸‹ä¸€æ­¥è¡ŒåŠ¨');
        }

        // æ˜¾ç¤ºé€‰æ‹©é€‰é¡¹
        function displayChoices(choices, title) {
            const choicesContainer = document.querySelector('.choices-container');
            
            choicesContainer.innerHTML = `
                <div class="choices-title">${title}</div>
                ${choices.map(choice => `
                    <div class="choice-card" onclick="makeChoice('${choice.id}')">
                        <div class="choice-title">${choice.title}</div>
                        <div class="choice-description">${choice.description}</div>
                        <div class="choice-tags">
                            ${choice.tags.map(tag => {
                                let tagClass = 'choice-tag';
                                if (['é£é™©', 'å±é™©', 'æé™©'].includes(tag)) tagClass += ' risk';
                                if (['å®‰å…¨', 'ç¨³å¦¥', 'å¹³è¡¡'].includes(tag)) tagClass += ' safe';
                                return `<span class="${tagClass}">${tag}</span>`;
                            }).join('')}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // æ›´æ–°å® ç‰©æ˜¾ç¤º
        function updatePetDisplay() {
            if (!gameState.currentPet) return;
            
            const pet = gameState.currentPet;
            const evolutionStatus = getEvolutionStatus();
            const petInfo = document.getElementById('petInfo');
            const petName = document.getElementById('petName');
            const petRarity = document.getElementById('petRarity');
            const petStats = document.getElementById('petStats');
            const petMood = document.getElementById('petMood');
            
            petInfo.style.display = 'block';
            petName.textContent = pet.name;
            
            const rarityNames = { 'N': 'æ™®é€š', 'R': 'ç¨€æœ‰', 'SR': 'è¶…ç¨€æœ‰', 'SSR': 'æç¨€æœ‰', 'SSS': 'ä¼ è¯´' };
            petRarity.textContent = rarityNames[pet.rarity] || 'æ™®é€š';
            petRarity.className = `pet-rarity rarity-${pet.rarity}`;
            
            // æ·»åŠ è¿›åŒ–çŠ¶æ€åˆ°å±æ€§æ˜¾ç¤ºä¸­
            let evolutionInfo = '';
            if (evolutionStatus.canEvolve) {
                evolutionInfo = `
                    <div class="stat-item evolution-ready" style="grid-column: span 2; background: rgba(255, 215, 0, 0.2); border-color: #ffd700;">
                        <div class="stat-label">ğŸŒŸ è¿›åŒ–çŠ¶æ€</div>
                        <div class="stat-value" style="color: #ffd700;">å¯ä»¥è¿›åŒ–ï¼</div>
                        <button onclick="triggerEvolution()" style="margin-top: 5px; padding: 5px 10px; background: #ffd700; color: #000; border: none; border-radius: 3px; cursor: pointer;">ç«‹å³è¿›åŒ–</button>
                    </div>
                `;
            } else if (evolutionStatus.status !== 'æ— å® ç‰©') {
                evolutionInfo = `
                    <div class="stat-item" style="grid-column: span 2;">
                        <div class="stat-label">ğŸŒŸ è¿›åŒ–çŠ¶æ€</div>
                        <div class="stat-value" style="color: #888;">${evolutionStatus.status}</div>
                    </div>
                `;
            }
            
            petStats.innerHTML = `
                <div class="stat-item">
                    <div class="stat-label">ç”Ÿå‘½</div>
                    <div class="stat-value">${pet.hp}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">æ”»å‡»</div>
                    <div class="stat-value">${pet.attack}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">é˜²å¾¡</div>
                    <div class="stat-value">${pet.defense}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">æ•æ·</div>
                    <div class="stat-value">${pet.speed}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">é­”æ³•</div>
                    <div class="stat-value">${pet.magic}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ç­‰çº§</div>
                    <div class="stat-value">${pet.level}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ç»éªŒ</div>
                    <div class="stat-value">${pet.exp || 0}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ç¾ç»Š</div>
                    <div class="stat-value">${pet.bond || 0}</div>
                </div>
                ${evolutionInfo}
            `;
            
            const moodNames = {
                'happy': 'å¼€å¿ƒ',
                'excited': 'å…´å¥‹',
                'calm': 'å¹³é™',
                'tired': 'ç–²æƒ«',
                'angry': 'æ„¤æ€’'
            };
            
            petMood.textContent = moodNames[pet.mood] || 'å¹³é™';
            petMood.className = `mood-value mood-${pet.mood}`;
        }

        // åº”ç”¨æ•ˆæœåˆ°å® ç‰©
        function applyEffectToPet(effects) {
            if (!gameState.currentPet) return;
            
            const pet = gameState.currentPet;
            
            Object.keys(effects).forEach(key => {
                if (key === 'mood') {
                    pet.mood = effects[key];
                } else if (typeof effects[key] === 'number') {
                    pet[key] = (pet[key] || 0) + effects[key];
                }
            });
            
            // æ£€æŸ¥å‡çº§
            if (effects.exp && pet.exp >= pet.level * 100) {
                pet.level++;
                pet.exp = 0;
                addStoryText(`ğŸ‰ ${pet.name}å‡çº§äº†ï¼ç­‰çº§æå‡è‡³${pet.level}çº§ï¼`, 'important');
                
                // è®°å½•å‡çº§è¡Œä¸º
                recordPetBehavior('level_up', {
                    newLevel: pet.level,
                    timestamp: Date.now()
                });
            }
            
            // è®°å½•å±æ€§å˜åŒ–è¡Œä¸º
            recordPetBehavior('stat_change', {
                effects: effects,
                timestamp: Date.now()
            });
            
            updatePetDisplay();
        }

        // æ·»åŠ æ•…äº‹æ–‡æœ¬
        function addStoryText(text, type = 'normal') {
            const storyFlow = document.getElementById('storyFlow');
            const storyDiv = document.createElement('div');
            
            let className = 'story-text';
            if (type === 'system') className += ' system';
            if (type === 'pet-speech') className += ' pet-speech';
            if (type === 'important') className += ' important';
            if (type === 'new') className += ' new';
            
            storyDiv.className = className;
            storyDiv.textContent = text;
            
            storyFlow.appendChild(storyDiv);
            
            // æ»šåŠ¨åˆ°æœ€æ–°å†…å®¹
            storyDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });
            
            // ä¿å­˜åˆ°å†å²
            gameState.storyHistory.push({ text, type, timestamp: Date.now() });
        }

        // æ˜¾ç¤ºæ•…äº‹åºåˆ—
        async function displayStorySequence(storyData) {
            if (typeof storyData === 'string') {
                // ç®€å•æ–‡æœ¬
                addStoryText(storyData, 'new');
                await sleep(2000);
            } else if (storyData.story && Array.isArray(storyData.story)) {
                // æ•…äº‹æ•°ç»„
                for (let segment of storyData.story) {
                    addStoryText(segment, 'new');
                    await sleep(2000);
                }
                
                // æ˜¾ç¤ºé€‰æ‹©
                if (storyData.choices) {
                    displayChoices(storyData.choices, storyData.choicesTitle || 'é€‰æ‹©ä½ çš„è¡ŒåŠ¨');
                }
            }
        }

        // ç”ŸæˆAIæ•…äº‹
        async function generateStory(prompt) {
            try {
                const response = await fetch(`${API_CONFIG.baseURL}/generate-story`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        gameState: gameState,
                        maxTokens: 800
                    }),
                    timeout: API_CONFIG.timeout
                });
                
                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                
                const data = await response.json();
                return data.story || data.content || 'æ•…äº‹ç”Ÿæˆå¤±è´¥';
                
            } catch (error) {
                console.error('AIæ•…äº‹ç”Ÿæˆå¤±è´¥:', error);
                throw error;
            }
        }

        // å‘é€èŠå¤©æ¶ˆæ¯
        async function sendChat() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message || !gameState.currentPet) {
                return;
            }
            
            showLoading('ä½ çš„ä¼™ä¼´æ­£åœ¨æ€è€ƒå›åº”...');
            
            try {
                addStoryText(`ä½ å¯¹${gameState.currentPet.name}è¯´ï¼š"${message}"`, 'system');
                
                const response = await generatePetResponse(message);
                await sleep(1000);
                
                addStoryText(`${gameState.currentPet.name}ï¼š${response}`, 'pet-speech');
                
                // å¢åŠ ç¾ç»Šå€¼
                gameState.currentPet.bond = Math.min(100, (gameState.currentPet.bond || 0) + 1);
                updatePetDisplay();
                
            } catch (error) {
                console.error('èŠå¤©å¤±è´¥:', error);
                const fallbackResponses = [
                    `${gameState.currentPet.name}å‹å¥½åœ°çœ‹ç€ä½ ï¼Œä¼¼ä¹å¾ˆå¼€å¿ƒå¬åˆ°ä½ çš„è¯ã€‚`,
                    `${gameState.currentPet.name}è½»å£°å›åº”ï¼Œè¡¨è¾¾ç€å¯¹ä½ çš„ä¿¡ä»»ã€‚`,
                    `${gameState.currentPet.name}æ‘‡æ‘†ç€èº«ä½“ï¼Œæ˜¾å¾—å¾ˆå…´å¥‹ã€‚`
                ];
                const randomResponse = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
                addStoryText(randomResponse, 'pet-speech');
            } finally {
                hideLoading();
                chatInput.value = '';
            }
        }

        // ç”Ÿæˆå® ç‰©å›åº”
        async function generatePetResponse(message) {
            const prompt = `
                ç©å®¶å¯¹å® ç‰©è¯´ï¼š"${message}"
                å® ç‰©ä¿¡æ¯ï¼š${JSON.stringify(gameState.currentPet)}
                
                è¯·ç”Ÿæˆä¸€ä¸ªç¬¦åˆå® ç‰©æ€§æ ¼çš„å›åº”ï¼ˆ50-100å­—ï¼‰ï¼Œè¦ä½“ç°ï¼š
                1. å® ç‰©çš„ç§æ—ç‰¹è‰²
                2. å½“å‰å¿ƒæƒ…çŠ¶æ€
                3. ä¸ç©å®¶çš„ç¾ç»Šç¨‹åº¦
                4. å¯¹è¯çš„è‡ªç„¶æ€§
            `;
            
            try {
                const response = await fetch(`${API_CONFIG.baseURL}/pet-chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        pet: gameState.currentPet,
                        message: message
                    })
                });
                
                if (!response.ok) throw new Error('APIè¯·æ±‚å¤±è´¥');
                
                const data = await response.json();
                return data.response || data.content || '...(æ— è¨€åœ°çœ‹ç€ä½ )';
                
            } catch (error) {
                throw error;
            }
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(text = 'åŠ è½½ä¸­...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = text;
            overlay.style.display = 'flex';
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'none';
        }

        // å·¥å…·å‡½æ•°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // é”®ç›˜äº‹ä»¶å¤„ç†
        function handleKeyboard(event) {
            if (event.key === 'Enter' && event.target.id === 'chatInput') {
                event.preventDefault();
                sendChat();
            }
        }

        // å…¶ä»–åŠŸèƒ½å‡½æ•°
        function showPetDetails() {
            if (!gameState.currentPet) {
                alert('è¿˜æ²¡æœ‰å® ç‰©ä¼™ä¼´');
                return;
            }
            
            const pet = gameState.currentPet;
            const details = `
ğŸ¾ ${pet.name} è¯¦ç»†ä¿¡æ¯

ğŸ“Š åŸºç¡€å±æ€§ï¼š
â€¢ ç§æ—ï¼š${pet.species}
â€¢ ç­‰çº§ï¼š${pet.level} (ç»éªŒ: ${pet.exp}/${pet.level * 100})
â€¢ ç¨€æœ‰åº¦ï¼š${pet.rarity}
â€¢ ç¾ç»Šå€¼ï¼š${pet.bond}/100

âš”ï¸ æˆ˜æ–—å±æ€§ï¼š
â€¢ ç”Ÿå‘½å€¼ï¼š${pet.hp}
â€¢ æ”»å‡»åŠ›ï¼š${pet.attack}
â€¢ é˜²å¾¡åŠ›ï¼š${pet.defense}
â€¢ æ•æ·åº¦ï¼š${pet.speed}
â€¢ é­”æ³•åŠ›ï¼š${pet.magic}

ğŸ­ çŠ¶æ€ä¿¡æ¯ï¼š
â€¢ å½“å‰å¿ƒæƒ…ï¼š${pet.mood}
â€¢ æ€§æ ¼ç‰¹ç‚¹ï¼š${pet.personality}

âœ¨ ç‰¹æ®Šèƒ½åŠ›ï¼š
${pet.traits.map(trait => `â€¢ ${trait}`).join('\n')}
            `;
            
            alert(details);
        }

        function saveProgress() {
            try {
                localStorage.setItem('lingjing_game_save', JSON.stringify(gameState));
                alert('âœ… æ¸¸æˆè¿›åº¦å·²ä¿å­˜ï¼');
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®');
            }
        }

        function autoSave() {
            if (gameState.currentPet) {
                try {
                    localStorage.setItem('lingjing_game_autosave', JSON.stringify(gameState));
                    console.log('ğŸ”„ è‡ªåŠ¨ä¿å­˜å®Œæˆ');
                } catch (error) {
                    console.error('è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
                }
            }
        }

        function loadProgress() {
            try {
                const saved = localStorage.getItem('lingjing_game_save');
                if (saved) {
                    gameState = JSON.parse(saved);
                    updatePetDisplay();
                    return true;
                }
            } catch (error) {
                console.error('è¯»å–å­˜æ¡£å¤±è´¥:', error);
            }
            return false;
        }

        function showSettings() {
            alert('âš™ï¸ æ¸¸æˆè®¾ç½®\n\nâ€¢ è‡ªåŠ¨ä¿å­˜ï¼šå·²å¯ç”¨\nâ€¢ éŸ³æ•ˆï¼šå¼€å‘ä¸­\nâ€¢ ä¸»é¢˜ï¼šæš—è‰²æ¨¡å¼\nâ€¢ è¯­è¨€ï¼šç®€ä½“ä¸­æ–‡');
        }

        function returnToMain() {
            if (confirm('ç¡®å®šè¦è¿”å›ä¸»ç•Œé¢å—ï¼Ÿæœªä¿å­˜çš„è¿›åº¦å°†ä¼šä¸¢å¤±ã€‚')) {
                window.location.href = 'index.html';
            }
        }

        // è¿›åŒ–ç³»ç»Ÿç›¸å…³å‡½æ•°
        async function showEvolutionStatus() {
            if (!gameState.currentPet) {
                alert('è¿˜æ²¡æœ‰å® ç‰©ä¼™ä¼´');
                return;
            }

            if (!window.evolutionSystem) {
                alert('è¿›åŒ–ç³»ç»ŸæœªåŠ è½½');
                return;
            }

            showLoading('åˆ†æè¿›åŒ–çŠ¶æ€...');

            try {
                // è·å–æœ€æ–°çš„è¿›åŒ–åˆ†æ
                await evolutionSystem.analyzeEvolutionPotential();
                const status = evolutionSystem.getEvolutionStatus();
                
                let statusText = `ğŸŒŸ ${gameState.currentPet.name} è¿›åŒ–çŠ¶æ€

`;
                statusText += `ğŸ“Š å½“å‰çŠ¶æ€ï¼š${status.status}
`;
                
                if (status.nextThreshold) {
                    const threshold = status.nextThreshold;
                    const pet = gameState.currentPet;
                    statusText += `
ğŸ¯ ä¸‹ä¸€é˜¶æ®µè¿›åŒ–æ¡ä»¶ï¼š
`;
                    statusText += `â€¢ ç­‰çº§ï¼š${pet.level}/${threshold.level} ${pet.level >= threshold.level ? 'âœ…' : 'âŒ'}
`;
                    statusText += `â€¢ ç»éªŒï¼š${pet.exp}/${threshold.experience} ${pet.exp >= threshold.experience ? 'âœ…' : 'âŒ'}
`;
                    statusText += `â€¢ ç¾ç»Šï¼š${pet.bond}/${threshold.bond} ${pet.bond >= threshold.bond ? 'âœ…' : 'âŒ'}
`;
                }

                if (status.prediction && status.prediction.length > 0) {
                    statusText += `
ğŸ”® è¿›åŒ–é¢„æµ‹ï¼š
`;
                    status.prediction.forEach((path, index) => {
                        statusText += `${index + 1}. ${path.name} (${(path.probability * 100).toFixed(1)}%)
`;
                        statusText += `   â†’ ${path.nextForm}
`;
                        statusText += `   ${path.description}

`;
                    });
                }

                if (status.canEvolve) {
                    statusText += `
âœ¨ ä½ çš„ä¼™ä¼´å·²ç»å‡†å¤‡å¥½è¿›åŒ–äº†ï¼
ç‚¹å‡»"è§¦å‘è¿›åŒ–"æŒ‰é’®å¼€å§‹è¿›åŒ–è¿‡ç¨‹ã€‚`;
                }

                alert(statusText);

            } catch (error) {
                console.error('è·å–è¿›åŒ–çŠ¶æ€å¤±è´¥:', error);
                alert('âŒ è·å–è¿›åŒ–çŠ¶æ€å¤±è´¥ï¼Œè¯·é‡è¯•');
            } finally {
                hideLoading();
            }
        }

        async function triggerEvolution() {
            if (!gameState.currentPet || !window.evolutionSystem) {
                return;
            }

            const status = evolutionSystem.getEvolutionStatus();
            if (!status.canEvolve) {
                alert('å½“å‰æ— æ³•è¿›åŒ–ï¼Œè¯·æŸ¥çœ‹è¿›åŒ–çŠ¶æ€äº†è§£è¯¦æƒ…');
                return;
            }

            if (!status.prediction || status.prediction.length === 0) {
                alert('æ²¡æœ‰å¯ç”¨çš„è¿›åŒ–è·¯å¾„');
                return;
            }

            // è®©ç©å®¶é€‰æ‹©è¿›åŒ–è·¯å¾„
            let choiceText = 'ğŸŒŸ é€‰æ‹©è¿›åŒ–è·¯å¾„ï¼š

';
            status.prediction.forEach((path, index) => {
                choiceText += `${index + 1}. ${path.name} (${(path.probability * 100).toFixed(1)}%)
`;
                choiceText += `   â†’ ${path.nextForm}
`;
                choiceText += `   ${path.description}

`;
            });
            choiceText += 'è¯·è¾“å…¥é€‰æ‹©çš„ç¼–å· (1-' + status.prediction.length + ')ï¼š';

            const choice = prompt(choiceText);
            const choiceIndex = parseInt(choice) - 1;

            if (isNaN(choiceIndex) || choiceIndex < 0 || choiceIndex >= status.prediction.length) {
                alert('æ— æ•ˆçš„é€‰æ‹©');
                return;
            }

            const selectedPath = status.prediction[choiceIndex];
            
            if (!confirm(`ç¡®å®šè¦è¿›åŒ–ä¸º ${selectedPath.nextForm} å—ï¼Ÿ

${selectedPath.description}

è¿›åŒ–åæ— æ³•æ’¤é”€ï¼`)) {
                return;
            }

            showLoading('è¿›åŒ–ä¸­...');

            try {
                const success = await evolutionSystem.executeEvolution(selectedPath);
                
                if (success) {
                    // æ›´æ–°æ˜¾ç¤º
                    updatePetDisplay();
                    
                    // æ·»åŠ è¿›åŒ–æ•…äº‹
                    addStoryText(`âœ¨ å¥‡è¿¹å‘ç”Ÿäº†ï¼`, 'important');
                    await sleep(1000);
                    addStoryText(`${gameState.currentPet.name}è¢«è€€çœ¼çš„å…‰èŠ’åŒ…å›´ï¼Œèº«ä½“å¼€å§‹å‘ç”Ÿç¥å¥‡çš„å˜åŒ–...`, 'new');
                    await sleep(2000);
                    addStoryText(`å½“å…‰èŠ’æ•£å»æ—¶ï¼Œä¸€åªå…¨æ–°çš„${selectedPath.nextForm}å‡ºç°åœ¨ä½ é¢å‰ï¼`, 'important');
                    await sleep(1500);
                    addStoryText(`ğŸ‰ è¿›åŒ–æˆåŠŸï¼ä½ çš„ä¼™ä¼´å·²ç»æˆé•¿ä¸º${selectedPath.nextForm}ï¼`, 'important');
                    
                    // è®°å½•è¿›åŒ–è¡Œä¸º
                    recordPetBehavior('evolution', {
                        evolutionPath: selectedPath.name,
                        newForm: selectedPath.nextForm,
                        timestamp: Date.now()
                    });
                    
                    alert(`ğŸ‰ è¿›åŒ–æˆåŠŸï¼

ä½ çš„ä¼™ä¼´å·²ç»æˆé•¿ä¸º ${selectedPath.nextForm}ï¼

è·å¾—äº†æ–°çš„èƒ½åŠ›å’Œæ›´å¼ºçš„å±æ€§ï¼`);
                    
                } else {
                    alert('âŒ è¿›åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
                
            } catch (error) {
                console.error('è¿›åŒ–æ‰§è¡Œå¤±è´¥:', error);
                alert('âŒ è¿›åŒ–è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•');
            } finally {
                hideLoading();
            }
        }

        // è·å–è¿›åŒ–çŠ¶æ€ï¼ˆä¾›UIæ›´æ–°ä½¿ç”¨ï¼‰
        function getEvolutionStatus() {
            if (!window.evolutionSystem || !gameState.currentPet) {
                return { status: 'æ— å® ç‰©', canEvolve: false };
            }
            
            return evolutionSystem.getEvolutionStatus();
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', () => {
            initGame();
            
            // å°è¯•åŠ è½½å­˜æ¡£
            if (loadProgress()) {
                console.log('ğŸ“‚ å­˜æ¡£åŠ è½½æˆåŠŸ');
            }
        });

        // é¡µé¢å¸è½½å‰è‡ªåŠ¨ä¿å­˜
        window.addEventListener('beforeunload', () => {
            autoSave();
        });
    </script>
</body>
</html>